<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeenWork ‚Äî –†–∞–±–æ—Ç–∞ –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ 14-18 –ª–µ—Ç</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563eb;
            --blue-hover: #1d4ed8;
            --blue-light: #3b82f6;
            --soft-blue: #eff6ff;
            --light-gray: #f8fafc;
            --border-gray: #e2e8f0;
            --text-dark: #0f172a;
            --text-gray: #64748b;
            --white: #ffffff;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --max-width: 1280px;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light-gray);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            opacity: 0;
            animation: fadeInPage 0.4s ease forwards;
        }

        @keyframes fadeInPage {
            to { opacity: 1; }
        }

        .nav {
            position: sticky;
            top: 0;
            background: var(--white);
            box-shadow: var(--shadow-sm);
            z-index: 1000;
            padding: 16px 0;
            transition: var(--transition);
        }

        .nav.scrolled {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-md);
        }

        .nav-container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 30px;
            font-weight: 800;
            color: var(--primary-blue);
            letter-spacing: -1px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--blue-light));
            transition: width 0.4s ease;
            border-radius: 2px;
        }

        .logo:hover::after {
            width: 100%;
        }

        .logo:hover {
            transform: translateY(-1px);
            filter: drop-shadow(0 4px 8px rgba(37, 99, 235, 0.3));
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .nav-profile-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            transition: var(--transition);
        }

        .nav-profile-wrapper:hover {
            background: var(--light-gray);
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            transition: var(--transition);
            border: 2px solid transparent;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .nav-profile-wrapper:hover .user-avatar {
            border-color: var(--primary-blue);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .nav-profile-text {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-dark);
        }

        .btn {
            padding: 11px 24px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.35);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-dark);
            border: 1.5px solid var(--border-gray);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--light-gray);
            border-color: var(--text-gray);
        }

        .btn-small {
            padding: 7px 16px;
            font-size: 13px;
        }

        .hero {
            background: linear-gradient(135deg, #1e40af 0%, var(--primary-blue) 50%, var(--blue-light) 100%);
            color: var(--white);
            padding: 100px 24px 120px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .hero-content {
            max-width: 850px;
            margin: 0 auto;
            animation: fadeInUp 0.7s ease;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero h1 {
            font-size: 58px;
            font-weight: 800;
            margin-bottom: 24px;
            line-height: 1.1;
            letter-spacing: -2px;
            animation: fadeInUp 0.7s ease 0.1s backwards;
        }

        .hero p {
            font-size: 21px;
            margin-bottom: 40px;
            opacity: 0.95;
            font-weight: 500;
            line-height: 1.7;
            animation: fadeInUp 0.7s ease 0.2s backwards;
        }

        .hero-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            animation: fadeInUp 0.7s ease 0.3s backwards;
        }

        .btn-hero {
            padding: 16px 36px;
            font-size: 17px;
            border-radius: var(--radius-lg);
            font-weight: 700;
        }

        .btn-white {
            background: var(--white);
            color: var(--primary-blue);
        }

        .btn-white:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--white);
            border: 2.5px solid var(--white);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px;
        }

        .filters-section {
            background: var(--white);
            padding: 36px 28px;
            margin-top: -60px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            position: relative;
            z-index: 10;
            animation: fadeInUp 0.6s ease 0.4s backwards;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-bottom: 18px;
        }

        .input, .select {
            width: 100%;
            padding: 13px 18px;
            border: 1.5px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: var(--transition);
            background: var(--white);
            font-weight: 500;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        .sort-dropdown {
            margin-left: auto;
            min-width: 200px;
        }

        .jobs-section {
            padding: 70px 0;
        }

        .section-header {
            margin-bottom: 36px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-header h2 {
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .section-info {
            color: var(--text-gray);
            font-size: 16px;
            font-weight: 500;
        }

        .jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .job-card {
            background: var(--white);
            padding: 26px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            animation: fadeIn 0.5s ease backwards;
        }

        .job-card:nth-child(1) { animation-delay: 0.05s; }
        .job-card:nth-child(2) { animation-delay: 0.1s; }
        .job-card:nth-child(3) { animation-delay: 0.15s; }
        .job-card:nth-child(4) { animation-delay: 0.2s; }
        .job-card:nth-child(5) { animation-delay: 0.25s; }
        .job-card:nth-child(6) { animation-delay: 0.3s; }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .job-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
        }

        .job-header {
            margin-bottom: 18px;
        }

        .job-title {
            font-size: 21px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .job-company {
            color: var(--text-gray);
            font-size: 15px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .job-location {
            color: var(--text-gray);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .job-details {
            margin-bottom: 18px;
        }

        .job-salary {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 14px;
        }

        .job-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 18px;
        }

        .tag {
            padding: 7px 14px;
            background: var(--soft-blue);
            color: var(--primary-blue);
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
        }

        .job-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-top: 18px;
            border-top: 1.5px solid var(--border-gray);
        }

        .btn-apply {
            padding: 9px 22px;
            font-size: 14px;
        }

        .info-section {
            padding: 90px 0;
            background: var(--white);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 32px;
            margin-top: 56px;
        }

        .info-card {
            padding: 36px;
            background: var(--light-gray);
            border-radius: var(--radius-lg);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .info-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-md);
            border-color: var(--soft-blue);
            background: var(--white);
        }

        .info-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--soft-blue), #dbeafe);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 24px;
            transition: var(--transition);
        }

        .info-card:hover .info-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .info-card h3 {
            font-size: 21px;
            margin-bottom: 14px;
            font-weight: 700;
        }

        .info-card p {
            color: var(--text-gray);
            line-height: 1.7;
            font-weight: 500;
        }

        .faq-section {
            padding: 90px 0;
        }

        .faq-list {
            max-width: 850px;
            margin: 56px auto 0;
        }

        .faq-item {
            background: var(--white);
            border-radius: var(--radius-lg);
            margin-bottom: 18px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .faq-item:hover {
            box-shadow: var(--shadow-md);
        }

        .faq-question {
            padding: 22px 26px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 16px;
            transition: var(--transition);
            user-select: none;
        }

        .faq-question:hover {
            background: var(--light-gray);
        }

        .faq-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
            flex-shrink: 0;
            color: var(--primary-blue);
        }

        .faq-item.active .faq-icon {
            transform: rotate(180deg);
        }

        .faq-item.active .faq-question {
            background: var(--soft-blue);
            color: var(--primary-blue);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .faq-answer-content {
            padding: 0 26px 22px;
            color: var(--text-gray);
            line-height: 1.8;
            font-weight: 500;
        }

        .footer {
            background: var(--text-dark);
            color: var(--white);
            padding: 60px 0 28px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-section h4 {
            margin-bottom: 18px;
            font-size: 17px;
            font-weight: 700;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
        }

        .footer-links a:hover {
            color: var(--white);
            padding-left: 4px;
        }

        .footer-bottom {
            padding-top: 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(6px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal.hiding .modal-content {
            animation: modalSlideOut 0.3s ease forwards;
        }

        @keyframes modalSlideOut {
            to {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
        }

        .modal-header {
            padding: 28px;
            border-bottom: 1.5px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .modal-close {
            background: var(--light-gray);
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-gray);
            transition: var(--transition);
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: var(--border-gray);
            color: var(--text-dark);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 28px;
        }

        .form-group {
            margin-bottom: 22px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 13px 18px;
            border: 1.5px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: var(--transition);
            font-weight: 500;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 110px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .form-error {
            color: var(--error);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            font-weight: 600;
        }

        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: var(--error);
        }

        .form-group.error .form-error {
            display: block;
        }

        .password-toggle {
            position: absolute;
            right: 18px;
            top: 42px;
            cursor: pointer;
            color: var(--text-gray);
            font-size: 18px;
            user-select: none;
        }

        .password-toggle:hover {
            color: var(--text-dark);
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: var(--text-gray);
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .empty-state-icon {
            font-size: 72px;
            margin-bottom: 24px;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 26px;
            margin-bottom: 14px;
            color: var(--text-dark);
            font-weight: 700;
        }

        .empty-state p {
            font-weight: 500;
        }

        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--white);
            padding: 18px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: start;
            gap: 14px;
            min-width: 320px;
            max-width: 420px;
            animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 4px solid;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(450px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideOutRight {
            to {
                transform: translateX(450px);
                opacity: 0;
            }
        }

        .toast-icon {
            font-size: 26px;
            flex-shrink: 0;
            line-height: 1;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--text-gray);
            line-height: 1.5;
            font-weight: 500;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.error .toast-icon {
            color: var(--error);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 48px;
        }

        .pagination-btn {
            padding: 10px 18px;
            border: 1.5px solid var(--border-gray);
            background: var(--white);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--light-gray);
            border-color: var(--primary-blue);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .profile-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            z-index: 1500;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-page.active {
            transform: translateX(0);
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            padding: 40px 24px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .profile-nav {
            max-width: var(--max-width);
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-family: inherit;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-title {
            max-width: var(--max-width);
            margin: 0 auto;
        }

        .profile-title h1 {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .profile-body {
            max-width: 700px;
            margin: 0 auto;
            padding: 60px 24px;
        }

        .profile-avatar-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .profile-avatar-display {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 4px solid var(--white);
            box-shadow: var(--shadow-lg);
        }

        .profile-avatar-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            display: inline-block;
            margin-top: 10px;
        }

        .avatar-upload input {
            display: none;
        }

        .avatar-upload label {
            cursor: pointer;
            color: var(--primary-blue);
            font-weight: 600;
            text-decoration: underline;
        }

        .profile-info {
            background: var(--light-gray);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }

        .profile-info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-gray);
        }

        .profile-info-item:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            font-weight: 600;
            color: var(--text-gray);
        }

        .profile-info-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .profile-section {
            margin-bottom: 32px;
        }

        .profile-section h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .applied-jobs-list {
            background: var(--light-gray);
            padding: 20px;
            border-radius: var(--radius-lg);
        }

        .applied-job-item {
            background: var(--white);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .applied-job-item:last-child {
            margin-bottom: 0;
        }

        .applied-job-title {
            font-weight: 600;
            color: var(--text-dark);
        }

        .applied-job-company {
            font-size: 14px;
            color: var(--text-gray);
        }

        .role-selector-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .role-option {
            padding: 18px;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .role-option:hover {
            border-color: var(--primary-blue);
            background: var(--soft-blue);
        }

        .admin-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .admin-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1.5px solid var(--border-gray);
        }

        .btn-admin {
            flex: 1;
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-danger {
            background: var(--error);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .job-stats {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-gray);
        }

        .application-list-item {
            background: var(--white);
            padding: 14px;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
        }

        .application-list-item:last-child {
            margin-bottom: 0;
        }

        .application-worker-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .application-worker-email {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        /* ==============================
           CHAT UI ENHANCEMENT
           Improved chat appearance while preserving existing logic
        ============================== */
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--light-gray);
            border-radius: var(--radius-md);
            scroll-behavior: smooth;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            max-width: 70%;
            word-wrap: break-word;
            display: block;
            /* Enhanced: slightly smoother rendering */
            line-height: 1.5;
            font-size: 14px;
            font-weight: 500;
        }

        .chat-message.sent {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            margin-left: auto;
            margin-right: 0;
            text-align: right;
            border-bottom-right-radius: 4px;
        }

        .chat-message.received {
            background: var(--white);
            color: var(--text-dark);
            margin-right: auto;
            margin-left: 0;
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        /* NEW: Chat image message styling */
        .chat-message-image {
            max-width: 220px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            display: block;
        }

        .chat-message-image:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        /* NEW: Chat audio message styling */
        .chat-message-audio {
            max-width: 260px;
            width: 100%;
            height: 36px;
            border-radius: 20px;
            outline: none;
            accent-color: var(--primary-blue);
        }

        .chat-message.sent .chat-message-audio {
            /* Keep audio in sent bubble */
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-input-container input {
            flex: 1;
        }

        /* NEW: Media buttons in chat toolbar */
        .chat-media-toolbar {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-media-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1.5px solid var(--border-gray);
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .chat-media-btn:hover {
            background: var(--soft-blue);
            border-color: var(--primary-blue);
            transform: scale(1.08);
        }

        .chat-media-btn.recording {
            background: #fee2e2;
            border-color: var(--error);
            animation: recordPulse 1s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }

        /* Hidden file input for image upload */
        #chatImageInput {
            display: none;
        }

        /* Upload progress indicator */
        .chat-upload-indicator {
            font-size: 12px;
            color: var(--text-gray);
            padding: 4px 8px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            display: none;
        }

        .chat-upload-indicator.visible {
            display: block;
        }

        .admin-panel-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: var(--white);
            padding: 6px 14px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 40px;
                letter-spacing: -1px;
            }

            .hero p {
                font-size: 18px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .jobs-grid {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .hero-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn-hero {
                width: 100%;
            }

            .nav-actions {
                gap: 8px;
            }

            .btn {
                padding: 9px 16px;
                font-size: 14px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .sort-dropdown {
                margin-left: 0;
                width: 100%;
            }

            .toast-container {
                right: 12px;
                left: 12px;
            }

            .toast {
                min-width: auto;
                max-width: none;
            }

            .profile-title h1 {
                font-size: 32px;
            }

            .logo {
                font-size: 24px;
            }

            .nav-profile-text {
                display: none;
            }
        }
 .quick-tags {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.tag-btn {
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-gray);
    background: var(--white);
    cursor: pointer;
    font-size: 13px;
    transition: 0.2s;
}

.tag-btn:hover {
    background: var(--soft-blue);
}

.tag-btn.active {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
}   
</style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <nav class="nav" id="navbar">
        <div class="nav-container">
            <div class="logo" onclick="scrollToTop()">TeenWork</div>
            <div class="nav-actions" id="navActions"></div>
        </div>
    </nav>

    <section class="hero">
        <div class="hero-content">
            <h1>–¢–≤–æ—è –ø–µ—Ä–≤–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–¥–µ—Å—å</h1>
            <p>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ–¥—Ä–æ—Å—Ç–∫–∞–º 14-18 –ª–µ—Ç. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, —Ä–µ–∞–ª—å–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–∏.</p>
            <div class="hero-actions">
                <button class="btn btn-hero btn-white" onclick="scrollToSearch()">–ù–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É</button>
                <button class="btn btn-hero btn-outline" onclick="handleEmployerButtonClick()">–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è–º</button>
            </div>
        </div>
    </section>

    <div class="container">
        <section class="filters-section" id="search">
            <div class="filters-grid">
                <input type="text" class="input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏...">
                function selectTag(tag) {
    const input = document.getElementById('searchInput');
    input.value = tag;
    applyFilters();
}
                <div class="quick-tags" id="quickTags">
    <button class="tag-btn">–°–±–æ—Ä—â–∏–∫ –∑–∞–∫–∞–∑–æ–≤</button>
    <button class="tag-btn">–†–∞–∑–Ω–æ—Ä–∞–±–æ—á–∏–π</button>
    <button class="tag-btn">–ö–∞—Å—Å–∏—Ä</button>
    <button class="tag-btn">–ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–∞—Å—Å–∏—Ä</button>
    <button class="tag-btn">–ü—Ä–æ–º–æ—É—Ç–µ—Ä</button>
    <button class="tag-btn">–ö—É—Ä—å–µ—Ä</button>
    <button class="tag-btn">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</button>
    <button class="tag-btn">–£–¥–∞–ª—ë–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞</button>
    <button class="tag-btn">–ë–µ–∑ –æ–ø—ã—Ç–∞</button>
</div>
                <select class="select" id="cityFilter">
                    <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                    <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                </select>
                <select class="select" id="typeFilter">
                    <option value="">–¢–∏–ø —Ä–∞–±–æ—Ç—ã</option>
                    <option value="–ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å">–ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å</option>
                    <option value="–°–µ–∑–æ–Ω–Ω–∞—è">–°–µ–∑–æ–Ω–Ω–∞—è</option>
                    <option value="–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è">–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è</option>
                    <option value="–í—Ä–µ–º–µ–Ω–Ω–∞—è">–í—Ä–µ–º–µ–Ω–Ω–∞—è</option>
                </select>
                <select class="select" id="salaryFilter">
                    <option value="">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
                    <option value="0-20000">–¥–æ 20 000 ‚ÇΩ</option>
                    <option value="20000-35000">20 000 - 35 000 ‚ÇΩ</option>
                    <option value="35000-50000">35 000 - 50 000 ‚ÇΩ</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                <button class="btn btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <select class="select sort-dropdown" id="sortFilter">
                    <option value="salary-desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é –∑–∞—Ä–ø–ª–∞—Ç—ã</option>
                    <option value="salary-asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∑–∞—Ä–ø–ª–∞—Ç—ã</option>
                </select>
            </div>
        </section>

        <section class="jobs-section">
            <div class="section-header">
                <div>
                    <h2>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏</h2>
                    <p class="section-info" id="jobCount">–ù–∞–π–¥–µ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: 0</p>
                </div>
            </div>
            <div class="jobs-grid" id="jobsGrid"></div>
            <div class="pagination" id="pagination"></div>
        </section>
    </div>

    <section class="info-section">
        <div class="container">
            <div class="section-header" style="text-align: center; display: block;">
                <h2>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ ‚Äî –Ω–∞—à –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</h2>
                <p class="section-info">–ú—ã —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è</p>
            </div>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-icon">üõ°Ô∏è</div>
                    <h3>–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–∏</h3>
                    <p>–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é. –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—é.</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">üìã</div>
                    <h3>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h3>
                    <p>–¢–æ–ª—å–∫–æ –ª–µ–≥–∞–ª—å–Ω–æ–µ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –¢—Ä—É–¥–æ–≤–æ–≥–æ –∫–æ–¥–µ–∫—Å–∞ –†–§ –¥–ª—è –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö.</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">‚è∞</div>
                    <h3>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫</h3>
                    <p>–ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É: –Ω–µ –±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤.</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">üí∞</div>
                    <h3>–ì–∞—Ä–∞–Ω—Ç–∏—è –≤—ã–ø–ª–∞—Ç</h3>
                    <p>–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã —Ç—Ä—É–¥–∞. –ù–∏–∫–∞–∫–∏—Ö —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–º–∏—Å—Å–∏–π –∏ –∑–∞–¥–µ—Ä–∂–µ–∫ –∑–∞—Ä–ø–ª–∞—Ç—ã.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="faq-section">
        <div class="container">
            <div class="section-header" style="text-align: center; display: block;">
                <h2>–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h2>
                <p class="section-info">–û—Ç–≤–µ—Ç—ã –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–±–æ—Ç–µ –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤</p>
            </div>
            <div class="faq-list" id="faqList">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>–° –∫–∞–∫–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å?</span>
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            –ü–æ –¢—Ä—É–¥–æ–≤–æ–º—É –∫–æ–¥–µ–∫—Å—É –†–§ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–∏—Ç—å—Å—è –º–æ–∂–Ω–æ —Å 14 –ª–µ—Ç —Å –ø–∏—Å—å–º–µ–Ω–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π. –° 16 –ª–µ—Ç - —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. –í—Å–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–∞ –Ω–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —ç—Ç–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>–°–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥—Ä–æ—Å—Ç–æ–∫?</span>
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            –í –≤–æ–∑—Ä–∞—Å—Ç–µ 14-15 –ª–µ—Ç –≤–æ –≤—Ä–µ–º—è —É—á–µ–±—ã - –Ω–µ –±–æ–ª–µ–µ 12 —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é, –≤ –∫–∞–Ω–∏–∫—É–ª—ã - –Ω–µ –±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤. –í –≤–æ–∑—Ä–∞—Å—Ç–µ 16-18 –ª–µ—Ç - –Ω–µ –±–æ–ª–µ–µ 17,5 —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é –≤–æ –≤—Ä–µ–º—è —É—á–µ–±—ã –∏ –Ω–µ –±–æ–ª–µ–µ 35 —á–∞—Å–æ–≤ –≤ –∫–∞–Ω–∏–∫—É–ª—ã.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>–ù—É–∂–Ω—ã –ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã?</span>
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            –î–∞. –í–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è: –ø–∞—Å–ø–æ—Ä—Ç, —Å–æ–≥–ª–∞—Å–∏–µ —Ä–æ–¥–∏—Ç–µ–ª–µ–π (–¥–ª—è 14-15 –ª–µ—Ç), —Å–ø—Ä–∞–≤–∫–∞ –∏–∑ —à–∫–æ–ª—ã, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã 086/—É. –°–ù–ò–õ–° –∏ –ò–ù–ù —Ç–∞–∫–∂–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è?</span>
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º –≤–∞–∫–∞–Ω—Å–∏–π. –í—ã –º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è, –æ—Ç–∑—ã–≤—ã –¥—Ä—É–≥–∏—Ö –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤, –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –≤–∞–∫–∞–Ω—Å–∏–∏.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>–ú–æ–∂–Ω–æ –ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω–æ?</span>
                        <span class="faq-icon">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            –î–∞, —É –Ω–∞—Å –µ—Å—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏: SMM-–º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–π–∫–µ—Ä, –¥–∏–∑–∞–π–Ω–µ—Ä, –ø–æ–º–æ—â–Ω–∏–∫ –≤ –æ–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω–µ –∏ –¥—Ä—É–≥–∏–µ. –£–¥–∞–ª—ë–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Ç–∞–∫–∂–µ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>–û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</h4>
                    <ul class="footer-links">
                        <li><a onclick="openModal('infoModal', 'about')">–û –Ω–∞—Å</a></li>
                        <li><a onclick="openModal('infoModal', 'how-it-works')">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</a></li>
                        <li><a onclick="openModal('infoModal', 'safety')">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è–º</h4>
                    <ul class="footer-links">
                        <li><a onclick="openModal('infoModal', 'employers')">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h4>
                    <ul class="footer-links">
                        <li><a onclick="openModal('infoModal', 'support')">–ü–æ–º–æ—â—å</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>–ü—Ä–∞–≤–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    <ul class="footer-links">
                        <li><a onclick="openModal('infoModal', 'legal')">–î–æ–∫—É–º–µ–Ω—Ç—ã</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 TeenWork. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. –ü–µ—Ä–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–∞–±–æ—Ç—ã –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ –≤ –†–æ—Å—Å–∏–∏.</p>
            </div>
        </div>
    </footer>

    <div class="profile-page" id="profilePage">
        <div class="profile-header">
            <div class="profile-nav">
                <button class="back-btn" onclick="closeProfile()">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            <div class="profile-title">
                <h1>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h1>
            </div>
        </div>
        <div class="profile-body">
            <div class="profile-avatar-section">
                <div class="profile-avatar-display" id="profileAvatarDisplay"></div>
                <div class="avatar-upload">
                    <input type="file" id="avatarUpload" accept="image/*">
                    <label for="avatarUpload">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</label>
                </div>
            </div>
            
            <form id="profileForm">
                <div class="form-group">
                    <label>–ù–∏–∫–Ω–µ–π–º</label>
                    <input type="text" id="profileNickname" required>
                    <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                </div>
                
                <div class="profile-info">
                    <div class="profile-info-item">
                        <span class="profile-info-label">Email:</span>
                        <span class="profile-info-value" id="profileEmail"></span>
                    </div>
                    <div class="profile-info-item">
                        <span class="profile-info-label">–†–æ–ª—å:</span>
                        <span class="profile-info-value" id="profileRole"></span>
                    </div>
                    <div class="profile-info-item">
                        <span class="profile-info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                        <span class="profile-info-value" id="profileDate"></span>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button type="button" class="btn btn-secondary" style="width: 100%; margin-bottom: 12px;" onclick="openRoleSelectorModal()">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>
                <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            </form>

            <div id="profileApplicationsSection" style="display: none;">
                <div class="profile-section">
                    <h3>–ú–æ–∏ –æ—Ç–∫–ª–∏–∫–∏</h3>
                    <div class="applied-jobs-list" id="appliedJobsList"></div>
                </div>
            </div>

            <div id="profileEmployerSection" style="display: none;">
                <div class="profile-section">
                    <h3>–ú–æ–∏ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏</h3>
                    <div class="applied-jobs-list" id="employerJobsList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h3>
                <button class="modal-close" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                        <div class="form-error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</div>
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="loginPassword" name="password" required>
                        <span class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</span>
                        <div class="form-error">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ email</div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">–í–æ–π—Ç–∏</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <button class="modal-close" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label>–ù–∏–∫–Ω–µ–π–º</label>
                        <input type="text" name="nickname" required>
                        <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                        <div class="form-error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</div>
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)</label>
                        <input type="password" id="registerPassword" name="password" required>
                        <span class="password-toggle" onclick="togglePassword('registerPassword')">üëÅÔ∏è</span>
                        <div class="form-error">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
                    </div>
                    <div class="form-group">
                        <label>–Ø —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Å—å –∫–∞–∫</label>
                        <select name="role" id="registerRoleSelect" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                            <option value="worker">–Ø –∏—â—É —Ä–∞–±–æ—Ç—É</option>
                            <option value="employer">–Ø —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å</option>
                        </select>
                        <div class="form-error">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="applyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é</h3>
                <button class="modal-close" onclick="closeModal('applyModal')">&times;</button>
            </div>
            <div class="modal-body" id="applyModalBody"></div>
        </div>
    </div>

    <div class="modal" id="postJobModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é</h3>
                <button class="modal-close" onclick="closeModal('postJobModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="postJobForm">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏</label>
                        <input type="text" name="title" required>
                        <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                    </div>
                    <div class="form-group">
                        <label>–ö–æ–º–ø–∞–Ω–∏—è</label>
                        <input type="text" name="company" required>
                        <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                    </div>
                    <div class="form-group">
                        <label>–ì–æ—Ä–æ–¥</label>
                        <select name="city" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                            <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                        </select>
                        <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                    </div>
                    <div class="form-group">
                        <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                        <input type="number" name="salary" required min="0">
                        <div class="form-error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∑–∞—Ä–ø–ª–∞—Ç—É</div>
                    </div>
                    <div class="form-group">
                        <label>–¢–∏–ø —Ä–∞–±–æ—Ç—ã</label>
                        <input type="text" name="type" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å, —Å–º–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫" required>
                        <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                    </div>
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea name="description" required></textarea>
                        <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="infoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="infoModalTitle"></h3>
                <button class="modal-close" onclick="closeModal('infoModal')">&times;</button>
            </div>
            <div class="modal-body" id="infoModalBody"></div>
        </div>
    </div>

    <div class="modal" id="roleSelectorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>
                <button class="modal-close" onclick="closeModal('roleSelectorModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="role-selector-options">
                    <div class="role-option" onclick="changeUserRole('worker')">
                        <div style="font-size: 18px; margin-bottom: 4px;">–Ø –∏—â—É —Ä–∞–±–æ—Ç—É</div>
                        <div style="font-size: 14px; color: var(--text-gray); font-weight: 500;">–°–æ–∏—Å–∫–∞—Ç–µ–ª—å</div>
                    </div>
                    <div class="role-option" onclick="changeUserRole('employer')">
                        <div style="font-size: 18px; margin-bottom: 4px;">–Ø —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å</div>
                        <div style="font-size: 14px; color: var(--text-gray); font-weight: 500;">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–π</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="workerNeedsChangeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</h3>
                <button class="modal-close" onclick="closeModal('workerNeedsChangeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; line-height: 1.7; color: var(--text-gray);">–ß—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é, —Å–º–µ–Ω–∏—Ç–µ —Ä–æ–ª—å –Ω–∞ –†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å</p>
                <button class="btn btn-primary" style="width: 100%;" onclick="openRoleSelectorModalFromWorker()">–°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>
            </div>
        </div>
    </div>

    <div class="modal" id="applicationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–û—Ç–∫–ª–∏–∫–∏ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é</h3>
                <button class="modal-close" onclick="closeModal('applicationsModal')">&times;</button>
            </div>
            <div class="modal-body" id="applicationsModalBody"></div>
        </div>
    </div>

    <!-- CHAT MODAL: Enhanced with media toolbar but existing logic untouched -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="chatModalTitle">–ß–∞—Ç</h3>
                <button class="modal-close" onclick="closeModal('chatModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chat-messages" id="chatMessages"></div>
                <!-- Upload progress indicator (hidden by default) -->
                <div class="chat-upload-indicator" id="chatUploadIndicator">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</div>
                <div class="chat-input-container">
                    <!-- Hidden file input for image uploads -->
                    <input type="file" id="chatImageInput" accept="image/*">
                    <!-- NEW: Image upload button -->
                    <button class="chat-media-btn" onclick="triggerChatImageUpload()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üñºÔ∏è</button>
                    <!-- NEW: Voice message button -->
                    <button class="chat-media-btn" id="voiceRecordBtn" onclick="toggleVoiceRecording()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">üéôÔ∏è</button>
                    <!-- Existing text input (unchanged) -->
                    <input type="text" class="input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <!-- Existing send button (unchanged) -->
                    <button class="btn btn-primary" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const JOBS = [
            {
                id: 1,
                title: '–ü—Ä–æ–º–æ—É—Ç–µ—Ä –≤–æ–¥–Ω—ã—Ö —ç–∫—Å–∫—É—Ä—Å–∏–π',
                company: '–ù–µ–≤–∞ –¢—Ä–µ–≤–µ–ª',
                city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                salary: 30000,
                type: '–°–µ–∑–æ–Ω–Ω–∞—è, —á–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å, –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ',
                description: '–†–∞–±–æ—Ç–∞ –≤ –≤–µ—Å–µ–Ω–Ω–µ-–ª–µ—Ç–Ω–∏–π –ø–µ—Ä–∏–æ–¥. –ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ —Ç—É—Ä–∏—Å—Ç–æ–≤ –Ω–∞ –≤–æ–¥–Ω—ã–µ —ç–∫—Å–∫—É—Ä—Å–∏–∏ –ø–æ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥—É. –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º. –†–∞–±–æ—Ç–∞ –Ω–∞ —É–ª–∏—Ü–µ. –°–ø–µ—Ü–æ–¥–µ–∂–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è.'
            },
            {
                id: 2,
                title: '–ö–∞—Å—Å–∏—Ä',
                company: '–î–æ–¥–æ –ü–∏—Ü—Ü–∞',
                city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                salary: 35000,
                type: '–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è, —Å–º–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫',
                description: '–ü—Ä–∏–µ–º –∑–∞–∫–∞–∑–æ–≤, —Ä–∞—Å—á–µ—Ç, –≤—ã–¥–∞—á–∞ –∑–∞–∫–∞–∑–æ–≤, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞. –ë–æ–Ω—É—Å—ã –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.'
            },
            {
                id: 3,
                title: '–ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–∞—Å—Å–∏—Ä',
                company: 'Carte Dor',
                city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                salary: 40000,
                type: '–°–º–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫, —Ç–æ—Ä–≥–æ–≤–ª—è',
                description: '–ü—Ä–æ–¥–∞–∂–∞ –º–æ—Ä–æ–∂–µ–Ω–æ–≥–æ. –†–∞–±–æ—Ç–∞ —Å —Ç–æ–≤–∞—Ä–æ–º, —Ä–∞—Å—á–µ—Ç, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —á–∏—Å—Ç–æ—Ç—ã.'
            },
            {
                id: 4,
                title: '–°–±–æ—Ä—â–∏–∫ –æ–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑–æ–≤',
                company: '–ü–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫',
                city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                salary: 40000,
                type: '–ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å, —Å–º–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫',
                description: '–°–±–æ—Ä –æ–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–æ–≤ –≥–æ–¥–Ω–æ—Å—Ç–∏, –ø–µ—Ä–µ–¥–∞—á–∞ –∫—É—Ä—å–µ—Ä–∞–º.'
            },
            {
                id: 5,
                title: '–ö–∞—Å—Å–∏—Ä',
                company: '–í–∫—É—Å–Ω–æ –∏ —Ç–æ—á–∫–∞',
                city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                salary: 45000,
                type: '–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è, —Å–º–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫',
                description: '–ü—Ä–∏–µ–º –∑–∞–∫–∞–∑–æ–≤, —Ä–∞—Å—á–µ—Ç, –≤—ã–¥–∞—á–∞, –æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.'
            },
            {
                id: 6,
                title: '–†–∞–∑–Ω–æ—Ä–∞–±–æ—á–∏–π (–±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π)',
                company: '–ì–æ—Ä–æ–¥—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–Ω—è—Ç–æ—Å—Ç–∏',
                city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
                salary: 14000,
                type: '–ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å, –≤—Ä–µ–º–µ–Ω–Ω–∞—è',
                description: '–£–±–æ—Ä–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π –≤ –ø–∞—Ä–∫–∞—Ö. –†–∞–±–æ—Ç–∞ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ.'
            }
        ];

        // ==============================
        // ADMIN EXTENSION
        // Added second admin email alongside the original.
        // Original ADMIN_EMAIL const is preserved; new ADMIN_EMAILS array
        // is used by the updated isAdmin() function below.
        // ==============================
        const ADMIN_EMAIL = 'erorarun@gmail.com'; // original ‚Äî keep untouched

        // NEW: Array of all admin emails (original + second admin)
        const ADMIN_EMAILS = [
            'erorarun@gmail.com',
            'skurkomaksim833@gmail.com'
        ];

        const STATE = {
            jobs: [],
            filteredJobs: [],
            currentPage: 1,
            jobsPerPage: 6,
            currentUser: null,
            users: [],
            employerJobs: [],
            appliedJobs: [],
            currentChatId: null,
            chatUnsubscribe: null
        };
        window.STATE = STATE;
        window.renderJobs = renderJobs;

        const STORAGE = {
            USERS: 'teenwork_users',
            CURRENT_USER: 'teenwork_current_user',
            EMPLOYER_JOBS: 'teenwork_employer_jobs',
            APPLIED_JOBS: 'teenwork_applied_jobs'
        };

        const INFO_CONTENT = {
            'about': {
                title: '–û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ',
                body: `
                    <h3 style="margin-bottom: 16px;">–ö—Ç–æ –º—ã</h3>
                    <p style="margin-bottom: 16px; line-height: 1.7;">TeenWork ‚Äî –ø–µ—Ä–≤–∞—è –≤ –†–æ—Å—Å–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ–¥—Ä–æ—Å—Ç–∫–∞–º–∏ 14-18 –ª–µ—Ç. –ú—ã —Å–æ–∑–¥–∞–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å—Ä–µ–¥—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ç—Ä—É–¥–æ–≤–æ–≥–æ –æ–ø—ã—Ç–∞.</p>
                    <h3 style="margin-bottom: 16px;">–ù–∞—à–∞ –º–∏—Å—Å–∏—è</h3>
                    <p style="line-height: 1.7;">–ü–æ–º–æ—á—å –ø–æ–¥—Ä–æ—Å—Ç–∫–∞–º –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –≤ –ª–µ–≥–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö, —Ä–∞–∑–≤–∏—Ç—å –Ω–∞–≤—ã–∫–∏ –∏ —Å—Ç–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏.</p>
                `
            },
            'how-it-works': {
                title: '–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç',
                body: `
                    <h3 style="margin-bottom: 16px;">–î–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤</h3>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</strong><br>–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∑–∞ –ø–∞—Ä—É –º–∏–Ω—É—Ç</p>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>2. –ü–æ–∏—Å–∫</strong><br>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–¥—Ö–æ–¥—è—â–µ–π —Ä–∞–±–æ—Ç—ã</p>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>3. –û—Ç–∫–ª–∏–∫</strong><br>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—é</p>
                    <p style="line-height: 1.7;"><strong>4. –†–∞–±–æ—Ç–∞</strong><br>–ü–æ–ª—É—á–∏—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</p>
                `
            },
            'safety': {
                title: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å',
                body: `
                    <h3 style="margin-bottom: 16px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–π</h3>
                    <p style="margin-bottom: 16px; line-height: 1.7;">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º –≤–∞–∫–∞–Ω—Å–∏–π.</p>
                    <h3 style="margin-bottom: 16px;">–ü—Ä–∞–≤–∞ –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤</h3>
                    <p style="line-height: 1.7;">–ú—ã —Å–ª–µ–¥–∏–º –∑–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º —Ç—Ä—É–¥–æ–≤–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –†–§: —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å, –∑–∞–ø—Ä–µ—Ç –Ω–∞ –Ω–æ—á–Ω—ã–µ —Å–º–µ–Ω—ã, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Ç—Ä—É–¥–∞.</p>
                `
            },
            'employers': {
                title: '–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è–º',
                body: `
                    <h3 style="margin-bottom: 16px;">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–π</h3>
                    <p style="margin-bottom: 16px; line-height: 1.7;">–î–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–π—Ç–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏.</p>
                    <h3 style="margin-bottom: 16px;">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</h3>
                    <p style="line-height: 1.7;">–í–∞–∫–∞–Ω—Å–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –¢–ö –†–§ –¥–ª—è –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.</p>
                `
            },
            'support': {
                title: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞',
                body: `
                    <h3 style="margin-bottom: 16px;">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</h3>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>Email:</strong> support@teenwork.ru</p>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> +7 (495) 123-45-67</p>
                    <p style="line-height: 1.7;"><strong>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</strong> –ü–Ω-–ü—Ç, 9:00-18:00 (–ú–°–ö)</p>
                `
            },
            'legal': {
                title: '–ü—Ä–∞–≤–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
                body: `
                    <h3 style="margin-bottom: 16px;">–î–æ–∫—É–º–µ–Ω—Ç—ã</h3>
                    <p style="margin-bottom: 12px; line-height: 1.7;">‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</p>
                    <p style="margin-bottom: 12px; line-height: 1.7;">‚Ä¢ –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</p>
                    <p style="line-height: 1.7;">‚Ä¢ –£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</p>
                `
            }
        };

        // ADMIN EXTENSION: isAdmin() now checks ADMIN_EMAILS array
        // Both original admin and new second admin are granted access.
        function isAdmin() {
            return STATE.currentUser && ADMIN_EMAILS.includes(STATE.currentUser.email);
        }

        function initStorage() {
            try {
                const storedUsers = localStorage.getItem(STORAGE.USERS);
                const storedUser = localStorage.getItem(STORAGE.CURRENT_USER);
                const storedEmployerJobs = localStorage.getItem(STORAGE.EMPLOYER_JOBS);
                const storedAppliedJobs = localStorage.getItem(STORAGE.APPLIED_JOBS);

                if (storedUsers) {
                    STATE.users = JSON.parse(storedUsers);
                }

                if (storedUser) {
                    STATE.currentUser = JSON.parse(storedUser);
                }

                if (storedEmployerJobs) {
                    STATE.employerJobs = JSON.parse(storedEmployerJobs);
                }

                if (storedAppliedJobs) {
                    STATE.appliedJobs = JSON.parse(storedAppliedJobs);
                }
            } catch (e) {
                console.error('Storage error:', e);
                localStorage.removeItem(STORAGE.USERS);
                localStorage.removeItem(STORAGE.CURRENT_USER);
                localStorage.removeItem(STORAGE.EMPLOYER_JOBS);
                localStorage.removeItem(STORAGE.APPLIED_JOBS);
            }
        }

        function saveUsers() {
            localStorage.setItem(STORAGE.USERS, JSON.stringify(STATE.users));
        }

        function saveCurrentUser() {
            if (STATE.currentUser) {
                localStorage.setItem(STORAGE.CURRENT_USER, JSON.stringify(STATE.currentUser));
            } else {
                localStorage.removeItem(STORAGE.CURRENT_USER);
            }
        }

        function saveEmployerJobs() {
            localStorage.setItem(STORAGE.EMPLOYER_JOBS, JSON.stringify(STATE.employerJobs));
        }

        function saveAppliedJobs() {
            localStorage.setItem(STORAGE.APPLIED_JOBS, JSON.stringify(STATE.appliedJobs));
        }

        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function updateNavbar() {
            const navActions = document.getElementById('navActions');
            
            if (STATE.currentUser) {
                const initial = STATE.currentUser.nickname ? STATE.currentUser.nickname[0].toUpperCase() : 'U';
                const avatarContent = STATE.currentUser.avatar 
                    ? `<img src="${STATE.currentUser.avatar}" alt="Avatar">` 
                    : initial;
                
                let navHTML = '';
                
                if (isAdmin()) {
                    navHTML += `<div class="admin-panel-badge">ADMIN</div>`;
                }
                
                if (STATE.currentUser.role === 'employer') {
                    navHTML += `<button class="btn btn-primary" onclick="openModal('postJobModal')">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é</button>`;
                }
                
                navHTML += `
                    <div class="nav-profile-wrapper" onclick="openProfile()">
                        <div class="user-avatar">
                            ${avatarContent}
                        </div>
                        <span class="nav-profile-text">–ü—Ä–æ—Ñ–∏–ª—å</span>
                    </div>
                `;
                
                navActions.innerHTML = navHTML;
            } else {
                navActions.innerHTML = `
                    <button class="btn btn-secondary" onclick="handleProfileClick()">–ü—Ä–æ—Ñ–∏–ª—å</button>
                    <button class="btn btn-secondary" onclick="openModal('registerModal')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                `;
            }
        }

        function handleProfileClick() {
            if (!STATE.currentUser) {
                openModal('loginModal');
            } else {
                openProfile();
            }
        }

        function handleEmployerButtonClick() {
            if (!STATE.currentUser) {
                const registerRoleSelect = document.getElementById('registerRoleSelect');
                if (registerRoleSelect) {
                    registerRoleSelect.value = 'employer';
                }
                openModal('registerModal');
            } else if (STATE.currentUser.role === 'employer') {
                openModal('postJobModal');
            } else {
                openModal('workerNeedsChangeModal');
            }
        }

        function openRoleSelectorModal() {
            openModal('roleSelectorModal');
        }

        function openRoleSelectorModalFromWorker() {
            closeModal('workerNeedsChangeModal');
            openModal('roleSelectorModal');
        }

        function changeUserRole(newRole) {
            if (!STATE.currentUser) return;
            
            STATE.currentUser.role = newRole;
            
            const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
            if (userIndex !== -1) {
                STATE.users[userIndex] = STATE.currentUser;
            }
            
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            
            closeModal('roleSelectorModal');
            
            if (document.getElementById('profilePage').classList.contains('active')) {
                openProfile();
            }
            
            showToast('–£—Å–ø–µ—à–Ω–æ', '–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function openProfile() {
            if (!STATE.currentUser) {
                openModal('loginModal');
                return;
            }
            
            const initial = STATE.currentUser.nickname ? STATE.currentUser.nickname[0].toUpperCase() : 'U';
            const avatarDisplay = document.getElementById('profileAvatarDisplay');
            
            if (STATE.currentUser.avatar) {
                avatarDisplay.innerHTML = `<img src="${STATE.currentUser.avatar}" alt="Avatar">`;
            } else {
                avatarDisplay.textContent = initial;
            }
            
            document.getElementById('profileNickname').value = STATE.currentUser.nickname || '';
            document.getElementById('profileEmail').textContent = STATE.currentUser.email;
            document.getElementById('profileRole').textContent = STATE.currentUser.role === 'worker' ? '–°–æ–∏—Å–∫–∞—Ç–µ–ª—å' : '–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å';
            
            const date = new Date(STATE.currentUser.createdAt);
            document.getElementById('profileDate').textContent = date.toLocaleDateString('ru-RU');
            
            if (STATE.currentUser.role === 'worker') {
                document.getElementById('profileApplicationsSection').style.display = 'block';
                document.getElementById('profileEmployerSection').style.display = 'none';
                renderAppliedJobs();
            } else {
                document.getElementById('profileApplicationsSection').style.display = 'none';
                document.getElementById('profileEmployerSection').style.display = 'block';
                renderEmployerJobs();
            }
            
            document.getElementById('profilePage').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        async function renderAppliedJobs() {
            const container = document.getElementById('appliedJobsList');
            
            if (!window.db) {
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
                return;
            }

            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const applicationsRef = collection(window.db, 'applications');
                const q = query(applicationsRef, where('workerId', '==', STATE.currentUser.uid || STATE.currentUser.email));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">–í—ã –ø–æ–∫–∞ –Ω–µ –æ—Ç–∫–ª–∏–∫–∞–ª–∏—Å—å –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏</p>';
                    return;
                }

                let html = '';
                for (const docSnap of snapshot.docs) {
                    const app = docSnap.data();
                    const job = STATE.jobs.find(j => j.id === app.jobId);
                    if (job) {
                        html += `
                            <div class="applied-job-item">
                                <div>
                                    <div class="applied-job-title">${job.title}</div>
                                    <div class="applied-job-company">${job.company}</div>
                                </div>
                                <button class="btn btn-small btn-primary" onclick="openChatFromWorker('${app.jobId}', '${app.employerId}')">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
                            </div>
                        `;
                    }
                }

                container.innerHTML = html || '<p style="color: var(--text-gray); text-align: center; padding: 20px;">–ù–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤</p>';
            } catch (error) {
                console.error('Error loading applications:', error);
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        async function renderEmployerJobs() {
            const container = document.getElementById('employerJobsList');
            const userJobs = STATE.jobs.filter(job => job.employerEmail === STATE.currentUser.email || job.employerId === (STATE.currentUser.uid || STATE.currentUser.email));
            
            if (userJobs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">–í—ã –µ—â–µ –Ω–µ —Ä–∞–∑–º–µ—Å—Ç–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏</p>';
                return;
            }

            let html = '';
            for (const job of userJobs) {
                let appCount = 0;
                let viewCount = job.views || 0;

                if (window.db) {
                    try {
                        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                        const appsRef = collection(window.db, 'applications');
                        const q = query(appsRef, where('jobId', '==', job.id));
                        const snapshot = await getDocs(q);
                        appCount = snapshot.size;
                    } catch (e) {
                        console.error('Error counting applications:', e);
                    }
                }

                html += `
                    <div class="applied-job-item">
                        <div style="flex: 1;">
                            <div class="applied-job-title">${job.title}</div>
                            <div class="applied-job-company">${job.company} ‚Ä¢ ${job.salary.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="job-stats">
                                üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: ${viewCount} | üì© –û—Ç–∫–ª–∏–∫–æ–≤: ${appCount}
                            </div>
                        </div>
                        <button class="btn btn-small btn-primary" onclick="showApplications('${job.id}')">–û—Ç–∫–ª–∏–∫–∏</button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function showApplications(jobId) {
            if (!window.db) {
                showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                return;
            }

            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;

            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const applicationsRef = collection(window.db, 'applications');
                const q = query(applicationsRef, where('jobId', '==', jobId));
                const snapshot = await getDocs(q);

                const modalBody = document.getElementById('applicationsModalBody');

                if (snapshot.empty) {
                    modalBody.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">–ù–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤ –Ω–∞ —ç—Ç—É –≤–∞–∫–∞–Ω—Å–∏—é</p>';
                } else {
                    let html = '<div class="applied-jobs-list">';
                    snapshot.forEach(docSnap => {
                        const app = docSnap.data();
                        html += `
                            <div class="application-list-item">
                                <div class="application-worker-name">${app.workerNickname || '–°–æ–∏—Å–∫–∞—Ç–µ–ª—å'}</div>
                                <div class="application-worker-email">${app.workerEmail}</div>
                                ${app.message ? `<div style="margin-top: 8px; color: var(--text-gray); font-size: 14px;">${app.message}</div>` : ''}
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-small btn-primary" onclick="openChatFromEmployer('${jobId}', '${app.workerId}')">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    modalBody.innerHTML = html;
                }

                openModal('applicationsModal');
            } catch (error) {
                console.error('Error loading applications:', error);
                showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∫–ª–∏–∫–∏', 'error');
            }
        }

        async function openChatFromWorker(jobId, employerId) {
            openChat(jobId, employerId, STATE.currentUser.uid || STATE.currentUser.email);
        }

        async function openChatFromEmployer(jobId, workerId) {
            openChat(jobId, STATE.currentUser.uid || STATE.currentUser.email, workerId);
        }

        async function openChat(jobId, employerId, workerId) {
            if (!window.db) {
                showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                return;
            }

            try {
                const { collection, query, where, getDocs, addDoc, onSnapshot, orderBy } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                
                if (STATE.chatUnsubscribe) {
                    STATE.chatUnsubscribe();
                    STATE.chatUnsubscribe = null;
                }

                const chatsRef = collection(window.db, 'chats');
                const q = query(chatsRef, 
                    where('jobId', '==', jobId),
                    where('employerId', '==', employerId),
                    where('workerId', '==', workerId)
                );
                const snapshot = await getDocs(q);

                let chatId;
                if (snapshot.empty) {
                    const newChat = await addDoc(chatsRef, {
                        jobId: jobId,
                        employerId: employerId,
                        workerId: workerId,
                        createdAt: Date.now()
                    });
                    chatId = newChat.id;
                } else {
                    chatId = snapshot.docs[0].id;
                }

                if (!chatId) {
                    showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç', 'error');
                    return;
                }

                STATE.currentChatId = chatId;

                const job = STATE.jobs.find(j => j.id === jobId);
                document.getElementById('chatModalTitle').textContent = `–ß–∞—Ç: ${job ? job.title : '–í–∞–∫–∞–Ω—Å–∏—è'}`;

                const messagesRef = collection(window.db, 'messages');
                const messagesQuery = query(messagesRef, 
                    where('chatId', '==', chatId),
                    orderBy('createdAt', 'asc')
                );

                // CHAT UI ENHANCEMENT: Extended onSnapshot rendering to support image/audio messages.
                // Original text message logic is fully preserved; new branches handle imageUrl/audioUrl.
                STATE.chatUnsubscribe = onSnapshot(messagesQuery, (messagesSnapshot) => {
                    const container = document.getElementById('chatMessages');
                    if (!container) return;

                    let html = '';
                    
                    messagesSnapshot.forEach(docSnap => {
                        const msg = docSnap.data();
                        const isSent = msg.senderId === (STATE.currentUser.uid || STATE.currentUser.email);
                        const alignClass = isSent ? 'sent' : 'received';

                        // IMAGE MESSAGE LOGIC: render image if imageUrl present
                        if (msg.imageUrl) {
                            html += `
                                <div class="chat-message ${alignClass}">
                                    <img
                                        class="chat-message-image"
                                        src="${msg.imageUrl}"
                                        alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                                        onclick="window.open('${msg.imageUrl}', '_blank')"
                                    />
                                </div>`;
                        }
                        // VOICE MESSAGE LOGIC: render audio player if audioUrl present
                        else if (msg.audioUrl) {
                            html += `
                                <div class="chat-message ${alignClass}">
                                    üéôÔ∏è
                                    <audio
                                        class="chat-message-audio"
                                        controls
                                        src="${msg.audioUrl}"
                                        preload="metadata"
                                    ></audio>
                                </div>`;
                        }
                        // Original text message logic ‚Äî unchanged
                        else {
                            html += `<div class="chat-message ${alignClass}">${msg.text}</div>`;
                        }
                    });

                    container.innerHTML = html || '<p style="color: var(--text-gray); text-align: center;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
                    container.scrollTop = container.scrollHeight;
                }, (error) => {
                    console.error('Error in chat listener:', error);
                });

                openModal('chatModal');
            } catch (error) {
                console.error('Error opening chat:', error);
                showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç', 'error');
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();

            if (!text || !STATE.currentChatId || !window.db) return;

            try {
                const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const messagesRef = collection(window.db, 'messages');
                
                await addDoc(messagesRef, {
                    chatId: STATE.currentChatId,
                    senderId: STATE.currentUser.uid || STATE.currentUser.email,
                    text: text,
                    createdAt: Date.now()
                });

                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
            }
        }

        function closeProfile() {
            document.getElementById('profilePage').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function logout() {
            if (STATE.chatUnsubscribe) {
                STATE.chatUnsubscribe();
                STATE.chatUnsubscribe = null;
            }
            STATE.currentUser = null;
            saveCurrentUser();
            updateNavbar();
            closeProfile();
            showToast('–î–æ –≤—Å—Ç—Ä–µ—á–∏!', '–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'success');
        }

        function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');

            const user = STATE.users.find(u => u.email === email);
            
            if (!user || user.password !== password) {
                const formGroup = e.target.querySelector('input[name="password"]').closest('.form-group');
                formGroup.classList.add('error');
                return;
            }

            STATE.currentUser = user;
            saveCurrentUser();
            updateNavbar();
            closeModal('loginModal');
            showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', '–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'success');
        }

        function handleRegister(e) {
            e.preventDefault();
            
            if (!validateForm(e.target)) {
                showToast('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'error');
                return;
            }

            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const nickname = formData.get('nickname');
            const role = formData.get('role');

            if (STATE.users.find(u => u.email === email)) {
                showToast('–û—à–∏–±–∫–∞', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
                return;
            }

            if (password.length < 6) {
                const formGroup = e.target.querySelector('input[name="password"]').closest('.form-group');
                formGroup.classList.add('error');
                return;
            }

            if (!role) {
                const formGroup = e.target.querySelector('select[name="role"]').closest('.form-group');
                formGroup.classList.add('error');
                return;
            }

            const newUser = {
                email,
                password,
                nickname,
                role,
                avatar: null,
                createdAt: Date.now(),
                uid: email
            };

            STATE.users.push(newUser);
            STATE.currentUser = newUser;
            
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            closeModal('registerModal');
            showToast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TeenWork', 'success');
        }

        function handleProfileUpdate(e) {
            e.preventDefault();
            
            const nickname = document.getElementById('profileNickname').value;
            
            if (!nickname) {
                showToast('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º', 'error');
                return;
            }

            STATE.currentUser.nickname = nickname;
            
            const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
            if (userIndex !== -1) {
                STATE.users[userIndex] = STATE.currentUser;
            }
            
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            showToast('–£—Å–ø–µ—à–Ω–æ', '–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        }

        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                STATE.currentUser.avatar = event.target.result;
                
                const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
                if (userIndex !== -1) {
                    STATE.users[userIndex] = STATE.currentUser;
                }
                
                saveUsers();
                saveCurrentUser();
                
                document.getElementById('profileAvatarDisplay').innerHTML = `<img src="${event.target.result}" alt="Avatar">`;
                updateNavbar();
                showToast('–£—Å–ø–µ—à–Ω–æ', '–§–æ—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            };
            reader.readAsDataURL(file);
        }

        async function handlePostJob(e) {
            e.preventDefault();

            if (!validateForm(e.target)) {
                showToast('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'error');
                return;
            }

            const formData = new FormData(e.target);

            const newJob = {
                title: formData.get('title'),
                company: formData.get('company'),
                city: formData.get('city'),
                salary: parseInt(formData.get('salary')),
                type: formData.get('type'),
                description: formData.get('description'),
                employerEmail: STATE.currentUser.email,
                employerId: STATE.currentUser.uid || STATE.currentUser.email,
                isTop: false,
                views: 0,
                createdAt: Date.now()
            };

            try {
                if (window.db && window.addDoc && window.collection) {
                    await window.addDoc(window.collection(window.db, "jobs"), newJob);
                }
            } catch (error) {
                console.error('Firestore error:', error);
            }

            closeModal('postJobModal');
            showToast('–£—Å–ø–µ—à–Ω–æ', '–í–∞–∫–∞–Ω—Å–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∞', 'success');

            if (window.loadJobsFromFirestore) {
                await window.loadJobsFromFirestore();
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cityFilter = document.getElementById('cityFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const salaryFilter = document.getElementById('salaryFilter').value;
            
            STATE.filteredJobs = STATE.jobs.filter(job => {
                const matchesSearch = !searchTerm || 
                    job.title.toLowerCase().includes(searchTerm) || 
                    job.company.toLowerCase().includes(searchTerm);
                
                const matchesCity = !cityFilter || job.city === cityFilter;
                const matchesType = !typeFilter || job.type.includes(typeFilter);
                
                let matchesSalary = true;
                if (salaryFilter) {
                    const [min, max] = salaryFilter.split('-').map(v => parseInt(v) || Infinity);
                    matchesSalary = job.salary >= min && (max === Infinity || job.salary <= max);
                }
                
                return matchesSearch && matchesCity && matchesType && matchesSalary;
            });

            applySorting();
            STATE.currentPage = 1;
            renderJobs();
        }

        function applySorting() {
            const sortValue = document.getElementById('sortFilter').value;
            
            STATE.filteredJobs.sort((a, b) => {
                if (a.isTop && !b.isTop) return -1;
                if (!a.isTop && b.isTop) return 1;
                
                if (sortValue === 'salary-desc') return b.salary - a.salary;
                if (sortValue === 'salary-asc') return a.salary - b.salary;
                return 0;
            });
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('cityFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('sortFilter').value = 'salary-desc';
            
            STATE.filteredJobs = [...STATE.jobs];
            applySorting();
            STATE.currentPage = 1;
            renderJobs();
        }

        function renderJobs() {
            const grid = document.getElementById('jobsGrid');
            const jobCount = document.getElementById('jobCount');
            
            jobCount.textContent = `–ù–∞–π–¥–µ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: ${STATE.filteredJobs.length}`;
            
            if (STATE.filteredJobs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>–í–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                    </div>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            const startIndex = (STATE.currentPage - 1) * STATE.jobsPerPage;
            const endIndex = startIndex + STATE.jobsPerPage;
            const jobsToRender = STATE.filteredJobs.slice(startIndex, endIndex);
            
            grid.innerHTML = jobsToRender.map(job => {
                const adminBadge = job.isTop ? '<div class="admin-badge">TOP</div>' : '';
                const adminControls = isAdmin() ? `
                    <div class="admin-controls">
                        <button class="btn btn-admin btn-danger" onclick="deleteJob('${job.id}', event)">–£–¥–∞–ª–∏—Ç—å</button>
                        <button class="btn btn-admin btn-warning" onclick="toggleTopJob('${job.id}', event)">
                            ${job.isTop ? '–°–Ω—è—Ç—å TOP' : '–°–¥–µ–ª–∞—Ç—å TOP'}
                        </button>
                    </div>
                ` : '';
                
                return `
                    <div class="job-card" onclick="openApplyModal('${job.id}')">
                        ${adminBadge}
                        <div class="job-header">
                            <div class="job-title">${job.title}</div>
                            <div class="job-company">${job.company}</div>
                            <div class="job-location">üìç ${job.city}</div>
                        </div>
                        <div class="job-details">
                            <div class="job-salary">${job.salary.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="job-tags">
                                <span class="tag">${job.type}</span>
                            </div>
                        </div>
                        <div class="job-footer">
                            <button class="btn btn-primary btn-apply" onclick="openApplyModal('${job.id}', event)">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button>
                        </div>
                        ${adminControls}
                    </div>
                `;
            }).join('');

            renderPagination();
        }

        async function deleteJob(jobId, event) {
            if (event) event.stopPropagation();
            
            if (!isAdmin()) {
                showToast('–û—à–∏–±–∫–∞', '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏', 'error');
                return;
            }
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –≤–∞–∫–∞–Ω—Å–∏—é?')) {
                return;
            }
            
            try {
                if (window.db) {
                    const { deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    await deleteDoc(doc(window.db, "jobs", jobId));
                }
                
                showToast('–£—Å–ø–µ—à–Ω–æ', '–í–∞–∫–∞–Ω—Å–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
                
                if (window.loadJobsFromFirestore) {
                    await window.loadJobsFromFirestore();
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é', 'error');
            }
        }

        async function toggleTopJob(jobId, event) {
            if (event) event.stopPropagation();
            
            if (!isAdmin()) {
                showToast('–û—à–∏–±–∫–∞', '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å TOP-–≤–∞–∫–∞–Ω—Å–∏—è–º–∏', 'error');
                return;
            }
            
            try {
                const job = STATE.jobs.find(j => j.id === jobId);
                if (!job) return;
                
                if (window.db) {
                    const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    await updateDoc(doc(window.db, "jobs", jobId), {
                        isTop: !job.isTop
                    });
                }
                
                showToast('–£—Å–ø–µ—à–Ω–æ', job.isTop ? 'TOP —Å–Ω—è—Ç' : '–í–∞–∫–∞–Ω—Å–∏—è –≤ TOP', 'success');
                
                if (window.loadJobsFromFirestore) {
                    await window.loadJobsFromFirestore();
                }
            } catch (error) {
                console.error('Toggle TOP error:', error);
                showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å', 'error');
            }
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(STATE.filteredJobs.length / STATE.jobsPerPage);

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `
                <button class="pagination-btn" onclick="changePage(${STATE.currentPage - 1})" ${STATE.currentPage === 1 ? 'disabled' : ''}>
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= STATE.currentPage - 1 && i <= STATE.currentPage + 1)) {
                    html += `
                        <button class="pagination-btn ${i === STATE.currentPage ? 'active' : ''}" onclick="changePage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === STATE.currentPage - 2 || i === STATE.currentPage + 2) {
                    html += `<span style="padding: 8px;">...</span>`;
                }
            }

            html += `
                <button class="pagination-btn" onclick="changePage(${STATE.currentPage + 1})" ${STATE.currentPage === totalPages ? 'disabled' : ''}>
                    –í–ø–µ—Ä—ë–¥ ‚Üí
                </button>
            `;

            pagination.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(STATE.filteredJobs.length / STATE.jobsPerPage);
            if (page < 1 || page > totalPages) return;
            
            STATE.currentPage = page;
            renderJobs();
            scrollToSearch();
        }

        function openModal(modalId, contentKey) {
            const modal = document.getElementById(modalId);
            
            if (modalId === 'infoModal' && contentKey) {
                const content = INFO_CONTENT[contentKey];
                if (content) {
                    document.getElementById('infoModalTitle').textContent = content.title;
                    document.getElementById('infoModalBody').innerHTML = content.body;
                }
            }
            
            modal.classList.remove('hiding');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hiding');
            
            if (modalId === 'chatModal' && STATE.chatUnsubscribe) {
                STATE.chatUnsubscribe();
                STATE.chatUnsubscribe = null;
                STATE.currentChatId = null;
            }
            
            setTimeout(() => {
                modal.classList.remove('active', 'hiding');
                document.body.style.overflow = 'auto';
                
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    clearFormErrors(form);
                }
            }, 300);
        }

        function clearFormErrors(form) {
            form.querySelectorAll('.form-group').forEach(group => {
                group.classList.remove('error');
            });
        }

        function validateForm(form) {
            let isValid = true;
            clearFormErrors(form);

            form.querySelectorAll('[required]').forEach(field => {
                const formGroup = field.closest('.form-group');
                
                if (!field.value.trim()) {
                    formGroup.classList.add('error');
                    isValid = false;
                } else if (field.type === 'email' && !field.validity.valid) {
                    formGroup.classList.add('error');
                    isValid = false;
                } else if (field.type === 'password' && field.value.length < 6) {
                    formGroup.classList.add('error');
                    isValid = false;
                } else if (field.tagName === 'SELECT' && !field.value) {
                    formGroup.classList.add('error');
                    isValid = false;
                }
            });

            return isValid;
        }

        async function openApplyModal(jobId, event) {
            if (event) event.stopPropagation();
            
            if (!STATE.currentUser) {
                showToast('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', '–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –æ—Ç–∫–ª–∏–∫–∞', 'warning');
                openModal('loginModal');
                return;
            }
            
            if (STATE.currentUser.role === 'employer') {
                showToast('–í–Ω–∏–º–∞–Ω–∏–µ', '–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –æ—Ç–∫–ª–∏–∫–∞—Ç—å—Å—è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏', 'warning');
                return;
            }
            
            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;

            if (window.db) {
                try {
                    const { updateDoc, doc, increment, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    const jobRef = doc(window.db, "jobs", jobId);
                    const jobSnap = await getDoc(jobRef);
                    
                    if (jobSnap.exists()) {
                        const jobData = jobSnap.data();
                        if (typeof jobData.views === 'number') {
                            await updateDoc(jobRef, {
                                views: increment(1)
                            });
                        } else {
                            await updateDoc(jobRef, {
                                views: 1
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error incrementing views:', error);
                }
            }

            let alreadyApplied = false;
            if (window.db) {
                try {
                    const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    const appsRef = collection(window.db, 'applications');
                    const q = query(appsRef, 
                        where('jobId', '==', jobId),
                        where('workerId', '==', STATE.currentUser.uid || STATE.currentUser.email)
                    );
                    const snapshot = await getDocs(q);
                    alreadyApplied = !snapshot.empty;
                } catch (error) {
                    console.error('Error checking application:', error);
                }
            }
            
            const modalBody = document.getElementById('applyModalBody');
            modalBody.innerHTML = `
                <div style="margin-bottom: 28px;">
                    <h3 style="margin-bottom: 10px; font-weight: 700; font-size: 22px;">${job.title}</h3>
                    <p style="color: var(--text-gray); margin-bottom: 20px; font-weight: 600;">${job.company} ‚Ä¢ ${job.city}</p>
                    <div style="background: var(--light-gray); padding: 18px; border-radius: var(--radius-md); margin-bottom: 20px;">
                        <strong>–ó–∞—Ä–ø–ª–∞—Ç–∞:</strong> ${job.salary.toLocaleString('ru-RU')} ‚ÇΩ<br>
                        <strong>–¢–∏–ø:</strong> ${job.type}
                    </div>
                    <p style="line-height: 1.7; color: var(--text-gray); font-weight: 500;">${job.description}</p>
                </div>
                <div style="text-align: center; padding: 20px;">
                    ${alreadyApplied 
                        ? '<p style="margin-bottom: 16px; color: var(--success); font-weight: 600;">–í—ã —É–∂–µ –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å –Ω–∞ —ç—Ç—É –≤–∞–∫–∞–Ω—Å–∏—é</p>'
                        : `
                            <textarea id="applicationMessage" class="input" placeholder="–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width: 100%; margin-bottom: 12px; min-height: 80px;"></textarea>
                            <button class="btn btn-primary" onclick="applyToJob('${jobId}')" style="margin-bottom: 12px;">–û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è</button>
                        `
                    }
                    <button class="btn btn-secondary" onclick="closeModal('applyModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            
            openModal('applyModal');
        }

        async function applyToJob(jobId) {
            if (!window.db) {
                showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                return;
            }

            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;

            const message = document.getElementById('applicationMessage')?.value || '';

            try {
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const applicationsRef = collection(window.db, 'applications');

                await addDoc(applicationsRef, {
                    jobId: jobId,
                    workerId: STATE.currentUser.uid || STATE.currentUser.email,
                    employerId: job.employerId || job.employerEmail,
                    workerEmail: STATE.currentUser.email,
                    workerNickname: STATE.currentUser.nickname || '–°–æ–∏—Å–∫–∞—Ç–µ–ª—å',
                    message: message,
                    createdAt: Date.now(),
                    status: 'new'
                });

                closeModal('applyModal');
                showToast('–£—Å–ø–µ—à–Ω–æ', '–í—ã –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é', 'success');
            } catch (error) {
                console.error('Error applying to job:', error);
                showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è', 'error');
            }
        }

        function toggleFaq(element) {
            const faqItem = element.parentElement;
            const answer = faqItem.querySelector('.faq-answer');
            const answerContent = answer.querySelector('.faq-answer-content');
            
            const isActive = faqItem.classList.contains('active');
            
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('.faq-answer').style.maxHeight = '0px';
            });
            
            if (!isActive) {
                faqItem.classList.add('active');
                answer.style.maxHeight = answerContent.scrollHeight + 'px';
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToSearch() {
            document.getElementById('search').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function initEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', () => {
                applySorting();
                STATE.currentPage = 1;
                renderJobs();
            });

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('avatarUpload').addEventListener('change', handleAvatarUpload);
            document.getElementById('postJobForm').addEventListener('submit', handlePostJob);

            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // IMAGE MESSAGE LOGIC: bind file input change to upload handler
            document.getElementById('chatImageInput').addEventListener('change', handleChatImageSelected);

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });

            window.addEventListener('scroll', () => {
                const navbar = document.getElementById('navbar');
                const currentScroll = window.pageYOffset;
                
                if (currentScroll > 50) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) {
                        closeModal(activeModal.id);
                    }
                    
                    const profilePage = document.getElementById('profilePage');
                    if (profilePage.classList.contains('active')) {
                        closeProfile();
                    }
                }
            });
        }

        function init() {
            initStorage();
            updateNavbar();
            initEventListeners();
        }

        document.addEventListener('DOMContentLoaded', init);

        // ==============================
        // STORAGE EXTENSION
        // Firebase Storage SDK loaded dynamically when needed.
        // getStorage, ref, uploadBytes, getDownloadURL imported on demand.
        // Does NOT modify Firebase config block.
        // ==============================

        /**
         * IMAGE MESSAGE LOGIC
         * Triggered when user clicks the image button in chat toolbar.
         * Opens the hidden file input.
         */
        function triggerChatImageUpload() {
            if (!STATE.currentChatId) {
                showToast('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç', 'error');
                return;
            }
            document.getElementById('chatImageInput').click();
        }

        /**
         * IMAGE MESSAGE LOGIC
         * Handles selected image file ‚Üí uploads to Firebase Storage ‚Üí saves imageUrl to Firestore messages.
         */
        async function handleChatImageSelected(e) {
            const file = e.target.files[0];
            // Reset input so same file can be re-selected
            e.target.value = '';

            if (!file || !STATE.currentChatId || !window.db) return;

            // Only allow image files
            if (!file.type.startsWith('image/')) {
                showToast('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                return;
            }

            // Max 5 MB check
            if (file.size > 5 * 1024 * 1024) {
                showToast('–û—à–∏–±–∫–∞', '–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë', 'error');
                return;
            }

            const indicator = document.getElementById('chatUploadIndicator');
            if (indicator) indicator.classList.add('visible');

            try {
                // Dynamically import Firebase Storage SDK (does not touch config)
                const { getStorage, ref, uploadBytes, getDownloadURL } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js');
                const storage = getStorage();

                // Upload to a unique path inside chat-images/
                const filePath = `chat-images/${STATE.currentChatId}/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, filePath);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // Save imageUrl message to Firestore (messages collection ‚Äî unchanged)
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const messagesRef = collection(window.db, 'messages');
                await addDoc(messagesRef, {
                    chatId: STATE.currentChatId,
                    senderId: STATE.currentUser.uid || STATE.currentUser.email,
                    imageUrl: downloadURL, // NEW field ‚Äî onSnapshot renders <img>
                    text: '',              // kept for schema consistency
                    createdAt: Date.now()
                });

            } catch (error) {
                console.error('Image upload error:', error);
                showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
            } finally {
                if (indicator) indicator.classList.remove('visible');
            }
        }

        // ==============================
        // VOICE MESSAGE LOGIC
        // MediaRecorder API records audio in the browser.
        // Recorded blob uploaded to Firebase Storage as audio/webm.
        // audioUrl saved to Firestore messages ‚Üí onSnapshot renders <audio controls>.
        // ==============================

        // State for voice recording (isolated, does not affect existing STATE)
        const VOICE_STATE = {
            mediaRecorder: null,
            audioChunks: [],
            isRecording: false,
            stream: null
        };

        /**
         * VOICE MESSAGE LOGIC
         * Toggle recording on/off when user clicks the microphone button.
         */
        async function toggleVoiceRecording() {
            if (!STATE.currentChatId) {
                showToast('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç', 'error');
                return;
            }

            if (VOICE_STATE.isRecording) {
                // Stop recording
                VOICE_STATE.mediaRecorder.stop();
            } else {
                // Start recording
                try {
                    VOICE_STATE.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    VOICE_STATE.audioChunks = [];
                    VOICE_STATE.mediaRecorder = new MediaRecorder(VOICE_STATE.stream);

                    VOICE_STATE.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            VOICE_STATE.audioChunks.push(event.data);
                        }
                    };

                    VOICE_STATE.mediaRecorder.onstop = handleVoiceRecordingStop;

                    VOICE_STATE.mediaRecorder.start();
                    VOICE_STATE.isRecording = true;

                    // Visual feedback: button turns red/pulsing
                    const btn = document.getElementById('voiceRecordBtn');
                    if (btn) {
                        btn.classList.add('recording');
                        btn.textContent = '‚èπÔ∏è';
                        btn.title = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
                    }

                } catch (err) {
                    console.error('Microphone error:', err);
                    showToast('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
                }
            }
        }

        /**
         * VOICE MESSAGE LOGIC
         * Called when recording stops. Uploads audio blob to Firebase Storage,
         * then saves audioUrl to Firestore messages.
         */
        async function handleVoiceRecordingStop() {
            VOICE_STATE.isRecording = false;

            // Reset button appearance
            const btn = document.getElementById('voiceRecordBtn');
            if (btn) {
                btn.classList.remove('recording');
                btn.textContent = 'üéôÔ∏è';
                btn.title = '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
            }

            // Stop all microphone tracks to release the device
            if (VOICE_STATE.stream) {
                VOICE_STATE.stream.getTracks().forEach(track => track.stop());
                VOICE_STATE.stream = null;
            }

            if (VOICE_STATE.audioChunks.length === 0) return;

            const audioBlob = new Blob(VOICE_STATE.audioChunks, { type: 'audio/webm' });

            // Minimum duration guard (< 0.5 KB is likely empty)
            if (audioBlob.size < 512) {
                showToast('–í–Ω–∏–º–∞–Ω–∏–µ', '–ó–∞–ø–∏—Å—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è', 'warning');
                return;
            }

            const indicator = document.getElementById('chatUploadIndicator');
            if (indicator) indicator.classList.add('visible');

            try {
                // Dynamically import Firebase Storage SDK
                const { getStorage, ref, uploadBytes, getDownloadURL } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js');
                const storage = getStorage();

                const filePath = `chat-audio/${STATE.currentChatId}/${Date.now()}.webm`;
                const storageRef = ref(storage, filePath);
                await uploadBytes(storageRef, audioBlob);
                const downloadURL = await getDownloadURL(storageRef);

                // Save audioUrl message to Firestore (messages collection ‚Äî unchanged)
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const messagesRef = collection(window.db, 'messages');
                await addDoc(messagesRef, {
                    chatId: STATE.currentChatId,
                    senderId: STATE.currentUser.uid || STATE.currentUser.email,
                    audioUrl: downloadURL, // NEW field ‚Äî onSnapshot renders <audio controls>
                    text: '',              // kept for schema consistency
                    createdAt: Date.now()
                });

            } catch (error) {
                console.error('Audio upload error:', error);
                showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
            } finally {
                if (indicator) indicator.classList.remove('visible');
            }
        }
    </script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC9l-LPIJl_51GC8FgdApYccycQjA7rNps",
    authDomain: "teenwork-app-afaa6.firebaseapp.com",
    projectId: "teenwork-app-afaa6",
    storageBucket: "teenwork-app-afaa6.firebasestorage.app",
    messagingSenderId: "657977585927",
    appId: "1:657977585927:web:190719f2acf432fdaf15a2",
    measurementId: "G-XWR4S2ZRN7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.addDoc = addDoc;
  window.collection = collection;
  window.deleteDoc = deleteDoc;
  window.doc = doc;
  window.updateDoc = updateDoc;

  const jobsCollection = collection(db, "jobs");

  async function uploadInitialJobs() {
    const snapshot = await getDocs(jobsCollection);

    if (!snapshot.empty) {
      console.log("–í–∞–∫–∞–Ω—Å–∏–∏ —É–∂–µ –µ—Å—Ç—å –≤ Firestore");
      return;
    }

    const initialJobs = [
      {
        title: "–ü—Ä–æ–º–æ—É—Ç–µ—Ä –≤–æ–¥–Ω—ã—Ö —ç–∫—Å–∫—É—Ä—Å–∏–π",
        company: "–ù–µ–≤–∞ –¢—Ä–µ–≤–µ–ª",
        city: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
        salary: 30000,
        type: "–°–µ–∑–æ–Ω–Ω–∞—è",
        description: "–†–∞–±–æ—Ç–∞ –≤ –≤–µ—Å–µ–Ω–Ω–µ-–ª–µ—Ç–Ω–∏–π –ø–µ—Ä–∏–æ–¥.",
        isTop: false,
        views: 0,
        createdAt: Date.now()
      },
      {
        title: "–ö–∞—Å—Å–∏—Ä",
        company: "–î–æ–¥–æ –ü–∏—Ü—Ü–∞",
        city: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
        salary: 35000,
        type: "–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è",
        description: "–†–∞–±–æ—Ç–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è.",
        isTop: false,
        views: 0,
        createdAt: Date.now()
      }
    ];

    for (let job of initialJobs) {
      await addDoc(jobsCollection, job);
    }

    console.log("–í–∞–∫–∞–Ω—Å–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ Firestore");
  }

  async function loadJobsFromFirestore() {
    const snapshot = await getDocs(collection(db, "jobs"));
    const jobs = [];

    snapshot.forEach(docSnap => {
      jobs.push({
        id: docSnap.id,
        ...docSnap.data()
      });
    });

    if (window.STATE) {
      window.STATE.jobs = jobs;
      window.STATE.filteredJobs = [...jobs];
      window.STATE.currentPage = 1;

      if (window.renderJobs) {
        window.renderJobs();
      }
    }

    console.log("–í–∞–∫–∞–Ω—Å–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firestore:", jobs.length);
  }

  window.loadJobsFromFirestore = loadJobsFromFirestore;
  
  uploadInitialJobs();
  loadJobsFromFirestore();
</script>

<!-- ================= SAFE PRESENCE EXTENSION ================= -->
<!-- Task 1: Real online status using Firestore users collection.
     isOnline (boolean) + lastSeen (timestamp).
     Set online on page load / login / register.
     Set offline on beforeunload / visibilitychange hidden / logout.
     Chat header shows animated green pulse or "–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏: –≤—Ä–µ–º—è".
     Admin emails remain 100% untouched.
-->
<style>
/* ================= SAFE PRESENCE EXTENSION ‚Äî CSS ================= */

/* Presence bar injected above chat-messages */
.chat-presence-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px 9px 20px;
    border-bottom: 1px solid var(--border-gray);
    background: linear-gradient(90deg, rgba(239,246,255,0.9) 0%, rgba(255,255,255,0) 100%);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-gray);
    min-height: 38px;
    transition: all 0.3s ease;
    animation: presenceBarFade 0.4s ease backwards;
}

@keyframes presenceBarFade {
    from { opacity: 0; transform: translateY(-5px); }
    to   { opacity: 1; transform: translateY(0); }
}

.presence-dot-online {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: var(--success);
    flex-shrink: 0;
    animation: presencePulse 2s ease-in-out infinite;
}

@keyframes presencePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.55); }
    50%       { box-shadow: 0 0 0 7px rgba(16,185,129,0); }
}

.presence-dot-offline {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background: #94a3b8;
    flex-shrink: 0;
}

.presence-text-online {
    color: var(--success);
    font-weight: 700;
    font-size: 13px;
}

.presence-text-offline {
    color: var(--text-gray);
    font-size: 12px;
    font-weight: 500;
    opacity: 0.85;
}

/* Chat modal enhancements for presence bar */
#chatModal .modal-body {
    padding: 0 0 20px 0;
}

#chatModal .chat-messages {
    max-height: 460px;
    margin: 0;
    border-radius: 0;
    border-left: none;
    border-right: none;
    border-top: none;
}

#chatModal .chat-input-container {
    margin: 16px 20px 0 20px;
}

#chatModal .modal-header {
    border-bottom: 2px solid var(--border-gray);
    padding: 18px 24px;
}

#chatModal .modal-header h3 {
    font-size: 18px;
    letter-spacing: -0.3px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 420px;
}

/* Send button disabled state */
#chatSendBtn:disabled {
    opacity: 0.42;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}
</style>

<script>
// ================= SAFE PRESENCE EXTENSION ‚Äî JS =================

const _PRESENCE_POLL_MS = 400;
const _PRESENCE_TIMEOUT = 12000;

// Wait until window.db is available, then run callback
function _presenceWhenDbReady(cb) {
    const start = Date.now();
    const t = setInterval(() => {
        if (window.db) { clearInterval(t); cb(); }
        else if (Date.now() - start > _PRESENCE_TIMEOUT) clearInterval(t);
    }, _PRESENCE_POLL_MS);
}

// Format lastSeen timestamp ‚Üí Russian human-readable string
function _formatLastSeen(ts) {
    if (!ts) return '';
    const now = new Date();
    const d = new Date(ts);
    const pad = n => String(n).padStart(2, '0');
    const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const yest  = today - 86400000;
    const msgD  = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
    if (msgD === today) return `—Å–µ–≥–æ–¥–Ω—è –≤ ${time}`;
    if (msgD === yest)  return `–≤—á–µ—Ä–∞ –≤ ${time}`;
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${time}`;
}

// Write presence fields to Firestore users/{userId}
async function _writePresence(isOnline) {
    if (!window.db || !window.STATE || !window.STATE.currentUser) return;
    const userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    if (!userId) return;
    try {
        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await setDoc(doc(window.db, 'users', userId), {
            isOnline: isOnline,
            lastSeen: Date.now(),
            nickname: window.STATE.currentUser.nickname || '',
            email: window.STATE.currentUser.email || ''
        }, { merge: true });
    } catch (e) {
        console.warn('[presence] write error:', e);
    }
}

// Public helpers ‚Äî called from handleLogin, handleRegister, logout (patched below)
function _setPresenceOnline()  { _presenceWhenDbReady(() => _writePresence(true));  }
function _setPresenceOffline() { _writePresence(false); }

// On page load: if already logged in, set online
document.addEventListener('DOMContentLoaded', () => {
    _presenceWhenDbReady(() => {
        if (window.STATE && window.STATE.currentUser) _writePresence(true);
    });
});

// On unload: try to set offline (best-effort)
window.addEventListener('beforeunload', () => {
    _setPresenceOffline();
});

// On tab visibility change
document.addEventListener('visibilitychange', () => {
    if (!window.STATE || !window.STATE.currentUser) return;
    _presenceWhenDbReady(() => _writePresence(!document.hidden));
});

// Subscribe to another user's presence in real-time
async function _subscribeToPresence(userId, callback) {
    if (!window.db || !userId) return null;
    try {
        const { doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        return onSnapshot(doc(window.db, 'users', userId), snap => {
            if (snap.exists()) {
                const d = snap.data();
                callback(!!d.isOnline, d.lastSeen || null);
            } else {
                callback(false, null);
            }
        }, err => console.warn('[presence] subscribe error:', err));
    } catch (e) {
        console.warn('[presence] subscribeToPresence error:', e);
        return null;
    }
}

// Inject presence bar into chat modal above chat-messages
function _injectPresenceBar(otherUserId) {
    const modalBody = document.querySelector('#chatModal .modal-body');
    if (!modalBody) return;

    const existing = modalBody.querySelector('.chat-presence-bar');
    if (existing) existing.remove();

    const bar = document.createElement('div');
    bar.className = 'chat-presence-bar';
    bar.id = 'chatPresenceBar';
    bar.innerHTML = `
        <span class="presence-dot-offline" id="presenceDot"></span>
        <span class="presence-text-offline" id="presenceText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    `;

    const chatMsgs = modalBody.querySelector('#chatMessages');
    if (chatMsgs) modalBody.insertBefore(bar, chatMsgs);
    else modalBody.insertBefore(bar, modalBody.firstChild);

    // Subscribe to real-time presence updates
    _presenceWhenDbReady(async () => {
        const unsub = await _subscribeToPresence(otherUserId, (isOnline, lastSeen) => {
            const dot  = document.getElementById('presenceDot');
            const text = document.getElementById('presenceText');
            if (!dot || !text) return;
            if (isOnline) {
                dot.className  = 'presence-dot-online';
                text.className = 'presence-text-online';
                text.textContent = '‚óè –í —Å–µ—Ç–∏';
            } else {
                dot.className  = 'presence-dot-offline';
                text.className = 'presence-text-offline';
                text.textContent = lastSeen
                    ? `–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏: ${_formatLastSeen(lastSeen)}`
                    : '–ù–µ –≤ —Å–µ—Ç–∏';
            }
        });
        window._presenceUnsub = unsub;
    });
}

// Patch closeModal to clean up presence subscription
const _origCloseModalPresence = window.closeModal || closeModal;
window.closeModal = function(modalId) {
    if (modalId === 'chatModal' && typeof window._presenceUnsub === 'function') {
        window._presenceUnsub();
        window._presenceUnsub = null;
    }
    _origCloseModalPresence(modalId);
};

// Patch openChat to inject presence bar + mark messages as read
const _origOpenChat = window.openChat;
window.openChat = async function(jobId, employerId, workerId) {
    await _origOpenChat(jobId, employerId, workerId);

    const currentUserId = window.STATE && window.STATE.currentUser
        ? (window.STATE.currentUser.uid || window.STATE.currentUser.email)
        : null;

    const otherId = (currentUserId === employerId) ? workerId : employerId;

    setTimeout(() => {
        if (otherId) _injectPresenceBar(otherId);
    }, 160);
};

// Patch handleLogin to set presence online after successful login
const _origHandleLogin = window.handleLogin || handleLogin;
window.handleLogin = function(e) {
    _origHandleLogin(e);
    // Delay to allow STATE.currentUser to be set
    setTimeout(() => { if (window.STATE && window.STATE.currentUser) _setPresenceOnline(); }, 200);
};

// Patch handleRegister to set presence online after registration
const _origHandleRegister = window.handleRegister || handleRegister;
window.handleRegister = function(e) {
    _origHandleRegister(e);
    setTimeout(() => { if (window.STATE && window.STATE.currentUser) _setPresenceOnline(); }, 200);
};

// Patch logout to set presence offline
const _origLogout = window.logout || logout;
window.logout = function() {
    _setPresenceOffline();
    _origLogout();
};

// ================= MESSAGE STATUS: markMessagesAsRead =================
// Called from inside openChat's onSnapshot. Marks receiver's incoming messages as read=true.
async function _markMessagesAsRead(chatId, currentUserId, messagesSnapshot) {
    if (!window.db || !chatId) return;
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const updates = [];
        messagesSnapshot.forEach(docSnap => {
            const msg = docSnap.data();
            if (msg.senderId !== currentUserId && msg.read === false) {
                updates.push(updateDoc(doc(window.db, 'messages', docSnap.id), {
                    read: true,
                    readAt: Date.now(),
                    status: 'read'
                }));
            }
        });
        if (updates.length > 0) await Promise.all(updates);
    } catch (e) {
        console.warn('[chat] markMessagesAsRead error:', e);
    }
}
</script>

<!-- ================= DESIGN RESTORE PATCH ================= -->
<!-- Task 2: Enhanced section header, animated job count badge, card hover improvements.
     No structural changes. Additive CSS + JS only.
-->
<style>
/* ================= DESIGN RESTORE PATCH ‚Äî CSS ================= */

/* Section h2 gradient text + underline animation */
.jobs-section .section-header h2 {
    background: linear-gradient(135deg, var(--text-dark) 0%, #1e3a8a 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: inline-block;
    transition: filter 0.3s ease;
}

.jobs-section .section-header h2::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 0;
    width: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-blue), var(--blue-light));
    border-radius: 2px;
    transition: width 0.55s cubic-bezier(0.4, 0, 0.2, 1);
}

.jobs-section .section-header:hover h2::after {
    width: 100%;
}

.jobs-section .section-header:hover h2 {
    filter: drop-shadow(0 2px 14px rgba(37,99,235,0.22));
}

/* Styled job count badge */
.job-count-badge {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: linear-gradient(135deg, var(--soft-blue), #dbeafe);
    color: var(--primary-blue);
    border: 1.5px solid rgba(37,99,235,0.15);
    border-radius: 24px;
    padding: 6px 16px;
    font-size: 14px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    cursor: default;
}

.job-count-badge:hover {
    transform: scale(1.04);
    box-shadow: 0 4px 18px rgba(37,99,235,0.16);
}

.job-count-number {
    font-size: 17px;
    font-weight: 800;
}

@keyframes countBadgePop {
    0%   { transform: scale(1); }
    45%  { transform: scale(1.28); }
    100% { transform: scale(1); }
}

.job-count-badge.pop {
    animation: countBadgePop 0.32s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes badgeGlow {
    0%, 100% { box-shadow: 0 2px 8px rgba(37,99,235,0.08); }
    50%       { box-shadow: 0 4px 22px rgba(37,99,235,0.24); }
}

.job-count-badge.loaded {
    animation: badgeGlow 2s ease-in-out 2;
}

/* Card shimmer hover sweep */
.job-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 60%;
    height: 100%;
    background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
    transform: skewX(-20deg);
    transition: left 0.55s cubic-bezier(0.4,0,0.2,1);
    pointer-events: none;
    z-index: 1;
    border-radius: var(--radius-lg);
}

.job-card:hover::before {
    left: 140%;
}

/* TOP badge pulse */
.admin-badge {
    animation: topBadgePulse 3s ease-in-out infinite;
}

@keyframes topBadgePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.5); }
    50%       { box-shadow: 0 0 0 6px rgba(245,158,11,0); }
}

/* Smooth grid re-render transition */
.jobs-grid {
    transition: opacity 0.15s ease;
}
.jobs-grid.rendering {
    opacity: 0.3;
    pointer-events: none;
}
</style>

<script>
// ================= DESIGN RESTORE PATCH ‚Äî JS =================

// Override renderJobs to: use styled badge + smooth re-render transition
(function patchRenderJobsDesign() {
    const _orig = window.renderJobs;
    if (!_orig) return;

    window.renderJobs = function() {
        const grid = document.getElementById('jobsGrid');
        const hasContent = grid && grid.children.length > 0 && !grid.querySelector('.skeleton-card');

        const doRender = () => {
            _orig();
            // Upgrade jobCount element to styled badge
            const jobCount = document.getElementById('jobCount');
            if (jobCount && !jobCount.querySelector('.job-count-badge')) {
                const raw = jobCount.textContent || '';
                const match = raw.match(/\d+/);
                const n = match ? match[0] : '0';
                jobCount.innerHTML = `<span class="job-count-badge loaded"><span class="job-count-number">${n}</span> –≤–∞–∫–∞–Ω—Å–∏–π –Ω–∞–π–¥–µ–Ω–æ</span>`;
            } else if (jobCount && jobCount.querySelector('.job-count-badge')) {
                // Update number inside existing badge
                const numEl = jobCount.querySelector('.job-count-number');
                if (numEl) {
                    const raw = jobCount.textContent || '';
                    const match = raw.match(/\d+/);
                    if (match) numEl.textContent = match[0];
                }
                const badge = jobCount.querySelector('.job-count-badge');
                if (badge) {
                    badge.classList.remove('pop', 'loaded');
                    void badge.offsetWidth;
                    badge.classList.add('pop');
                    setTimeout(() => { badge.classList.remove('pop'); badge.classList.add('loaded'); }, 340);
                }
            }
        };

        if (hasContent) {
            grid.classList.add('rendering');
            setTimeout(() => { grid.classList.remove('rendering'); doRender(); }, 110);
        } else {
            doRender();
        }
    };
})();
</script>

<!-- ================= CHAT UI ENHANCEMENT ================= -->
<!-- Task 3: Chat modal width +15% (640px via CSS), taller message area,
     message status badges, send button disable-when-empty,
     backdrop blur, better spacing, smooth bubble animations.
     Zero logic changes. All patches are additive.
-->
<style>
/* ================= CHAT UI ENHANCEMENT ‚Äî CSS ================= */

/* Chat modal already 640px ‚Äî further enhance interior */
#chatModal {
    backdrop-filter: blur(8px);
}

/* Delivered / read status indicators inside sent bubbles */
.chat-message.sent::after {
    content: '‚úî';
    display: block;
    font-size: 11px;
    text-align: right;
    margin-top: 3px;
    opacity: 0.65;
    letter-spacing: -1px;
}

.chat-message.sent.read::after {
    content: '‚úî‚úî';
    opacity: 1;
    color: #bfdbfe;
}

/* Remove default ::after when chat-msg-wrap is used (presence bar upgraded bubbles) */
.chat-msg-wrap .chat-message.sent::after {
    content: none;
}

/* Enhanced bubble animation */
@keyframes msgAppear {
    from { opacity: 0; transform: translateY(10px) scale(0.95); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}

.chat-message {
    animation: msgAppear 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
}

/* Send button idle pulse when input has content */
@keyframes sendPulse {
    0%, 100% { box-shadow: 0 2px 8px rgba(37,99,235,0.2); }
    50%       { box-shadow: 0 4px 18px rgba(37,99,235,0.4); }
}

#chatSendBtn:not(:disabled):hover {
    animation: sendPulse 1.2s ease-in-out infinite;
}

#chatSendBtn:disabled {
    opacity: 0.42;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

/* Lighter empty state text */
.chat-empty-msg {
    color: var(--text-gray);
    text-align: center;
    padding: 48px 20px;
    font-size: 14px;
    font-weight: 500;
    opacity: 0.75;
}

/* Typing indicator (future use) */
.chat-typing-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 10px 14px;
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 18px;
    border-bottom-left-radius: 5px;
    width: fit-content;
    margin-bottom: 10px;
    animation: msgAppear 0.25s ease;
    box-shadow: var(--shadow-sm);
}

.chat-typing-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #94a3b8;
    animation: typingBounce 1.2s ease-in-out infinite;
}
.chat-typing-dot:nth-child(2) { animation-delay: 0.2s; }
.chat-typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30%            { transform: translateY(-5px); opacity: 1; }
}
</style>

<script>
// ================= CHAT UI ENHANCEMENT ‚Äî JS =================

// Disable send button when chat input is empty; re-enable as user types
document.addEventListener('DOMContentLoaded', function() {
    const chatInput  = document.getElementById('chatInput');
    const chatModal  = document.getElementById('chatModal');
    if (!chatInput) return;

    function syncSendBtn() {
        const btn = document.getElementById('chatSendBtn');
        if (btn) btn.disabled = !chatInput.value.trim();
    }

    chatInput.addEventListener('input', syncSendBtn);
    syncSendBtn();

    // Re-sync whenever chat modal opens
    if (chatModal) {
        new MutationObserver(() => {
            if (chatModal.classList.contains('active')) setTimeout(syncSendBtn, 100);
        }).observe(chatModal, { attributes: true, attributeFilter: ['class'] });
    }
});
</script>

<!-- ================= UX FILTER SYSTEM ================= -->
<!-- Active filter chips, localStorage persistence, skeleton loading, button ripple.
     No changes to applyFilters(), applySorting(), resetFilters() logic.
-->
<style>
/* ================= UX FILTER SYSTEM ‚Äî CSS ================= */
.filter-chips-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 14px;
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--soft-blue);
    color: var(--primary-blue);
    border: 1.5px solid rgba(37,99,235,0.22);
    border-radius: 24px;
    padding: 5px 14px 5px 12px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: var(--transition);
    animation: chipPop 0.22s cubic-bezier(0.34,1.56,0.64,1) backwards;
    user-select: none;
}

.filter-chip:hover {
    background: var(--primary-blue);
    color: var(--white);
    transform: scale(1.04);
}

.filter-chip-remove {
    font-size: 14px;
    font-weight: 800;
    opacity: 0.65;
    line-height: 1;
}

@keyframes chipPop {
    from { transform: scale(0.6); opacity: 0; }
    to   { transform: scale(1);   opacity: 1; }
}

/* Loading skeleton */
.skeleton-card {
    background: var(--white);
    padding: 26px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 2px solid transparent;
    overflow: hidden;
}

.skeleton-line {
    border-radius: 6px;
    background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s infinite;
}

@keyframes shimmer {
    0%   { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Filter restored badge */
.filter-restored-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #dcfce7;
    color: #16a34a;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 12px;
    font-weight: 700;
    margin-left: 8px;
    animation: fadeIn 0.5s ease;
    transition: opacity 0.5s ease;
}

/* Button ripple */
.btn-ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255,255,255,0.35);
    transform: scale(0);
    animation: rippleAnim 0.55s linear;
    pointer-events: none;
}

@keyframes rippleAnim {
    to { transform: scale(4); opacity: 0; }
}
</style>

<script>
// ================= UX FILTER SYSTEM ‚Äî JS =================

const FILTER_STORAGE_KEY = 'teenwork_filters_v1';

const FILTER_LABELS = {
    search: { id: 'searchInput',  label: '–ü–æ–∏—Å–∫',    type: 'input'  },
    city:   { id: 'cityFilter',   label: '–ì–æ—Ä–æ–¥',    type: 'select' },
    type:   { id: 'typeFilter',   label: '–¢–∏–ø',      type: 'select' },
    salary: { id: 'salaryFilter', label: '–ó–∞—Ä–ø–ª–∞—Ç–∞', type: 'select' },
};

function initFilterChipsContainer() {
    const filterSection = document.querySelector('.filters-section');
    if (!filterSection || filterSection.querySelector('#filterChipsRow')) return;
    const actionsRow = filterSection.querySelector('.filter-actions');
    if (!actionsRow) return;
    const row = document.createElement('div');
    row.className = 'filter-chips-row';
    row.id = 'filterChipsRow';
    filterSection.insertBefore(row, actionsRow);
}

function renderFilterChips() {
    const row = document.getElementById('filterChipsRow');
    if (!row) return;
    row.innerHTML = '';
    let idx = 0;
    Object.entries(FILTER_LABELS).forEach(([, meta]) => {
        const el = document.getElementById(meta.id);
        if (!el || !el.value) return;
        const label = meta.type === 'select' && el.options[el.selectedIndex]
            ? el.options[el.selectedIndex].text
            : el.value;
        const chip = document.createElement('span');
        chip.className = 'filter-chip';
        chip.style.animationDelay = (idx * 40) + 'ms';
        chip.innerHTML = `${meta.label}: <strong>${label}</strong> <span class="filter-chip-remove">√ó</span>`;
        chip.addEventListener('click', () => { el.value = ''; applyFilters(); });
        row.appendChild(chip);
        idx++;
    });
}

function saveFiltersToStorage() {
    const s = {};
    Object.values(FILTER_LABELS).forEach(m => { const el = document.getElementById(m.id); if (el) s[m.id] = el.value; });
    const sort = document.getElementById('sortFilter');
    if (sort) s['sortFilter'] = sort.value;
    try { localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(s)); } catch(e) {}
}

function restoreFiltersFromStorage() {
    try {
        const saved = JSON.parse(localStorage.getItem(FILTER_STORAGE_KEY) || 'null');
        if (!saved) return false;
        let any = false;
        Object.values(FILTER_LABELS).forEach(m => {
            const el = document.getElementById(m.id);
            if (el && saved[m.id]) { el.value = saved[m.id]; any = true; }
        });
        const sort = document.getElementById('sortFilter');
        if (sort && saved['sortFilter']) sort.value = saved['sortFilter'];
        return any;
    } catch(e) { return false; }
}

function showRestoredBadge() {
    const jc = document.getElementById('jobCount');
    if (!jc) return;
    const badge = document.createElement('span');
    badge.className = 'filter-restored-badge';
    badge.textContent = '‚Ü© –§–∏–ª—å—Ç—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã';
    jc.parentNode.insertBefore(badge, jc.nextSibling);
    setTimeout(() => { badge.style.opacity = '0'; setTimeout(() => badge.remove(), 500); }, 3000);
}

function showJobSkeletons(count) {
    const grid = document.getElementById('jobsGrid');
    if (!grid) return;
    let html = '';
    for (let i = 0; i < count; i++) {
        html += `<div class="skeleton-card">
            <div class="skeleton-line" style="height:22px;width:70%;margin-bottom:12px;"></div>
            <div class="skeleton-line" style="height:14px;width:45%;margin-bottom:8px;"></div>
            <div class="skeleton-line" style="height:14px;width:35%;margin-bottom:20px;"></div>
            <div class="skeleton-line" style="height:28px;width:55%;margin-bottom:14px;"></div>
            <div class="skeleton-line" style="height:34px;width:40%;border-radius:24px;margin-bottom:22px;"></div>
            <div style="display:flex;justify-content:flex-end;">
                <div class="skeleton-line" style="height:36px;width:120px;border-radius:12px;"></div>
            </div>
        </div>`;
    }
    grid.innerHTML = html;
}

// Patch applyFilters to also render chips + save state
const _origApplyFilters_ux = applyFilters;
window.applyFilters = function() {
    _origApplyFilters_ux();
    renderFilterChips();
    saveFiltersToStorage();
};

// Patch resetFilters to clear chips + storage
const _origResetFilters_ux = resetFilters;
window.resetFilters = function() {
    _origResetFilters_ux();
    renderFilterChips();
    try { localStorage.removeItem(FILTER_STORAGE_KEY); } catch(e) {}
};

// Button ripple effect
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn, .btn-clear-filters');
    if (!btn) return;
    const ripple = document.createElement('span');
    ripple.className = 'btn-ripple';
    const r = btn.getBoundingClientRect();
    const size = Math.max(r.width, r.height);
    ripple.style.cssText = `width:${size}px;height:${size}px;left:${e.clientX-r.left-size/2}px;top:${e.clientY-r.top-size/2}px;`;
    btn.appendChild(ripple);
    ripple.addEventListener('animationend', () => ripple.remove());
}, true);

// Init on DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    initFilterChipsContainer();
    showJobSkeletons(6);

    const wasRestored = restoreFiltersFromStorage();
    if (wasRestored) {
        const poll = setInterval(() => {
            if (window.STATE && window.STATE.jobs.length > 0) {
                applyFilters();
                showRestoredBadge();
                clearInterval(poll);
            }
        }, 300);
        setTimeout(() => clearInterval(poll), 8000);
    }
});
</script>

<!-- ================= DESIGN REWORK ================= -->
<!-- TASK 1: Section header redesign
     - Remove animated underline visually (override with display:none on ::after)
     - Clean "–ù–∞–π–¥–µ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: X" large bold header
     - Smooth number counter transition
     - Blue accent glow
     - Premium SaaS look (Linear / Stripe style)
     No HTML structure changed. Only CSS + JS extension.
-->
<style>
/* ================= DESIGN REWORK ‚Äî CSS ================= */

/* Hide animated underline from previous patch (visual only, ::after still exists in DOM) */
.jobs-section .section-header h2::after {
    display: none !important;
}

/* Remove gradient text fill from h2 ‚Äî replaced with new rework below */
.jobs-section .section-header h2 {
    -webkit-text-fill-color: initial !important;
    background: none !important;
    background-clip: initial !important;
    filter: none !important;
    display: block !important;
    font-size: 0 !important; /* hide original "–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏" text */
    position: relative;
    min-height: 0;
}

/* NEW: Job section hero counter replacing the h2 */
.job-section-hero {
    display: flex;
    flex-direction: column;
    gap: 6px;
    animation: heroCounterIn 0.6s cubic-bezier(0.34,1.56,0.64,1) backwards;
}

@keyframes heroCounterIn {
    from { opacity: 0; transform: translateY(18px); }
    to   { opacity: 1; transform: translateY(0); }
}

.job-section-label {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    color: var(--primary-blue);
    opacity: 0.8;
}

.job-section-count-row {
    display: flex;
    align-items: baseline;
    gap: 10px;
    line-height: 1;
}

.job-section-num {
    font-size: 52px;
    font-weight: 800;
    letter-spacing: -3px;
    color: var(--text-dark);
    font-variant-numeric: tabular-nums;
    transition: color 0.3s ease;
    text-shadow: 0 2px 24px rgba(37,99,235,0.10);
    position: relative;
}

.job-section-num::after {
    content: '';
    display: none; /* suppress inherited ::after */
}

/* Blue glow accent under number */
.job-section-num-wrap {
    position: relative;
    display: inline-block;
}

.job-section-num-wrap::before {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 100%;
    height: 6px;
    background: linear-gradient(90deg, var(--primary-blue), var(--blue-light));
    border-radius: 3px;
    opacity: 0.18;
    filter: blur(4px);
    transition: opacity 0.4s ease, width 0.4s ease;
}

.job-section-hero:hover .job-section-num-wrap::before {
    opacity: 0.32;
}

.job-section-suffix {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-gray);
    letter-spacing: -0.3px;
    padding-bottom: 4px;
}

/* Number flip animation when count changes */
@keyframes numFlip {
    0%   { opacity: 0; transform: translateY(-14px) scale(0.9); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

.job-section-num.flipping {
    animation: numFlip 0.28s cubic-bezier(0.34,1.56,0.64,1);
}

/* Hide old section-info job count pill (replaced by hero) */
#jobCount {
    display: none !important;
}
</style>

<script>
// ================= DESIGN REWORK ‚Äî JS =================

// Inject the new hero counter into the section header
// Called once on DOMContentLoaded, then synced on every renderJobs call.

(function installJobSectionHero() {
    function buildHero() {
        const sectionHeader = document.querySelector('.jobs-section .section-header');
        if (!sectionHeader || sectionHeader.querySelector('.job-section-hero')) return;

        const heroDiv = document.createElement('div');
        heroDiv.className = 'job-section-hero';
        heroDiv.id = 'jobSectionHero';
        heroDiv.innerHTML = `
            <div class="job-section-label">–í–∞–∫–∞–Ω—Å–∏–∏</div>
            <div class="job-section-count-row">
                <div class="job-section-num-wrap">
                    <span class="job-section-num" id="jobSectionNum">0</span>
                </div>
                <span class="job-section-suffix" id="jobSectionSuffix">–Ω–∞–π–¥–µ–Ω–æ</span>
            </div>
        `;

        // Insert before the h2 inside the first child div
        const headerInner = sectionHeader.querySelector('div');
        if (headerInner) {
            headerInner.insertBefore(heroDiv, headerInner.firstChild);
        } else {
            sectionHeader.insertBefore(heroDiv, sectionHeader.firstChild);
        }
    }

    // Smooth animated counter from current ‚Üí target
    function animateCount(el, from, to, duration) {
        if (from === to) return;
        const startTime = performance.now();
        function tick(now) {
            const t = Math.min((now - startTime) / duration, 1);
            // Ease-out cubic
            const eased = 1 - Math.pow(1 - t, 3);
            el.textContent = Math.round(from + (to - from) * eased);
            if (t < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
    }

    let _lastCount = null;

    function syncHeroCount() {
        const numEl = document.getElementById('jobSectionNum');
        if (!numEl) return;

        const count = window.STATE ? window.STATE.filteredJobs.length : 0;
        if (count === _lastCount) return;

        const prev = _lastCount === null ? 0 : _lastCount;
        _lastCount = count;

        // Flip animation
        numEl.classList.remove('flipping');
        void numEl.offsetWidth; // reflow
        numEl.classList.add('flipping');

        animateCount(numEl, prev, count, 420);

        // Update suffix with plural form
        const suffix = document.getElementById('jobSectionSuffix');
        if (suffix) {
            const mod10 = count % 10;
            const mod100 = count % 100;
            let word;
            if (mod100 >= 11 && mod100 <= 14) word = '–Ω–∞–π–¥–µ–Ω–æ';
            else if (mod10 === 1) word = '–Ω–∞–π–¥–µ–Ω–∞';
            else if (mod10 >= 2 && mod10 <= 4) word = '–Ω–∞–π–¥–µ–Ω–æ';
            else word = '–Ω–∞–π–¥–µ–Ω–æ';
            suffix.textContent = word;
        }
    }

    // Patch renderJobs to call syncHeroCount after render
    const _origRenderForHero = window.renderJobs;
    window.renderJobs = function() {
        _origRenderForHero();
        syncHeroCount();
    };

    document.addEventListener('DOMContentLoaded', function() {
        buildHero();
        syncHeroCount();
    });

    // Also try after a short delay in case DOMContentLoaded already fired
    setTimeout(() => { buildHero(); syncHeroCount(); }, 80);
})();
</script>

<!-- ================= CARD ANIMATION SYSTEM ================= -->
<!-- TASK 2: Complete job card redesign
     - Elevated clean white card (Linear / Stripe / Airbnb)
     - Better spacing, typography hierarchy
     - Strong salary highlight
     - Smooth hover lift with premium shadow
     - Staggered card entry on render
     - Ultra-smooth modal open (scale + blur)
     No layout / grid structure changed.
-->
<style>
/* ================= CARD ANIMATION SYSTEM ‚Äî CSS ================= */

/* Elevated card base ‚Äî overrides existing .job-card */
.job-card {
    background: #ffffff !important;
    padding: 30px 28px 24px !important;
    border-radius: 20px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06) !important;
    border: 1.5px solid rgba(226,232,240,0.8) !important;
    transition: box-shadow 0.35s cubic-bezier(0.4,0,0.2,1),
                transform 0.35s cubic-bezier(0.4,0,0.2,1),
                border-color 0.25s ease !important;
    position: relative;
    overflow: hidden;
}

.job-card:hover {
    transform: translateY(-8px) scale(1.012) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04),
                0 12px 40px rgba(37,99,235,0.12),
                0 24px 60px rgba(0,0,0,0.08) !important;
    border-color: rgba(37,99,235,0.3) !important;
}

.job-card:active {
    transform: translateY(-3px) scale(1.005) !important;
    transition-duration: 0.12s !important;
}

/* Stronger title */
.job-title {
    font-size: 19px !important;
    font-weight: 800 !important;
    letter-spacing: -0.4px !important;
    line-height: 1.25 !important;
    color: #0f172a !important;
    margin-bottom: 8px !important;
}

/* Company */
.job-company {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: var(--text-gray) !important;
    margin-bottom: 4px !important;
}

.job-location {
    font-size: 13px !important;
    color: #94a3b8 !important;
    font-weight: 500 !important;
}

/* Salary ‚Äî prominent highlight */
.job-salary {
    font-size: 26px !important;
    font-weight: 800 !important;
    letter-spacing: -1px !important;
    margin-bottom: 16px !important;
    background: linear-gradient(130deg, #1d4ed8 0%, var(--blue-light) 100%) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}

/* Tags */
.tag {
    padding: 5px 12px !important;
    background: #f0f7ff !important;
    color: #2563eb !important;
    border-radius: 20px !important;
    font-size: 12px !important;
    font-weight: 700 !important;
    border: 1px solid rgba(37,99,235,0.12) !important;
    letter-spacing: 0.1px !important;
}

/* Footer divider */
.job-footer {
    padding-top: 16px !important;
    border-top: 1px solid #f1f5f9 !important;
    margin-top: 4px !important;
}

/* Apply button refinement */
.btn-apply {
    padding: 10px 22px !important;
    font-size: 13px !important;
    font-weight: 700 !important;
    letter-spacing: 0.2px !important;
    border-radius: var(--radius-md) !important;
}

/* Staggered entry animation for cards */
@keyframes cardEntry {
    from {
        opacity: 0;
        transform: translateY(28px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.job-card {
    animation: cardEntry 0.5s cubic-bezier(0.4,0,0.2,1) backwards !important;
}

/* Stagger delays ‚Äî resets every 6 cards */
.job-card:nth-child(1)  { animation-delay: 0.04s !important; }
.job-card:nth-child(2)  { animation-delay: 0.09s !important; }
.job-card:nth-child(3)  { animation-delay: 0.14s !important; }
.job-card:nth-child(4)  { animation-delay: 0.19s !important; }
.job-card:nth-child(5)  { animation-delay: 0.24s !important; }
.job-card:nth-child(6)  { animation-delay: 0.29s !important; }

/* Keep shimmer from previous patch working (z-index layering) */
.job-card::before {
    z-index: 0 !important;
    border-radius: 20px !important;
}

/* Modal ultra-smooth open ‚Äî override existing */
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.93) translateY(-24px);
        filter: blur(2px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: blur(0);
    }
}

@keyframes modalSlideOut {
    to {
        opacity: 0;
        transform: scale(0.96) translateY(-16px);
        filter: blur(1px);
    }
}

.modal-content {
    animation: modalSlideIn 0.42s cubic-bezier(0.34,1.56,0.64,1) !important;
}

.modal.hiding .modal-content {
    animation: modalSlideOut 0.28s ease forwards !important;
}

/* Backdrop blur on all modals */
.modal {
    backdrop-filter: blur(10px) !important;
    background: rgba(15, 23, 42, 0.5) !important;
}

/* Grid gap slight increase for breathing room */
.jobs-grid {
    gap: 28px !important;
}
</style>

<!-- ================= EMPLOYER VACANCY CONTROL ================= -->
<!-- TASK 3: Employer vacancy control system
     New Firestore field: isClosed (boolean, default false)
     - Toggle open/close per vacancy
     - "–ù–∞–±–æ—Ä –∑–∞–∫—Ä—ã—Ç" badge when closed
     - Apply button disabled when closed
     - Edit vacancy modal (prefilled: title, salary, description, type, city)
     - "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏—è–º–∏" section in employer profile
     All extensions. Existing code untouched.
-->
<style>
/* ================= EMPLOYER VACANCY CONTROL ‚Äî CSS ================= */

/* "–ù–∞–±–æ—Ä –∑–∞–∫—Ä—ã—Ç" badge on job cards */
.job-closed-badge {
    position: absolute;
    top: 12px;
    left: 14px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: #fff;
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.4px;
    z-index: 2;
    pointer-events: none;
    box-shadow: 0 2px 8px rgba(239,68,68,0.3);
}

/* Muted overlay on closed cards */
.job-card.job-is-closed {
    opacity: 0.72;
}

.job-card.job-is-closed::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(241,245,249,0.45);
    border-radius: 20px;
    pointer-events: none;
    z-index: 0;
}

/* Employer vacancy management section */
.employer-vacancy-section {
    margin-top: 32px;
    background: var(--light-gray);
    border-radius: var(--radius-lg);
    padding: 24px;
    animation: fadeInUp 0.5s ease;
}

.employer-vacancy-section h3 {
    font-size: 19px;
    font-weight: 700;
    margin-bottom: 18px;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.employer-vacancy-section h3::before {
    content: '‚öôÔ∏è';
    font-size: 18px;
}

.employer-vacancy-card {
    background: var(--white);
    border-radius: var(--radius-md);
    padding: 18px;
    margin-bottom: 14px;
    box-shadow: var(--shadow-sm);
    border: 1.5px solid var(--border-gray);
    transition: var(--transition);
}

.employer-vacancy-card:last-child {
    margin-bottom: 0;
}

.employer-vacancy-card:hover {
    box-shadow: var(--shadow-md);
    border-color: rgba(37,99,235,0.2);
}

.employer-vacancy-card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.employer-vacancy-card-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.employer-vacancy-card-meta {
    font-size: 13px;
    color: var(--text-gray);
    font-weight: 500;
}

.employer-vacancy-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    flex-shrink: 0;
    transition: var(--transition);
}

.employer-vacancy-status-badge.open {
    background: #dcfce7;
    color: #16a34a;
}

.employer-vacancy-status-badge.closed {
    background: #fee2e2;
    color: #dc2626;
}

.employer-vacancy-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 14px;
    font-size: 13px;
    color: var(--text-gray);
    font-weight: 500;
}

.employer-vacancy-stat {
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: 600;
}

.employer-vacancy-controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-toggle-vacancy {
    padding: 7px 16px;
    font-size: 12px;
    font-weight: 700;
    border-radius: var(--radius-sm);
    border: 1.5px solid var(--border-gray);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    background: var(--white);
    color: var(--text-dark);
}

.btn-toggle-vacancy:hover {
    border-color: var(--primary-blue);
    background: var(--soft-blue);
    color: var(--primary-blue);
}

.btn-toggle-vacancy.close-action {
    border-color: #fca5a5;
    color: #dc2626;
}

.btn-toggle-vacancy.close-action:hover {
    background: #fee2e2;
    border-color: #dc2626;
}

.btn-toggle-vacancy.open-action {
    border-color: #86efac;
    color: #16a34a;
}

.btn-toggle-vacancy.open-action:hover {
    background: #dcfce7;
    border-color: #16a34a;
}

.btn-edit-vacancy {
    padding: 7px 16px;
    font-size: 12px;
    font-weight: 700;
    border-radius: var(--radius-sm);
    border: 1.5px solid rgba(37,99,235,0.3);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    background: var(--soft-blue);
    color: var(--primary-blue);
}

.btn-edit-vacancy:hover {
    background: var(--primary-blue);
    color: var(--white);
    border-color: var(--primary-blue);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37,99,235,0.2);
}

/* Apply button disabled state for closed jobs */
.btn-apply:disabled,
.btn-apply[data-closed="true"] {
    opacity: 0.45 !important;
    cursor: not-allowed !important;
    background: var(--text-gray) !important;
    transform: none !important;
    box-shadow: none !important;
}
</style>

<!-- Edit vacancy modal HTML injected via JS to avoid touching existing HTML -->
<div class="modal" id="editVacancyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é</h3>
            <button class="modal-close" onclick="closeModal('editVacancyModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editVacancyForm">
                <input type="hidden" id="editVacancyId">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏</label>
                    <input type="text" id="editVacancyTitle" required>
                    <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                </div>
                <div class="form-group">
                    <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                    <input type="number" id="editVacancySalary" required min="0">
                    <div class="form-error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∑–∞—Ä–ø–ª–∞—Ç—É</div>
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø —Ä–∞–±–æ—Ç—ã</label>
                    <input type="text" id="editVacancyType" required>
                    <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                </div>
                <div class="form-group">
                    <label>–ì–æ—Ä–æ–¥</label>
                    <select id="editVacancyCity" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                        <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                    </select>
                    <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="editVacancyDescription" required style="min-height: 110px; resize: vertical;"></textarea>
                    <div class="form-error">–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </form>
        </div>
    </div>
</div>

<script>
// ================= EMPLOYER VACANCY CONTROL ‚Äî JS =================

// -------------------------------------------------------
// PATCH renderJobs: Add isClosed badge + disable apply btn
// -------------------------------------------------------
(function patchRenderJobsForClosed() {
    const _origRender = window.renderJobs;
    if (!_origRender) return;

    window.renderJobs = function() {
        _origRender();

        // After render, add closed badge and disable apply for closed jobs
        const grid = document.getElementById('jobsGrid');
        if (!grid) return;

        // Get all job cards
        const cards = grid.querySelectorAll('.job-card');
        cards.forEach(card => {
            // Extract job id from the onclick attribute
            const onclickAttr = card.getAttribute('onclick') || '';
            const match = onclickAttr.match(/openApplyModal\(['"]([^'"]+)['"]\)/);
            if (!match) return;
            const jobId = match[1];

            const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
            if (!job) return;

            if (job.isClosed) {
                // Add closed class
                card.classList.add('job-is-closed');

                // Inject closed badge if not present
                if (!card.querySelector('.job-closed-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'job-closed-badge';
                    badge.textContent = '–ù–∞–±–æ—Ä –∑–∞–∫—Ä—ã—Ç';
                    card.insertBefore(badge, card.firstChild);
                }

                // Disable apply button
                const applyBtn = card.querySelector('.btn-apply');
                if (applyBtn) {
                    applyBtn.disabled = true;
                    applyBtn.dataset.closed = 'true';
                    applyBtn.title = '–ù–∞–±–æ—Ä –Ω–∞ —ç—Ç—É –≤–∞–∫–∞–Ω—Å–∏—é –∑–∞–∫—Ä—ã—Ç';
                    // Prevent click from opening modal
                    applyBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (window.showToast) showToast('–ù–∞–±–æ—Ä –∑–∞–∫—Ä—ã—Ç', '–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏–ª –Ω–∞–±–æ—Ä –Ω–∞ —ç—Ç—É –≤–∞–∫–∞–Ω—Å–∏—é', 'warning');
                    };
                }
            }
        });
    };
})();

// -------------------------------------------------------
// TOGGLE isClosed on Firestore job document
// -------------------------------------------------------
async function toggleVacancyClosed(jobId, currentlyClosed) {
    if (!window.db) {
        showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
    }
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'jobs', jobId), {
            isClosed: !currentlyClosed
        });
        showToast('–£—Å–ø–µ—à–Ω–æ', currentlyClosed ? '–ù–∞–±–æ—Ä –æ—Ç–∫—Ä—ã—Ç' : '–ù–∞–±–æ—Ä –∑–∞–∫—Ä—ã—Ç', 'success');
        if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
        // Refresh employer vacancy section
        _renderEmployerVacancySection();
    } catch (e) {
        console.error('toggleVacancyClosed error:', e);
        showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å', 'error');
    }
}

// -------------------------------------------------------
// OPEN EDIT VACANCY MODAL
// -------------------------------------------------------
function openEditVacancyModal(jobId) {
    const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
    if (!job) return;

    document.getElementById('editVacancyId').value = jobId;
    document.getElementById('editVacancyTitle').value = job.title || '';
    document.getElementById('editVacancySalary').value = job.salary || '';
    document.getElementById('editVacancyType').value = job.type || '';
    document.getElementById('editVacancyCity').value = job.city || '';
    document.getElementById('editVacancyDescription').value = job.description || '';

    openModal('editVacancyModal');
}

// -------------------------------------------------------
// SAVE EDIT VACANCY
// -------------------------------------------------------
async function handleEditVacancySave(e) {
    e.preventDefault();

    const jobId = document.getElementById('editVacancyId').value;
    const title = document.getElementById('editVacancyTitle').value.trim();
    const salary = parseInt(document.getElementById('editVacancySalary').value);
    const type = document.getElementById('editVacancyType').value.trim();
    const city = document.getElementById('editVacancyCity').value;
    const description = document.getElementById('editVacancyDescription').value.trim();

    if (!title || !salary || !type || !city || !description) {
        showToast('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
    }

    if (!window.db) {
        showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
    }

    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'jobs', jobId), {
            title,
            salary,
            type,
            city,
            description,
            updatedAt: Date.now()
        });

        closeModal('editVacancyModal');
        showToast('–£—Å–ø–µ—à–Ω–æ', '–í–∞–∫–∞–Ω—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');

        if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
        _renderEmployerVacancySection();
    } catch (e) {
        console.error('handleEditVacancySave error:', e);
        showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é', 'error');
    }
}

// -------------------------------------------------------
// RENDER "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏—è–º–∏" SECTION IN EMPLOYER PROFILE
// -------------------------------------------------------
async function _renderEmployerVacancySection() {
    const profileBody = document.querySelector('.profile-body');
    if (!profileBody) return;
    if (!window.STATE || !window.STATE.currentUser) return;
    if (window.STATE.currentUser.role !== 'employer') return;

    // Remove old section if exists
    const oldSection = document.getElementById('employerVacancyControlSection');
    if (oldSection) oldSection.remove();

    const userJobs = window.STATE.jobs.filter(
        j => j.employerEmail === window.STATE.currentUser.email ||
             j.employerId === (window.STATE.currentUser.uid || window.STATE.currentUser.email)
    );

    if (userJobs.length === 0) return;

    const section = document.createElement('div');
    section.className = 'employer-vacancy-section';
    section.id = 'employerVacancyControlSection';

    let html = '<h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏—è–º–∏</h3>';

    for (const job of userJobs) {
        let appCount = 0;
        const viewCount = job.views || 0;

        if (window.db) {
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const q = query(collection(window.db, 'applications'), where('jobId', '==', job.id));
                const snap = await getDocs(q);
                appCount = snap.size;
            } catch (e) { /* silent */ }
        }

        const isClosed = !!job.isClosed;
        const statusClass = isClosed ? 'closed' : 'open';
        const statusText = isClosed ? '‚óè –ù–∞–±–æ—Ä –∑–∞–∫—Ä—ã—Ç' : '‚óè –ù–∞–±–æ—Ä –æ—Ç–∫—Ä—ã—Ç';

        html += `
            <div class="employer-vacancy-card">
                <div class="employer-vacancy-card-top">
                    <div>
                        <div class="employer-vacancy-card-title">${job.title}</div>
                        <div class="employer-vacancy-card-meta">${job.company} ‚Ä¢ ${(job.salary || 0).toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                    <div class="employer-vacancy-status-badge ${statusClass}">${statusText}</div>
                </div>
                <div class="employer-vacancy-stats">
                    <div class="employer-vacancy-stat">üëÅÔ∏è <span>${viewCount} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span></div>
                    <div class="employer-vacancy-stat">üì© <span>${appCount} –æ—Ç–∫–ª–∏–∫–æ–≤</span></div>
                </div>
                <div class="employer-vacancy-controls">
                    <button class="btn-toggle-vacancy ${isClosed ? 'open-action' : 'close-action'}"
                        onclick="toggleVacancyClosed('${job.id}', ${isClosed})">
                        ${isClosed ? '‚úì –û—Ç–∫—Ä—ã—Ç—å –Ω–∞–±–æ—Ä' : '‚úó –ó–∞–∫—Ä—ã—Ç—å –Ω–∞–±–æ—Ä'}
                    </button>
                    <button class="btn-edit-vacancy" onclick="openEditVacancyModal('${job.id}')">
                        ‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-small btn-primary" onclick="showApplications('${job.id}')">
                        –û—Ç–∫–ª–∏–∫–∏
                    </button>
                </div>
            </div>
        `;
    }

    section.innerHTML = html;
    profileBody.appendChild(section);
}

// -------------------------------------------------------
// PATCH openProfile to inject employer vacancy section
// -------------------------------------------------------
const _origOpenProfileForVacancy = window.openProfile || openProfile;
window.openProfile = function() {
    _origOpenProfileForVacancy();
    // Wait for profile page to mount
    setTimeout(() => {
        if (window.STATE && window.STATE.currentUser && window.STATE.currentUser.role === 'employer') {
            _renderEmployerVacancySection();
        }
    }, 200);
};

// -------------------------------------------------------
// Bind edit form submit
// -------------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editVacancyForm');
    if (editForm) editForm.addEventListener('submit', handleEditVacancySave);
});
</script>

<!-- ================= INTERACTION ENHANCEMENT ================= -->
<!-- TASK 4: Global smooth interaction layer
     - Micro hover scale on all buttons
     - Active press animation
     - Smooth section fade on scroll (IntersectionObserver)
     - Card elevation is handled in CARD ANIMATION SYSTEM above
-->
<style>
/* ================= INTERACTION ENHANCEMENT ‚Äî CSS ================= */

/* Micro hover scale on all interactive buttons */
.btn:not(:disabled):hover {
    transform: translateY(-2px) scale(1.02) !important;
}

.btn:not(:disabled):active {
    transform: translateY(0) scale(0.97) !important;
    transition-duration: 0.08s !important;
}

/* Back button micro interaction */
.back-btn:hover {
    transform: translateX(-2px) !important;
}

/* Pagination button hover */
.pagination-btn:hover:not(:disabled) {
    transform: translateY(-2px) !important;
}

/* FAQ item hover lift */
.faq-item {
    transition: box-shadow 0.25s ease, transform 0.25s ease !important;
}

.faq-item:hover {
    transform: translateX(3px) !important;
}

/* Info card ‚Äî enhanced hover elevation */
.info-card:hover {
    transform: translateY(-8px) scale(1.015) !important;
    box-shadow: 0 12px 36px rgba(37,99,235,0.12) !important;
}

/* Section fade-in on scroll */
.section-fade-in {
    opacity: 0;
    transform: translateY(24px);
    transition: opacity 0.55s cubic-bezier(0.4,0,0.2,1),
                transform 0.55s cubic-bezier(0.4,0,0.2,1);
}

.section-fade-in.visible {
    opacity: 1;
    transform: translateY(0);
}

/* Modal close button enhanced hover */
.modal-close:hover {
    transform: rotate(90deg) scale(1.15) !important;
}

/* Nav profile wrapper hover */
.nav-profile-wrapper {
    transition: background 0.2s ease, transform 0.2s ease !important;
}

.nav-profile-wrapper:hover {
    transform: translateY(-1px) !important;
}

/* Input focus micro pop */
.input:focus, .select:focus,
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    transform: scale(1.005);
}

/* Role option hover */
.role-option:hover {
    transform: translateX(4px) !important;
}

/* Profile back btn enhanced */
.back-btn:hover {
    background: rgba(255,255,255,0.35) !important;
    transform: translateX(-3px) !important;
}

/* Smooth logo hover */
.logo {
    transition: transform 0.3s ease, filter 0.3s ease !important;
}

/* Applied job item hover */
.applied-job-item {
    transition: box-shadow 0.2s ease, transform 0.2s ease;
}

.applied-job-item:hover {
    transform: translateX(3px);
    box-shadow: var(--shadow-md);
}

/* Employer vacancy card hover already done above via .employer-vacancy-card */

/* Toast slight scale-in polish */
@keyframes slideInRight {
    from {
        transform: translateX(450px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateX(0) scale(1);
        opacity: 1;
    }
}

/* Scroll-to-top smooth cue on logo */
.logo:hover {
    filter: drop-shadow(0 4px 12px rgba(37,99,235,0.4)) !important;
    transform: translateY(-2px) !important;
}
</style>

<script>
// ================= INTERACTION ENHANCEMENT ‚Äî JS =================

// -------------------------------------------------------
// Section scroll fade-in with IntersectionObserver
// -------------------------------------------------------
(function initScrollFadeIn() {
    const targets = [
        '.info-section',
        '.faq-section',
        '.footer',
        '.info-card',
        '.faq-item',
    ];

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target);
            }
        });
    }, {
        rootMargin: '-40px 0px',
        threshold: 0.08
    });

    function observeTargets() {
        targets.forEach(sel => {
            document.querySelectorAll(sel).forEach(el => {
                // Don't re-add if already visible
                if (!el.classList.contains('visible')) {
                    el.classList.add('section-fade-in');
                    observer.observe(el);
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        observeTargets();

        // Re-observe dynamically added info cards on profile open
        document.getElementById('profilePage')?.addEventListener('transitionend', observeTargets);
    });
})();

// -------------------------------------------------------
// Keyboard trap in modals for accessibility (additive)
// -------------------------------------------------------
document.addEventListener('keydown', function(e) {
    if (e.key !== 'Tab') return;
    const activeModal = document.querySelector('.modal.active');
    if (!activeModal) return;
    const focusable = activeModal.querySelectorAll(
        'button:not(:disabled), input:not(:disabled), select:not(:disabled), textarea:not(:disabled), [tabindex]:not([tabindex="-1"])'
    );
    if (focusable.length === 0) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (e.shiftKey) {
        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
    } else {
        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
});
</script>

<!-- ================= EMPLOYER DESCRIPTION ================= -->
<!-- Feature 1: Employer company description
     - Textarea "–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏" in profile form for employer accounts
     - Saves to Firestore users/{userId} as field: description
     - Displayed in employer profile page
     - Displayed in job card apply modal under company info
     Zero changes to existing code. Additive only.
-->
<style>
/* ================= EMPLOYER DESCRIPTION ‚Äî CSS ================= */

.employer-description-block {
    background: var(--light-gray);
    border-radius: var(--radius-md);
    padding: 18px 20px;
    margin-bottom: 20px;
    border: 1.5px solid var(--border-gray);
}

.employer-description-block-label {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-gray);
    margin-bottom: 8px;
}

.employer-description-block-text {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-dark);
    font-weight: 500;
    white-space: pre-wrap;
}

.employer-description-edit-group {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1.5px solid var(--border-gray);
    display: none; /* shown only for employer */
}

.employer-description-edit-group.visible {
    display: block;
}

.employer-description-edit-group label {
    display: block;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 8px;
    color: var(--text-dark);
}

.employer-description-edit-group textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1.5px solid var(--border-gray);
    border-radius: var(--radius-md);
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    min-height: 100px;
    transition: var(--transition);
    font-weight: 500;
    color: var(--text-dark);
}

.employer-description-edit-group textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
}

.employer-description-save-btn {
    margin-top: 10px;
    padding: 9px 20px;
    font-size: 14px;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
    color: var(--white);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.employer-description-save-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(37,99,235,0.3);
}

/* In apply modal */
.job-modal-employer-desc {
    background: linear-gradient(135deg, rgba(239,246,255,0.8), rgba(219,234,254,0.4));
    border: 1px solid rgba(37,99,235,0.12);
    border-radius: var(--radius-md);
    padding: 14px 16px;
    margin-top: 12px;
    margin-bottom: 4px;
}

.job-modal-employer-desc-label {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--primary-blue);
    margin-bottom: 6px;
    opacity: 0.85;
}

.job-modal-employer-desc-text {
    font-size: 13px;
    line-height: 1.65;
    color: var(--text-dark);
    font-weight: 500;
    white-space: pre-wrap;
}
</style>

<script>
// ================= EMPLOYER DESCRIPTION ‚Äî JS =================

// ------------------------------------------------------------------
// Load employer description from Firestore users/{userId}
// ------------------------------------------------------------------
async function _loadEmployerDescription(employerId) {
    if (!window.db || !employerId) return null;
    try {
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const snap = await getDoc(doc(window.db, 'users', employerId));
        if (snap.exists()) return snap.data().description || null;
        return null;
    } catch (e) {
        console.warn('[employer-desc] load error:', e);
        return null;
    }
}

// ------------------------------------------------------------------
// Save employer description to Firestore users/{userId}
// ------------------------------------------------------------------
async function _saveEmployerDescription() {
    if (!window.STATE || !window.STATE.currentUser) return;
    if (window.STATE.currentUser.role !== 'employer') return;

    const textarea = document.getElementById('employerDescTextarea');
    if (!textarea) return;
    const desc = textarea.value.trim();

    if (!window.db) {
        showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
    }

    const userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    try {
        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await setDoc(doc(window.db, 'users', userId), { description: desc }, { merge: true });

        // Also cache locally
        window.STATE.currentUser.description = desc;

        showToast('–£—Å–ø–µ—à–Ω–æ', '–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');

        // Refresh the display block
        const displayEl = document.getElementById('employerDescDisplay');
        if (displayEl) {
            if (desc) {
                displayEl.parentElement.style.display = '';
                displayEl.textContent = desc;
            } else {
                displayEl.parentElement.style.display = 'none';
            }
        }
    } catch (e) {
        console.error('[employer-desc] save error:', e);
        showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ', 'error');
    }
}

// ------------------------------------------------------------------
// Inject description UI into the employer profile page
// ------------------------------------------------------------------
async function _injectEmployerDescriptionUI() {
    if (!window.STATE || !window.STATE.currentUser) return;
    if (window.STATE.currentUser.role !== 'employer') return;

    const profileBody = document.querySelector('.profile-body');
    if (!profileBody) return;

    // Remove old block if present
    const old = document.getElementById('employerDescBlock');
    if (old) old.remove();

    const userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    const existingDesc = await _loadEmployerDescription(userId);

    const block = document.createElement('div');
    block.id = 'employerDescBlock';
    block.innerHTML = `
        <!-- Display block -->
        <div id="employerDescDisplayWrapper" style="${existingDesc ? '' : 'display:none'}">
            <div class="employer-description-block">
                <div class="employer-description-block-label">–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
                <div class="employer-description-block-text" id="employerDescDisplay">${existingDesc || ''}</div>
            </div>
        </div>
        <!-- Edit block -->
        <div class="employer-description-edit-group visible">
            <label for="employerDescTextarea">–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
            <textarea id="employerDescTextarea" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å, –∫–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ...">${existingDesc || ''}</textarea>
            <button class="employer-description-save-btn" onclick="_saveEmployerDescription()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>
    `;

    // Insert after the profile-info block
    const profileInfo = profileBody.querySelector('.profile-info');
    if (profileInfo && profileInfo.nextSibling) {
        profileInfo.parentNode.insertBefore(block, profileInfo.nextSibling);
    } else if (profileInfo) {
        profileInfo.parentNode.appendChild(block);
    } else {
        profileBody.appendChild(block);
    }
}

// ------------------------------------------------------------------
// Patch openProfile to inject employer description UI
// ------------------------------------------------------------------
const _origOpenProfileForDesc = window.openProfile || openProfile;
window.openProfile = function() {
    _origOpenProfileForDesc();
    setTimeout(() => {
        if (window.STATE && window.STATE.currentUser && window.STATE.currentUser.role === 'employer') {
            _injectEmployerDescriptionUI();
        }
    }, 150);
};

// ------------------------------------------------------------------
// Patch openApplyModal to show employer description inside job modal
// ------------------------------------------------------------------
const _origOpenApplyModalForDesc = window.openApplyModal || openApplyModal;
window.openApplyModal = async function(jobId, event) {
    await _origOpenApplyModalForDesc(jobId, event);

    // After modal opens, inject employer description if available
    const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
    if (!job) return;

    const employerId = job.employerId || job.employerEmail;
    if (!employerId) return;

    // Load async and inject into the modal body
    try {
        const desc = await _loadEmployerDescription(employerId);
        if (!desc) return;

        const modalBody = document.getElementById('applyModalBody');
        if (!modalBody) return;

        // Find the company/city line to inject after it
        const companyEl = modalBody.querySelector('p[style*="text-gray"]');
        if (companyEl) {
            const descBlock = document.createElement('div');
            descBlock.className = 'job-modal-employer-desc';
            descBlock.innerHTML = `
                <div class="job-modal-employer-desc-label">–û –∫–æ–º–ø–∞–Ω–∏–∏</div>
                <div class="job-modal-employer-desc-text">${desc}</div>
            `;
            companyEl.insertAdjacentElement('afterend', descBlock);
        }
    } catch (e) {
        // Silent ‚Äî non-critical feature
    }
};
</script>

<!-- ================= RESUME SYSTEM ================= -->
<!-- Feature 2: Worker resume
     - "–ú–æ—ë —Ä–µ–∑—é–º–µ" button in worker profile
     - Opens modal with resume form (name, age, city, skills, about)
     - Saves to Firestore users/{userId} as nested object: resume{}
     - Loaded and shown when editing
     Zero changes to existing code. Additive only.
-->
<style>
/* ================= RESUME SYSTEM ‚Äî CSS ================= */

.resume-profile-btn {
    width: 100%;
    margin-bottom: 12px;
    padding: 11px 24px;
    font-size: 15px;
    font-weight: 600;
    background: transparent;
    color: var(--primary-blue);
    border: 1.5px solid var(--primary-blue);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.resume-profile-btn:hover {
    background: var(--soft-blue);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37,99,235,0.15);
}

/* Resume view inside modal */
.resume-view-section {
    margin-bottom: 20px;
}

.resume-view-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-gray);
    gap: 16px;
}

.resume-view-row:last-child {
    border-bottom: none;
}

.resume-view-label {
    font-weight: 700;
    font-size: 13px;
    color: var(--text-gray);
    min-width: 90px;
    flex-shrink: 0;
}

.resume-view-value {
    font-weight: 500;
    font-size: 14px;
    color: var(--text-dark);
    line-height: 1.6;
    text-align: right;
    flex: 1;
}

.resume-skills-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: flex-end;
}

.resume-skill-tag {
    display: inline-block;
    padding: 3px 10px;
    background: var(--soft-blue);
    color: var(--primary-blue);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
}

.resume-empty-notice {
    text-align: center;
    color: var(--text-gray);
    padding: 32px 20px;
    font-size: 14px;
    font-weight: 500;
}

.resume-empty-notice .emoji {
    font-size: 40px;
    display: block;
    margin-bottom: 12px;
}

/* Form inside resume modal */
.resume-form-hint {
    font-size: 13px;
    color: var(--text-gray);
    font-weight: 500;
    margin-bottom: 20px;
    line-height: 1.6;
    padding: 12px;
    background: var(--soft-blue);
    border-radius: var(--radius-sm);
}
</style>

<!-- Resume edit modal -->
<div class="modal" id="resumeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–ú–æ—ë —Ä–µ–∑—é–º–µ</h3>
            <button class="modal-close" onclick="closeModal('resumeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="resume-form-hint">
                –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∑—é–º–µ, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ —É–∑–Ω–∞—Ç—å –æ –≤–∞—Å –±–æ–ª—å—à–µ
            </div>
            <form id="resumeForm">
                <div class="form-group">
                    <label>–ò–º—è</label>
                    <input type="text" id="resumeName" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?">
                </div>
                <div class="form-group">
                    <label>–í–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" id="resumeAge" placeholder="14-18" min="14" max="18">
                </div>
                <div class="form-group">
                    <label>–ì–æ—Ä–æ–¥</label>
                    <input type="text" id="resumeCity" placeholder="–í–∞—à –≥–æ—Ä–æ–¥">
                </div>
                <div class="form-group">
                    <label>–ù–∞–≤—ã–∫–∏</label>
                    <input type="text" id="resumeSkills" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Ä–∞–±–æ—Ç–∞ —Å –∫–∞—Å—Å–æ–π, –ü–ö...">
                </div>
                <div class="form-group">
                    <label>–û —Å–µ–±–µ</label>
                    <textarea id="resumeAbout" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ, —Å–≤–æ—ë–º –æ–ø—ã—Ç–µ, —Ü–µ–ª—è—Ö..." style="min-height: 90px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 4px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—é–º–µ</button>
            </form>
        </div>
    </div>
</div>

<script>
// ================= RESUME SYSTEM ‚Äî JS =================

// ------------------------------------------------------------------
// Load resume from Firestore users/{userId}
// ------------------------------------------------------------------
async function _loadWorkerResume(userId) {
    if (!window.db || !userId) return null;
    try {
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const snap = await getDoc(doc(window.db, 'users', userId));
        if (snap.exists()) return snap.data().resume || null;
        return null;
    } catch (e) {
        console.warn('[resume] load error:', e);
        return null;
    }
}

// ------------------------------------------------------------------
// Save resume to Firestore users/{userId}
// ------------------------------------------------------------------
async function _handleResumeSave(e) {
    e.preventDefault();
    if (!window.STATE || !window.STATE.currentUser) return;

    const resume = {
        name: (document.getElementById('resumeName')?.value || '').trim(),
        age: (document.getElementById('resumeAge')?.value || '').trim(),
        city: (document.getElementById('resumeCity')?.value || '').trim(),
        skills: (document.getElementById('resumeSkills')?.value || '').trim(),
        about: (document.getElementById('resumeAbout')?.value || '').trim(),
        updatedAt: Date.now()
    };

    if (!window.db) {
        showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
    }

    const userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    try {
        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await setDoc(doc(window.db, 'users', userId), { resume }, { merge: true });

        // Cache in memory
        window.STATE.currentUser.resume = resume;

        showToast('–£—Å–ø–µ—à–Ω–æ', '–†–µ–∑—é–º–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
        closeModal('resumeModal');
    } catch (err) {
        console.error('[resume] save error:', err);
        showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—é–º–µ', 'error');
    }
}

// ------------------------------------------------------------------
// Open resume modal for editing (worker self-edit)
// ------------------------------------------------------------------
async function openResumeModal() {
    if (!window.STATE || !window.STATE.currentUser) {
        openModal('loginModal');
        return;
    }
    if (window.STATE.currentUser.role !== 'worker') return;

    const userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    const resume = await _loadWorkerResume(userId);

    // Populate form
    const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
    setVal('resumeName', resume?.name);
    setVal('resumeAge', resume?.age);
    setVal('resumeCity', resume?.city);
    setVal('resumeSkills', resume?.skills);
    setVal('resumeAbout', resume?.about);

    openModal('resumeModal');
}

// ------------------------------------------------------------------
// Bind resume form on DOMContentLoaded
// ------------------------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resumeForm');
    if (form) form.addEventListener('submit', _handleResumeSave);
});

// ------------------------------------------------------------------
// Inject "–ú–æ—ë —Ä–µ–∑—é–º–µ" button into worker profile page
// ------------------------------------------------------------------
function _injectResumeButtonInProfile() {
    if (!window.STATE || !window.STATE.currentUser) return;
    if (window.STATE.currentUser.role !== 'worker') return;

    const profileBody = document.querySelector('.profile-body');
    if (!profileBody) return;

    // Avoid double injection
    if (document.getElementById('resumeProfileBtn')) return;

    const btn = document.createElement('button');
    btn.id = 'resumeProfileBtn';
    btn.className = 'resume-profile-btn';
    btn.innerHTML = 'üìÑ –ú–æ—ë —Ä–µ–∑—é–º–µ';
    btn.onclick = openResumeModal;

    // Insert after the profileForm submit button group ‚Äî find the last btn-secondary in profileForm
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.insertAdjacentElement('afterend', btn);
    } else {
        profileBody.insertBefore(btn, profileBody.firstChild);
    }
}

// ------------------------------------------------------------------
// Patch openProfile to inject resume button for workers
// ------------------------------------------------------------------
const _origOpenProfileForResume = window.openProfile || openProfile;
window.openProfile = function() {
    _origOpenProfileForResume();
    setTimeout(() => {
        if (window.STATE && window.STATE.currentUser && window.STATE.currentUser.role === 'worker') {
            _injectResumeButtonInProfile();
        }
    }, 150);
};
</script>

<!-- ================= RESUME VIEW UI ================= -->
<!-- Feature 3: Employers can view worker resumes
     - "–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ" button in applications list
     - "–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ" button in chat modal (when employer views)
     - Opens read-only resume view modal
     - Only employers see these buttons; workers do not
     Zero changes to existing code. Additive only.
-->
<style>
/* ================= RESUME VIEW UI ‚Äî CSS ================= */

/* Button shown to employers */
.btn-view-resume {
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 700;
    background: var(--soft-blue);
    color: var(--primary-blue);
    border: 1.5px solid rgba(37,99,235,0.25);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.btn-view-resume:hover {
    background: var(--primary-blue);
    color: var(--white);
    border-color: var(--primary-blue);
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(37,99,235,0.2);
}

/* Resume view modal content */
.resume-view-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 22px;
    padding-bottom: 18px;
    border-bottom: 1.5px solid var(--border-gray);
}

.resume-view-avatar {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
    color: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: 700;
    flex-shrink: 0;
}

.resume-view-name-block {
    flex: 1;
}

.resume-view-worker-name {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 3px;
}

.resume-view-worker-meta {
    font-size: 13px;
    color: var(--text-gray);
    font-weight: 500;
}
</style>

<!-- Resume view modal (read-only, for employers) -->
<div class="modal" id="resumeViewModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–†–µ–∑—é–º–µ —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è</h3>
            <button class="modal-close" onclick="closeModal('resumeViewModal')">&times;</button>
        </div>
        <div class="modal-body" id="resumeViewModalBody">
            <div class="resume-empty-notice">
                <span class="emoji">üìÑ</span>
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>
</div>

<script>
// ================= RESUME VIEW UI ‚Äî JS =================

// ------------------------------------------------------------------
// Open resume view modal for a given workerId (employers only)
// ------------------------------------------------------------------
async function viewWorkerResume(workerId, workerName) {
    // Guard: only employers (and admins) can view
    if (!window.STATE || !window.STATE.currentUser) return;
    const role = window.STATE.currentUser.role;
    const isAdminUser = window.ADMIN_EMAILS && window.ADMIN_EMAILS.includes(window.STATE.currentUser.email);
    if (role !== 'employer' && !isAdminUser) {
        showToast('–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç', '–¢–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ä–µ–∑—é–º–µ', 'warning');
        return;
    }

    const body = document.getElementById('resumeViewModalBody');
    if (body) body.innerHTML = '<div class="resume-empty-notice"><span class="emoji">‚è≥</span>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

    openModal('resumeViewModal');

    const resume = await _loadWorkerResume(workerId);

    if (!resume || (!resume.name && !resume.age && !resume.city && !resume.skills && !resume.about)) {
        body.innerHTML = `
            <div class="resume-empty-notice">
                <span class="emoji">üìÑ</span>
                –°–æ–∏—Å–∫–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª —Ä–µ–∑—é–º–µ
            </div>
        `;
        return;
    }

    const initial = (workerName || '–°')[0].toUpperCase();
    const skillTags = resume.skills
        ? resume.skills.split(/[,;]+/).map(s => s.trim()).filter(Boolean)
            .map(s => `<span class="resume-skill-tag">${s}</span>`).join('')
        : '';

    body.innerHTML = `
        <div class="resume-view-header">
            <div class="resume-view-avatar">${initial}</div>
            <div class="resume-view-name-block">
                <div class="resume-view-worker-name">${resume.name || workerName || '–°–æ–∏—Å–∫–∞—Ç–µ–ª—å'}</div>
                <div class="resume-view-worker-meta">
                    ${resume.age ? resume.age + ' –ª–µ—Ç' : ''}
                    ${resume.age && resume.city ? ' ¬∑ ' : ''}
                    ${resume.city || ''}
                </div>
            </div>
        </div>
        <div class="resume-view-section">
            ${resume.skills ? `
            <div class="resume-view-row">
                <div class="resume-view-label">–ù–∞–≤—ã–∫–∏</div>
                <div class="resume-view-value">
                    <div class="resume-skills-wrap">${skillTags}</div>
                </div>
            </div>` : ''}
            ${resume.about ? `
            <div class="resume-view-row">
                <div class="resume-view-label">–û —Å–µ–±–µ</div>
                <div class="resume-view-value" style="white-space:pre-wrap;">${resume.about}</div>
            </div>` : ''}
            ${resume.age ? `
            <div class="resume-view-row">
                <div class="resume-view-label">–í–æ–∑—Ä–∞—Å—Ç</div>
                <div class="resume-view-value">${resume.age} –ª–µ—Ç</div>
            </div>` : ''}
            ${resume.city ? `
            <div class="resume-view-row">
                <div class="resume-view-label">–ì–æ—Ä–æ–¥</div>
                <div class="resume-view-value">${resume.city}</div>
            </div>` : ''}
        </div>
    `;
}

// ------------------------------------------------------------------
// PATCH showApplications: Add "–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ" button per applicant
// ------------------------------------------------------------------
const _origShowApplications = window.showApplications || showApplications;
window.showApplications = async function(jobId) {
    await _origShowApplications(jobId);

    // After the original renders, inject resume view buttons
    // Only if current user is employer
    if (!window.STATE || !window.STATE.currentUser) return;
    if (window.STATE.currentUser.role !== 'employer') return;

    const modalBody = document.getElementById('applicationsModalBody');
    if (!modalBody) return;

    const appItems = modalBody.querySelectorAll('.application-list-item');
    appItems.forEach(item => {
        // Avoid double injection
        if (item.querySelector('.btn-view-resume')) return;

        // Find workerId from the existing "–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç" button onclick
        const chatBtn = item.querySelector('.btn-small.btn-primary');
        if (!chatBtn) return;
        const onclickStr = chatBtn.getAttribute('onclick') || '';
        // openChatFromEmployer('jobId', 'workerId')
        const match = onclickStr.match(/openChatFromEmployer\(['"][^'"]+['"],\s*['"]([^'"]+)['"]\)/);
        if (!match) return;
        const workerId = match[1];

        const workerNameEl = item.querySelector('.application-worker-name');
        const workerName = workerNameEl ? workerNameEl.textContent.trim() : '–°–æ–∏—Å–∫–∞—Ç–µ–ª—å';

        const resumeBtn = document.createElement('button');
        resumeBtn.className = 'btn-view-resume';
        resumeBtn.innerHTML = 'üìÑ –°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ';
        resumeBtn.onclick = () => viewWorkerResume(workerId, workerName);

        // Insert the button in the controls div (next to chat button)
        const controlsDiv = chatBtn.parentElement;
        if (controlsDiv) {
            controlsDiv.appendChild(resumeBtn);
        }
    });
};

// ------------------------------------------------------------------
// PATCH openChat: Inject "–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—é–º–µ" link in chat modal header
// for employer viewing a worker's chat
// ------------------------------------------------------------------
const _origOpenChatForResume = window.openChat || openChat;
window.openChat = async function(jobId, employerId, workerId) {
    await _origOpenChatForResume(jobId, employerId, workerId);

    if (!window.STATE || !window.STATE.currentUser) return;
    if (window.STATE.currentUser.role !== 'employer') return;

    const currentUserId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    // Determine who the "other" user is
    const otherUserId = (currentUserId === employerId) ? workerId : employerId;
    if (!otherUserId || otherUserId === currentUserId) return;

    setTimeout(() => {
        const chatHeader = document.querySelector('#chatModal .modal-header');
        if (!chatHeader || chatHeader.querySelector('.btn-view-resume')) return;

        const btn = document.createElement('button');
        btn.className = 'btn-view-resume';
        btn.innerHTML = 'üìÑ –†–µ–∑—é–º–µ';
        btn.onclick = () => viewWorkerResume(otherUserId, '–°–æ–∏—Å–∫–∞—Ç–µ–ª—å');
        btn.style.marginLeft = 'auto';
        btn.style.marginRight = '8px';
        btn.style.flexShrink = '0';

        // Insert before the close button
        const closeBtn = chatHeader.querySelector('.modal-close');
        if (closeBtn) chatHeader.insertBefore(btn, closeBtn);
        else chatHeader.appendChild(btn);
    }, 200);
};
</script>
<style>
/* ================= FAVORITES SYSTEM ‚Äî CSS ================= */

/* The Heart Button */
.btn-like-floating {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    border: 1.5px solid var(--border-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    color: #cbd5e1; /* Gray by default */
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 5;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.btn-like-floating:hover {
    transform: scale(1.15);
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #fda4af;
}

/* Active State (Red Heart) */
.btn-like-floating.active {
    color: #ef4444;
    border-color: #fee2e2;
    background: #fef2f2;
}

.btn-like-floating.active:hover {
    transform: scale(0.95); /* Press effect */
}

/* Animation for clicking */
@keyframes heartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}

.btn-like-floating.popping {
    animation: heartPop 0.3s ease;
}

/* Favorites Section in Profile */
.favorites-section {
    margin-top: 32px;
    animation: fadeInUp 0.5s ease;
}

.favorites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

/* Mini Job Card for Profile */
.fav-mini-card {
    background: var(--white);
    border: 1.5px solid var(--border-gray);
    border-radius: var(--radius-md);
    padding: 16px;
    position: relative;
    transition: var(--transition);
    cursor: pointer;
}

.fav-mini-card:hover {
    border-color: var(--primary-blue);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.fav-remove-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    color: #ef4444;
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    padding: 4px;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.fav-remove-btn:hover {
    opacity: 1;
    transform: scale(1.1);
}
</style>

<script>
// ================= FAVORITES SYSTEM ‚Äî JS =================

const FAV_STORAGE_KEY = 'teenwork_favorites_v1';

// 1. STATE MANAGEMENT
// Initialize favorites from LocalStorage
window.STATE.favorites = JSON.parse(localStorage.getItem(FAV_STORAGE_KEY) || '[]');

function saveFavorites() {
    localStorage.setItem(FAV_STORAGE_KEY, JSON.stringify(window.STATE.favorites));
}

// 2. TOGGLE FUNCTION
function toggleLike(jobId, btnElement) {
    if (window.event) window.event.stopPropagation();

    const index = window.STATE.favorites.indexOf(jobId);
    const isLiked = index !== -1;

    if (isLiked) {
        // Remove
        window.STATE.favorites.splice(index, 1);
        if (btnElement) {
            btnElement.classList.remove('active');
            btnElement.innerHTML = '‚ô•';
        }
        if (window.showToast) showToast('–£–±—Ä–∞–Ω–æ', '–í–∞–∫–∞–Ω—Å–∏—è —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');
    } else {
        // Add
        window.STATE.favorites.push(jobId);
        if (btnElement) {
            btnElement.classList.add('active', 'popping');
            setTimeout(() => btnElement.classList.remove('popping'), 300);
            btnElement.innerHTML = '‚ù§Ô∏è';
        }
        if (window.showToast) showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', '–í–∞–∫–∞–Ω—Å–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', 'success');
    }

    saveFavorites();

    // If we are in the profile page, refresh the list immediately
    const profilePage = document.getElementById('profilePage');
    if (profilePage && profilePage.classList.contains('active')) {
        renderFavoritesInProfile();
    }
}

// 3. INJECT HEARTS INTO CARDS (PATCH RENDER)
const _origRenderForLikes = window.renderJobs;
window.renderJobs = function() {
    _origRenderForLikes();

    const grid = document.getElementById('jobsGrid');
    if (!grid) return;

    const cards = grid.querySelectorAll('.job-card');

    cards.forEach(card => {
        if (card.querySelector('.btn-like-floating')) return;

        const onclickAttr = card.getAttribute('onclick');
        if (!onclickAttr) return;
        const match = onclickAttr.match(/openApplyModal\(['"]([^'"]+)['"]\)/);
        if (!match) return;
        const jobId = match[1];

        const isLiked = window.STATE.favorites.includes(jobId);

        const hasTopBadge = card.querySelector('.admin-badge');

        const btn = document.createElement('div');
        btn.className = `btn-like-floating ${isLiked ? 'active' : ''}`;
        btn.innerHTML = isLiked ? '‚ù§Ô∏è' : '‚ô•';
        btn.onclick = (e) => { e.stopPropagation(); toggleLike(jobId, btn); };

        if (hasTopBadge) {
            btn.style.top = '54px';
        }

        card.appendChild(btn);
    });
};

// 4. PROFILE SECTION RENDER
function renderFavoritesInProfile() {
    const profileBody = document.querySelector('.profile-body');
    if (!profileBody) return;

    const existing = document.getElementById('profileFavoritesSection');
    if (existing) existing.remove();

    if (window.STATE.favorites.length === 0) return;

    const section = document.createElement('div');
    section.id = 'profileFavoritesSection';
    section.className = 'favorites-section';

    let html = `
        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">
            üíô –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏
        </h3>
        <div class="favorites-grid">
    `;

    window.STATE.favorites.forEach(favId => {
        const job = window.STATE.jobs.find(j => j.id == favId);
        if (job) {
            html += `
                <div class="fav-mini-card" onclick="openApplyModal('${job.id}')">
                    <button class="fav-remove-btn" onclick="toggleLike('${job.id}', null); event.stopPropagation();" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                    <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px; padding-right: 20px;">${job.title}</div>
                    <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 8px;">${job.company}</div>
                    <div style="font-weight: 700; color: var(--primary-blue); font-size: 14px;">${job.salary.toLocaleString('ru-RU')} ‚ÇΩ</div>
                </div>
            `;
        }
    });

    html += `</div>`;
    section.innerHTML = html;

    const infoSection = document.querySelector('.profile-info');
    if (infoSection && infoSection.nextSibling) {
        infoSection.parentNode.insertBefore(section, infoSection.nextSibling);
    } else {
        profileBody.appendChild(section);
    }
}

// Patch openProfile to render favorites
const _origOpenProfileForFavs = window.openProfile;
window.openProfile = function() {
    _origOpenProfileForFavs();
    setTimeout(renderFavoritesInProfile, 100);
};
</script>

<!-- ================= APPLICATION STATUS EXTENSION ================= -->
<!-- Feature 1: Application Status System
     New field: status = "sent" | "viewed" | "accepted" | "rejected" | "archived_hired" | "archived_not_hired"
     - When worker applies ‚Üí status = "sent" (patched applyToJob)
     - When employer opens applications ‚Üí mark unviewed as "viewed" (patched showApplications)
     - Employer can Accept/Reject per application (new buttons in showApplications)
     - Worker profile: shows status badge per application; rejected ‚Üí archive; accepted ‚Üí hired/not-hired buttons
     Zero changes to existing functions. All additive patches.
-->
<style>
/* ================= APPLICATION STATUS EXTENSION ‚Äî CSS ================= */

.app-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.3px;
    flex-shrink: 0;
}

.app-status-sent {
    background: #f1f5f9;
    color: #64748b;
}

.app-status-viewed {
    background: #eff6ff;
    color: #2563eb;
}

.app-status-accepted {
    background: #dcfce7;
    color: #16a34a;
}

.app-status-rejected {
    background: #fee2e2;
    color: #dc2626;
}

.app-status-archived {
    background: #f3f4f6;
    color: #6b7280;
}

/* Employer accept/reject button pair */
.app-decision-btns {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.btn-accept-app {
    padding: 5px 14px;
    font-size: 12px;
    font-weight: 700;
    background: #dcfce7;
    color: #16a34a;
    border: 1.5px solid #86efac;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.btn-accept-app:hover {
    background: #16a34a;
    color: #fff;
    border-color: #16a34a;
}

.btn-reject-app {
    padding: 5px 14px;
    font-size: 12px;
    font-weight: 700;
    background: #fee2e2;
    color: #dc2626;
    border: 1.5px solid #fca5a5;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.btn-reject-app:hover {
    background: #dc2626;
    color: #fff;
    border-color: #dc2626;
}

/* Worker "hired / not hired" outcome buttons */
.btn-hired {
    padding: 6px 16px;
    font-size: 12px;
    font-weight: 700;
    background: #dcfce7;
    color: #16a34a;
    border: 1.5px solid #86efac;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.btn-hired:hover {
    background: #16a34a;
    color: #fff;
}

.btn-not-hired {
    padding: 6px 16px;
    font-size: 12px;
    font-weight: 700;
    background: #f1f5f9;
    color: #64748b;
    border: 1.5px solid #cbd5e1;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.btn-not-hired:hover {
    background: #64748b;
    color: #fff;
}

/* Archive section in worker profile */
.app-archive-section {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1.5px solid var(--border-gray);
}

.app-archive-section h4 {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-gray);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.applied-job-item.archived-item {
    opacity: 0.65;
    background: var(--light-gray);
}
</style>

<script>
// ================= APPLICATION STATUS EXTENSION ‚Äî JS =================

// ------------------------------------------------------------------
// Helpers: update application status in Firestore
// ------------------------------------------------------------------
async function _updateAppStatus(docId, newStatus) {
    if (!window.db || !docId) return;
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'applications', docId), {
            status: newStatus,
            [`statusUpdatedAt_${newStatus}`]: Date.now()
        });
    } catch (e) {
        console.warn('[app-status] updateAppStatus error:', e);
    }
}

// ------------------------------------------------------------------
// Employer: Accept / Reject application (called from showApplications UI)
// ------------------------------------------------------------------
async function _employerDecideApp(docId, decision) {
    if (!['accepted', 'rejected'].includes(decision)) return;
    await _updateAppStatus(docId, decision);
    showToast(
        decision === 'accepted' ? '–ü—Ä–∏–Ω—è—Ç–æ' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ',
        decision === 'accepted' ? '–û—Ç–∫–ª–∏–∫ –ø—Ä–∏–Ω—è—Ç' : '–û—Ç–∫–ª–∏–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω',
        decision === 'accepted' ? 'success' : 'warning'
    );
    // Re-render the applications modal after decision
    const badge = document.querySelector(`[data-appdoc="${docId}"] .app-status-badge`);
    if (badge) {
        badge.className = `app-status-badge app-status-${decision}`;
        badge.textContent = decision === 'accepted' ? '‚úî –ü—Ä–∏–Ω—è—Ç–æ' : '‚úï –û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
    }
    const btns = document.querySelector(`[data-appdoc="${docId}"] .app-decision-btns`);
    if (btns) btns.remove();
}

// ------------------------------------------------------------------
// Worker: "–£—Å—Ç—Ä–æ–∏–ª—Å—è" / "–ù–µ —É—Å—Ç—Ä–æ–∏–ª—Å—è" outcome
// ------------------------------------------------------------------
async function _workerHiredOutcome(docId, hired) {
    const newStatus = hired ? 'archived_hired' : 'archived_not_hired';
    await _updateAppStatus(docId, newStatus);
    showToast(
        hired ? '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!' : '–ü–æ–Ω—è—Ç–Ω–æ',
        hired ? '–û—Ç–º–µ—á–µ–Ω–æ ‚Äî –≤—ã —É—Å—Ç—Ä–æ–∏–ª–∏—Å—å!' : '–û—Ç–∫–ª–∏–∫ –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –∞—Ä—Ö–∏–≤',
        'success'
    );
    // Refresh the applications view
    if (window.renderAppliedJobs) window.renderAppliedJobs();
}

// ------------------------------------------------------------------
// STATUS label helper
// ------------------------------------------------------------------
function _appStatusLabel(status) {
    const map = {
        sent: { text: 'üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', cls: 'app-status-sent' },
        new:  { text: 'üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', cls: 'app-status-sent' },
        viewed: { text: 'üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ', cls: 'app-status-viewed' },
        accepted: { text: '‚úî –ü—Ä–∏–Ω—è—Ç–æ', cls: 'app-status-accepted' },
        rejected: { text: '‚úï –û—Ç–∫–ª–æ–Ω–µ–Ω–æ', cls: 'app-status-rejected' },
        archived_hired: { text: 'üéâ –£—Å—Ç—Ä–æ–∏–ª—Å—è', cls: 'app-status-archived' },
        archived_not_hired: { text: 'üìÅ –ê—Ä—Ö–∏–≤', cls: 'app-status-archived' }
    };
    return map[status] || map['sent'];
}

// ------------------------------------------------------------------
// PATCH applyToJob: set status = "sent"
// ------------------------------------------------------------------
const _origApplyToJob_status = window.applyToJob || applyToJob;
window.applyToJob = async function(jobId) {
    if (!window.db) {
        showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
    }
    const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
    if (!job) return;
    const message = document.getElementById('applicationMessage')?.value || '';
    try {
        const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await addDoc(collection(window.db, 'applications'), {
            jobId: jobId,
            workerId: window.STATE.currentUser.uid || window.STATE.currentUser.email,
            employerId: job.employerId || job.employerEmail,
            workerEmail: window.STATE.currentUser.email,
            workerNickname: window.STATE.currentUser.nickname || '–°–æ–∏—Å–∫–∞—Ç–µ–ª—å',
            message: message,
            createdAt: Date.now(),
            status: 'sent'
        });
        closeModal('applyModal');
        showToast('–£—Å–ø–µ—à–Ω–æ', '–í—ã –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∏—Å—å –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é', 'success');
    } catch (error) {
        console.error('Error applying to job:', error);
        showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è', 'error');
    }
};

// ------------------------------------------------------------------
// PATCH showApplications: mark viewed + add Accept/Reject buttons
// ------------------------------------------------------------------
const _origShowApplications_status = window.showApplications || showApplications;
window.showApplications = async function(jobId) {
    await _origShowApplications_status(jobId);

    if (!window.db) return;
    try {
        const { collection, query, where, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const q = query(collection(window.db, 'applications'), where('jobId', '==', jobId));
        const snapshot = await getDocs(q);

        const modalBody = document.getElementById('applicationsModalBody');
        if (!modalBody) return;

        const appItems = modalBody.querySelectorAll('.application-list-item');
        const docs = [];
        snapshot.forEach(d => docs.push({ id: d.id, ...d.data() }));

        // Mark as viewed and inject UI
        for (const appDoc of docs) {
            // Mark as viewed if not already decided
            if (!appDoc.status || appDoc.status === 'sent' || appDoc.status === 'new') {
                try {
                    await updateDoc(doc(window.db, 'applications', appDoc.id), {
                        status: 'viewed',
                        statusUpdatedAt_viewed: Date.now()
                    });
                    appDoc.status = 'viewed';
                } catch (e) { /* silent */ }
            }

            // Find the matching DOM item by email/name
            appItems.forEach(item => {
                if (item.dataset.appdoc) return; // already processed
                const emailEl = item.querySelector('.application-worker-email');
                if (emailEl && emailEl.textContent.trim() === appDoc.workerEmail) {
                    item.dataset.appdoc = appDoc.id;

                    // Inject status badge at top of item
                    const { text, cls } = _appStatusLabel(appDoc.status || 'viewed');
                    const badge = document.createElement('span');
                    badge.className = `app-status-badge ${cls}`;
                    badge.textContent = text;
                    const nameEl = item.querySelector('.application-worker-name');
                    if (nameEl) {
                        nameEl.style.display = 'flex';
                        nameEl.style.alignItems = 'center';
                        nameEl.style.justifyContent = 'space-between';
                        nameEl.appendChild(badge);
                    }

                    // Inject Accept/Reject buttons if not yet decided
                    const neutral = ['sent', 'new', 'viewed'].includes(appDoc.status || 'viewed');
                    if (neutral) {
                        const decisionDiv = document.createElement('div');
                        decisionDiv.className = 'app-decision-btns';
                        decisionDiv.innerHTML = `
                            <button class="btn-accept-app" onclick="_employerDecideApp('${appDoc.id}', 'accepted')">‚úî –ü—Ä–∏–Ω—è—Ç—å</button>
                            <button class="btn-reject-app" onclick="_employerDecideApp('${appDoc.id}', 'rejected')">‚úï –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        `;
                        const controlsDiv = item.querySelector('[style*="margin-top: 10px"]') || item;
                        controlsDiv.appendChild(decisionDiv);
                    }
                }
            });
        }
    } catch (e) {
        console.warn('[app-status] showApplications patch error:', e);
    }
};

// ------------------------------------------------------------------
// PATCH renderAppliedJobs: show status + hired/not-hired + archive
// ------------------------------------------------------------------
const _origRenderAppliedJobs_status = window.renderAppliedJobs || renderAppliedJobs;
window.renderAppliedJobs = async function() {
    const container = document.getElementById('appliedJobsList');
    if (!container) return;

    if (!window.db) {
        await _origRenderAppliedJobs_status();
        return;
    }

    try {
        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const q = query(
            collection(window.db, 'applications'),
            where('workerId', '==', window.STATE.currentUser.uid || window.STATE.currentUser.email)
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">–í—ã –ø–æ–∫–∞ –Ω–µ –æ—Ç–∫–ª–∏–∫–∞–ª–∏—Å—å –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏</p>';
            return;
        }

        const active = [];
        const archived = [];

        snapshot.forEach(docSnap => {
            const app = { id: docSnap.id, ...docSnap.data() };
            const status = app.status || 'sent';
            if (status === 'archived_hired' || status === 'archived_not_hired' || status === 'rejected') {
                archived.push(app);
            } else {
                active.push(app);
            }
        });

        function buildItem(app, isArchived) {
            const job = window.STATE.jobs.find(j => j.id === app.jobId);
            if (!job) return '';
            const status = app.status || 'sent';
            const { text, cls } = _appStatusLabel(status);

            let extraHTML = '';
            if (status === 'accepted') {
                extraHTML = `
                    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                        <button class="btn-hired" onclick="_workerHiredOutcome('${app.id}', true)">üéâ –£—Å—Ç—Ä–æ–∏–ª—Å—è</button>
                        <button class="btn-not-hired" onclick="_workerHiredOutcome('${app.id}', false)">–ù–µ —É—Å—Ç—Ä–æ–∏–ª—Å—è</button>
                    </div>
                `;
            }

            return `
                <div class="applied-job-item ${isArchived ? 'archived-item' : ''}">
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                            <div class="applied-job-title">${job.title}</div>
                            <span class="app-status-badge ${cls}">${text}</span>
                        </div>
                        <div class="applied-job-company">${job.company}</div>
                        ${extraHTML}
                    </div>
                    ${!isArchived ? `<button class="btn btn-small btn-primary" style="margin-left:12px;flex-shrink:0;" onclick="openChatFromWorker('${app.jobId}', '${app.employerId}')">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>` : ''}
                </div>
            `;
        }

        let html = active.map(a => buildItem(a, false)).join('');

        if (archived.length > 0) {
            html += `
                <div class="app-archive-section">
                    <h4>üìÅ –ê—Ä—Ö–∏–≤ –æ—Ç–∫–ª–∏–∫–æ–≤</h4>
                    ${archived.map(a => buildItem(a, true)).join('')}
                </div>
            `;
        }

        container.innerHTML = html || '<p style="color: var(--text-gray); text-align: center; padding: 20px;">–ù–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤</p>';
    } catch (error) {
        console.error('[app-status] renderAppliedJobs error:', error);
        await _origRenderAppliedJobs_status();
    }
};
</script>

<!-- ================= VERIFIED BADGE ================= -->
<!-- Feature 2: Verified employer badge
     New optional Firestore field on job document: verified = true/false
     If true: show "‚úî –ü—Ä–æ–≤–µ—Ä–µ–Ω" badge on job card (small, clean, next to company name)
     Also show in apply modal header.
     Admin can toggle verified status per vacancy (new button in admin controls).
     Zero structural changes. Additive CSS + JS patches only.
-->
<style>
/* ================= VERIFIED BADGE ‚Äî CSS ================= */

.verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    color: #15803d;
    border: 1px solid rgba(21,128,61,0.2);
    border-radius: 20px;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.2px;
    vertical-align: middle;
    margin-left: 6px;
    flex-shrink: 0;
}

.verified-badge-check {
    font-size: 10px;
    font-weight: 900;
}

/* In apply modal */
.apply-modal-verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    color: #15803d;
    border: 1px solid rgba(21,128,61,0.22);
    border-radius: 20px;
    padding: 3px 10px;
    font-size: 12px;
    font-weight: 700;
    margin-left: 8px;
    vertical-align: middle;
}

/* Admin toggle verified btn */
.btn-verify-toggle {
    padding: 7px 14px;
    font-size: 12px;
    font-weight: 700;
    border-radius: var(--radius-sm);
    border: 1.5px solid rgba(21,128,61,0.3);
    background: #dcfce7;
    color: #15803d;
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
}

.btn-verify-toggle:hover {
    background: #15803d;
    color: #fff;
    border-color: #15803d;
}

.btn-verify-toggle.unverify {
    background: #f1f5f9;
    color: #64748b;
    border-color: #cbd5e1;
}

.btn-verify-toggle.unverify:hover {
    background: #64748b;
    color: #fff;
    border-color: #64748b;
}
</style>

<script>
// ================= VERIFIED BADGE ‚Äî JS =================

// ------------------------------------------------------------------
// PATCH renderJobs: inject verified badge on cards + admin verify btn
// ------------------------------------------------------------------
(function patchRenderJobsForVerified() {
    const _origRender = window.renderJobs;
    if (!_origRender) return;

    window.renderJobs = function() {
        _origRender();

        const grid = document.getElementById('jobsGrid');
        if (!grid) return;

        grid.querySelectorAll('.job-card').forEach(card => {
            if (card.querySelector('.verified-badge')) return;

            const onclickAttr = card.getAttribute('onclick') || '';
            const match = onclickAttr.match(/openApplyModal\(['"]([^'"]+)['"]\)/);
            if (!match) return;
            const jobId = match[1];
            const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
            if (!job) return;

            // Add verified badge next to company name
            if (job.verified) {
                const companyEl = card.querySelector('.job-company');
                if (companyEl && !companyEl.querySelector('.verified-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'verified-badge';
                    badge.innerHTML = '<span class="verified-badge-check">‚úî</span> –ü—Ä–æ–≤–µ—Ä–µ–Ω';
                    companyEl.appendChild(badge);
                }
            }

            // Admin: add "Verify / Unverify" button in admin controls
            if (window.isAdmin && window.isAdmin()) {
                const adminControls = card.querySelector('.admin-controls');
                if (adminControls && !adminControls.querySelector('.btn-verify-toggle')) {
                    const verifyBtn = document.createElement('button');
                    verifyBtn.className = `btn btn-admin btn-verify-toggle ${job.verified ? 'unverify' : ''}`;
                    verifyBtn.textContent = job.verified ? '‚úï –°–Ω—è—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é' : '‚úî –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å';
                    verifyBtn.onclick = (e) => { e.stopPropagation(); _toggleVerified(jobId, !!job.verified); };
                    adminControls.appendChild(verifyBtn);
                }
            }
        });
    };
})();

// ------------------------------------------------------------------
// Admin: toggle verified field on Firestore job
// ------------------------------------------------------------------
async function _toggleVerified(jobId, currentVerified) {
    if (!window.db) {
        showToast('–û—à–∏–±–∫–∞', '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
        return;
    }
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'jobs', jobId), {
            verified: !currentVerified
        });
        showToast('–£—Å–ø–µ—à–Ω–æ', currentVerified ? '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–Ω—è—Ç–∞' : '–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω', 'success');
        if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
    } catch (e) {
        console.error('[verified] toggleVerified error:', e);
        showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å', 'error');
    }
}

// ------------------------------------------------------------------
// PATCH openApplyModal: show verified badge in modal header
// ------------------------------------------------------------------
const _origOpenApplyModal_verified = window.openApplyModal || openApplyModal;
window.openApplyModal = async function(jobId, event) {
    await _origOpenApplyModal_verified(jobId, event);

    const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
    if (!job || !job.verified) return;

    // Find the company line in the modal and append badge
    const modalBody = document.getElementById('applyModalBody');
    if (!modalBody) return;
    const companyEl = modalBody.querySelector('p[style*="text-gray"]');
    if (companyEl && !companyEl.querySelector('.apply-modal-verified-badge')) {
        const badge = document.createElement('span');
        badge.className = 'apply-modal-verified-badge';
        badge.innerHTML = '‚úî –ü—Ä–æ–≤–µ—Ä–µ–Ω';
        companyEl.appendChild(badge);
    }
};
</script>

<!-- ================= EMPTY STATES UI ================= -->
<!-- Feature 3: Enhanced empty states
     - No jobs ‚Üí friendly icon + "–í–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" + subtext
     - No applications (employer) ‚Üí friendly message
     - No employer jobs ‚Üí friendly message
     All are additive overrides of existing empty state strings. Zero logic changes.
-->
<style>
/* ================= EMPTY STATES UI ‚Äî CSS ================= */

/* Enhanced empty state container */
.empty-state-enhanced {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-gray);
    background: var(--white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1.5px dashed var(--border-gray);
    animation: fadeInUp 0.5s ease;
}

.empty-state-enhanced .ese-icon {
    font-size: 60px;
    display: block;
    margin-bottom: 20px;
    opacity: 0.7;
    animation: iconBounce 2s ease-in-out infinite;
}

@keyframes iconBounce {
    0%, 100% { transform: translateY(0); }
    50%       { transform: translateY(-8px); }
}

.empty-state-enhanced .ese-title {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 10px;
}

.empty-state-enhanced .ese-sub {
    font-size: 15px;
    color: var(--text-gray);
    font-weight: 500;
    margin-bottom: 20px;
    line-height: 1.6;
}

.empty-state-enhanced .ese-action {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 9px 22px;
    background: var(--soft-blue);
    color: var(--primary-blue);
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    border: 1.5px solid rgba(37,99,235,0.2);
    transition: var(--transition);
    font-family: inherit;
}

.empty-state-enhanced .ese-action:hover {
    background: var(--primary-blue);
    color: var(--white);
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(37,99,235,0.2);
}

/* Profile list empty state */
.profile-empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-gray);
    border-radius: var(--radius-md);
    background: var(--white);
    border: 1.5px dashed var(--border-gray);
}

.profile-empty-state .pes-icon {
    font-size: 44px;
    display: block;
    margin-bottom: 14px;
    opacity: 0.65;
}

.profile-empty-state .pes-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 8px;
}

.profile-empty-state .pes-sub {
    font-size: 13px;
    color: var(--text-gray);
    font-weight: 500;
    line-height: 1.6;
}
</style>

<script>
// ================= EMPTY STATES UI ‚Äî JS =================

// ------------------------------------------------------------------
// PATCH renderJobs: replace default empty state with enhanced version
// ------------------------------------------------------------------
(function patchRenderJobsEmptyState() {
    const _origRender = window.renderJobs;
    if (!_origRender) return;

    window.renderJobs = function() {
        _origRender();

        const grid = document.getElementById('jobsGrid');
        if (!grid) return;

        // Check if the original rendered an .empty-state
        const oldEmpty = grid.querySelector('.empty-state');
        if (oldEmpty && window.STATE && window.STATE.filteredJobs.length === 0) {
            grid.innerHTML = `
                <div class="empty-state-enhanced" style="grid-column: 1 / -1;">
                    <span class="ese-icon">üîç</span>
                    <div class="ese-title">–í–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                    <div class="ese-sub">–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.</div>
                    <button class="ese-action" onclick="resetFilters()">‚Ü© –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                </div>
            `;
        }
    };
})();

// ------------------------------------------------------------------
// PATCH renderAppliedJobs: enhanced empty state for worker
// Already patched above in app-status ‚Äî we override the empty message
// We add a friendly icon-based empty state if no applications found.
// This runs on DOMContentLoaded as a MutationObserver on the container.
// ------------------------------------------------------------------
(function watchAppliedJobsEmpty() {
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('appliedJobsList');
        if (!container) return;

        const obs = new MutationObserver(() => {
            if (container.innerHTML.trim().includes('–ø–æ–∫–∞ –Ω–µ –æ—Ç–∫–ª–∏–∫–∞–ª–∏—Å—å')) {
                container.innerHTML = `
                    <div class="profile-empty-state">
                        <span class="pes-icon">üìã</span>
                        <div class="pes-title">–û—Ç–∫–ª–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                        <div class="pes-sub">–í—ã –µ—â—ë –Ω–µ –æ—Ç–∫–ª–∏–∫–∞–ª–∏—Å—å –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏.<br>–ù–∞–π–¥–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Ä–∞–±–æ—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–∫–ª–∏–∫!</div>
                    </div>
                `;
            }
        });
        obs.observe(container, { childList: true, subtree: true });
    });
})();

// ------------------------------------------------------------------
// PATCH renderEmployerJobs: enhanced empty state for employer
// ------------------------------------------------------------------
const _origRenderEmployerJobs_empty = window.renderEmployerJobs || renderEmployerJobs;
window.renderEmployerJobs = async function() {
    await _origRenderEmployerJobs_empty();

    const container = document.getElementById('employerJobsList');
    if (!container) return;

    if (container.innerHTML.includes('–Ω–µ —Ä–∞–∑–º–µ—Å—Ç–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π')) {
        container.innerHTML = `
            <div class="profile-empty-state">
                <span class="pes-icon">üì¢</span>
                <div class="pes-title">–í–∞–∫–∞–Ω—Å–∏–π –µ—â—ë –Ω–µ—Ç</div>
                <div class="pes-sub">–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ –ø–µ—Ä–≤—É—é –≤–∞–∫–∞–Ω—Å–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å<br>–ø–æ–ª—É—á–∞—Ç—å –æ—Ç–∫–ª–∏–∫–∏ –æ—Ç —Å–æ–∏—Å–∫–∞—Ç–µ–ª–µ–π.</div>
            </div>
        `;
    }
};

// ------------------------------------------------------------------
// PATCH showApplications: enhanced empty state when no applications
// ------------------------------------------------------------------
const _origShowApplications_empty = window.showApplications || showApplications;
window.showApplications = async function(jobId) {
    await _origShowApplications_empty(jobId);

    const modalBody = document.getElementById('applicationsModalBody');
    if (!modalBody) return;
    if (modalBody.innerHTML.includes('–ù–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤ –Ω–∞ —ç—Ç—É –≤–∞–∫–∞–Ω—Å–∏—é')) {
        modalBody.innerHTML = `
            <div class="profile-empty-state">
                <span class="pes-icon">üì≠</span>
                <div class="pes-title">–û—Ç–∫–ª–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                <div class="pes-sub">–°–æ–∏—Å–∫–∞—Ç–µ–ª–∏ –µ—â—ë –Ω–µ –æ—Ç–∫–ª–∏–∫–∞–ª–∏—Å—å –Ω–∞ —ç—Ç—É –≤–∞–∫–∞–Ω—Å–∏—é.<br>–í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –∑–∞—Ä–ø–ª–∞—Ç—É.</div>
            </div>
        `;
    }
};
</script>

<!-- ================= NEW SORT LOGIC ================= -->
<!-- Feature 4: Sort by date (newest first)
     Adds "–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ" option to existing #sortFilter dropdown.
     Patches applySorting() to handle new "date-desc" sort value.
     No existing sort options removed.
-->
<style>
/* ================= NEW SORT LOGIC ‚Äî CSS ================= */
/* No extra CSS needed ‚Äî uses existing .select styling */
.sort-new-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 700;
    background: #eff6ff;
    color: var(--primary-blue);
    padding: 2px 8px;
    border-radius: 20px;
    margin-left: 6px;
    vertical-align: middle;
}
</style>

<script>
// ================= NEW SORT LOGIC ‚Äî JS =================

// ------------------------------------------------------------------
// Inject "–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ" option into the sort dropdown
// ------------------------------------------------------------------
(function injectDateSortOption() {
    function addOption() {
        const sortFilter = document.getElementById('sortFilter');
        if (!sortFilter) return;
        // Avoid duplicate
        if (sortFilter.querySelector('option[value="date-desc"]')) return;
        const opt = document.createElement('option');
        opt.value = 'date-desc';
        opt.textContent = 'üïê –°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ';
        sortFilter.appendChild(opt);
    }

    document.addEventListener('DOMContentLoaded', addOption);
    // Also try immediately in case DOM is ready
    setTimeout(addOption, 50);
})();

// ------------------------------------------------------------------
// PATCH applySorting: add date-desc handling
// ------------------------------------------------------------------
const _origApplySorting_date = window.applySorting || applySorting;
window.applySorting = function() {
    const sortValue = document.getElementById('sortFilter')?.value;

    if (sortValue === 'date-desc') {
        // Sort by createdAt descending (newest first), keep top jobs first
        window.STATE.filteredJobs.sort((a, b) => {
            if (a.isTop && !b.isTop) return -1;
            if (!a.isTop && b.isTop) return 1;
            // Newest first
            const aTime = a.createdAt || 0;
            const bTime = b.createdAt || 0;
            return bTime - aTime;
        });
        return;
    }

    // For all other sort values, delegate to original
    _origApplySorting_date();
};
</script>

<!-- ================= EXPERIENCE FILTER ================= -->
<!-- Feature 5: "–ë–µ–∑ –æ–ø—ã—Ç–∞" filter
     Adds a checkbox "–ë–µ–∑ –æ–ø—ã—Ç–∞" to the filters section.
     Patches applyFilters() to filter jobs matching:
       - job.type or job.description or job.title contains "–±–µ–∑ –æ–ø—ã—Ç–∞" (case-insensitive)
       - OR job.noExperience === true (explicit field)
     resetFilters() clears the checkbox.
     No existing filter inputs modified.
-->
<style>
/* ================= EXPERIENCE FILTER ‚Äî CSS ================= */

.no-exp-filter-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
    padding: 10px 14px;
    background: var(--light-gray);
    border-radius: var(--radius-md);
    border: 1.5px solid var(--border-gray);
    transition: var(--transition);
    cursor: pointer;
    user-select: none;
}

.no-exp-filter-row:hover {
    border-color: var(--primary-blue);
    background: var(--soft-blue);
}

.no-exp-filter-row.active {
    border-color: var(--primary-blue);
    background: var(--soft-blue);
}

.no-exp-checkbox {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    accent-color: var(--primary-blue);
    cursor: pointer;
    flex-shrink: 0;
}

.no-exp-label {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-dark);
    cursor: pointer;
    flex: 1;
}

.no-exp-sublabel {
    font-size: 12px;
    color: var(--text-gray);
    font-weight: 500;
}

.no-exp-tag {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 8px;
    background: #fef3c7;
    color: #92400e;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
}
</style>

<script>
// ================= EXPERIENCE FILTER ‚Äî JS =================

// ------------------------------------------------------------------
// Inject "–ë–µ–∑ –æ–ø—ã—Ç–∞" checkbox into the filters section
// ------------------------------------------------------------------
(function injectNoExpFilter() {
    function addNoExpFilter() {
        const filtersSection = document.querySelector('.filters-section');
        if (!filtersSection || document.getElementById('noExpFilterRow')) return;

        const row = document.createElement('div');
        row.className = 'no-exp-filter-row';
        row.id = 'noExpFilterRow';
        row.innerHTML = `
            <input type="checkbox" class="no-exp-checkbox" id="noExpCheckbox">
            <label class="no-exp-label" for="noExpCheckbox">
                –ë–µ–∑ –æ–ø—ã—Ç–∞ —Ä–∞–±–æ—Ç—ã
                <span class="no-exp-sublabel"> ‚Äî –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤</span>
            </label>
            <span class="no-exp-tag">üå± –ù–∞—á–∏–Ω–∞—é—â–∏–º</span>
        `;

        // Toggle active class on click for visual feedback
        row.addEventListener('click', function(e) {
            if (e.target.id !== 'noExpCheckbox') {
                const cb = document.getElementById('noExpCheckbox');
                if (cb) cb.checked = !cb.checked;
            }
            row.classList.toggle('active', document.getElementById('noExpCheckbox')?.checked);
            // Trigger filter
            if (window.applyFilters) window.applyFilters();
        });

        // Insert between filters-grid and filter-actions
        const actionsRow = filtersSection.querySelector('.filter-actions');
        const chipsRow = filtersSection.querySelector('#filterChipsRow');
        const insertBefore = chipsRow || actionsRow;
        if (insertBefore) {
            filtersSection.insertBefore(row, insertBefore);
        } else {
            filtersSection.appendChild(row);
        }
    }

    document.addEventListener('DOMContentLoaded', addNoExpFilter);
    setTimeout(addNoExpFilter, 80);
})();

// ------------------------------------------------------------------
// PATCH applyFilters: add noExperience filtering
// ------------------------------------------------------------------
const _origApplyFilters_noexp = window.applyFilters || applyFilters;
window.applyFilters = function() {
    // Call original first
    _origApplyFilters_noexp();

    // Then apply no-experience filter on top of filteredJobs
    const noExpCb = document.getElementById('noExpCheckbox');
    if (!noExpCb || !noExpCb.checked) return;

    const keyword = '–±–µ–∑ –æ–ø—ã—Ç–∞';
    window.STATE.filteredJobs = window.STATE.filteredJobs.filter(job => {
        if (job.noExperience === true) return true;
        const haystack = [
            job.title || '',
            job.description || '',
            job.type || '',
            job.requirements || ''
        ].join(' ').toLowerCase();
        return haystack.includes(keyword);
    });

    // Re-render after additional filtering
    if (window.renderJobs) {
        window.STATE.currentPage = 1;
        window.renderJobs();
    }

    // Update chips row label for noExp
    const chipsRow = document.getElementById('filterChipsRow');
    if (chipsRow && noExpCb.checked && !chipsRow.querySelector('#noExpChip')) {
        const chip = document.createElement('span');
        chip.className = 'filter-chip';
        chip.id = 'noExpChip';
        chip.innerHTML = `üå± –ë–µ–∑ –æ–ø—ã—Ç–∞ <span class="filter-chip-remove">√ó</span>`;
        chip.addEventListener('click', () => {
            const cb = document.getElementById('noExpCheckbox');
            if (cb) cb.checked = false;
            const row = document.getElementById('noExpFilterRow');
            if (row) row.classList.remove('active');
            chip.remove();
            if (window.applyFilters) window.applyFilters();
        });
        chipsRow.appendChild(chip);
    }
};

// ------------------------------------------------------------------
// PATCH resetFilters: clear the noExp checkbox
// ------------------------------------------------------------------
const _origResetFilters_noexp = window.resetFilters || resetFilters;
window.resetFilters = function() {
    const noExpCb = document.getElementById('noExpCheckbox');
    if (noExpCb) noExpCb.checked = false;
    const row = document.getElementById('noExpFilterRow');
    if (row) row.classList.remove('active');
    // Remove chip if exists
    const chip = document.getElementById('noExpChip');
    if (chip) chip.remove();
    _origResetFilters_noexp();
};
</script>



<!-- ================= NOTIFICATIONS SYSTEM ================= -->
<!-- TASK: Full notification system + activity enhancements
     - Firestore collection: notifications (userId, type, text, isRead, createdAt)
     - Triggers: apply->employer, accept/reject->worker, new message->receiver, viewed->worker
     - Navbar bell icon with red unread badge
     - Notifications dropdown modal (realtime onSnapshot)
     - Chat activity: unread counter, last message preview
     - Enhanced lastSeen with activity events
     - Visual improvements throughout
     Zero breaking changes. Additive only.
-->
<style>
/* ================= NOTIFICATIONS SYSTEM CSS ================= */

.notif-bell-btn {
    position: relative;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1.5px solid var(--border-gray);
    background: var(--white);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    flex-shrink: 0;
    animation: bellAppear 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
}

@keyframes bellAppear {
    from { opacity: 0; transform: scale(0.6); }
    to   { opacity: 1; transform: scale(1); }
}

.notif-bell-btn:hover {
    background: var(--soft-blue);
    border-color: var(--primary-blue);
    transform: scale(1.08);
    box-shadow: 0 4px 14px rgba(37,99,235,0.15);
}

.notif-bell-btn.has-unread {
    animation: bellShake 0.5s ease;
}

@keyframes bellShake {
    0%, 100% { transform: rotate(0deg); }
    20%  { transform: rotate(-12deg); }
    40%  { transform: rotate(12deg); }
    60%  { transform: rotate(-8deg); }
    80%  { transform: rotate(8deg); }
}

.notif-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    background: #ef4444;
    color: #fff;
    font-size: 10px;
    font-weight: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    border: 2px solid var(--white);
    pointer-events: none;
    animation: badgePop2 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes badgePop2 {
    from { transform: scale(0); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
}

.notif-badge.notif-hidden {
    display: none;
}

@keyframes badgeFlash2 {
    0%   { background: #fbbf24; transform: scale(1.3); }
    100% { background: #ef4444; transform: scale(1); }
}

.notif-badge.flash {
    animation: badgeFlash2 0.3s ease;
}

.notif-modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 2500;
    background: transparent;
}

.notif-modal-overlay.active {
    display: block;
}

.notif-dropdown {
    position: fixed;
    top: 76px;
    right: 24px;
    width: 380px;
    max-width: calc(100vw - 32px);
    background: var(--white);
    border-radius: var(--radius-xl);
    box-shadow: 0 8px 40px rgba(0,0,0,0.16), 0 2px 8px rgba(0,0,0,0.08);
    z-index: 2501;
    overflow: hidden;
    animation: notifDropIn 0.28s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1.5px solid var(--border-gray);
    max-height: 520px;
    display: flex;
    flex-direction: column;
}

@keyframes notifDropIn {
    from { opacity: 0; transform: translateY(-12px) scale(0.96); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}

.notif-dropdown-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px 14px;
    border-bottom: 1.5px solid var(--border-gray);
    flex-shrink: 0;
}

.notif-dropdown-title {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-dark);
    letter-spacing: -0.3px;
}

.notif-mark-all-btn {
    font-size: 12px;
    font-weight: 600;
    color: var(--primary-blue);
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    transition: var(--transition);
    font-family: inherit;
}

.notif-mark-all-btn:hover {
    background: var(--soft-blue);
}

.notif-list {
    overflow-y: auto;
    flex: 1;
}

.notif-list::-webkit-scrollbar { width: 4px; }
.notif-list::-webkit-scrollbar-track { background: transparent; }
.notif-list::-webkit-scrollbar-thumb { background: var(--border-gray); border-radius: 4px; }

.notif-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 18px;
    cursor: pointer;
    transition: background 0.18s ease;
    border-bottom: 1px solid var(--border-gray);
    position: relative;
    animation: notifSlideIn2 0.3s ease backwards;
}

@keyframes notifSlideIn2 {
    from { opacity: 0; transform: translateX(18px); }
    to   { opacity: 1; transform: translateX(0); }
}

.notif-item:last-child { border-bottom: none; }

.notif-item:hover {
    background: var(--light-gray);
}

.notif-item.unread {
    background: linear-gradient(90deg, rgba(239,246,255,0.8) 0%, rgba(255,255,255,0) 100%);
}

.notif-item.unread:hover {
    background: linear-gradient(90deg, rgba(219,234,254,0.7) 0%, rgba(239,246,255,0.3) 100%);
}

.notif-unread-dot {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--primary-blue);
}

.notif-icon-wrap {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

.notif-icon-application { background: #eff6ff; }
.notif-icon-message     { background: #f0fdf4; }
.notif-icon-status      { background: #fff7ed; }
.notif-icon-system      { background: #f8fafc; }

.notif-content {
    flex: 1;
    min-width: 0;
    padding-right: 18px;
}

.notif-text {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dark);
    line-height: 1.5;
    margin-bottom: 3px;
}

.notif-item.unread .notif-text { font-weight: 700; }

.notif-time {
    font-size: 11px;
    color: var(--text-gray);
    font-weight: 500;
}

.notif-empty {
    padding: 52px 24px;
    text-align: center;
    color: var(--text-gray);
}

.notif-empty-icon {
    font-size: 44px;
    display: block;
    margin-bottom: 14px;
    opacity: 0.55;
}

.notif-empty-text {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 6px;
}

.notif-empty-sub {
    font-size: 12px;
    font-weight: 500;
}

/* ---- Chat Activity CSS ---- */
.chat-unread-badge2 {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 17px;
    height: 17px;
    border-radius: 9px;
    background: #ef4444;
    color: #fff;
    font-size: 9px;
    font-weight: 800;
    padding: 0 3px;
    margin-left: 5px;
    vertical-align: middle;
    animation: badgePop2 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.chat-preview-row {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 3px;
}

.chat-preview-text {
    font-size: 12px;
    color: var(--text-gray);
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 180px;
}

.chat-preview-text.unread-preview {
    font-weight: 700;
    color: var(--primary-blue);
}

.chat-preview-dot {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 15px;
    height: 15px;
    border-radius: 8px;
    background: var(--primary-blue);
    color: #fff;
    font-size: 9px;
    font-weight: 800;
    padding: 0 3px;
    flex-shrink: 0;
}

.applied-job-item.has-unread-chat {
    border-left: 3px solid var(--primary-blue);
    background: linear-gradient(90deg, rgba(239,246,255,0.6) 0%, rgba(255,255,255,0) 100%);
}

/* New message divider */
.new-message-divider {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 8px 0;
}

.new-message-divider::before,
.new-message-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(37,99,235,0.22);
}

.new-message-divider-text {
    font-size: 11px;
    font-weight: 700;
    color: var(--primary-blue);
    white-space: nowrap;
    background: var(--soft-blue);
    padding: 3px 10px;
    border-radius: 20px;
}

/* Avatar notif ring */
@keyframes avatarNotifRing {
    0%   { box-shadow: 0 0 0 0px rgba(239,68,68,0.4); }
    50%  { box-shadow: 0 0 0 5px rgba(239,68,68,0.1); }
    100% { box-shadow: 0 0 0 0px rgba(239,68,68,0); }
}

.user-avatar.notif-ring {
    animation: avatarNotifRing 0.8s ease;
}

/* Enhanced presence color */
.presence-text-online.activity-fresh { color: #15803d !important; }
.presence-dot-online.activity-dot    { background: #15803d !important; }

@media (max-width: 480px) {
    .notif-dropdown { right: 12px; left: 12px; width: auto; top: 70px; }
}
</style>

<script>
// ================= NOTIFICATIONS SYSTEM JS =================

const _NOTIF_STATE = {
    unsubscribe: null,
    count: 0,
    items: [],
    lastSentTs: {},
    activityTimer: null
};

function _notifTimeAgo(ts) {
    if (!ts) return '';
    const diff = Date.now() - ts;
    const sec = Math.floor(diff / 1000);
    if (sec < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    const min = Math.floor(sec / 60);
    if (min < 60) return min + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
    const hr = Math.floor(min / 60);
    if (hr < 24) return hr + ' —á –Ω–∞–∑–∞–¥';
    return Math.floor(hr / 24) + ' –¥ –Ω–∞–∑–∞–¥';
}

function _notifIcon(type) {
    return { application: 'üì©', message: 'üí¨', status: '‚úÖ', system: 'üîî' }[type] || 'üîî';
}

function _notifIconClass(type) {
    return 'notif-icon-' + (type || 'system');
}

async function _createNotification(userId, type, text, dedupKey) {
    if (!window.db || !userId) return;
    const dk = type + '_' + (dedupKey || text);
    const now = Date.now();
    if (_NOTIF_STATE.lastSentTs[dk] && now - _NOTIF_STATE.lastSentTs[dk] < 30000) return;
    _NOTIF_STATE.lastSentTs[dk] = now;
    try {
        const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await addDoc(collection(window.db, 'notifications'), {
            userId: userId, type: type, text: text, isRead: false, createdAt: now
        });
    } catch (e) { console.warn('[notif] create error:', e); }
}

async function _markNotifRead(docId) {
    if (!window.db || !docId) return;
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'notifications', docId), { isRead: true });
    } catch (e) { console.warn('[notif] markRead error:', e); }
}

async function _markAllNotifRead() {
    if (!window.db || !window.STATE || !window.STATE.currentUser) return;
    const userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    if (!userId) return;
    try {
        const { collection, query, where, getDocs, doc, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const q = query(collection(window.db, 'notifications'), where('userId', '==', userId), where('isRead', '==', false));
        const snap = await getDocs(q);
        const batch = writeBatch(window.db);
        snap.forEach(d => batch.update(doc(window.db, 'notifications', d.id), { isRead: true }));
        await batch.commit();
        _NOTIF_STATE.items.forEach(i => { i.isRead = true; });
        _renderNotifDropdown(_NOTIF_STATE.items);
        _updateNotifBadge(0);
    } catch (e) { console.warn('[notif] markAll error:', e); }
}

function _renderNotifDropdown(items) {
    const list = document.getElementById('notifList');
    if (!list) return;
    if (!items || items.length === 0) {
        list.innerHTML = '<div class="notif-empty"><span class="notif-empty-icon">üîî</span><div class="notif-empty-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç</div><div class="notif-empty-sub">–ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div></div>';
        return;
    }
    const sorted = [...items].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    list.innerHTML = sorted.map(function(item, i) {
        return '<div class="notif-item ' + (!item.isRead ? 'unread' : '') + '" style="animation-delay:' + (i * 30) + 'ms" onclick="_handleNotifClick(\'' + item.id + '\', this)">' +
            '<div class="notif-icon-wrap ' + _notifIconClass(item.type) + '">' + _notifIcon(item.type) + '</div>' +
            '<div class="notif-content"><div class="notif-text">' + item.text + '</div><div class="notif-time">' + _notifTimeAgo(item.createdAt) + '</div></div>' +
            (!item.isRead ? '<div class="notif-unread-dot"></div>' : '') +
            '</div>';
    }).join('');
}

function _handleNotifClick(docId, el) {
    if (!docId) return;
    _markNotifRead(docId);
    if (el) {
        el.classList.remove('unread');
        var dot = el.querySelector('.notif-unread-dot');
        if (dot) dot.remove();
    }
    _NOTIF_STATE.count = Math.max(0, _NOTIF_STATE.count - 1);
    _updateNotifBadge(_NOTIF_STATE.count);
}

function _updateNotifBadge(count) {
    var prev = _NOTIF_STATE.count;
    _NOTIF_STATE.count = count;
    var badge = document.getElementById('notifBadge');
    if (!badge) return;
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : String(count);
        badge.classList.remove('notif-hidden');
        if (count > prev) {
            badge.classList.remove('flash');
            void badge.offsetWidth;
            badge.classList.add('flash');
            setTimeout(function() { badge.classList.remove('flash'); }, 350);
        }
        var btn = document.getElementById('notifBellBtn');
        if (btn) {
            btn.classList.add('has-unread');
            clearTimeout(btn._shakeTimer);
            btn._shakeTimer = setTimeout(function() { btn.classList.remove('has-unread'); }, 600);
        }
        var avatar = document.querySelector('.user-avatar');
        if (avatar) {
            avatar.classList.add('notif-ring');
            clearTimeout(avatar._ringTimer);
            avatar._ringTimer = setTimeout(function() { avatar.classList.remove('notif-ring'); }, 900);
        }
    } else {
        badge.classList.add('notif-hidden');
    }
}

async function _startNotifListener() {
    if (!window.db || !window.STATE || !window.STATE.currentUser) return;
    if (_NOTIF_STATE.unsubscribe) { _NOTIF_STATE.unsubscribe(); _NOTIF_STATE.unsubscribe = null; }
    var userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    if (!userId) return;
    try {
        const { collection, query, where, orderBy, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        var q = query(collection(window.db, 'notifications'), where('userId', '==', userId), orderBy('createdAt', 'desc'));
        _NOTIF_STATE.unsubscribe = onSnapshot(q, function(snap) {
            var items = [];
            var unread = 0;
            snap.forEach(function(d) {
                var data = Object.assign({ id: d.id }, d.data());
                items.push(data);
                if (!data.isRead) unread++;
            });
            _NOTIF_STATE.items = items;
            _updateNotifBadge(unread);
            var overlay = document.getElementById('notifOverlay');
            if (overlay && overlay.classList.contains('active')) _renderNotifDropdown(items);
        }, function(err) { console.warn('[notif] listener error:', err); });
    } catch (e) { console.warn('[notif] startListener error:', e); }
}

function _stopNotifListener() {
    if (_NOTIF_STATE.unsubscribe) { _NOTIF_STATE.unsubscribe(); _NOTIF_STATE.unsubscribe = null; }
}

function _toggleNotifDropdown() {
    var overlay = document.getElementById('notifOverlay');
    if (!overlay) return;
    if (overlay.classList.contains('active')) {
        overlay.classList.remove('active');
    } else {
        overlay.classList.add('active');
        _renderNotifDropdown(_NOTIF_STATE.items);
    }
}

function _injectNotifBell() {
    if (document.getElementById('notifBellBtn')) return;
    var bell = document.createElement('div');
    bell.id = 'notifBellBtn';
    bell.className = 'notif-bell-btn';
    bell.title = '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
    bell.innerHTML = 'üîî<span class="notif-badge notif-hidden" id="notifBadge">0</span>';
    bell.onclick = function(e) { e.stopPropagation(); _toggleNotifDropdown(); };
    var navActions = document.getElementById('navActions');
    if (!navActions) return;
    var profileWrapper = navActions.querySelector('.nav-profile-wrapper');
    if (profileWrapper) navActions.insertBefore(bell, profileWrapper);
    else navActions.appendChild(bell);
}

function _injectNotifOverlay() {
    if (document.getElementById('notifOverlay')) return;
    var overlay = document.createElement('div');
    overlay.className = 'notif-modal-overlay';
    overlay.id = 'notifOverlay';
    overlay.onclick = function(e) { if (e.target === overlay) overlay.classList.remove('active'); };
    overlay.innerHTML = '<div class="notif-dropdown" id="notifDropdown"><div class="notif-dropdown-header"><div class="notif-dropdown-title">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div><button class="notif-mark-all-btn" onclick="_markAllNotifRead()">–í—Å—ë –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</button></div><div class="notif-list" id="notifList"><div class="notif-empty"><span class="notif-empty-icon">üîî</span><div class="notif-empty-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç</div><div class="notif-empty-sub">–ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div></div></div></div>';
    document.body.appendChild(overlay);
}

// Patch updateNavbar to inject bell
var _origUpdateNavbar_n = window.updateNavbar || updateNavbar;
window.updateNavbar = function() {
    _origUpdateNavbar_n();
    if (window.STATE && window.STATE.currentUser) {
        setTimeout(function() { _injectNotifBell(); _startNotifListener(); }, 60);
    }
};

// Patch logout
var _origLogout_n = window.logout || logout;
window.logout = function() {
    _stopNotifListener();
    _NOTIF_STATE.count = 0; _NOTIF_STATE.items = []; _NOTIF_STATE.lastSentTs = {};
    _origLogout_n();
};

// ==================== NOTIFICATION TRIGGERS ====================

// TRIGGER 1: Worker applies -> notify employer
var _origApplyToJob_n = window.applyToJob || applyToJob;
window.applyToJob = async function(jobId) {
    await _origApplyToJob_n(jobId);
    try {
        var job = window.STATE && window.STATE.jobs.find(function(j) { return j.id === jobId; });
        if (!job) return;
        var employerId = job.employerId || job.employerEmail;
        if (!employerId) return;
        var workerName = window.STATE.currentUser.nickname || '–°–æ–∏—Å–∫–∞—Ç–µ–ª—å';
        await _createNotification(employerId, 'application', 'üì© ' + workerName + ' –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é ¬´' + job.title + '¬ª', 'apply_' + jobId + '_' + (window.STATE.currentUser.uid || window.STATE.currentUser.email));
    } catch (e) { console.warn('[notif] applyTrigger error:', e); }
};

// TRIGGER 2: Employer decides (accept/reject) -> notify worker
var _origEmpDecide_n = window._employerDecideApp;
window._employerDecideApp = async function(docId, decision) {
    if (_origEmpDecide_n) await _origEmpDecide_n(docId, decision);
    try {
        if (!window.db) return;
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        var appSnap = await getDoc(doc(window.db, 'applications', docId));
        if (!appSnap.exists()) return;
        var app = appSnap.data();
        var workerId = app.workerId;
        if (!workerId) return;
        var job = window.STATE && window.STATE.jobs.find(function(j) { return j.id === app.jobId; });
        var jobTitle = job ? job.title : '–≤–∞–∫–∞–Ω—Å–∏—é';
        var text = decision === 'accepted' ? '‚úÖ –í–∞—à –æ—Ç–∫–ª–∏–∫ –Ω–∞ ¬´' + jobTitle + '¬ª –ø—Ä–∏–Ω—è—Ç —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–º!' : '‚ùå –í–∞—à –æ—Ç–∫–ª–∏–∫ –Ω–∞ ¬´' + jobTitle + '¬ª –æ—Ç–∫–ª–æ–Ω—ë–Ω —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–º';
        await _createNotification(workerId, 'status', text, 'decide_' + docId + '_' + decision);
    } catch (e) { console.warn('[notif] decideNotif error:', e); }
};

// TRIGGER 3: Application viewed -> notify worker
async function _notifyWorkerViewed(workerId, jobTitle) {
    if (!workerId || !jobTitle) return;
    await _createNotification(workerId, 'status', 'üëÅÔ∏è –†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª –≤–∞—à –æ—Ç–∫–ª–∏–∫ –Ω–∞ ¬´' + jobTitle + '¬ª', 'viewed_' + workerId + '_' + jobTitle);
}

// TRIGGER 4: New chat message -> notify receiver
async function _notifyChatMessage(chatId, senderName) {
    if (!window.db || !chatId) return;
    try {
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        var chatSnap = await getDoc(doc(window.db, 'chats', chatId));
        if (!chatSnap.exists()) return;
        var chat = chatSnap.data();
        var senderId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
        var receiverId = (senderId === chat.employerId) ? chat.workerId : chat.employerId;
        if (!receiverId || receiverId === senderId) return;
        var job = window.STATE && window.STATE.jobs.find(function(j) { return j.id === chat.jobId; });
        var jobTitle = job ? job.title : '–≤–∞–∫–∞–Ω—Å–∏—é';
        await _createNotification(receiverId, 'message', 'üí¨ ' + senderName + ' –Ω–∞–ø–∏—Å–∞–ª(–∞) –≤–∞–º –ø–æ –≤–∞–∫–∞–Ω—Å–∏–∏ ¬´' + jobTitle + '¬ª', 'msg_' + chatId + '_' + senderId);
    } catch (e) { console.warn('[notif] chatMsgTrigger error:', e); }
}

var _origSendChat_n = window.sendChatMessage || sendChatMessage;
window.sendChatMessage = async function() {
    await _origSendChat_n();
    if (window.STATE && window.STATE.currentChatId && window.STATE.currentUser) {
        var name = window.STATE.currentUser.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        setTimeout(function() { _notifyChatMessage(window.STATE.currentChatId, name); }, 200);
    }
};

// Patch showApplications to notify viewed
var _origShowApps_n = window.showApplications;
window.showApplications = async function(jobId) {
    await _origShowApps_n(jobId);
    try {
        if (!window.db) return;
        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        var q = query(collection(window.db, 'applications'), where('jobId', '==', jobId));
        var snap = await getDocs(q);
        var job = window.STATE && window.STATE.jobs.find(function(j) { return j.id === jobId; });
        var jobTitle = job ? job.title : '–≤–∞–∫–∞–Ω—Å–∏—é';
        snap.forEach(function(d) {
            var app = d.data();
            if (app.status === 'viewed' && app.statusUpdatedAt_viewed && Date.now() - app.statusUpdatedAt_viewed < 5000) {
                _notifyWorkerViewed(app.workerId, jobTitle);
            }
        });
    } catch (e) { console.warn('[notif] viewedNotif error:', e); }
};

// Patch image/voice send to also notify
var _origImgUpload_n = window.handleChatImageSelected;
if (_origImgUpload_n) {
    window.handleChatImageSelected = async function(e) {
        await _origImgUpload_n(e);
        if (window.STATE && window.STATE.currentChatId && window.STATE.currentUser) {
            setTimeout(function() { _notifyChatMessage(window.STATE.currentChatId, window.STATE.currentUser.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'); }, 300);
        }
    };
}

var _origVoiceStop_n = window.handleVoiceRecordingStop;
if (_origVoiceStop_n) {
    window.handleVoiceRecordingStop = async function() {
        await _origVoiceStop_n();
        if (window.STATE && window.STATE.currentChatId && window.STATE.currentUser) {
            setTimeout(function() { _notifyChatMessage(window.STATE.currentChatId, window.STATE.currentUser.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'); }, 300);
        }
    };
}

// Close dropdown on outside click
document.addEventListener('click', function(e) {
    var overlay = document.getElementById('notifOverlay');
    if (!overlay || !overlay.classList.contains('active')) return;
    var dropdown = document.getElementById('notifDropdown');
    var bell = document.getElementById('notifBellBtn');
    if (dropdown && dropdown.contains(e.target)) return;
    if (bell && bell.contains(e.target)) return;
    overlay.classList.remove('active');
}, true);

// Init
document.addEventListener('DOMContentLoaded', function() {
    _injectNotifOverlay();
    var check = setInterval(function() {
        if (window.db && window.STATE && window.STATE.currentUser) {
            clearInterval(check);
            _injectNotifBell();
            _startNotifListener();
        }
    }, 500);
    setTimeout(function() { clearInterval(check); }, 15000);
});

// Patch handleLogin + handleRegister
var _origHLogin_n = window.handleLogin || handleLogin;
window.handleLogin = function(e) {
    _origHLogin_n(e);
    setTimeout(function() {
        _injectNotifOverlay();
        if (window.STATE && window.STATE.currentUser) { _injectNotifBell(); _startNotifListener(); }
    }, 400);
};

var _origHReg_n = window.handleRegister || handleRegister;
window.handleRegister = function(e) {
    _origHReg_n(e);
    setTimeout(function() {
        _injectNotifOverlay();
        if (window.STATE && window.STATE.currentUser) { _injectNotifBell(); _startNotifListener(); }
    }, 400);
};
</script>

<!-- ================= REALTIME LISTENERS ================= -->
<!-- Chat activity: unread counter per chat, last message preview -->
<script>
// ================= REALTIME LISTENERS JS =================

async function _getChatActivity(chatId, currentUserId) {
    if (!window.db || !chatId) return { lastMsg: null, unread: 0 };
    try {
        const { collection, query, where, orderBy, getDocs, limit } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        var q = query(collection(window.db, 'messages'), where('chatId', '==', chatId), orderBy('createdAt', 'desc'), limit(20));
        var snap = await getDocs(q);
        var unread = 0, lastMsg = null;
        snap.forEach(function(d) {
            var m = d.data();
            if (!lastMsg) lastMsg = m.imageUrl ? 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : m.audioUrl ? 'üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–µ' : (m.text || '');
            if (m.senderId !== currentUserId && m.read === false) unread++;
        });
        return { lastMsg: lastMsg, unread: unread };
    } catch (e) { return { lastMsg: null, unread: 0 }; }
}

// Patch renderAppliedJobs to add chat preview + unread counter
var _origRenderApplied_act = window.renderAppliedJobs;
window.renderAppliedJobs = async function() {
    await _origRenderApplied_act();
    if (!window.STATE || !window.STATE.currentUser || !window.db) return;
    var currentUserId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    if (!currentUserId) return;
    var container = document.getElementById('appliedJobsList');
    if (!container) return;
    try {
        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        var appsQ = query(collection(window.db, 'applications'), where('workerId', '==', currentUserId));
        var appsSnap = await getDocs(appsQ);
        var apps = [];
        appsSnap.forEach(function(d) { apps.push(Object.assign({ id: d.id }, d.data())); });
        for (var i = 0; i < apps.length; i++) {
            var app = apps[i];
            var chatsQ = query(collection(window.db, 'chats'), where('jobId', '==', app.jobId), where('workerId', '==', currentUserId));
            var chatsSnap = await getDocs(chatsQ);
            if (chatsSnap.empty) continue;
            var chatId = chatsSnap.docs[0].id;
            var activity = await _getChatActivity(chatId, currentUserId);
            var job = window.STATE.jobs.find(function(j) { return j.id === app.jobId; });
            if (!job) continue;
            var allItems = container.querySelectorAll('.applied-job-item:not(.archived-item)');
            allItems.forEach(function(item) {
                if (item.dataset.actDone) return;
                var titleEl = item.querySelector('.applied-job-title');
                if (!titleEl || titleEl.textContent.trim() !== job.title) return;
                item.dataset.actDone = '1';
                if (activity.lastMsg) {
                    var companyEl = item.querySelector('.applied-job-company');
                    if (companyEl && !companyEl.nextElementSibling?.classList.contains('chat-preview-row')) {
                        var pr = document.createElement('div');
                        pr.className = 'chat-preview-row';
                        var previewTxt = activity.lastMsg.slice(0, 38) + (activity.lastMsg.length > 38 ? '‚Ä¶' : '');
                        pr.innerHTML = '<span class="chat-preview-text ' + (activity.unread > 0 ? 'unread-preview' : '') + '">' + previewTxt + '</span>' + (activity.unread > 0 ? '<span class="chat-preview-dot">' + activity.unread + '</span>' : '');
                        companyEl.insertAdjacentElement('afterend', pr);
                    }
                }
                if (activity.unread > 0) {
                    item.classList.add('has-unread-chat');
                    var chatBtn = item.querySelector('.btn-small.btn-primary');
                    if (chatBtn && !chatBtn.querySelector('.chat-unread-badge2')) {
                        var b2 = document.createElement('span');
                        b2.className = 'chat-unread-badge2';
                        b2.textContent = String(activity.unread);
                        chatBtn.appendChild(b2);
                    }
                }
            });
        }
    } catch (e) { console.warn('[activity] renderApplied patch error:', e); }
};
</script>

<!-- ================= ACTIVITY SYSTEM ================= -->
<!-- Enhanced lastSeen: updates on user interaction. Debounced 30s. -->
<script>
// ================= ACTIVITY SYSTEM JS =================

(function _setupActivityTracking() {
    var _lastWrite = 0;
    var _WRITE_INTERVAL = 30000;
    var _actDebounce = null;

    async function _writeActivity() {
        if (!window.STATE || !window.STATE.currentUser) return;
        var now = Date.now();
        if (now - _lastWrite < _WRITE_INTERVAL) return;
        _lastWrite = now;
        if (!window.db) return;
        var userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
        if (!userId) return;
        try {
            const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
            await setDoc(doc(window.db, 'users', userId), { isOnline: true, lastSeen: now, lastActivity: now }, { merge: true });
        } catch (e) { /* silent */ }
    }

    function _onActivity() {
        clearTimeout(_actDebounce);
        _actDebounce = setTimeout(_writeActivity, 2000);
    }

    ['click', 'keypress', 'mousemove', 'touchstart', 'scroll'].forEach(function(evt) {
        document.addEventListener(evt, _onActivity, { passive: true });
    });

    // Enhance presence subscription: if lastSeen < 60s, treat as online
    var _origSub = window._subscribeToPresence;
    if (_origSub) {
        window._subscribeToPresence = async function(userId, callback) {
            return _origSub(userId, function(isOnline, lastSeen) {
                if (!isOnline && lastSeen && Date.now() - lastSeen < 60000) callback(true, lastSeen);
                else callback(isOnline, lastSeen);
            });
        };
    }
})();

// Improve _formatLastSeen
(function _improveLastSeenFormat() {
    var _origFmt = window._formatLastSeen;
    wifndow._formatLastSeen = function(ts) {
        if (!ts) return '';
        var diff = Date.now() - ts;
        var sec = Math.floor(diff / 1000);
        if (sec < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        var min = Math.floor(sec / 60);
        if (min < 60) return min + ' –º–∏–Ω –Ω–∞–∑–∞–¥';
        var hr = Math.floor(min / 60);
        if (hr < 24) return hr + ' —á –Ω–∞–∑–∞–¥';
        if (_origFmt) return _origFmt(ts);
        var d = new Date(ts);
        var pad = function(n) { return String(n).padStart(2, '0'); };
        return pad(d.getDate()) + '.' + pad(d.getMonth() + 1) + ' –≤ ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    };
})();

// Enhance presence bar after injection
var _origInjectBar = window._injectPresenceBar;
if (_origInjectBar) {
    window._injectPresenceBar = function(otherUserId) {
        _origInjectBar(otherUserId);
        setTimeout(function() {
            var dot = document.getElementById('presenceDot');
            var text = document.getElementById('presenceText');
            if (dot && dot.classList.contains('presence-dot-online')) dot.classList.add('activity-dot');
            if (text && text.classList.contains('presence-text-online')) text.classList.add('activity-fresh');
        }, 300);
    };
}

console.log('[TeenWork] Notification + Activity system v1.0 loaded');
</script>


</body>
</html>
