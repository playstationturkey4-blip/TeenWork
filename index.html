<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeenWork — Работа для подростков 14-18 лет</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563eb;
            --blue-hover: #1d4ed8;
            --blue-light: #3b82f6;
            --soft-blue: #eff6ff;
            --light-gray: #f8fafc;
            --border-gray: #e2e8f0;
            --text-dark: #0f172a;
            --text-gray: #64748b;
            --white: #ffffff;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --max-width: 1280px;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light-gray);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            opacity: 0;
            animation: fadeInPage 0.4s ease forwards;
        }

        @keyframes fadeInPage {
            to { opacity: 1; }
        }

        .nav {
            position: sticky;
            top: 0;
            background: var(--white);
            box-shadow: var(--shadow-sm);
            z-index: 1000;
            padding: 16px 0;
            transition: var(--transition);
        }

        .nav.scrolled {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-md);
        }

        .nav-container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 30px;
            font-weight: 800;
            color: var(--primary-blue);
            letter-spacing: -1px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--blue-light));
            transition: width 0.4s ease;
            border-radius: 2px;
        }

        .logo:hover::after {
            width: 100%;
        }

        .logo:hover {
            transform: translateY(-1px);
            filter: drop-shadow(0 4px 8px rgba(37, 99, 235, 0.3));
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .nav-profile-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            transition: var(--transition);
        }

        .nav-profile-wrapper:hover {
            background: var(--light-gray);
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            transition: var(--transition);
            border: 2px solid transparent;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .nav-profile-wrapper:hover .user-avatar {
            border-color: var(--primary-blue);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .nav-profile-text {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-dark);
        }

        .btn {
            padding: 11px 24px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.35);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-dark);
            border: 1.5px solid var(--border-gray);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--light-gray);
            border-color: var(--text-gray);
        }

        .btn-small {
            padding: 7px 16px;
            font-size: 13px;
        }

        .hero {
            background: linear-gradient(135deg, #1e40af 0%, var(--primary-blue) 50%, var(--blue-light) 100%);
            color: var(--white);
            padding: 100px 24px 120px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .hero-content {
            max-width: 850px;
            margin: 0 auto;
            animation: fadeInUp 0.7s ease;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero h1 {
            font-size: 58px;
            font-weight: 800;
            margin-bottom: 24px;
            line-height: 1.1;
            letter-spacing: -2px;
            animation: fadeInUp 0.7s ease 0.1s backwards;
        }

        .hero p {
            font-size: 21px;
            margin-bottom: 40px;
            opacity: 0.95;
            font-weight: 500;
            line-height: 1.7;
            animation: fadeInUp 0.7s ease 0.2s backwards;
        }

        .hero-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            animation: fadeInUp 0.7s ease 0.3s backwards;
        }

        .btn-hero {
            padding: 16px 36px;
            font-size: 17px;
            border-radius: var(--radius-lg);
            font-weight: 700;
        }

        .btn-white {
            background: var(--white);
            color: var(--primary-blue);
        }

        .btn-white:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--white);
            border: 2.5px solid var(--white);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px;
        }

        .filters-section {
            background: var(--white);
            padding: 36px 28px;
            margin-top: -60px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            position: relative;
            z-index: 10;
            animation: fadeInUp 0.6s ease 0.4s backwards;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-bottom: 18px;
        }

        .input, .select {
            width: 100%;
            padding: 13px 18px;
            border: 1.5px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: var(--transition);
            background: var(--white);
            font-weight: 500;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        .sort-dropdown {
            margin-left: auto;
            min-width: 200px;
        }

        .jobs-section {
            padding: 70px 0;
        }

        .section-header {
            margin-bottom: 36px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-header h2 {
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .section-info {
            color: var(--text-gray);
            font-size: 16px;
            font-weight: 500;
        }

        .jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .job-card {
            background: var(--white);
            padding: 26px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            animation: fadeIn 0.5s ease backwards;
        }

        .job-card:nth-child(1) { animation-delay: 0.05s; }
        .job-card:nth-child(2) { animation-delay: 0.1s; }
        .job-card:nth-child(3) { animation-delay: 0.15s; }
        .job-card:nth-child(4) { animation-delay: 0.2s; }
        .job-card:nth-child(5) { animation-delay: 0.25s; }
        .job-card:nth-child(6) { animation-delay: 0.3s; }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .job-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
        }

        .job-header {
            margin-bottom: 18px;
        }

        .job-title {
            font-size: 21px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .job-company {
            color: var(--text-gray);
            font-size: 15px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .job-location {
            color: var(--text-gray);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .job-details {
            margin-bottom: 18px;
        }

        .job-salary {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 14px;
        }

        .job-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 18px;
        }

        .tag {
            padding: 7px 14px;
            background: var(--soft-blue);
            color: var(--primary-blue);
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
        }

        .job-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-top: 18px;
            border-top: 1.5px solid var(--border-gray);
        }

        .btn-apply {
            padding: 9px 22px;
            font-size: 14px;
        }

        .info-section {
            padding: 90px 0;
            background: var(--white);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 32px;
            margin-top: 56px;
        }

        .info-card {
            padding: 36px;
            background: var(--light-gray);
            border-radius: var(--radius-lg);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .info-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-md);
            border-color: var(--soft-blue);
            background: var(--white);
        }

        .info-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--soft-blue), #dbeafe);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 24px;
            transition: var(--transition);
        }

        .info-card:hover .info-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .info-card h3 {
            font-size: 21px;
            margin-bottom: 14px;
            font-weight: 700;
        }

        .info-card p {
            color: var(--text-gray);
            line-height: 1.7;
            font-weight: 500;
        }

        .faq-section {
            padding: 90px 0;
        }

        .faq-list {
            max-width: 850px;
            margin: 56px auto 0;
        }

        .faq-item {
            background: var(--white);
            border-radius: var(--radius-lg);
            margin-bottom: 18px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .faq-item:hover {
            box-shadow: var(--shadow-md);
        }

        .faq-question {
            padding: 22px 26px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 16px;
            transition: var(--transition);
            user-select: none;
        }

        .faq-question:hover {
            background: var(--light-gray);
        }

        .faq-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
            flex-shrink: 0;
            color: var(--primary-blue);
        }

        .faq-item.active .faq-icon {
            transform: rotate(180deg);
        }

        .faq-item.active .faq-question {
            background: var(--soft-blue);
            color: var(--primary-blue);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .faq-answer-content {
            padding: 0 26px 22px;
            color: var(--text-gray);
            line-height: 1.8;
            font-weight: 500;
        }

        .footer {
            background: var(--text-dark);
            color: var(--white);
            padding: 60px 0 28px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-section h4 {
            margin-bottom: 18px;
            font-size: 17px;
            font-weight: 700;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
        }

        .footer-links a:hover {
            color: var(--white);
            padding-left: 4px;
        }

        .footer-bottom {
            padding-top: 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(6px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal.hiding .modal-content {
            animation: modalSlideOut 0.3s ease forwards;
        }

        @keyframes modalSlideOut {
            to {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
        }

        .modal-header {
            padding: 28px;
            border-bottom: 1.5px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .modal-close {
            background: var(--light-gray);
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-gray);
            transition: var(--transition);
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: var(--border-gray);
            color: var(--text-dark);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 28px;
        }

        .form-group {
            margin-bottom: 22px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 13px 18px;
            border: 1.5px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: var(--transition);
            font-weight: 500;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 110px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .form-error {
            color: var(--error);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            font-weight: 600;
        }

        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: var(--error);
        }

        .form-group.error .form-error {
            display: block;
        }

        .password-toggle {
            position: absolute;
            right: 18px;
            top: 42px;
            cursor: pointer;
            color: var(--text-gray);
            font-size: 18px;
            user-select: none;
        }

        .password-toggle:hover {
            color: var(--text-dark);
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: var(--text-gray);
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .empty-state-icon {
            font-size: 72px;
            margin-bottom: 24px;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 26px;
            margin-bottom: 14px;
            color: var(--text-dark);
            font-weight: 700;
        }

        .empty-state p {
            font-weight: 500;
        }

        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--white);
            padding: 18px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: start;
            gap: 14px;
            min-width: 320px;
            max-width: 420px;
            animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 4px solid;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(450px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideOutRight {
            to {
                transform: translateX(450px);
                opacity: 0;
            }
        }

        .toast-icon {
            font-size: 26px;
            flex-shrink: 0;
            line-height: 1;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--text-gray);
            line-height: 1.5;
            font-weight: 500;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.error .toast-icon {
            color: var(--error);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 48px;
        }

        .pagination-btn {
            padding: 10px 18px;
            border: 1.5px solid var(--border-gray);
            background: var(--white);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--light-gray);
            border-color: var(--primary-blue);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .profile-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            z-index: 1500;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-page.active {
            transform: translateX(0);
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            padding: 40px 24px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .profile-nav {
            max-width: var(--max-width);
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-family: inherit;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-title {
            max-width: var(--max-width);
            margin: 0 auto;
        }

        .profile-title h1 {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .profile-body {
            max-width: 700px;
            margin: 0 auto;
            padding: 60px 24px;
        }

        .profile-avatar-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .profile-avatar-display {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 4px solid var(--white);
            box-shadow: var(--shadow-lg);
        }

        .profile-avatar-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            display: inline-block;
            margin-top: 10px;
        }

        .avatar-upload input {
            display: none;
        }

        .avatar-upload label {
            cursor: pointer;
            color: var(--primary-blue);
            font-weight: 600;
            text-decoration: underline;
        }

        .profile-info {
            background: var(--light-gray);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }

        .profile-info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-gray);
        }

        .profile-info-item:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            font-weight: 600;
            color: var(--text-gray);
        }

        .profile-info-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .profile-section {
            margin-bottom: 32px;
        }

        .profile-section h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .applied-jobs-list {
            background: var(--light-gray);
            padding: 20px;
            border-radius: var(--radius-lg);
        }

        .applied-job-item {
            background: var(--white);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .applied-job-item:last-child {
            margin-bottom: 0;
        }

        .applied-job-title {
            font-weight: 600;
            color: var(--text-dark);
        }

        .applied-job-company {
            font-size: 14px;
            color: var(--text-gray);
        }

        .role-selector-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .role-option {
            padding: 18px;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .role-option:hover {
            border-color: var(--primary-blue);
            background: var(--soft-blue);
        }

        .admin-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .admin-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1.5px solid var(--border-gray);
        }

        .btn-admin {
            flex: 1;
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-danger {
            background: var(--error);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .job-stats {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-gray);
        }

        .application-list-item {
            background: var(--white);
            padding: 14px;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
        }

        .application-list-item:last-child {
            margin-bottom: 0;
        }

        .application-worker-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .application-worker-email {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--light-gray);
            border-radius: var(--radius-md);
            scroll-behavior: smooth;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            max-width: 70%;
            word-wrap: break-word;
            display: block;
            line-height: 1.5;
            font-size: 14px;
            font-weight: 500;
        }

        .chat-message.sent {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            margin-left: auto;
            margin-right: 0;
            text-align: right;
            border-bottom-right-radius: 4px;
        }

        .chat-message.received {
            background: var(--white);
            color: var(--text-dark);
            margin-right: auto;
            margin-left: 0;
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .chat-message-image {
            max-width: 220px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            display: block;
        }

        .chat-message-image:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        .chat-message-audio {
            max-width: 260px;
            width: 100%;
            height: 36px;
            border-radius: 20px;
            outline: none;
            accent-color: var(--primary-blue);
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-input-container input {
            flex: 1;
        }

        .chat-media-toolbar {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-media-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1.5px solid var(--border-gray);
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .chat-media-btn:hover {
            background: var(--soft-blue);
            border-color: var(--primary-blue);
            transform: scale(1.08);
        }

        .chat-media-btn.recording {
            background: #fee2e2;
            border-color: var(--error);
            animation: recordPulse 1s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }

        #chatImageInput {
            display: none;
        }

        .chat-upload-indicator {
            font-size: 12px;
            color: var(--text-gray);
            padding: 4px 8px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            display: none;
        }

        .chat-upload-indicator.visible {
            display: block;
        }

        .admin-panel-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: var(--white);
            padding: 6px 14px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 40px;
                letter-spacing: -1px;
            }

            .hero p {
                font-size: 18px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .jobs-grid {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .hero-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn-hero {
                width: 100%;
            }

            .nav-actions {
                gap: 8px;
            }

            .btn {
                padding: 9px 16px;
                font-size: 14px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .sort-dropdown {
                margin-left: 0;
                width: 100%;
            }

            .toast-container {
                right: 12px;
                left: 12px;
            }

            .toast {
                min-width: auto;
                max-width: none;
            }

            .profile-title h1 {
                font-size: 32px;
            }

            .logo {
                font-size: 24px;
            }

            .nav-profile-text {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <nav class="nav" id="navbar">
        <div class="nav-container">
            <div class="logo" onclick="scrollToTop()">TeenWork</div>
            <div class="nav-actions" id="navActions"></div>
        </div>
    </nav>

    <section class="hero">
        <div class="hero-content">
            <h1>Твоя первая работа начинается здесь</h1>
            <p>Безопасная платформа для поиска работы подросткам 14-18 лет. Официальное трудоустройство, реальная зарплата, проверенные работодатели.</p>
            <div class="hero-actions">
                <button class="btn btn-hero btn-white" onclick="scrollToSearch()">Найти работу</button>
                <button class="btn btn-hero btn-outline" onclick="handleEmployerButtonClick()">Работодателям</button>
            </div>
        </div>
    </section>

    <div class="container">
        <section class="filters-section" id="search">
            <div class="filters-grid">
                <input type="text" class="input" id="searchInput" placeholder="Поиск по названию или компании...">
                <select class="select" id="cityFilter">
                    <option value="">Все города</option>
                    <option value="Санкт-Петербург">Санкт-Петербург</option>
                </select>
                <select class="select" id="typeFilter">
                    <option value="">Тип работы</option>
                    <option value="Частичная занятость">Частичная занятость</option>
                    <option value="Сезонная">Сезонная</option>
                    <option value="Постоянная">Постоянная</option>
                    <option value="Временная">Временная</option>
                </select>
                <select class="select" id="salaryFilter">
                    <option value="">Зарплата</option>
                    <option value="0-20000">до 20 000 ₽</option>
                    <option value="20000-35000">20 000 - 35 000 ₽</option>
                    <option value="35000-50000">35 000 - 50 000 ₽</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">Применить фильтры</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>
                <select class="select sort-dropdown" id="sortFilter">
                    <option value="salary-desc">По убыванию зарплаты</option>
                    <option value="salary-asc">По возрастанию зарплаты</option>
                </select>
            </div>
        </section>

        <section class="jobs-section">
            <div class="section-header">
                <div>
                    <h2>Актуальные вакансии</h2>
                    <p class="section-info" id="jobCount">Найдено вакансий: 0</p>
                </div>
            </div>
            <div class="jobs-grid" id="jobsGrid"></div>
            <div class="pagination" id="pagination"></div>
        </section>
    </div>

    <section class="info-section">
        <div class="container">
            <div class="section-header" style="text-align: center; display: block;">
                <h2>Безопасность подростков — наш приоритет</h2>
                <p class="section-info">Мы тщательно проверяем каждого работодателя</p>
            </div>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-icon">??️</div>
                    <h3>Проверенные работодатели</h3>
                    <p>Все компании проходят обязательную верификацию. Мы проверяем юридические данные и репутацию.</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">??</div>
                    <h3>Официальное оформление</h3>
                    <p>Только легальное трудоустройство с соблюдением Трудового кодекса РФ для несовершеннолетних.</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">⏰</div>
                    <h3>Безопасный график</h3>
                    <p>Контроль рабочего времени согласно законодательству: не более 24 часов в неделю для школьников.</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">??</div>
                    <h3>Гарантия выплат</h3>
                    <p>Прозрачные условия оплаты труда. Никаких скрытых комиссий и задержек зарплаты.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="faq-section">
        <div class="container">
            <div class="section-header" style="text-align: center; display: block;">
                <h2>Часто задаваемые вопросы</h2>
                <p class="section-info">Ответы на популярные вопросы о работе для подростков</p>
            </div>
            <div class="faq-list" id="faqList">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>С какого возраста можно работать?</span>
                        <span class="faq-icon">▼</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            По Трудовому кодексу РФ официально трудоустроиться можно с 14 лет с письменного согласия родителей. С 16 лет - самостоятельно. Все вакансии на нашей платформе соответствуют этим требованиям.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Сколько часов в неделю может работать подросток?</span>
                        <span class="faq-icon">▼</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            В возрасте 14-15 лет во время учебы - не более 12 часов в неделю, в каникулы - не более 24 часов. В возрасте 16-18 лет - не более 17,5 часов в неделю во время учебы и не более 35 часов в каникулы.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Нужны ли какие-то документы?</span>
                        <span class="faq-icon">▼</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Да. Вам понадобятся: паспорт, согласие родителей (для 14-15 лет), справка из школы, медицинская справка формы 086/у. СНИЛС и ИНН также потребуются для оформления.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Как проверить надежность работодателя?</span>
                        <span class="faq-icon">▼</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Мы проверяем все компании перед размещением вакансий. Вы можете увидеть рейтинг работодателя, отзывы других подростков, а также проверить юридические данные компании в карточке вакансии.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span>Можно ли работать удалённо?</span>
                        <span class="faq-icon">▼</span>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Да, у нас есть удалённые вакансии: SMM-менеджер, контент-мейкер, дизайнер, помощник в онлайн-магазине и другие. Удалённая работа также оформляется официально.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>О платформе</h4>
                    <ul class="footer-links">
                        <li><a onclick="openModal('infoModal', 'about')">О нас</a></li>
                        <li><a onclick="openModal('infoModal', 'how-it-works')">Как это работает</a></li>
                        <li><a onclick="openModal('infoModal', 'safety')">Безопасность</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Работодателям</h4>
                    <ul class="footer-links">
                        <li><a onclick="openModal('infoModal', 'employers')">Информация</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Поддержка</h4>
                    <ul class="footer-links">
                        <li><a onclick="openModal('infoModal', 'support')">Помощь</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Правовая информация</h4>
                    <ul class="footer-links">
                        <li><a onclick="openModal('infoModal', 'legal')">Документы</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 TeenWork. Все права защищены. Первая платформа работы для подростков в России.</p>
            </div>
        </div>
    </footer>

    <div class="profile-page" id="profilePage">
        <div class="profile-header">
            <div class="profile-nav">
                <button class="back-btn" onclick="closeProfile()">← Назад</button>
            </div>
            <div class="profile-title">
                <h1>Мой профиль</h1>
            </div>
        </div>
        <div class="profile-body">
            <div class="profile-avatar-section">
                <div class="profile-avatar-display" id="profileAvatarDisplay"></div>
                <div class="avatar-upload">
                    <input type="file" id="avatarUpload" accept="image/*">
                    <label for="avatarUpload">Изменить фото</label>
                </div>
            </div>
            
            <form id="profileForm">
                <div class="form-group">
                    <label>Никнейм</label>
                    <input type="text" id="profileNickname" required>
                    <div class="form-error">Это поле обязательно</div>
                </div>
                
                <div class="profile-info">
                    <div class="profile-info-item">
                        <span class="profile-info-label">Email:</span>
                        <span class="profile-info-value" id="profileEmail"></span>
                    </div>
                    <div class="profile-info-item">
                        <span class="profile-info-label">Роль:</span>
                        <span class="profile-info-value" id="profileRole"></span>
                    </div>
                    <div class="profile-info-item">
                        <span class="profile-info-label">Дата регистрации:</span>
                        <span class="profile-info-value" id="profileDate"></span>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 12px;">Сохранить изменения</button>
                <button type="button" class="btn btn-secondary" style="width: 100%; margin-bottom: 12px;" onclick="openRoleSelectorModal()">Изменить роль</button>
                <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="logout()">Выйти из аккаунта</button>
            </form>

            <div id="profileApplicationsSection" style="display: none;">
                <div class="profile-section">
                    <h3>Мои отклики</h3>
                    <div class="applied-jobs-list" id="appliedJobsList"></div>
                </div>
            </div>

            <div id="profileEmployerSection" style="display: none;">
                <div class="profile-section">
                    <h3>Мои размещенные вакансии</h3>
                    <div class="applied-jobs-list" id="employerJobsList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Вход в аккаунт</h3>
                <button class="modal-close" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                        <div class="form-error">Введите корректный email</div>
                    </div>
                    <div class="form-group">
                        <label>Пароль</label>
                        <input type="password" id="loginPassword" name="password" required>
                        <span class="password-toggle" onclick="togglePassword('loginPassword')">??️</span>
                        <div class="form-error">Неверный пароль или email</div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Войти</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Регистрация</h3>
                <button class="modal-close" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label>Никнейм</label>
                        <input type="text" name="nickname" required>
                        <div class="form-error">Это поле обязательно</div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                        <div class="form-error">Введите корректный email</div>
                    </div>
                    <div class="form-group">
                        <label>Пароль (минимум 6 символов)</label>
                        <input type="password" id="registerPassword" name="password" required>
                        <span class="password-toggle" onclick="togglePassword('registerPassword')">??️</span>
                        <div class="form-error">Пароль должен быть не менее 6 символов</div>
                    </div>
                    <div class="form-group">
                        <label>Я регистрируюсь как</label>
                        <select name="role" id="registerRoleSelect" required>
                            <option value="">Выберите роль</option>
                            <option value="worker">Я ищу работу</option>
                            <option value="employer">Я работодатель</option>
                        </select>
                        <div class="form-error">Выберите роль</div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Зарегистрироваться</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="applyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Откликнуться на вакансию</h3>
                <button class="modal-close" onclick="closeModal('applyModal')">&times;</button>
            </div>
            <div class="modal-body" id="applyModalBody"></div>
        </div>
    </div>

    <div class="modal" id="postJobModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Разместить вакансию</h3>
                <button class="modal-close" onclick="closeModal('postJobModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="postJobForm">
                    <div class="form-group">
                        <label>Название вакансии</label>
                        <input type="text" name="title" required>
                        <div class="form-error">Это поле обязательно</div>
                    </div>
                    <div class="form-group">
                        <label>Компания</label>
                        <input type="text" name="company" required>
                        <div class="form-error">Это поле обязательно</div>
                    </div>
                    <div class="form-group">
                        <label>Город</label>
                        <select name="city" required>
                            <option value="">Выберите город</option>
                            <option value="Санкт-Петербург">Санкт-Петербург</option>
                        </select>
                        <div class="form-error">Это поле обязательно</div>
                    </div>
                    <div class="form-group">
                        <label>Зарплата (₽)</label>
                        <input type="number" name="salary" required min="0">
                        <div class="form-error">Введите корректную зарплату</div>
                    </div>
                    <div class="form-group">
                        <label>Тип работы</label>
                        <input type="text" name="type" placeholder="Например: Частичная занятость, сменный график" required>
                        <div class="form-error">Это поле обязательно</div>
                    </div>
                    <div class="form-group">
                        <label>Описание</label>
                        <textarea name="description" required></textarea>
                        <div class="form-error">Это поле обязательно</div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Разместить вакансию</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="infoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="infoModalTitle"></h3>
                <button class="modal-close" onclick="closeModal('infoModal')">&times;</button>
            </div>
            <div class="modal-body" id="infoModalBody"></div>
        </div>
    </div>

    <div class="modal" id="roleSelectorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Изменить роль</h3>
                <button class="modal-close" onclick="closeModal('roleSelectorModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="role-selector-options">
                    <div class="role-option" onclick="changeUserRole('worker')">
                        <div style="font-size: 18px; margin-bottom: 4px;">Я ищу работу</div>
                        <div style="font-size: 14px; color: var(--text-gray); font-weight: 500;">Соискатель</div>
                    </div>
                    <div class="role-option" onclick="changeUserRole('employer')">
                        <div style="font-size: 18px; margin-bottom: 4px;">Я работодатель</div>
                        <div style="font-size: 14px; color: var(--text-gray); font-weight: 500;">Размещение вакансий</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="workerNeedsChangeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Изменить роль</h3>
                <button class="modal-close" onclick="closeModal('workerNeedsChangeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; line-height: 1.7; color: var(--text-gray);">Чтобы разместить вакансию, смените роль на Работодатель</p>
                <button class="btn btn-primary" style="width: 100%;" onclick="openRoleSelectorModalFromWorker()">Сменить роль</button>
            </div>
        </div>
    </div>

    <div class="modal" id="applicationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Отклики на вакансию</h3>
                <button class="modal-close" onclick="closeModal('applicationsModal')">&times;</button>
            </div>
            <div class="modal-body" id="applicationsModalBody"></div>
        </div>
    </div>

    <div class="modal" id="chatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="chatModalTitle">Чат</h3>
                <button class="modal-close" onclick="closeModal('chatModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-upload-indicator" id="chatUploadIndicator">⏳ Загрузка файла...</div>
                <div class="chat-input-container">
                    <input type="file" id="chatImageInput" accept="image/*">
                    <button class="chat-media-btn" onclick="triggerChatImageUpload()" title="Отправить изображение">??️</button>
                    <button class="chat-media-btn" id="voiceRecordBtn" onclick="toggleVoiceRecording()" title="Голосовое сообщение">??️</button>
                    <input type="text" class="input" id="chatInput" placeholder="Введите сообщение...">
                    <button class="btn btn-primary" id="chatSendBtn" onclick="sendChatMessage()">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const JOBS = [
            {
                id: 1,
                title: 'Промоутер водных экскурсий',
                company: 'Нева Тревел',
                city: 'Санкт-Петербург',
                salary: 30000,
                type: 'Сезонная, частичная занятость, на свежем воздухе',
                description: 'Работа в весенне-летний период. Привлечение туристов на водные экскурсии по Санкт-Петербургу. Консультирование клиентов по маршрутам. Работа на улице. Спецодежда предоставляется.'
            },
            {
                id: 2,
                title: 'Кассир',
                company: 'Додо Пицца',
                city: 'Санкт-Петербург',
                salary: 35000,
                type: 'Постоянная, сменный график',
                description: 'Прием заказов, расчет, выдача заказов, поддержание порядка. Бонусы для сотрудников.'
            },
            {
                id: 3,
                title: 'Продавец-кассир',
                company: 'Carte Dor',
                city: 'Санкт-Петербург',
                salary: 40000,
                type: 'Сменный график, торговля',
                description: 'Продажа мороженого. Работа с товаром, расчет, поддержание чистоты.'
            },
            {
                id: 4,
                title: 'Сборщик онлайн-заказов',
                company: 'Перекресток',
                city: 'Санкт-Петербург',
                salary: 40000,
                type: 'Частичная занятость, сменный график',
                description: 'Сбор онлайн-заказов, проверка сроков годности, передача курьерам.'
            },
            {
                id: 5,
                title: 'Кассир',
                company: 'Вкусно и точка',
                city: 'Санкт-Петербург',
                salary: 45000,
                type: 'Постоянная, сменный график',
                description: 'Прием заказов, расчет, выдача, общение с клиентами.'
            },
            {
                id: 6,
                title: 'Разнорабочий (благоустройство территорий)',
                company: 'Городская программа временной занятости',
                city: 'Санкт-Петербург',
                salary: 14000,
                type: 'Частичная занятость, временная',
                description: 'Уборка территорий в парках. Работа на свежем воздухе.'
            }
        ];

        const ADMIN_EMAIL = 'erorarun@gmail.com';

        const ADMIN_EMAILS = [
            'erorarun@gmail.com',
            'skurkomaksim833@gmail.com'
        ];

        const STATE = {
            jobs: [],
            filteredJobs: [],
            currentPage: 1,
            jobsPerPage: 6,
            currentUser: null,
            users: [],
            employerJobs: [],
            appliedJobs: [],
            currentChatId: null,
            chatUnsubscribe: null
        };
        window.STATE = STATE;
        window.renderJobs = renderJobs;

        const STORAGE = {
            USERS: 'teenwork_users',
            CURRENT_USER: 'teenwork_current_user',
            EMPLOYER_JOBS: 'teenwork_employer_jobs',
            APPLIED_JOBS: 'teenwork_applied_jobs'
        };

        const INFO_CONTENT = {
            'about': {
                title: 'О платформе',
                body: `
                    <h3 style="margin-bottom: 16px;">Кто мы</h3>
                    <p style="margin-bottom: 16px; line-height: 1.7;">TeenWork — первая в России платформа для поиска работы подростками 14-18 лет. Мы создали безопасную среду для получения первого трудового опыта.</p>
                    <h3 style="margin-bottom: 16px;">Наша миссия</h3>
                    <p style="line-height: 1.7;">Помочь подросткам получить первый опыт работы в легальных условиях, развить навыки и стать финансово независимыми.</p>
                `
            },
            'how-it-works': {
                title: 'Как это работает',
                body: `
                    <h3 style="margin-bottom: 16px;">Для подростков</h3>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>1. Регистрация</strong><br>Создайте аккаунт за пару минут</p>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>2. Поиск</strong><br>Используйте фильтры для поиска подходящей работы</p>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>3. Отклик</strong><br>Отправьте заявку работодателю</p>
                    <p style="line-height: 1.7;"><strong>4. Работа</strong><br>Получите официальное трудоустройство</p>
                `
            },
            'safety': {
                title: 'Безопасность',
                body: `
                    <h3 style="margin-bottom: 16px;">Проверка работодателей</h3>
                    <p style="margin-bottom: 16px; line-height: 1.7;">Все компании проходят многоуровневую верификацию перед размещением вакансий.</p>
                    <h3 style="margin-bottom: 16px;">Права подростков</h3>
                    <p style="line-height: 1.7;">Мы следим за соблюдением трудового законодательства РФ: сокращенный рабочий день, запрет на ночные смены, безопасные условия труда.</p>
                `
            },
            'employers': {
                title: 'Работодателям',
                body: `
                    <h3 style="margin-bottom: 16px;">Размещение вакансий</h3>
                    <p style="margin-bottom: 16px; line-height: 1.7;">Для размещения вакансий необходимо пройти верификацию и предоставить документы компании.</p>
                    <h3 style="margin-bottom: 16px;">Требования</h3>
                    <p style="line-height: 1.7;">Вакансии должны соответствовать требованиям ТК РФ для несовершеннолетних сотрудников.</p>
                `
            },
            'support': {
                title: 'Поддержка',
                body: `
                    <h3 style="margin-bottom: 16px;">Свяжитесь с нами</h3>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>Email:</strong> support@teenwork.ru</p>
                    <p style="margin-bottom: 12px; line-height: 1.7;"><strong>Телефон:</strong> +7 (495) 123-45-67</p>
                    <p style="line-height: 1.7;"><strong>Время работы:</strong> Пн-Пт, 9:00-18:00 (МСК)</p>
                `
            },
            'legal': {
                title: 'Правовая информация',
                body: `
                    <h3 style="margin-bottom: 16px;">Документы</h3>
                    <p style="margin-bottom: 12px; line-height: 1.7;">• Пользовательское соглашение</p>
                    <p style="margin-bottom: 12px; line-height: 1.7;">• Политика конфиденциальности</p>
                    <p style="line-height: 1.7;">• Условия использования платформы</p>
                `
            }
        };

        function isAdmin() {
            return STATE.currentUser && ADMIN_EMAILS.includes(STATE.currentUser.email);
        }

        function initStorage() {
            try {
                const storedUsers = localStorage.getItem(STORAGE.USERS);
                const storedUser = localStorage.getItem(STORAGE.CURRENT_USER);
                const storedEmployerJobs = localStorage.getItem(STORAGE.EMPLOYER_JOBS);
                const storedAppliedJobs = localStorage.getItem(STORAGE.APPLIED_JOBS);

                if (storedUsers) STATE.users = JSON.parse(storedUsers);
                if (storedUser) STATE.currentUser = JSON.parse(storedUser);
                if (storedEmployerJobs) STATE.employerJobs = JSON.parse(storedEmployerJobs);
                if (storedAppliedJobs) STATE.appliedJobs = JSON.parse(storedAppliedJobs);
            } catch (e) {
                console.error('Storage error:', e);
                localStorage.removeItem(STORAGE.USERS);
                localStorage.removeItem(STORAGE.CURRENT_USER);
                localStorage.removeItem(STORAGE.EMPLOYER_JOBS);
                localStorage.removeItem(STORAGE.APPLIED_JOBS);
            }
        }

        function saveUsers() { localStorage.setItem(STORAGE.USERS, JSON.stringify(STATE.users)); }
        function saveCurrentUser() {
            if (STATE.currentUser) localStorage.setItem(STORAGE.CURRENT_USER, JSON.stringify(STATE.currentUser));
            else localStorage.removeItem(STORAGE.CURRENT_USER);
        }
        function saveEmployerJobs() { localStorage.setItem(STORAGE.EMPLOYER_JOBS, JSON.stringify(STATE.employerJobs)); }
        function saveAppliedJobs() { localStorage.setItem(STORAGE.APPLIED_JOBS, JSON.stringify(STATE.appliedJobs)); }

        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: '✓', error: '✕', warning: '⚠' };
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function updateNavbar() {
            const navActions = document.getElementById('navActions');
            if (STATE.currentUser) {
                const initial = STATE.currentUser.nickname ? STATE.currentUser.nickname[0].toUpperCase() : 'U';
                const avatarContent = STATE.currentUser.avatar ? `<img src="${STATE.currentUser.avatar}" alt="Avatar">` : initial;
                let navHTML = '';
                if (isAdmin()) navHTML += `<div class="admin-panel-badge">ADMIN</div>`;
                if (STATE.currentUser.role === 'employer') navHTML += `<button class="btn btn-primary" onclick="openModal('postJobModal')">Разместить вакансию</button>`;
                navHTML += `
                    <div class="nav-profile-wrapper" onclick="openProfile()">
                        <div class="user-avatar">${avatarContent}</div>
                        <span class="nav-profile-text">Профиль</span>
                    </div>
                `;
                navActions.innerHTML = navHTML;
            } else {
                navActions.innerHTML = `
                    <button class="btn btn-secondary" onclick="handleProfileClick()">Профиль</button>
                    <button class="btn btn-secondary" onclick="openModal('registerModal')">Регистрация</button>
                `;
            }
        }

        function handleProfileClick() {
            if (!STATE.currentUser) openModal('loginModal');
            else openProfile();
        }

        function handleEmployerButtonClick() {
            if (!STATE.currentUser) {
                const registerRoleSelect = document.getElementById('registerRoleSelect');
                if (registerRoleSelect) registerRoleSelect.value = 'employer';
                openModal('registerModal');
            } else if (STATE.currentUser.role === 'employer') {
                openModal('postJobModal');
            } else {
                openModal('workerNeedsChangeModal');
            }
        }

        function openRoleSelectorModal() { openModal('roleSelectorModal'); }
        function openRoleSelectorModalFromWorker() { closeModal('workerNeedsChangeModal'); openModal('roleSelectorModal'); }

        function changeUserRole(newRole) {
            if (!STATE.currentUser) return;
            STATE.currentUser.role = newRole;
            const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
            if (userIndex !== -1) STATE.users[userIndex] = STATE.currentUser;
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            closeModal('roleSelectorModal');
            if (document.getElementById('profilePage').classList.contains('active')) openProfile();
            showToast('Успешно', 'Роль изменена', 'success');
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function openProfile() {
            if (!STATE.currentUser) { openModal('loginModal'); return; }
            const initial = STATE.currentUser.nickname ? STATE.currentUser.nickname[0].toUpperCase() : 'U';
            const avatarDisplay = document.getElementById('profileAvatarDisplay');
            if (STATE.currentUser.avatar) avatarDisplay.innerHTML = `<img src="${STATE.currentUser.avatar}" alt="Avatar">`;
            else avatarDisplay.textContent = initial;
            document.getElementById('profileNickname').value = STATE.currentUser.nickname || '';
            document.getElementById('profileEmail').textContent = STATE.currentUser.email;
            document.getElementById('profileRole').textContent = STATE.currentUser.role === 'worker' ? 'Соискатель' : 'Работодатель';
            const date = new Date(STATE.currentUser.createdAt);
            document.getElementById('profileDate').textContent = date.toLocaleDateString('ru-RU');
            if (STATE.currentUser.role === 'worker') {
                document.getElementById('profileApplicationsSection').style.display = 'block';
                document.getElementById('profileEmployerSection').style.display = 'none';
                renderAppliedJobs();
            } else {
                document.getElementById('profileApplicationsSection').style.display = 'none';
                document.getElementById('profileEmployerSection').style.display = 'block';
                renderEmployerJobs();
            }
            document.getElementById('profilePage').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        async function renderAppliedJobs() {
            const container = document.getElementById('appliedJobsList');
            if (!window.db) {
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">Загрузка...</p>';
                return;
            }
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const applicationsRef = collection(window.db, 'applications');
                const q = query(applicationsRef, where('workerId', '==', STATE.currentUser.uid || STATE.currentUser.email));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">Вы пока не откликались на вакансии</p>';
                    return;
                }
                let html = '';
                for (const docSnap of snapshot.docs) {
                    const app = docSnap.data();
                    const job = STATE.jobs.find(j => j.id === app.jobId);
                    if (job) {
                        html += `
                            <div class="applied-job-item">
                                <div>
                                    <div class="applied-job-title">${job.title}</div>
                                    <div class="applied-job-company">${job.company}</div>
                                </div>
                                <button class="btn btn-small btn-primary" onclick="openChatFromWorker('${app.jobId}', '${app.employerId}')">Открыть чат</button>
                            </div>
                        `;
                    }
                }
                container.innerHTML = html || '<p style="color: var(--text-gray); text-align: center; padding: 20px;">Нет откликов</p>';
            } catch (error) {
                console.error('Error loading applications:', error);
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">Ошибка загрузки</p>';
            }
        }

        async function renderEmployerJobs() {
            const container = document.getElementById('employerJobsList');
            const userJobs = STATE.jobs.filter(job => job.employerEmail === STATE.currentUser.email || job.employerId === (STATE.currentUser.uid || STATE.currentUser.email));
            if (userJobs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">Вы еще не разместили ни одной вакансии</p>';
                return;
            }
            let html = '';
            for (const job of userJobs) {
                let appCount = 0;
                let viewCount = job.views || 0;
                if (window.db) {
                    try {
                        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                        const appsRef = collection(window.db, 'applications');
                        const q = query(appsRef, where('jobId', '==', job.id));
                        const snapshot = await getDocs(q);
                        appCount = snapshot.size;
                    } catch (e) { console.error('Error counting applications:', e); }
                }
                html += `
                    <div class="applied-job-item">
                        <div style="flex: 1;">
                            <div class="applied-job-title">${job.title}</div>
                            <div class="applied-job-company">${job.company} • ${job.salary.toLocaleString('ru-RU')} ₽</div>
                            <div class="job-stats">??️ Просмотров: ${viewCount} | ?? Откликов: ${appCount}</div>
                        </div>
                        <button class="btn btn-small btn-primary" onclick="showApplications('${job.id}')">Отклики</button>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        async function showApplications(jobId) {
            if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const applicationsRef = collection(window.db, 'applications');
                const q = query(applicationsRef, where('jobId', '==', jobId));
                const snapshot = await getDocs(q);
                const modalBody = document.getElementById('applicationsModalBody');
                if (snapshot.empty) {
                    modalBody.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 20px;">Нет откликов на эту вакансию</p>';
                } else {
                    let html = '<div class="applied-jobs-list">';
                    snapshot.forEach(docSnap => {
                        const app = docSnap.data();
                        html += `
                            <div class="application-list-item">
                                <div class="application-worker-name">${app.workerNickname || 'Соискатель'}</div>
                                <div class="application-worker-email">${app.workerEmail}</div>
                                ${app.message ? `<div style="margin-top: 8px; color: var(--text-gray); font-size: 14px;">${app.message}</div>` : ''}
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-small btn-primary" onclick="openChatFromEmployer('${jobId}', '${app.workerId}')">Открыть чат</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    modalBody.innerHTML = html;
                }
                openModal('applicationsModal');
            } catch (error) {
                console.error('Error loading applications:', error);
                showToast('Ошибка', 'Не удалось загрузить отклики', 'error');
            }
        }

        async function openChatFromWorker(jobId, employerId) {
            openChat(jobId, employerId, STATE.currentUser.uid || STATE.currentUser.email);
        }

        async function openChatFromEmployer(jobId, workerId) {
            openChat(jobId, STATE.currentUser.uid || STATE.currentUser.email, workerId);
        }

        async function openChat(jobId, employerId, workerId) {
            if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
            try {
                const { collection, query, where, getDocs, addDoc, onSnapshot, orderBy } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                if (STATE.chatUnsubscribe) { STATE.chatUnsubscribe(); STATE.chatUnsubscribe = null; }
                const chatsRef = collection(window.db, 'chats');
                const q = query(chatsRef, where('jobId', '==', jobId), where('employerId', '==', employerId), where('workerId', '==', workerId));
                const snapshot = await getDocs(q);
                let chatId;
                if (snapshot.empty) {
                    const newChat = await addDoc(chatsRef, { jobId, employerId, workerId, createdAt: Date.now() });
                    chatId = newChat.id;
                } else {
                    chatId = snapshot.docs[0].id;
                }
                if (!chatId) { showToast('Ошибка', 'Не удалось создать чат', 'error'); return; }
                STATE.currentChatId = chatId;
                const job = STATE.jobs.find(j => j.id === jobId);
                document.getElementById('chatModalTitle').textContent = `Чат: ${job ? job.title : 'Вакансия'}`;
                const messagesRef = collection(window.db, 'messages');
                const messagesQuery = query(messagesRef, where('chatId', '==', chatId), orderBy('createdAt', 'asc'));
                STATE.chatUnsubscribe = onSnapshot(messagesQuery, (messagesSnapshot) => {
                    const container = document.getElementById('chatMessages');
                    if (!container) return;
                    let html = '';
                    messagesSnapshot.forEach(docSnap => {
                        const msg = docSnap.data();
                        const isSent = msg.senderId === (STATE.currentUser.uid || STATE.currentUser.email);
                        const alignClass = isSent ? 'sent' : 'received';
                        if (msg.imageUrl) {
                            html += `<div class="chat-message ${alignClass}"><img class="chat-message-image" src="${msg.imageUrl}" alt="Изображение" onclick="window.open('${msg.imageUrl}', '_blank')"/></div>`;
                        } else if (msg.audioUrl) {
                            html += `<div class="chat-message ${alignClass}">??️ <audio class="chat-message-audio" controls src="${msg.audioUrl}" preload="metadata"></audio></div>`;
                        } else {
                            html += `<div class="chat-message ${alignClass}">${msg.text}</div>`;
                        }
                    });
                    container.innerHTML = html || '<p style="color: var(--text-gray); text-align: center;">Нет сообщений</p>';
                    container.scrollTop = container.scrollHeight;
                }, (error) => { console.error('Error in chat listener:', error); });
                openModal('chatModal');
            } catch (error) {
                console.error('Error opening chat:', error);
                showToast('Ошибка', 'Не удалось открыть чат', 'error');
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !STATE.currentChatId || !window.db) return;
            try {
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                await addDoc(collection(window.db, 'messages'), {
                    chatId: STATE.currentChatId,
                    senderId: STATE.currentUser.uid || STATE.currentUser.email,
                    text,
                    createdAt: Date.now()
                });
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Ошибка', 'Не удалось отправить сообщение', 'error');
            }
        }

        function closeProfile() {
            document.getElementById('profilePage').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function logout() {
            if (STATE.chatUnsubscribe) { STATE.chatUnsubscribe(); STATE.chatUnsubscribe = null; }
            STATE.currentUser = null;
            saveCurrentUser();
            updateNavbar();
            closeProfile();
            showToast('До встречи!', 'Вы вышли из аккаунта', 'success');
        }

        function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const user = STATE.users.find(u => u.email === email);
            if (!user || user.password !== password) {
                const formGroup = e.target.querySelector('input[name="password"]').closest('.form-group');
                formGroup.classList.add('error');
                return;
            }
            STATE.currentUser = user;
            saveCurrentUser();
            updateNavbar();
            closeModal('loginModal');
            showToast('Добро пожаловать!', 'Вы успешно вошли в систему', 'success');
        }

        function handleRegister(e) {
            e.preventDefault();
            if (!validateForm(e.target)) { showToast('Ошибка', 'Заполните все поля корректно', 'error'); return; }
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const nickname = formData.get('nickname');
            const role = formData.get('role');
            if (STATE.users.find(u => u.email === email)) { showToast('Ошибка', 'Пользователь с таким email уже существует', 'error'); return; }
            if (password.length < 6) { const fg = e.target.querySelector('input[name="password"]').closest('.form-group'); fg.classList.add('error'); return; }
            if (!role) { const fg = e.target.querySelector('select[name="role"]').closest('.form-group'); fg.classList.add('error'); return; }
            const newUser = { email, password, nickname, role, avatar: null, createdAt: Date.now(), uid: email };
            STATE.users.push(newUser);
            STATE.currentUser = newUser;
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            closeModal('registerModal');
            showToast('Регистрация успешна!', 'Добро пожаловать в TeenWork', 'success');
        }

        function handleProfileUpdate(e) {
            e.preventDefault();
            const nickname = document.getElementById('profileNickname').value;
            if (!nickname) { showToast('Ошибка', 'Заполните никнейм', 'error'); return; }
            STATE.currentUser.nickname = nickname;
            const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
            if (userIndex !== -1) STATE.users[userIndex] = STATE.currentUser;
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            showToast('Успешно', 'Профиль обновлен', 'success');
        }

        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                STATE.currentUser.avatar = event.target.result;
                const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
                if (userIndex !== -1) STATE.users[userIndex] = STATE.currentUser;
                saveUsers();
                saveCurrentUser();
                document.getElementById('profileAvatarDisplay').innerHTML = `<img src="${event.target.result}" alt="Avatar">`;
                updateNavbar();
                showToast('Успешно', 'Фото обновлено', 'success');
            };
            reader.readAsDataURL(file);
        }

        async function handlePostJob(e) {
            e.preventDefault();
            if (!validateForm(e.target)) { showToast('Ошибка', 'Заполните все поля корректно', 'error'); return; }
            const formData = new FormData(e.target);
            const newJob = {
                title: formData.get('title'),
                company: formData.get('company'),
                city: formData.get('city'),
                salary: parseInt(formData.get('salary')),
                type: formData.get('type'),
                description: formData.get('description'),
                employerEmail: STATE.currentUser.email,
                employerId: STATE.currentUser.uid || STATE.currentUser.email,
                isTop: false,
                views: 0,
                createdAt: Date.now()
            };
            try {
                if (window.db && window.addDoc && window.collection) {
                    await window.addDoc(window.collection(window.db, "jobs"), newJob);
                }
            } catch (error) { console.error('Firestore error:', error); }
            closeModal('postJobModal');
            showToast('Успешно', 'Вакансия размещена', 'success');
            if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cityFilter = document.getElementById('cityFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const salaryFilter = document.getElementById('salaryFilter').value;
            STATE.filteredJobs = STATE.jobs.filter(job => {
                const matchesSearch = !searchTerm || job.title.toLowerCase().includes(searchTerm) || job.company.toLowerCase().includes(searchTerm);
                const matchesCity = !cityFilter || job.city === cityFilter;
                const matchesType = !typeFilter || job.type.includes(typeFilter);
                let matchesSalary = true;
                if (salaryFilter) {
                    const [min, max] = salaryFilter.split('-').map(v => parseInt(v) || Infinity);
                    matchesSalary = job.salary >= min && (max === Infinity || job.salary <= max);
                }
                return matchesSearch && matchesCity && matchesType && matchesSalary;
            });
            applySorting();
            STATE.currentPage = 1;
            renderJobs();
        }

        function applySorting() {
            const sortValue = document.getElementById('sortFilter').value;
            STATE.filteredJobs.sort((a, b) => {
                if (a.isTop && !b.isTop) return -1;
                if (!a.isTop && b.isTop) return 1;
                if (sortValue === 'salary-desc') return b.salary - a.salary;
                if (sortValue === 'salary-asc') return a.salary - b.salary;
                return 0;
            });
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('cityFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('sortFilter').value = 'salary-desc';
            STATE.filteredJobs = [...STATE.jobs];
            applySorting();
            STATE.currentPage = 1;
            renderJobs();
        }

        function renderJobs() {
            const grid = document.getElementById('jobsGrid');
            const jobCount = document.getElementById('jobCount');
            jobCount.textContent = `Найдено вакансий: ${STATE.filteredJobs.length}`;
            if (STATE.filteredJobs.length === 0) {
                grid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">??</div><h3>Вакансии не найдены</h3><p>Попробуйте изменить параметры поиска</p></div>`;
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            const startIndex = (STATE.currentPage - 1) * STATE.jobsPerPage;
            const endIndex = startIndex + STATE.jobsPerPage;
            const jobsToRender = STATE.filteredJobs.slice(startIndex, endIndex);
            grid.innerHTML = jobsToRender.map(job => {
                const adminBadge = job.isTop ? '<div class="admin-badge">TOP</div>' : '';
                const adminControls = isAdmin() ? `
                    <div class="admin-controls">
                        <button class="btn btn-admin btn-danger" onclick="deleteJob('${job.id}', event)">Удалить</button>
                        <button class="btn btn-admin btn-warning" onclick="toggleTopJob('${job.id}', event)">${job.isTop ? 'Снять TOP' : 'Сделать TOP'}</button>
                    </div>
                ` : '';
                return `
                    <div class="job-card" onclick="openApplyModal('${job.id}')">
                        ${adminBadge}
                        <div class="job-header">
                            <div class="job-title">${job.title}</div>
                            <div class="job-company">${job.company}</div>
                            <div class="job-location">?? ${job.city}</div>
                        </div>
                        <div class="job-details">
                            <div class="job-salary">${job.salary.toLocaleString('ru-RU')} ₽</div>
                            <div class="job-tags"><span class="tag">${job.type}</span></div>
                        </div>
                        <div class="job-footer">
                            <button class="btn btn-primary btn-apply" onclick="openApplyModal('${job.id}', event)">Откликнуться</button>
                        </div>
                        ${adminControls}
                    </div>
                `;
            }).join('');
            renderPagination();
        }

        async function deleteJob(jobId, event) {
            if (event) event.stopPropagation();
            if (!isAdmin()) { showToast('Ошибка', 'Только админ может удалять вакансии', 'error'); return; }
            if (!confirm('Вы уверены, что хотите удалить эту вакансию?')) return;
            try {
                if (window.db) {
                    const { deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    await deleteDoc(doc(window.db, "jobs", jobId));
                }
                showToast('Успешно', 'Вакансия удалена', 'success');
                if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
            } catch (error) { console.error('Delete error:', error); showToast('Ошибка', 'Не удалось удалить вакансию', 'error'); }
        }

        async function toggleTopJob(jobId, event) {
            if (event) event.stopPropagation();
            if (!isAdmin()) { showToast('Ошибка', 'Только админ может управлять TOP-вакансиями', 'error'); return; }
            try {
                const job = STATE.jobs.find(j => j.id === jobId);
                if (!job) return;
                if (window.db) {
                    const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    await updateDoc(doc(window.db, "jobs", jobId), { isTop: !job.isTop });
                }
                showToast('Успешно', job.isTop ? 'TOP снят' : 'Вакансия в TOP', 'success');
                if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
            } catch (error) { console.error('Toggle TOP error:', error); showToast('Ошибка', 'Не удалось изменить статус', 'error'); }
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(STATE.filteredJobs.length / STATE.jobsPerPage);
            if (totalPages <= 1) { pagination.innerHTML = ''; return; }
            let html = `<button class="pagination-btn" onclick="changePage(${STATE.currentPage - 1})" ${STATE.currentPage === 1 ? 'disabled' : ''}>← Назад</button>`;
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= STATE.currentPage - 1 && i <= STATE.currentPage + 1)) {
                    html += `<button class="pagination-btn ${i === STATE.currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === STATE.currentPage - 2 || i === STATE.currentPage + 2) {
                    html += `<span style="padding: 8px;">...</span>`;
                }
            }
            html += `<button class="pagination-btn" onclick="changePage(${STATE.currentPage + 1})" ${STATE.currentPage === totalPages ? 'disabled' : ''}>Вперёд →</button>`;
            pagination.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(STATE.filteredJobs.length / STATE.jobsPerPage);
            if (page < 1 || page > totalPages) return;
            STATE.currentPage = page;
            renderJobs();
            scrollToSearch();
        }

        function openModal(modalId, contentKey) {
            const modal = document.getElementById(modalId);
            if (modalId === 'infoModal' && contentKey) {
                const content = INFO_CONTENT[contentKey];
                if (content) {
                    document.getElementById('infoModalTitle').textContent = content.title;
                    document.getElementById('infoModalBody').innerHTML = content.body;
                }
            }
            modal.classList.remove('hiding');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hiding');
            if (modalId === 'chatModal' && STATE.chatUnsubscribe) {
                STATE.chatUnsubscribe();
                STATE.chatUnsubscribe = null;
                STATE.currentChatId = null;
            }
            setTimeout(() => {
                modal.classList.remove('active', 'hiding');
                document.body.style.overflow = 'auto';
                const form = modal.querySelector('form');
                if (form) { form.reset(); clearFormErrors(form); }
            }, 300);
        }

        function clearFormErrors(form) {
            form.querySelectorAll('.form-group').forEach(group => group.classList.remove('error'));
        }

        function validateForm(form) {
            let isValid = true;
            clearFormErrors(form);
            form.querySelectorAll('[required]').forEach(field => {
                const formGroup = field.closest('.form-group');
                if (!field.value.trim()) { formGroup.classList.add('error'); isValid = false; }
                else if (field.type === 'email' && !field.validity.valid) { formGroup.classList.add('error'); isValid = false; }
                else if (field.type === 'password' && field.value.length < 6) { formGroup.classList.add('error'); isValid = false; }
                else if (field.tagName === 'SELECT' && !field.value) { formGroup.classList.add('error'); isValid = false; }
            });
            return isValid;
        }

        async function openApplyModal(jobId, event) {
            if (event) event.stopPropagation();
            if (!STATE.currentUser) { showToast('Требуется авторизация', 'Войдите в аккаунт для отклика', 'warning'); openModal('loginModal'); return; }
            if (STATE.currentUser.role === 'employer') { showToast('Внимание', 'Работодатели не могут откликаться на вакансии', 'warning'); return; }
            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;
            if (window.db) {
                try {
                    const { updateDoc, doc, increment, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    const jobRef = doc(window.db, "jobs", jobId);
                    const jobSnap = await getDoc(jobRef);
                    if (jobSnap.exists()) {
                        const jobData = jobSnap.data();
                        if (typeof jobData.views === 'number') await updateDoc(jobRef, { views: increment(1) });
                        else await updateDoc(jobRef, { views: 1 });
                    }
                } catch (error) { console.error('Error incrementing views:', error); }
            }
            let alreadyApplied = false;
            if (window.db) {
                try {
                    const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    const appsRef = collection(window.db, 'applications');
                    const q = query(appsRef, where('jobId', '==', jobId), where('workerId', '==', STATE.currentUser.uid || STATE.currentUser.email));
                    const snapshot = await getDocs(q);
                    alreadyApplied = !snapshot.empty;
                } catch (error) { console.error('Error checking application:', error); }
            }
            const modalBody = document.getElementById('applyModalBody');
            modalBody.innerHTML = `
                <div style="margin-bottom: 28px;">
                    <h3 style="margin-bottom: 10px; font-weight: 700; font-size: 22px;">${job.title}</h3>
                    <p style="color: var(--text-gray); margin-bottom: 20px; font-weight: 600;">${job.company} • ${job.city}</p>
                    <div style="background: var(--light-gray); padding: 18px; border-radius: var(--radius-md); margin-bottom: 20px;">
                        <strong>Зарплата:</strong> ${job.salary.toLocaleString('ru-RU')} ₽<br>
                        <strong>Тип:</strong> ${job.type}
                    </div>
                    <p style="line-height: 1.7; color: var(--text-gray); font-weight: 500;">${job.description}</p>
                </div>
                <div style="text-align: center; padding: 20px;">
                    ${alreadyApplied
                        ? '<p style="margin-bottom: 16px; color: var(--success); font-weight: 600;">Вы уже откликнулись на эту вакансию</p>'
                        : `<textarea id="applicationMessage" class="input" placeholder="Сопроводительное сообщение (необязательно)" style="width: 100%; margin-bottom: 12px; min-height: 80px;"></textarea>
                           <button class="btn btn-primary" onclick="applyToJob('${jobId}')" style="margin-bottom: 12px;">Откликнуться</button>`
                    }
                    <button class="btn btn-secondary" onclick="closeModal('applyModal')">Закрыть</button>
                </div>
            `;
            openModal('applyModal');
        }

        async function applyToJob(jobId) {
            if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;
            const message = document.getElementById('applicationMessage')?.value || '';
            try {
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                await addDoc(collection(window.db, 'applications'), {
                    jobId,
                    workerId: STATE.currentUser.uid || STATE.currentUser.email,
                    employerId: job.employerId || job.employerEmail,
                    workerEmail: STATE.currentUser.email,
                    workerNickname: STATE.currentUser.nickname || 'Соискатель',
                    message,
                    createdAt: Date.now(),
                    status: 'new'
                });
                closeModal('applyModal');
                showToast('Успешно', 'Вы откликнулись на вакансию', 'success');
            } catch (error) { console.error('Error applying to job:', error); showToast('Ошибка', 'Не удалось откликнуться', 'error'); }
        }

        function toggleFaq(element) {
            const faqItem = element.parentElement;
            const answer = faqItem.querySelector('.faq-answer');
            const answerContent = answer.querySelector('.faq-answer-content');
            const isActive = faqItem.classList.contains('active');
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('.faq-answer').style.maxHeight = '0px';
            });
            if (!isActive) { faqItem.classList.add('active'); answer.style.maxHeight = answerContent.scrollHeight + 'px'; }
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function scrollToSearch() { document.getElementById('search').scrollIntoView({ behavior: 'smooth', block: 'start' }); }

        function initEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', () => { applySorting(); STATE.currentPage = 1; renderJobs(); });
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('avatarUpload').addEventListener('change', handleAvatarUpload);
            document.getElementById('postJobForm').addEventListener('submit', handlePostJob);
            document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
            document.getElementById('chatImageInput').addEventListener('change', handleChatImageSelected);
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal.id); });
            });
            window.addEventListener('scroll', () => {
                const navbar = document.getElementById('navbar');
                if (window.pageYOffset > 50) navbar.classList.add('scrolled');
                else navbar.classList.remove('scrolled');
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) closeModal(activeModal.id);
                    const profilePage = document.getElementById('profilePage');
                    if (profilePage.classList.contains('active')) closeProfile();
                }
            });
        }

        function init() { initStorage(); updateNavbar(); initEventListeners(); }
        document.addEventListener('DOMContentLoaded', init);

        // ==============================
        // STORAGE EXTENSION
        // ==============================
        function triggerChatImageUpload() {
            if (!STATE.currentChatId) { showToast('Ошибка', 'Сначала откройте чат', 'error'); return; }
            document.getElementById('chatImageInput').click();
        }

        async function handleChatImageSelected(e) {
            const file = e.target.files[0];
            e.target.value = '';
            if (!file || !STATE.currentChatId || !window.db) return;
            if (!file.type.startsWith('image/')) { showToast('Ошибка', 'Выберите изображение', 'error'); return; }
            if (file.size > 5 * 1024 * 1024) { showToast('Ошибка', 'Размер изображения не должен превышать 5 МБ', 'error'); return; }
            const indicator = document.getElementById('chatUploadIndicator');
            if (indicator) indicator.classList.add('visible');
            try {
                const { getStorage, ref, uploadBytes, getDownloadURL } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js');
                const storage = getStorage();
                const filePath = `chat-images/${STATE.currentChatId}/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, filePath);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                await addDoc(collection(window.db, 'messages'), { chatId: STATE.currentChatId, senderId: STATE.currentUser.uid || STATE.currentUser.email, imageUrl: downloadURL, text: '', createdAt: Date.now() });
            } catch (error) { console.error('Image upload error:', error); showToast('Ошибка', 'Не удалось загрузить изображение', 'error'); }
            finally { if (indicator) indicator.classList.remove('visible'); }
        }

        // ==============================
        // VOICE MESSAGE LOGIC
        // ==============================
        const VOICE_STATE = { mediaRecorder: null, audioChunks: [], isRecording: false, stream: null };

        async function toggleVoiceRecording() {
            if (!STATE.currentChatId) { showToast('Ошибка', 'Сначала откройте чат', 'error'); return; }
            if (VOICE_STATE.isRecording) {
                VOICE_STATE.mediaRecorder.stop();
            } else {
                try {
                    VOICE_STATE.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    VOICE_STATE.audioChunks = [];
                    VOICE_STATE.mediaRecorder = new MediaRecorder(VOICE_STATE.stream);
                    VOICE_STATE.mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) VOICE_STATE.audioChunks.push(event.data); };
                    VOICE_STATE.mediaRecorder.onstop = handleVoiceRecordingStop;
                    VOICE_STATE.mediaRecorder.start();
                    VOICE_STATE.isRecording = true;
                    const btn = document.getElementById('voiceRecordBtn');
                    if (btn) { btn.classList.add('recording'); btn.textContent = '⏹️'; btn.title = 'Остановить запись'; }
                } catch (err) { console.error('Microphone error:', err); showToast('Ошибка', 'Нет доступа к микрофону', 'error'); }
            }
        }

        async function handleVoiceRecordingStop() {
            VOICE_STATE.isRecording = false;
            const btn = document.getElementById('voiceRecordBtn');
            if (btn) { btn.classList.remove('recording'); btn.textContent = '??️'; btn.title = 'Голосовое сообщение'; }
            if (VOICE_STATE.stream) { VOICE_STATE.stream.getTracks().forEach(track => track.stop()); VOICE_STATE.stream = null; }
            if (VOICE_STATE.audioChunks.length === 0) return;
            const audioBlob = new Blob(VOICE_STATE.audioChunks, { type: 'audio/webm' });
            if (audioBlob.size < 512) { showToast('Внимание', 'Запись слишком короткая', 'warning'); return; }
            const indicator = document.getElementById('chatUploadIndicator');
            if (indicator) indicator.classList.add('visible');
            try {
                const { getStorage, ref, uploadBytes, getDownloadURL } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js');
                const storage = getStorage();
                const filePath = `chat-audio/${STATE.currentChatId}/${Date.now()}.webm`;
                const storageRef = ref(storage, filePath);
                await uploadBytes(storageRef, audioBlob);
                const downloadURL = await getDownloadURL(storageRef);
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                await addDoc(collection(window.db, 'messages'), { chatId: STATE.currentChatId, senderId: STATE.currentUser.uid || STATE.currentUser.email, audioUrl: downloadURL, text: '', createdAt: Date.now() });
            } catch (error) { console.error('Audio upload error:', error); showToast('Ошибка', 'Не удалось загрузить голосовое сообщение', 'error'); }
            finally { if (indicator) indicator.classList.remove('visible'); }
        }
    </script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC9l-LPIJl_51GC8FgdApYccycQjA7rNps",
    authDomain: "teenwork-app-afaa6.firebaseapp.com",
    projectId: "teenwork-app-afaa6",
    storageBucket: "teenwork-app-afaa6.firebasestorage.app",
    messagingSenderId: "657977585927",
    appId: "1:657977585927:web:190719f2acf432fdaf15a2",
    measurementId: "G-XWR4S2ZRN7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.addDoc = addDoc;
  window.collection = collection;
  window.deleteDoc = deleteDoc;
  window.doc = doc;
  window.updateDoc = updateDoc;

  const jobsCollection = collection(db, "jobs");

  async function uploadInitialJobs() {
    const snapshot = await getDocs(jobsCollection);
    if (!snapshot.empty) { console.log("Вакансии уже есть в Firestore"); return; }
    const initialJobs = [
      { title: "Промоутер водных экскурсий", company: "Нева Тревел", city: "Санкт-Петербург", salary: 30000, type: "Сезонная", description: "Работа в весенне-летний период.", isTop: false, views: 0, createdAt: Date.now() },
      { title: "Кассир", company: "Додо Пицца", city: "Санкт-Петербург", salary: 35000, type: "Постоянная", description: "Работа в ресторане быстрого питания.", isTop: false, views: 0, createdAt: Date.now() }
    ];
    for (let job of initialJobs) await addDoc(jobsCollection, job);
    console.log("Вакансии успешно загружены в Firestore");
  }

  async function loadJobsFromFirestore() {
    const snapshot = await getDocs(collection(db, "jobs"));
    const jobs = [];
    snapshot.forEach(docSnap => { jobs.push({ id: docSnap.id, ...docSnap.data() }); });
    if (window.STATE) {
      window.STATE.jobs = jobs;
      window.STATE.filteredJobs = [...jobs];
      window.STATE.currentPage = 1;
      if (window.renderJobs) window.renderJobs();
    }
    console.log("Вакансии загружены из Firestore:", jobs.length);
  }

  window.loadJobsFromFirestore = loadJobsFromFirestore;
  uploadInitialJobs();
  loadJobsFromFirestore();
</script>

<!-- ================= SAFE PRESENCE EXTENSION ================= -->
<style>
.chat-presence-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px 9px 20px;
    border-bottom: 1px solid var(--border-gray);
    background: linear-gradient(90deg, rgba(239,246,255,0.9) 0%, rgba(255,255,255,0) 100%);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-gray);
    min-height: 38px;
    transition: all 0.3s ease;
    animation: presenceBarFade 0.4s ease backwards;
}

@keyframes presenceBarFade {
    from { opacity: 0; transform: translateY(-5px); }
    to   { opacity: 1; transform: translateY(0); }
}

.presence-dot-online {
    width: 9px; height: 9px; border-radius: 50%;
    background: var(--success); flex-shrink: 0;
    animation: presencePulse 2s ease-in-out infinite;
}

@keyframes presencePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.55); }
    50%       { box-shadow: 0 0 0 7px rgba(16,185,129,0); }
}

.presence-dot-offline { width: 9px; height: 9px; border-radius: 50%; background: #94a3b8; flex-shrink: 0; }
.presence-text-online { color: var(--success); font-weight: 700; font-size: 13px; }
.presence-text-offline { color: var(--text-gray); font-size: 12px; font-weight: 500; opacity: 0.85; }

#chatModal .modal-body { padding: 0 0 20px 0; }
#chatModal .chat-messages { max-height: 460px; margin: 0; border-radius: 0; border-left: none; border-right: none; border-top: none; }
#chatModal .chat-input-container { margin: 16px 20px 0 20px; }
#chatModal .modal-header { border-bottom: 2px solid var(--border-gray); padding: 18px 24px; }
#chatModal .modal-header h3 { font-size: 18px; letter-spacing: -0.3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 420px; }
#chatSendBtn:disabled { opacity: 0.42; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
</style>

<script>
const _PRESENCE_POLL_MS = 400;
const _PRESENCE_TIMEOUT = 12000;

function _presenceWhenDbReady(cb) {
    const start = Date.now();
    const t = setInterval(() => {
        if (window.db) { clearInterval(t); cb(); }
        else if (Date.now() - start > _PRESENCE_TIMEOUT) clearInterval(t);
    }, _PRESENCE_POLL_MS);
}

function _formatLastSeen(ts) {
    if (!ts) return '';
    const now = new Date();
    const d = new Date(ts);
    const pad = n => String(n).padStart(2, '0');
    const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const yest  = today - 86400000;
    const msgD  = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
    if (msgD === today) return `сегодня в ${time}`;
    if (msgD === yest)  return `вчера в ${time}`;
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${time}`;
}

async function _writePresence(isOnline) {
    if (!window.db || !window.STATE || !window.STATE.currentUser) return;
    const userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    if (!userId) return;
    try {
        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await setDoc(doc(window.db, 'users', userId), { isOnline, lastSeen: Date.now(), nickname: window.STATE.currentUser.nickname || '', email: window.STATE.currentUser.email || '' }, { merge: true });
    } catch (e) { console.warn('[presence] write error:', e); }
}

function _setPresenceOnline()  { _presenceWhenDbReady(() => _writePresence(true)); }
function _setPresenceOffline() { _writePresence(false); }

document.addEventListener('DOMContentLoaded', () => {
    _presenceWhenDbReady(() => { if (window.STATE && window.STATE.currentUser) _writePresence(true); });
});

window.addEventListener('beforeunload', () => { _setPresenceOffline(); });
document.addEventListener('visibilitychange', () => {
    if (!window.STATE || !window.STATE.currentUser) return;
    _presenceWhenDbReady(() => _writePresence(!document.hidden));
});

async function _subscribeToPresence(userId, callback) {
    if (!window.db || !userId) return null;
    try {
        const { doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        return onSnapshot(doc(window.db, 'users', userId), snap => {
            if (snap.exists()) { const d = snap.data(); callback(!!d.isOnline, d.lastSeen || null); }
            else callback(false, null);
        }, err => console.warn('[presence] subscribe error:', err));
    } catch (e) { console.warn('[presence] subscribeToPresence error:', e); return null; }
}

function _injectPresenceBar(otherUserId) {
    const modalBody = document.querySelector('#chatModal .modal-body');
    if (!modalBody) return;
    const existing = modalBody.querySelector('.chat-presence-bar');
    if (existing) existing.remove();
    const bar = document.createElement('div');
    bar.className = 'chat-presence-bar';
    bar.id = 'chatPresenceBar';
    bar.innerHTML = `<span class="presence-dot-offline" id="presenceDot"></span><span class="presence-text-offline" id="presenceText">Загрузка...</span>`;
    const chatMsgs = modalBody.querySelector('#chatMessages');
    if (chatMsgs) modalBody.insertBefore(bar, chatMsgs);
    else modalBody.insertBefore(bar, modalBody.firstChild);
    _presenceWhenDbReady(async () => {
        const unsub = await _subscribeToPresence(otherUserId, (isOnline, lastSeen) => {
            const dot = document.getElementById('presenceDot');
            const text = document.getElementById('presenceText');
            if (!dot || !text) return;
            if (isOnline) { dot.className = 'presence-dot-online'; text.className = 'presence-text-online'; text.textContent = '● В сети'; }
            else { dot.className = 'presence-dot-offline'; text.className = 'presence-text-offline'; text.textContent = lastSeen ? `Был(а) в сети: ${_formatLastSeen(lastSeen)}` : 'Не в сети'; }
        });
        window._presenceUnsub = unsub;
    });
}

const _origCloseModalPresence = window.closeModal || closeModal;
window.closeModal = function(modalId) {
    if (modalId === 'chatModal' && typeof window._presenceUnsub === 'function') { window._presenceUnsub(); window._presenceUnsub = null; }
    _origCloseModalPresence(modalId);
};

const _origOpenChat = window.openChat;
window.openChat = async function(jobId, employerId, workerId) {
    await _origOpenChat(jobId, employerId, workerId);
    const currentUserId = window.STATE && window.STATE.currentUser ? (window.STATE.currentUser.uid || window.STATE.currentUser.email) : null;
    const otherId = (currentUserId === employerId) ? workerId : employerId;
    setTimeout(() => { if (otherId) _injectPresenceBar(otherId); }, 160);
};

const _origHandleLogin = window.handleLogin || handleLogin;
window.handleLogin = function(e) { _origHandleLogin(e); setTimeout(() => { if (window.STATE && window.STATE.currentUser) _setPresenceOnline(); }, 200); };

const _origHandleRegister = window.handleRegister || handleRegister;
window.handleRegister = function(e) { _origHandleRegister(e); setTimeout(() => { if (window.STATE && window.STATE.currentUser) _setPresenceOnline(); }, 200); };

const _origLogout = window.logout || logout;
window.logout = function() { _setPresenceOffline(); _origLogout(); };

async function _markMessagesAsRead(chatId, currentUserId, messagesSnapshot) {
    if (!window.db || !chatId) return;
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const updates = [];
        messagesSnapshot.forEach(docSnap => {
            const msg = docSnap.data();
            if (msg.senderId !== currentUserId && msg.read === false) {
                updates.push(updateDoc(doc(window.db, 'messages', docSnap.id), { read: true, readAt: Date.now(), status: 'read' }));
            }
        });
        if (updates.length > 0) await Promise.all(updates);
    } catch (e) { console.warn('[chat] markMessagesAsRead error:', e); }
}
</script>

<!-- ================= DESIGN RESTORE PATCH ================= -->
<style>
.jobs-section .section-header h2 {
    background: linear-gradient(135deg, var(--text-dark) 0%, #1e3a8a 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: inline-block;
    transition: filter 0.3s ease;
}

.jobs-section .section-header h2::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 0;
    width: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-blue), var(--blue-light));
    border-radius: 2px;
    transition: width 0.55s cubic-bezier(0.4, 0, 0.2, 1);
}

.jobs-section .section-header:hover h2::after { width: 100%; }
.jobs-section .section-header:hover h2 { filter: drop-shadow(0 2px 14px rgba(37,99,235,0.22)); }

.job-count-badge {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: linear-gradient(135deg, var(--soft-blue), #dbeafe);
    color: var(--primary-blue);
    border: 1.5px solid rgba(37,99,235,0.15);
    border-radius: 24px;
    padding: 6px 16px;
    font-size: 14px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    cursor: default;
}

.job-count-badge:hover { transform: scale(1.04); box-shadow: 0 4px 18px rgba(37,99,235,0.16); }
.job-count-number { font-size: 17px; font-weight: 800; }

@keyframes countBadgePop {
    0%   { transform: scale(1); }
    45%  { transform: scale(1.28); }
    100% { transform: scale(1); }
}

.job-count-badge.pop { animation: countBadgePop 0.32s cubic-bezier(0.34, 1.56, 0.64, 1); }

@keyframes badgeGlow {
    0%, 100% { box-shadow: 0 2px 8px rgba(37,99,235,0.08); }
    50%       { box-shadow: 0 4px 22px rgba(37,99,235,0.24); }
}

.job-count-badge.loaded { animation: badgeGlow 2s ease-in-out 2; }

.job-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 60%;
    height: 100%;
    background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
    transform: skewX(-20deg);
    transition: left 0.55s cubic-bezier(0.4,0,0.2,1);
    pointer-events: none;
    z-index: 1;
    border-radius: var(--radius-lg);
}

.job-card:hover::before { left: 140%; }
.admin-badge { animation: topBadgePulse 3s ease-in-out infinite; }

@keyframes topBadgePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.5); }
    50%       { box-shadow: 0 0 0 6px rgba(245,158,11,0); }
}

.jobs-grid { transition: opacity 0.15s ease; }
.jobs-grid.rendering { opacity: 0.3; pointer-events: none; }
</style>

<script>
(function patchRenderJobsDesign() {
    const _orig = window.renderJobs;
    if (!_orig) return;
    window.renderJobs = function() {
        const grid = document.getElementById('jobsGrid');
        const hasContent = grid && grid.children.length > 0 && !grid.querySelector('.skeleton-card');
        const doRender = () => {
            _orig();
            const jobCount = document.getElementById('jobCount');
            if (jobCount && !jobCount.querySelector('.job-count-badge')) {
                const raw = jobCount.textContent || '';
                const match = raw.match(/\d+/);
                const n = match ? match[0] : '0';
                jobCount.innerHTML = `<span class="job-count-badge loaded"><span class="job-count-number">${n}</span> вакансий найдено</span>`;
            } else if (jobCount && jobCount.querySelector('.job-count-badge')) {
                const numEl = jobCount.querySelector('.job-count-number');
                if (numEl) { const raw = jobCount.textContent || ''; const match = raw.match(/\d+/); if (match) numEl.textContent = match[0]; }
                const badge = jobCount.querySelector('.job-count-badge');
                if (badge) { badge.classList.remove('pop', 'loaded'); void badge.offsetWidth; badge.classList.add('pop'); setTimeout(() => { badge.classList.remove('pop'); badge.classList.add('loaded'); }, 340); }
            }
        };
        if (hasContent) { grid.classList.add('rendering'); setTimeout(() => { grid.classList.remove('rendering'); doRender(); }, 110); }
        else doRender();
    };
})();
</script>

<!-- ================= CHAT UI ENHANCEMENT ================= -->
<style>
#chatModal { backdrop-filter: blur(8px); }

.chat-message.sent::after {
    content: '✔';
    display: block;
    font-size: 11px;
    text-align: right;
    margin-top: 3px;
    opacity: 0.65;
    letter-spacing: -1px;
}

.chat-message.sent.read::after { content: '✔✔'; opacity: 1; color: #bfdbfe; }

@keyframes msgAppear {
    from { opacity: 0; transform: translateY(10px) scale(0.95); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}

.chat-message { animation: msgAppear 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) backwards; }

@keyframes sendPulse {
    0%, 100% { box-shadow: 0 2px 8px rgba(37,99,235,0.2); }
    50%       { box-shadow: 0 4px 18px rgba(37,99,235,0.4); }
}

#chatSendBtn:not(:disabled):hover { animation: sendPulse 1.2s ease-in-out infinite; }
#chatSendBtn:disabled { opacity: 0.42; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

.chat-typing-indicator {
    display: flex; align-items: center; gap: 4px;
    padding: 10px 14px;
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 18px;
    border-bottom-left-radius: 5px;
    width: fit-content;
    margin-bottom: 10px;
    animation: msgAppear 0.25s ease;
    box-shadow: var(--shadow-sm);
}

.chat-typing-dot { width: 6px; height: 6px; border-radius: 50%; background: #94a3b8; animation: typingBounce 1.2s ease-in-out infinite; }
.chat-typing-dot:nth-child(2) { animation-delay: 0.2s; }
.chat-typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30%            { transform: translateY(-5px); opacity: 1; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    const chatModal = document.getElementById('chatModal');
    if (!chatInput) return;
    function syncSendBtn() { const btn = document.getElementById('chatSendBtn'); if (btn) btn.disabled = !chatInput.value.trim(); }
    chatInput.addEventListener('input', syncSendBtn);
    syncSendBtn();
    if (chatModal) {
        new MutationObserver(() => { if (chatModal.classList.contains('active')) setTimeout(syncSendBtn, 100); }).observe(chatModal, { attributes: true, attributeFilter: ['class'] });
    }
});
</script>

<!-- ================= UX FILTER SYSTEM ================= -->
<style>
.filter-chips-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }

.filter-chip {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--soft-blue); color: var(--primary-blue);
    border: 1.5px solid rgba(37,99,235,0.22); border-radius: 24px;
    padding: 5px 14px 5px 12px; font-size: 13px; font-weight: 700;
    cursor: pointer; transition: var(--transition);
    animation: chipPop 0.22s cubic-bezier(0.34,1.56,0.64,1) backwards;
    user-select: none;
}

.filter-chip:hover { background: var(--primary-blue); color: var(--white); transform: scale(1.04); }
.filter-chip-remove { font-size: 14px; font-weight: 800; opacity: 0.65; line-height: 1; }

@keyframes chipPop { from { transform: scale(0.6); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.skeleton-card { background: var(--white); padding: 26px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 2px solid transparent; overflow: hidden; }
.skeleton-line { border-radius: 6px; background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; }

@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

.filter-restored-badge { display: inline-flex; align-items: center; gap: 5px; background: #dcfce7; color: #16a34a; border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 700; margin-left: 8px; animation: fadeIn 0.5s ease; transition: opacity 0.5s ease; }

.btn-ripple { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.35); transform: scale(0); animation: rippleAnim 0.55s linear; pointer-events: none; }

@keyframes rippleAnim { to { transform: scale(4); opacity: 0; } }
</style>

<script>
const FILTER_STORAGE_KEY = 'teenwork_filters_v1';
const FILTER_LABELS = {
    search: { id: 'searchInput',  label: 'Поиск',    type: 'input' },
    city:   { id: 'cityFilter',   label: 'Город',    type: 'select' },
    type:   { id: 'typeFilter',   label: 'Тип',      type: 'select' },
    salary: { id: 'salaryFilter', label: 'Зарплата', type: 'select' },
};

function initFilterChipsContainer() {
    const filterSection = document.querySelector('.filters-section');
    if (!filterSection || filterSection.querySelector('#filterChipsRow')) return;
    const actionsRow = filterSection.querySelector('.filter-actions');
    if (!actionsRow) return;
    const row = document.createElement('div');
    row.className = 'filter-chips-row';
    row.id = 'filterChipsRow';
    filterSection.insertBefore(row, actionsRow);
}

function renderFilterChips() {
    const row = document.getElementById('filterChipsRow');
    if (!row) return;
    row.innerHTML = '';
    let idx = 0;
    Object.entries(FILTER_LABELS).forEach(([, meta]) => {
        const el = document.getElementById(meta.id);
        if (!el || !el.value) return;
        const label = meta.type === 'select' && el.options[el.selectedIndex] ? el.options[el.selectedIndex].text : el.value;
        const chip = document.createElement('span');
        chip.className = 'filter-chip';
        chip.style.animationDelay = (idx * 40) + 'ms';
        chip.innerHTML = `${meta.label}: <strong>${label}</strong> <span class="filter-chip-remove">×</span>`;
        chip.addEventListener('click', () => { el.value = ''; applyFilters(); });
        row.appendChild(chip);
        idx++;
    });
}

function saveFiltersToStorage() {
    const s = {};
    Object.values(FILTER_LABELS).forEach(m => { const el = document.getElementById(m.id); if (el) s[m.id] = el.value; });
    const sort = document.getElementById('sortFilter');
    if (sort) s['sortFilter'] = sort.value;
    try { localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(s)); } catch(e) {}
}

function restoreFiltersFromStorage() {
    try {
        const saved = JSON.parse(localStorage.getItem(FILTER_STORAGE_KEY) || 'null');
        if (!saved) return false;
        let any = false;
        Object.values(FILTER_LABELS).forEach(m => { const el = document.getElementById(m.id); if (el && saved[m.id]) { el.value = saved[m.id]; any = true; } });
        const sort = document.getElementById('sortFilter');
        if (sort && saved['sortFilter']) sort.value = saved['sortFilter'];
        return any;
    } catch(e) { return false; }
}

function showRestoredBadge() {
    const jc = document.getElementById('jobCount');
    if (!jc) return;
    const badge = document.createElement('span');
    badge.className = 'filter-restored-badge';
    badge.textContent = '↩ Фильтры восстановлены';
    jc.parentNode.insertBefore(badge, jc.nextSibling);
    setTimeout(() => { badge.style.opacity = '0'; setTimeout(() => badge.remove(), 500); }, 3000);
}

function showJobSkeletons(count) {
    const grid = document.getElementById('jobsGrid');
    if (!grid) return;
    let html = '';
    for (let i = 0; i < count; i++) {
        html += `<div class="skeleton-card">
            <div class="skeleton-line" style="height:22px;width:70%;margin-bottom:12px;"></div>
            <div class="skeleton-line" style="height:14px;width:45%;margin-bottom:8px;"></div>
            <div class="skeleton-line" style="height:14px;width:35%;margin-bottom:20px;"></div>
            <div class="skeleton-line" style="height:28px;width:55%;margin-bottom:14px;"></div>
            <div class="skeleton-line" style="height:34px;width:40%;border-radius:24px;margin-bottom:22px;"></div>
            <div style="display:flex;justify-content:flex-end;"><div class="skeleton-line" style="height:36px;width:120px;border-radius:12px;"></div></div>
        </div>`;
    }
    grid.innerHTML = html;
}

const _origApplyFilters_ux = applyFilters;
window.applyFilters = function() { _origApplyFilters_ux(); renderFilterChips(); saveFiltersToStorage(); };

const _origResetFilters_ux = resetFilters;
window.resetFilters = function() { _origResetFilters_ux(); renderFilterChips(); try { localStorage.removeItem(FILTER_STORAGE_KEY); } catch(e) {} };

document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn, .btn-clear-filters');
    if (!btn) return;
    const ripple = document.createElement('span');
    ripple.className = 'btn-ripple';
    const r = btn.getBoundingClientRect();
    const size = Math.max(r.width, r.height);
    ripple.style.cssText = `width:${size}px;height:${size}px;left:${e.clientX-r.left-size/2}px;top:${e.clientY-r.top-size/2}px;`;
    btn.appendChild(ripple);
    ripple.addEventListener('animationend', () => ripple.remove());
}, true);

document.addEventListener('DOMContentLoaded', function() {
    initFilterChipsContainer();
    showJobSkeletons(6);
    const wasRestored = restoreFiltersFromStorage();
    if (wasRestored) {
        const poll = setInterval(() => {
            if (window.STATE && window.STATE.jobs.length > 0) { applyFilters(); showRestoredBadge(); clearInterval(poll); }
        }, 300);
        setTimeout(() => clearInterval(poll), 8000);
    }
});
</script>

<!-- ================= DESIGN REWORK ================= -->
<style>
.jobs-section .section-header h2::after { display: none !important; }

.jobs-section .section-header h2 {
    -webkit-text-fill-color: initial !important;
    background: none !important;
    background-clip: initial !important;
    filter: none !important;
    display: block !important;
    font-size: 0 !important;
    position: relative;
    min-height: 0;
}

.job-section-hero { display: flex; flex-direction: column; gap: 6px; animation: heroCounterIn 0.6s cubic-bezier(0.34,1.56,0.64,1) backwards; }

@keyframes heroCounterIn { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }

.job-section-label { font-size: 11px; font-weight: 700; letter-spacing: 2.5px; text-transform: uppercase; color: var(--primary-blue); opacity: 0.8; }

.job-section-count-row { display: flex; align-items: baseline; gap: 10px; line-height: 1; }

.job-section-num { font-size: 52px; font-weight: 800; letter-spacing: -3px; color: var(--text-dark); font-variant-numeric: tabular-nums; transition: color 0.3s ease; text-shadow: 0 2px 24px rgba(37,99,235,0.10); position: relative; }

.job-section-num::after { content: ''; display: none; }

.job-section-num-wrap { position: relative; display: inline-block; }

.job-section-num-wrap::before { content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--primary-blue), var(--blue-light)); border-radius: 3px; opacity: 0.18; filter: blur(4px); transition: opacity 0.4s ease, width 0.4s ease; }

.job-section-hero:hover .job-section-num-wrap::before { opacity: 0.32; }

.job-section-suffix { font-size: 20px; font-weight: 600; color: var(--text-gray); letter-spacing: -0.3px; padding-bottom: 4px; }

@keyframes numFlip { 0% { opacity: 0; transform: translateY(-14px) scale(0.9); } 100% { opacity: 1; transform: translateY(0) scale(1); } }

.job-section-num.flipping { animation: numFlip 0.28s cubic-bezier(0.34,1.56,0.64,1); }

#jobCount { display: none !important; }
</style>

<script>
(function installJobSectionHero() {
    function buildHero() {
        const sectionHeader = document.querySelector('.jobs-section .section-header');
        if (!sectionHeader || sectionHeader.querySelector('.job-section-hero')) return;
        const heroDiv = document.createElement('div');
        heroDiv.className = 'job-section-hero';
        heroDiv.id = 'jobSectionHero';
        heroDiv.innerHTML = `
            <div class="job-section-label">Вакансии</div>
            <div class="job-section-count-row">
                <div class="job-section-num-wrap"><span class="job-section-num" id="jobSectionNum">0</span></div>
                <span class="job-section-suffix" id="jobSectionSuffix">найдено</span>
            </div>
        `;
        const headerInner = sectionHeader.querySelector('div');
        if (headerInner) headerInner.insertBefore(heroDiv, headerInner.firstChild);
        else sectionHeader.insertBefore(heroDiv, sectionHeader.firstChild);
    }

    function animateCount(el, from, to, duration) {
        if (from === to) return;
        const startTime = performance.now();
        function tick(now) {
            const t = Math.min((now - startTime) / duration, 1);
            const eased = 1 - Math.pow(1 - t, 3);
            el.textContent = Math.round(from + (to - from) * eased);
            if (t < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
    }

    let _lastCount = null;

    function syncHeroCount() {
        const numEl = document.getElementById('jobSectionNum');
        if (!numEl) return;
        const count = window.STATE ? window.STATE.filteredJobs.length : 0;
        if (count === _lastCount) return;
        const prev = _lastCount === null ? 0 : _lastCount;
        _lastCount = count;
        numEl.classList.remove('flipping');
        void numEl.offsetWidth;
        numEl.classList.add('flipping');
        animateCount(numEl, prev, count, 420);
        const suffix = document.getElementById('jobSectionSuffix');
        if (suffix) {
            const mod10 = count % 10, mod100 = count % 100;
            let word;
            if (mod100 >= 11 && mod100 <= 14) word = 'найдено';
            else if (mod10 === 1) word = 'найдена';
            else if (mod10 >= 2 && mod10 <= 4) word = 'найдено';
            else word = 'найдено';
            suffix.textContent = word;
        }
    }

    const _origRenderForHero = window.renderJobs;
    window.renderJobs = function() { _origRenderForHero(); syncHeroCount(); };

    document.addEventListener('DOMContentLoaded', function() { buildHero(); syncHeroCount(); });
    setTimeout(() => { buildHero(); syncHeroCount(); }, 80);
})();
</script>

<!-- ================= CARD ANIMATION SYSTEM ================= -->
<style>
.job-card {
    background: #ffffff !important;
    padding: 30px 28px 24px !important;
    border-radius: 20px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06) !important;
    border: 1.5px solid rgba(226,232,240,0.8) !important;
    transition: box-shadow 0.35s cubic-bezier(0.4,0,0.2,1), transform 0.35s cubic-bezier(0.4,0,0.2,1), border-color 0.25s ease !important;
    position: relative;
    overflow: hidden;
}

.job-card:hover {
    transform: translateY(-8px) scale(1.012) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04), 0 12px 40px rgba(37,99,235,0.12), 0 24px 60px rgba(0,0,0,0.08) !important;
    border-color: rgba(37,99,235,0.3) !important;
}

.job-card:active { transform: translateY(-3px) scale(1.005) !important; transition-duration: 0.12s !important; }
.job-title { font-size: 19px !important; font-weight: 800 !important; letter-spacing: -0.4px !important; line-height: 1.25 !important; color: #0f172a !important; margin-bottom: 8px !important; }
.job-company { font-size: 14px !important; font-weight: 600 !important; color: var(--text-gray) !important; margin-bottom: 4px !important; }
.job-location { font-size: 13px !important; color: #94a3b8 !important; font-weight: 500 !important; }
.job-salary { font-size: 26px !important; font-weight: 800 !important; letter-spacing: -1px !important; margin-bottom: 16px !important; background: linear-gradient(130deg, #1d4ed8 0%, var(--blue-light) 100%) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; }
.tag { padding: 5px 12px !important; background: #f0f7ff !important; color: #2563eb !important; border-radius: 20px !important; font-size: 12px !important; font-weight: 700 !important; border: 1px solid rgba(37,99,235,0.12) !important; letter-spacing: 0.1px !important; }
.job-footer { padding-top: 16px !important; border-top: 1px solid #f1f5f9 !important; margin-top: 4px !important; }
.btn-apply { padding: 10px 22px !important; font-size: 13px !important; font-weight: 700 !important; letter-spacing: 0.2px !important; border-radius: var(--radius-md) !important; }

@keyframes cardEntry { from { opacity: 0; transform: translateY(28px); } to { opacity: 1; transform: translateY(0); } }

.job-card { animation: cardEntry 0.5s cubic-bezier(0.4,0,0.2,1) backwards !important; }
.job-card:nth-child(1) { animation-delay: 0.04s !important; }
.job-card:nth-child(2) { animation-delay: 0.09s !important; }
.job-card:nth-child(3) { animation-delay: 0.14s !important; }
.job-card:nth-child(4) { animation-delay: 0.19s !important; }
.job-card:nth-child(5) { animation-delay: 0.24s !important; }
.job-card:nth-child(6) { animation-delay: 0.29s !important; }

.job-card::before { z-index: 0 !important; border-radius: 20px !important; }

@keyframes modalSlideIn { from { opacity: 0; transform: scale(0.93) translateY(-24px); filter: blur(2px); } to { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); } }
@keyframes modalSlideOut { to { opacity: 0; transform: scale(0.96) translateY(-16px); filter: blur(1px); } }

.modal-content { animation: modalSlideIn 0.42s cubic-bezier(0.34,1.56,0.64,1) !important; }
.modal.hiding .modal-content { animation: modalSlideOut 0.28s ease forwards !important; }
.modal { backdrop-filter: blur(10px) !important; background: rgba(15, 23, 42, 0.5) !important; }
.jobs-grid { gap: 28px !important; }
</style>

<!-- ================= EMPLOYER VACANCY CONTROL ================= -->
<style>
.job-closed-badge { position: absolute; top: 12px; left: 14px; background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; letter-spacing: 0.4px; z-index: 2; pointer-events: none; box-shadow: 0 2px 8px rgba(239,68,68,0.3); }

.job-card.job-is-closed { opacity: 0.72; }
.job-card.job-is-closed::after { content: ''; position: absolute; inset: 0; background: rgba(241,245,249,0.45); border-radius: 20px; pointer-events: none; z-index: 0; }

.employer-vacancy-section { margin-top: 32px; background: var(--light-gray); border-radius: var(--radius-lg); padding: 24px; animation: fadeInUp 0.5s ease; }
.employer-vacancy-section h3 { font-size: 19px; font-weight: 700; margin-bottom: 18px; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
.employer-vacancy-section h3::before { content: '⚙️'; font-size: 18px; }

.employer-vacancy-card { background: var(--white); border-radius: var(--radius-md); padding: 18px; margin-bottom: 14px; box-shadow: var(--shadow-sm); border: 1.5px solid var(--border-gray); transition: var(--transition); }
.employer-vacancy-card:last-child { margin-bottom: 0; }
.employer-vacancy-card:hover { box-shadow: var(--shadow-md); border-color: rgba(37,99,235,0.2); }

.employer-vacancy-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.employer-vacancy-card-title { font-size: 16px; font-weight: 700; color: var(--text-dark); margin-bottom: 4px; }
.employer-vacancy-card-meta { font-size: 13px; color: var(--text-gray); font-weight: 500; }

.employer-vacancy-status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; flex-shrink: 0; transition: var(--transition); }
.employer-vacancy-status-badge.open { background: #dcfce7; color: #16a34a; }
.employer-vacancy-status-badge.closed { background: #fee2e2; color: #dc2626; }

.employer-vacancy-stats { display: flex; gap: 20px; margin-bottom: 14px; font-size: 13px; color: var(--text-gray); font-weight: 500; }
.employer-vacancy-stat { display: flex; align-items: center; gap: 5px; font-weight: 600; }

.employer-vacancy-controls { display: flex; gap: 8px; flex-wrap: wrap; }

.btn-toggle-vacancy { padding: 7px 16px; font-size: 12px; font-weight: 700; border-radius: var(--radius-sm); border: 1.5px solid var(--border-gray); cursor: pointer; transition: var(--transition); font-family: inherit; background: var(--white); color: var(--text-dark); }
.btn-toggle-vacancy:hover { border-color: var(--primary-blue); background: var(--soft-blue); color: var(--primary-blue); }
.btn-toggle-vacancy.close-action { border-color: #fca5a5; color: #dc2626; }
.btn-toggle-vacancy.close-action:hover { background: #fee2e2; border-color: #dc2626; }
.btn-toggle-vacancy.open-action { border-color: #86efac; color: #16a34a; }
.btn-toggle-vacancy.open-action:hover { background: #dcfce7; border-color: #16a34a; }

.btn-edit-vacancy { padding: 7px 16px; font-size: 12px; font-weight: 700; border-radius: var(--radius-sm); border: 1.5px solid rgba(37,99,235,0.3); cursor: pointer; transition: var(--transition); font-family: inherit; background: var(--soft-blue); color: var(--primary-blue); }
.btn-edit-vacancy:hover { background: var(--primary-blue); color: var(--white); border-color: var(--primary-blue); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.2); }

.btn-apply:disabled, .btn-apply[data-closed="true"] { opacity: 0.45 !important; cursor: not-allowed !important; background: var(--text-gray) !important; transform: none !important; box-shadow: none !important; }
</style>

<div class="modal" id="editVacancyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Редактировать вакансию</h3>
            <button class="modal-close" onclick="closeModal('editVacancyModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editVacancyForm">
                <input type="hidden" id="editVacancyId">
                <div class="form-group"><label>Название вакансии</label><input type="text" id="editVacancyTitle" required><div class="form-error">Это поле обязательно</div></div>
                <div class="form-group"><label>Зарплата (₽)</label><input type="number" id="editVacancySalary" required min="0"><div class="form-error">Введите корректную зарплату</div></div>
                <div class="form-group"><label>Тип работы</label><input type="text" id="editVacancyType" required><div class="form-error">Это поле обязательно</div></div>
                <div class="form-group"><label>Город</label><select id="editVacancyCity" required><option value="">Выберите город</option><option value="Санкт-Петербург">Санкт-Петербург</option></select><div class="form-error">Это поле обязательно</div></div>
                <div class="form-group"><label>Описание</label><textarea id="editVacancyDescription" required style="min-height: 110px; resize: vertical;"></textarea><div class="form-error">Это поле обязательно</div></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Сохранить изменения</button>
            </form>
        </div>
    </div>
</div>

<script>
(function patchRenderJobsForClosed() {
    const _origRender = window.renderJobs;
    if (!_origRender) return;
    window.renderJobs = function() {
        _origRender();
        const grid = document.getElementById('jobsGrid');
        if (!grid) return;
        const cards = grid.querySelectorAll('.job-card');
        cards.forEach(card => {
            const onclickAttr = card.getAttribute('onclick') || '';
            const match = onclickAttr.match(/openApplyModal\(['"]([^'"]+)['"]\)/);
            if (!match) return;
            const jobId = match[1];
            const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
            if (!job) return;
            if (job.isClosed) {
                card.classList.add('job-is-closed');
                if (!card.querySelector('.job-closed-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'job-closed-badge';
                    badge.textContent = 'Набор закрыт';
                    card.insertBefore(badge, card.firstChild);
                }
                const applyBtn = card.querySelector('.btn-apply');
                if (applyBtn) {
                    applyBtn.disabled = true;
                    applyBtn.dataset.closed = 'true';
                    applyBtn.title = 'Набор на эту вакансию закрыт';
                    applyBtn.onclick = (e) => { e.stopPropagation(); if (window.showToast) showToast('Набор закрыт', 'Работодатель приостановил набор на эту вакансию', 'warning'); };
                }
            }
        });
    };
})();

async function toggleVacancyClosed(jobId, currentlyClosed) {
    if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'jobs', jobId), { isClosed: !currentlyClosed });
        showToast('Успешно', currentlyClosed ? 'Набор открыт' : 'Набор закрыт', 'success');
        if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
        _renderEmployerVacancySection();
    } catch (e) { console.error('toggleVacancyClosed error:', e); showToast('Ошибка', 'Не удалось изменить статус', 'error'); }
}

function openEditVacancyModal(jobId) {
    const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
    if (!job) return;
    document.getElementById('editVacancyId').value = jobId;
    document.getElementById('editVacancyTitle').value = job.title || '';
    document.getElementById('editVacancySalary').value = job.salary || '';
    document.getElementById('editVacancyType').value = job.type || '';
    document.getElementById('editVacancyCity').value = job.city || '';
    document.getElementById('editVacancyDescription').value = job.description || '';
    openModal('editVacancyModal');
}

async function handleEditVacancySave(e) {
    e.preventDefault();
    const jobId = document.getElementById('editVacancyId').value;
    const title = document.getElementById('editVacancyTitle').value.trim();
    const salary = parseInt(document.getElementById('editVacancySalary').value);
    const type = document.getElementById('editVacancyType').value.trim();
    const city = document.getElementById('editVacancyCity').value;
    const description = document.getElementById('editVacancyDescription').value.trim();
    if (!title || !salary || !type || !city || !description) { showToast('Ошибка', 'Заполните все поля', 'error'); return; }
    if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'jobs', jobId), { title, salary, type, city, description, updatedAt: Date.now() });
        closeModal('editVacancyModal');
        showToast('Успешно', 'Вакансия обновлена', 'success');
        if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
        _renderEmployerVacancySection();
    } catch (e) { console.error('handleEditVacancySave error:', e); showToast('Ошибка', 'Не удалось обновить вакансию', 'error'); }
}

async function _renderEmployerVacancySection() {
    const profileBody = document.querySelector('.profile-body');
    if (!profileBody || !window.STATE || !window.STATE.currentUser) return;
    if (window.STATE.currentUser.role !== 'employer') return;
    const oldSection = document.getElementById('employerVacancyControlSection');
    if (oldSection) oldSection.remove();
    const userJobs = window.STATE.jobs.filter(j => j.employerEmail === window.STATE.currentUser.email || j.employerId === (window.STATE.currentUser.uid || window.STATE.currentUser.email));
    if (userJobs.length === 0) return;
    const section = document.createElement('div');
    section.className = 'employer-vacancy-section';
    section.id = 'employerVacancyControlSection';
    let html = '<h3>Управление вакансиями</h3>';
    for (const job of userJobs) {
        let appCount = 0;
        const viewCount = job.views || 0;
        if (window.db) {
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const q = query(collection(window.db, 'applications'), where('jobId', '==', job.id));
                const snap = await getDocs(q);
                appCount = snap.size;
            } catch (e) { }
        }
        const isClosed = !!job.isClosed;
        const statusClass = isClosed ? 'closed' : 'open';
        const statusText = isClosed ? '● Набор закрыт' : '● Набор открыт';
        html += `
            <div class="employer-vacancy-card">
                <div class="employer-vacancy-card-top">
                    <div><div class="employer-vacancy-card-title">${job.title}</div><div class="employer-vacancy-card-meta">${job.company} • ${(job.salary || 0).toLocaleString('ru-RU')} ₽</div></div>
                    <div class="employer-vacancy-status-badge ${statusClass}">${statusText}</div>
                </div>
                <div class="employer-vacancy-stats"><div class="employer-vacancy-stat">??️ <span>${viewCount} просмотров</span></div><div class="employer-vacancy-stat">?? <span>${appCount} откликов</span></div></div>
                <div class="employer-vacancy-controls">
                    <button class="btn-toggle-vacancy ${isClosed ? 'open-action' : 'close-action'}" onclick="toggleVacancyClosed('${job.id}', ${isClosed})">${isClosed ? '✓ Открыть набор' : '✗ Закрыть набор'}</button>
                    <button class="btn-edit-vacancy" onclick="openEditVacancyModal('${job.id}')">✎ Редактировать</button>
                    <button class="btn btn-small btn-primary" onclick="showApplications('${job.id}')">Отклики</button>
                </div>
            </div>
        `;
    }
    section.innerHTML = html;
    profileBody.appendChild(section);
}

const _origOpenProfileForVacancy = window.openProfile || openProfile;
window.openProfile = function() {
    _origOpenProfileForVacancy();
    setTimeout(() => { if (window.STATE && window.STATE.currentUser && window.STATE.currentUser.role === 'employer') _renderEmployerVacancySection(); }, 200);
};

document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editVacancyForm');
    if (editForm) editForm.addEventListener('submit', handleEditVacancySave);
});
</script>

<!-- ================= INTERACTION ENHANCEMENT ================= -->
<style>
.btn:not(:disabled):hover { transform: translateY(-2px) scale(1.02) !important; }
.btn:not(:disabled):active { transform: translateY(0) scale(0.97) !important; transition-duration: 0.08s !important; }
.back-btn:hover { transform: translateX(-2px) !important; }
.pagination-btn:hover:not(:disabled) { transform: translateY(-2px) !important; }
.faq-item { transition: box-shadow 0.25s ease, transform 0.25s ease !important; }
.faq-item:hover { transform: translateX(3px) !important; }
.info-card:hover { transform: translateY(-8px) scale(1.015) !important; box-shadow: 0 12px 36px rgba(37,99,235,0.12) !important; }

.section-fade-in { opacity: 0; transform: translateY(24px); transition: opacity 0.55s cubic-bezier(0.4,0,0.2,1), transform 0.55s cubic-bezier(0.4,0,0.2,1); }
.section-fade-in.visible { opacity: 1; transform: translateY(0); }

.modal-close:hover { transform: rotate(90deg) scale(1.15) !important; }
.nav-profile-wrapper { transition: background 0.2s ease, transform 0.2s ease !important; }
.nav-profile-wrapper:hover { transform: translateY(-1px) !important; }
.input:focus, .select:focus, .form-group input:focus, .form-group select:focus, .form-group textarea:focus { transform: scale(1.005); }
.role-option:hover { transform: translateX(4px) !important; }
.back-btn:hover { background: rgba(255,255,255,0.35) !important; transform: translateX(-3px) !important; }
.logo { transition: transform 0.3s ease, filter 0.3s ease !important; }
.applied-job-item { transition: box-shadow 0.2s ease, transform 0.2s ease; }
.applied-job-item:hover { transform: translateX(3px); box-shadow: var(--shadow-md); }
@keyframes slideInRight { from { transform: translateX(450px) scale(0.9); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
.logo:hover { filter: drop-shadow(0 4px 12px rgba(37,99,235,0.4)) !important; transform: translateY(-2px) !important; }
</style>

<script>
(function initScrollFadeIn() {
    const targets = ['.info-section', '.faq-section', '.footer', '.info-card', '.faq-item'];
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); observer.unobserve(entry.target); } });
    }, { rootMargin: '-40px 0px', threshold: 0.08 });

    function observeTargets() {
        targets.forEach(sel => {
            document.querySelectorAll(sel).forEach(el => { if (!el.classList.contains('visible')) { el.classList.add('section-fade-in'); observer.observe(el); } });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        observeTargets();
        document.getElementById('profilePage')?.addEventListener('transitionend', observeTargets);
    });
})();

document.addEventListener('keydown', function(e) {
    if (e.key !== 'Tab') return;
    const activeModal = document.querySelector('.modal.active');
    if (!activeModal) return;
    const focusable = activeModal.querySelectorAll('button:not(:disabled), input:not(:disabled), select:not(:disabled), textarea:not(:disabled), [tabindex]:not([tabindex="-1"])');
    if (focusable.length === 0) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (e.shiftKey) { if (document.activeElement === first) { e.preventDefault(); last.focus(); } }
    else { if (document.activeElement === last) { e.preventDefault(); first.focus(); } }
});
</script>

<!-- ================= APPLICATION STATUS EXTENSION ================= -->
<style>
/* APPLICATION STATUS — CSS */

.app-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.2px;
    transition: all 0.3s ease;
    animation: statusFadeIn 0.3s cubic-bezier(0.34,1.56,0.64,1) backwards;
}

.app-status-badge.status-new { background: #eff6ff; color: #2563eb; border: 1px solid rgba(37,99,235,0.2); }
.app-status-badge.status-accepted { background: #dcfce7; color: #16a34a; border: 1px solid rgba(22,163,74,0.2); }
.app-status-badge.status-rejected { background: #fee2e2; color: #dc2626; border: 1px solid rgba(220,38,38,0.2); }
.app-status-badge.status-in_progress { background: #fef9c3; color: #d97706; border: 1px solid rgba(217,119,6,0.2); }
.app-status-badge.status-hired { background: #d1fae5; color: #059669; border: 1px solid rgba(5,150,105,0.2); font-weight: 800; }
.app-status-badge.status-not_hired { background: #f3f4f6; color: #6b7280; border: 1px solid rgba(107,114,128,0.2); }
.app-status-badge.status-archived { background: #f1f5f9; color: #94a3b8; border: 1px solid rgba(148,163,184,0.2); }

@keyframes statusFadeIn { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }

.app-tabs { display: flex; gap: 4px; margin-bottom: 18px; background: var(--light-gray); border-radius: var(--radius-md); padding: 4px; flex-wrap: wrap; }

.app-tab-btn { flex"
    },
    "message": "Creating file",
    "integration_name": null,
    "integration_icon_url": null,
    "icon_name": "file",
    "context": null,
    "display_content": {
      "type": "json_block",
      "json_block": "{"language": "html", "code": "<!DOCTYPE html>
<html lang=\"ru\">
<head>
    <meta charset=\"UTF-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>TeenWork — Работа для подростков 14-18 лет</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563eb;
            --blue-hover: #1d4ed8;
            --blue-light: #3b82f6;
            --soft-blue: #eff6ff;
            --light-gray: #f8fafc;
            --border-gray: #e2e8f0;
            --text-dark: #0f172a;
            --text-gray: #64748b;
            --white: #ffffff;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --max-width: 1280px;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light-gray);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            opacity: 0;
            animation: fadeInPage 0.4s ease forwards;
        }

        @keyframes fadeInPage {
            to { opacity: 1; }
        }

        .nav {
            position: sticky;
            top: 0;
            background: var(--white);
            box-shadow: var(--shadow-sm);
            z-index: 1000;
            padding: 16px 0;
            transition: var(--transition);
        }

        .nav.scrolled {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-md);
        }

        .nav-container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 30px;
            font-weight: 800;
            color: var(--primary-blue);
            letter-spacing: -1px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--blue-light));
            transition: width 0.4s ease;
            border-radius: 2px;
        }

        .logo:hover::after {
            width: 100%;
        }

        .logo:hover {
            transform: translateY(-1px);
            filter: drop-shadow(0 4px 8px rgba(37, 99, 235, 0.3));
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .nav-profile-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            transition: var(--transition);
        }

        .nav-profile-wrapper:hover {
            background: var(--light-gray);
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            transition: var(--transition);
            border: 2px solid transparent;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .nav-profile-wrapper:hover .user-avatar {
            border-color: var(--primary-blue);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .nav-profile-text {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-dark);
        }

        .btn {
            padding: 11px 24px;
            border-radius: var(--radius-md);
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.35);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-dark);
            border: 1.5px solid var(--border-gray);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--light-gray);
            border-color: var(--text-gray);
        }

        .btn-small {
            padding: 7px 16px;
            font-size: 13px;
        }

        .hero {
            background: linear-gradient(135deg, #1e40af 0%, var(--primary-blue) 50%, var(--blue-light) 100%);
            color: var(--white);
            padding: 100px 24px 120px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .hero-content {
            max-width: 850px;
            margin: 0 auto;
            animation: fadeInUp 0.7s ease;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero h1 {
            font-size: 58px;
            font-weight: 800;
            margin-bottom: 24px;
            line-height: 1.1;
            letter-spacing: -2px;
            animation: fadeInUp 0.7s ease 0.1s backwards;
        }

        .hero p {
            font-size: 21px;
            margin-bottom: 40px;
            opacity: 0.95;
            font-weight: 500;
            line-height: 1.7;
            animation: fadeInUp 0.7s ease 0.2s backwards;
        }

        .hero-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            animation: fadeInUp 0.7s ease 0.3s backwards;
        }

        .btn-hero {
            padding: 16px 36px;
            font-size: 17px;
            border-radius: var(--radius-lg);
            font-weight: 700;
        }

        .btn-white {
            background: var(--white);
            color: var(--primary-blue);
        }

        .btn-white:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--white);
            border: 2.5px solid var(--white);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px;
        }

        .filters-section {
            background: var(--white);
            padding: 36px 28px;
            margin-top: -60px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            position: relative;
            z-index: 10;
            animation: fadeInUp 0.6s ease 0.4s backwards;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-bottom: 18px;
        }

        .input, .select {
            width: 100%;
            padding: 13px 18px;
            border: 1.5px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: var(--transition);
            background: var(--white);
            font-weight: 500;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        .sort-dropdown {
            margin-left: auto;
            min-width: 200px;
        }

        .jobs-section {
            padding: 70px 0;
        }

        .section-header {
            margin-bottom: 36px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-header h2 {
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .section-info {
            color: var(--text-gray);
            font-size: 16px;
            font-weight: 500;
        }

        .jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .job-card {
            background: var(--white);
            padding: 26px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            animation: fadeIn 0.5s ease backwards;
        }

        .job-card:nth-child(1) { animation-delay: 0.05s; }
        .job-card:nth-child(2) { animation-delay: 0.1s; }
        .job-card:nth-child(3) { animation-delay: 0.15s; }
        .job-card:nth-child(4) { animation-delay: 0.2s; }
        .job-card:nth-child(5) { animation-delay: 0.25s; }
        .job-card:nth-child(6) { animation-delay: 0.3s; }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .job-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-blue);
        }

        .job-header {
            margin-bottom: 18px;
        }

        .job-title {
            font-size: 21px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .job-company {
            color: var(--text-gray);
            font-size: 15px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .job-location {
            color: var(--text-gray);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .job-details {
            margin-bottom: 18px;
        }

        .job-salary {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 14px;
        }

        .job-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 18px;
        }

        .tag {
            padding: 7px 14px;
            background: var(--soft-blue);
            color: var(--primary-blue);
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
        }

        .job-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-top: 18px;
            border-top: 1.5px solid var(--border-gray);
        }

        .btn-apply {
            padding: 9px 22px;
            font-size: 14px;
        }

        .info-section {
            padding: 90px 0;
            background: var(--white);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 32px;
            margin-top: 56px;
        }

        .info-card {
            padding: 36px;
            background: var(--light-gray);
            border-radius: var(--radius-lg);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .info-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-md);
            border-color: var(--soft-blue);
            background: var(--white);
        }

        .info-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--soft-blue), #dbeafe);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 24px;
            transition: var(--transition);
        }

        .info-card:hover .info-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .info-card h3 {
            font-size: 21px;
            margin-bottom: 14px;
            font-weight: 700;
        }

        .info-card p {
            color: var(--text-gray);
            line-height: 1.7;
            font-weight: 500;
        }

        .faq-section {
            padding: 90px 0;
        }

        .faq-list {
            max-width: 850px;
            margin: 56px auto 0;
        }

        .faq-item {
            background: var(--white);
            border-radius: var(--radius-lg);
            margin-bottom: 18px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .faq-item:hover {
            box-shadow: var(--shadow-md);
        }

        .faq-question {
            padding: 22px 26px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 16px;
            transition: var(--transition);
            user-select: none;
        }

        .faq-question:hover {
            background: var(--light-gray);
        }

        .faq-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
            flex-shrink: 0;
            color: var(--primary-blue);
        }

        .faq-item.active .faq-icon {
            transform: rotate(180deg);
        }

        .faq-item.active .faq-question {
            background: var(--soft-blue);
            color: var(--primary-blue);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .faq-answer-content {
            padding: 0 26px 22px;
            color: var(--text-gray);
            line-height: 1.8;
            font-weight: 500;
        }

        .footer {
            background: var(--text-dark);
            color: var(--white);
            padding: 60px 0 28px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-section h4 {
            margin-bottom: 18px;
            font-size: 17px;
            font-weight: 700;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
        }

        .footer-links a:hover {
            color: var(--white);
            padding-left: 4px;
        }

        .footer-bottom {
            padding-top: 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(6px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-xl);
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal.hiding .modal-content {
            animation: modalSlideOut 0.3s ease forwards;
        }

        @keyframes modalSlideOut {
            to {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
        }

        .modal-header {
            padding: 28px;
            border-bottom: 1.5px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .modal-close {
            background: var(--light-gray);
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-gray);
            transition: var(--transition);
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: var(--border-gray);
            color: var(--text-dark);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 28px;
        }

        .form-group {
            margin-bottom: 22px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 13px 18px;
            border: 1.5px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: var(--transition);
            font-weight: 500;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 110px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .form-error {
            color: var(--error);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            font-weight: 600;
        }

        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: var(--error);
        }

        .form-group.error .form-error {
            display: block;
        }

        .password-toggle {
            position: absolute;
            right: 18px;
            top: 42px;
            cursor: pointer;
            color: var(--text-gray);
            font-size: 18px;
            user-select: none;
        }

        .password-toggle:hover {
            color: var(--text-dark);
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: var(--text-gray);
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .empty-state-icon {
            font-size: 72px;
            margin-bottom: 24px;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 26px;
            margin-bottom: 14px;
            color: var(--text-dark);
            font-weight: 700;
        }

        .empty-state p {
            font-weight: 500;
        }

        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--white);
            padding: 18px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: start;
            gap: 14px;
            min-width: 320px;
            max-width: 420px;
            animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 4px solid;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(450px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideOutRight {
            to {
                transform: translateX(450px);
                opacity: 0;
            }
        }

        .toast-icon {
            font-size: 26px;
            flex-shrink: 0;
            line-height: 1;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--text-gray);
            line-height: 1.5;
            font-weight: 500;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.error .toast-icon {
            color: var(--error);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 48px;
        }

        .pagination-btn {
            padding: 10px 18px;
            border: 1.5px solid var(--border-gray);
            background: var(--white);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--light-gray);
            border-color: var(--primary-blue);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .profile-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            z-index: 1500;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-page.active {
            transform: translateX(0);
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            padding: 40px 24px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .profile-nav {
            max-width: var(--max-width);
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-family: inherit;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-title {
            max-width: var(--max-width);
            margin: 0 auto;
        }

        .profile-title h1 {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .profile-body {
            max-width: 700px;
            margin: 0 auto;
            padding: 60px 24px;
        }

        .profile-avatar-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .profile-avatar-display {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 4px solid var(--white);
            box-shadow: var(--shadow-lg);
        }

        .profile-avatar-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            display: inline-block;
            margin-top: 10px;
        }

        .avatar-upload input {
            display: none;
        }

        .avatar-upload label {
            cursor: pointer;
            color: var(--primary-blue);
            font-weight: 600;
            text-decoration: underline;
        }

        .profile-info {
            background: var(--light-gray);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }

        .profile-info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-gray);
        }

        .profile-info-item:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            font-weight: 600;
            color: var(--text-gray);
        }

        .profile-info-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .profile-section {
            margin-bottom: 32px;
        }

        .profile-section h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .applied-jobs-list {
            background: var(--light-gray);
            padding: 20px;
            border-radius: var(--radius-lg);
        }

        .applied-job-item {
            background: var(--white);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .applied-job-item:last-child {
            margin-bottom: 0;
        }

        .applied-job-title {
            font-weight: 600;
            color: var(--text-dark);
        }

        .applied-job-company {
            font-size: 14px;
            color: var(--text-gray);
        }

        .role-selector-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .role-option {
            padding: 18px;
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .role-option:hover {
            border-color: var(--primary-blue);
            background: var(--soft-blue);
        }

        .admin-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .admin-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1.5px solid var(--border-gray);
        }

        .btn-admin {
            flex: 1;
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-danger {
            background: var(--error);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .job-stats {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-gray);
        }

        .application-list-item {
            background: var(--white);
            padding: 14px;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
        }

        .application-list-item:last-child {
            margin-bottom: 0;
        }

        .application-worker-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .application-worker-email {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--light-gray);
            border-radius: var(--radius-md);
            scroll-behavior: smooth;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            max-width: 70%;
            word-wrap: break-word;
            display: block;
            line-height: 1.5;
            font-size: 14px;
            font-weight: 500;
        }

        .chat-message.sent {
            background: linear-gradient(135deg, var(--primary-blue), var(--blue-light));
            color: var(--white);
            margin-left: auto;
            margin-right: 0;
            text-align: right;
            border-bottom-right-radius: 4px;
        }

        .chat-message.received {
            background: var(--white);
            color: var(--text-dark);
            margin-right: auto;
            margin-left: 0;
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .chat-message-image {
            max-width: 220px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            display: block;
        }

        .chat-message-image:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        .chat-message-audio {
            max-width: 260px;
            width: 100%;
            height: 36px;
            border-radius: 20px;
            outline: none;
            accent-color: var(--primary-blue);
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-input-container input {
            flex: 1;
        }

        .chat-media-toolbar {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .chat-media-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1.5px solid var(--border-gray);
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .chat-media-btn:hover {
            background: var(--soft-blue);
            border-color: var(--primary-blue);
            transform: scale(1.08);
        }

        .chat-media-btn.recording {
            background: #fee2e2;
            border-color: var(--error);
            animation: recordPulse 1s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }

        #chatImageInput {
            display: none;
        }

        .chat-upload-indicator {
            font-size: 12px;
            color: var(--text-gray);
            padding: 4px 8px;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            display: none;
        }

        .chat-upload-indicator.visible {
            display: block;
        }

        .admin-panel-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: var(--white);
            padding: 6px 14px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 40px;
                letter-spacing: -1px;
            }

            .hero p {
                font-size: 18px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .jobs-grid {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .hero-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn-hero {
                width: 100%;
            }

            .nav-actions {
                gap: 8px;
            }

            .btn {
                padding: 9px 16px;
                font-size: 14px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .sort-dropdown {
                margin-left: 0;
                width: 100%;
            }

            .toast-container {
                right: 12px;
                left: 12px;
            }

            .toast {
                min-width: auto;
                max-width: none;
            }

            .profile-title h1 {
                font-size: 32px;
            }

            .logo {
                font-size: 24px;
            }

            .nav-profile-text {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class=\"toast-container\" id=\"toastContainer\"></div>

    <nav class=\"nav\" id=\"navbar\">
        <div class=\"nav-container\">
            <div class=\"logo\" onclick=\"scrollToTop()\">TeenWork</div>
            <div class=\"nav-actions\" id=\"navActions\"></div>
        </div>
    </nav>

    <section class=\"hero\">
        <div class=\"hero-content\">
            <h1>Твоя первая работа начинается здесь</h1>
            <p>Безопасная платформа для поиска работы подросткам 14-18 лет. Официальное трудоустройство, реальная зарплата, проверенные работодатели.</p>
            <div class=\"hero-actions\">
                <button class=\"btn btn-hero btn-white\" onclick=\"scrollToSearch()\">Найти работу</button>
                <button class=\"btn btn-hero btn-outline\" onclick=\"handleEmployerButtonClick()\">Работодателям</button>
            </div>
        </div>
    </section>

    <div class=\"container\">
        <section class=\"filters-section\" id=\"search\">
            <div class=\"filters-grid\">
                <input type=\"text\" class=\"input\" id=\"searchInput\" placeholder=\"Поиск по названию или компании...\">
                <select class=\"select\" id=\"cityFilter\">
                    <option value=\"\">Все города</option>
                    <option value=\"Санкт-Петербург\">Санкт-Петербург</option>
                </select>
                <select class=\"select\" id=\"typeFilter\">
                    <option value=\"\">Тип работы</option>
                    <option value=\"Частичная занятость\">Частичная занятость</option>
                    <option value=\"Сезонная\">Сезонная</option>
                    <option value=\"Постоянная\">Постоянная</option>
                    <option value=\"Временная\">Временная</option>
                </select>
                <select class=\"select\" id=\"salaryFilter\">
                    <option value=\"\">Зарплата</option>
                    <option value=\"0-20000\">до 20 000 ₽</option>
                    <option value=\"20000-35000\">20 000 - 35 000 ₽</option>
                    <option value=\"35000-50000\">35 000 - 50 000 ₽</option>
                </select>
            </div>
            <div class=\"filter-actions\">
                <button class=\"btn btn-primary\" onclick=\"applyFilters()\">Применить фильтры</button>
                <button class=\"btn btn-secondary\" onclick=\"resetFilters()\">Сбросить</button>
                <select class=\"select sort-dropdown\" id=\"sortFilter\">
                    <option value=\"salary-desc\">По убыванию зарплаты</option>
                    <option value=\"salary-asc\">По возрастанию зарплаты</option>
                </select>
            </div>
        </section>

        <section class=\"jobs-section\">
            <div class=\"section-header\">
                <div>
                    <h2>Актуальные вакансии</h2>
                    <p class=\"section-info\" id=\"jobCount\">Найдено вакансий: 0</p>
                </div>
            </div>
            <div class=\"jobs-grid\" id=\"jobsGrid\"></div>
            <div class=\"pagination\" id=\"pagination\"></div>
        </section>
    </div>

    <section class=\"info-section\">
        <div class=\"container\">
            <div class=\"section-header\" style=\"text-align: center; display: block;\">
                <h2>Безопасность подростков — наш приоритет</h2>
                <p class=\"section-info\">Мы тщательно проверяем каждого работодателя</p>
            </div>
            <div class=\"info-grid\">
                <div class=\"info-card\">
                    <div class=\"info-icon\">??️</div>
                    <h3>Проверенные работодатели</h3>
                    <p>Все компании проходят обязательную верификацию. Мы проверяем юридические данные и репутацию.</p>
                </div>
                <div class=\"info-card\">
                    <div class=\"info-icon\">??</div>
                    <h3>Официальное оформление</h3>
                    <p>Только легальное трудоустройство с соблюдением Трудового кодекса РФ для несовершеннолетних.</p>
                </div>
                <div class=\"info-card\">
                    <div class=\"info-icon\">⏰</div>
                    <h3>Безопасный график</h3>
                    <p>Контроль рабочего времени согласно законодательству: не более 24 часов в неделю для школьников.</p>
                </div>
                <div class=\"info-card\">
                    <div class=\"info-icon\">??</div>
                    <h3>Гарантия выплат</h3>
                    <p>Прозрачные условия оплаты труда. Никаких скрытых комиссий и задержек зарплаты.</p>
                </div>
            </div>
        </div>
    </section>

    <section class=\"faq-section\">
        <div class=\"container\">
            <div class=\"section-header\" style=\"text-align: center; display: block;\">
                <h2>Часто задаваемые вопросы</h2>
                <p class=\"section-info\">Ответы на популярные вопросы о работе для подростков</p>
            </div>
            <div class=\"faq-list\" id=\"faqList\">
                <div class=\"faq-item\">
                    <div class=\"faq-question\" onclick=\"toggleFaq(this)\">
                        <span>С какого возраста можно работать?</span>
                        <span class=\"faq-icon\">▼</span>
                    </div>
                    <div class=\"faq-answer\">
                        <div class=\"faq-answer-content\">
                            По Трудовому кодексу РФ официально трудоустроиться можно с 14 лет с письменного согласия родителей. С 16 лет - самостоятельно. Все вакансии на нашей платформе соответствуют этим требованиям.
                        </div>
                    </div>
                </div>
                <div class=\"faq-item\">
                    <div class=\"faq-question\" onclick=\"toggleFaq(this)\">
                        <span>Сколько часов в неделю может работать подросток?</span>
                        <span class=\"faq-icon\">▼</span>
                    </div>
                    <div class=\"faq-answer\">
                        <div class=\"faq-answer-content\">
                            В возрасте 14-15 лет во время учебы - не более 12 часов в неделю, в каникулы - не более 24 часов. В возрасте 16-18 лет - не более 17,5 часов в неделю во время учебы и не более 35 часов в каникулы.
                        </div>
                    </div>
                </div>
                <div class=\"faq-item\">
                    <div class=\"faq-question\" onclick=\"toggleFaq(this)\">
                        <span>Нужны ли какие-то документы?</span>
                        <span class=\"faq-icon\">▼</span>
                    </div>
                    <div class=\"faq-answer\">
                        <div class=\"faq-answer-content\">
                            Да. Вам понадобятся: паспорт, согласие родителей (для 14-15 лет), справка из школы, медицинская справка формы 086/у. СНИЛС и ИНН также потребуются для оформления.
                        </div>
                    </div>
                </div>
                <div class=\"faq-item\">
                    <div class=\"faq-question\" onclick=\"toggleFaq(this)\">
                        <span>Как проверить надежность работодателя?</span>
                        <span class=\"faq-icon\">▼</span>
                    </div>
                    <div class=\"faq-answer\">
                        <div class=\"faq-answer-content\">
                            Мы проверяем все компании перед размещением вакансий. Вы можете увидеть рейтинг работодателя, отзывы других подростков, а также проверить юридические данные компании в карточке вакансии.
                        </div>
                    </div>
                </div>
                <div class=\"faq-item\">
                    <div class=\"faq-question\" onclick=\"toggleFaq(this)\">
                        <span>Можно ли работать удалённо?</span>
                        <span class=\"faq-icon\">▼</span>
                    </div>
                    <div class=\"faq-answer\">
                        <div class=\"faq-answer-content\">
                            Да, у нас есть удалённые вакансии: SMM-менеджер, контент-мейкер, дизайнер, помощник в онлайн-магазине и другие. Удалённая работа также оформляется официально.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class=\"footer\">
        <div class=\"container\">
            <div class=\"footer-content\">
                <div class=\"footer-section\">
                    <h4>О платформе</h4>
                    <ul class=\"footer-links\">
                        <li><a onclick=\"openModal('infoModal', 'about')\">О нас</a></li>
                        <li><a onclick=\"openModal('infoModal', 'how-it-works')\">Как это работает</a></li>
                        <li><a onclick=\"openModal('infoModal', 'safety')\">Безопасность</a></li>
                    </ul>
                </div>
                <div class=\"footer-section\">
                    <h4>Работодателям</h4>
                    <ul class=\"footer-links\">
                        <li><a onclick=\"openModal('infoModal', 'employers')\">Информация</a></li>
                    </ul>
                </div>
                <div class=\"footer-section\">
                    <h4>Поддержка</h4>
                    <ul class=\"footer-links\">
                        <li><a onclick=\"openModal('infoModal', 'support')\">Помощь</a></li>
                    </ul>
                </div>
                <div class=\"footer-section\">
                    <h4>Правовая информация</h4>
                    <ul class=\"footer-links\">
                        <li><a onclick=\"openModal('infoModal', 'legal')\">Документы</a></li>
                    </ul>
                </div>
            </div>
            <div class=\"footer-bottom\">
                <p>&copy; 2026 TeenWork. Все права защищены. Первая платформа работы для подростков в России.</p>
            </div>
        </div>
    </footer>

    <div class=\"profile-page\" id=\"profilePage\">
        <div class=\"profile-header\">
            <div class=\"profile-nav\">
                <button class=\"back-btn\" onclick=\"closeProfile()\">← Назад</button>
            </div>
            <div class=\"profile-title\">
                <h1>Мой профиль</h1>
            </div>
        </div>
        <div class=\"profile-body\">
            <div class=\"profile-avatar-section\">
                <div class=\"profile-avatar-display\" id=\"profileAvatarDisplay\"></div>
                <div class=\"avatar-upload\">
                    <input type=\"file\" id=\"avatarUpload\" accept=\"image/*\">
                    <label for=\"avatarUpload\">Изменить фото</label>
                </div>
            </div>
            
            <form id=\"profileForm\">
                <div class=\"form-group\">
                    <label>Никнейм</label>
                    <input type=\"text\" id=\"profileNickname\" required>
                    <div class=\"form-error\">Это поле обязательно</div>
                </div>
                
                <div class=\"profile-info\">
                    <div class=\"profile-info-item\">
                        <span class=\"profile-info-label\">Email:</span>
                        <span class=\"profile-info-value\" id=\"profileEmail\"></span>
                    </div>
                    <div class=\"profile-info-item\">
                        <span class=\"profile-info-label\">Роль:</span>
                        <span class=\"profile-info-value\" id=\"profileRole\"></span>
                    </div>
                    <div class=\"profile-info-item\">
                        <span class=\"profile-info-label\">Дата регистрации:</span>
                        <span class=\"profile-info-value\" id=\"profileDate\"></span>
                    </div>
                </div>
                
                <button type=\"submit\" class=\"btn btn-primary\" style=\"width: 100%; margin-bottom: 12px;\">Сохранить изменения</button>
                <button type=\"button\" class=\"btn btn-secondary\" style=\"width: 100%; margin-bottom: 12px;\" onclick=\"openRoleSelectorModal()\">Изменить роль</button>
                <button type=\"button\" class=\"btn btn-secondary\" style=\"width: 100%;\" onclick=\"logout()\">Выйти из аккаунта</button>
            </form>

            <div id=\"profileApplicationsSection\" style=\"display: none;\">
                <div class=\"profile-section\">
                    <h3>Мои отклики</h3>
                    <div class=\"applied-jobs-list\" id=\"appliedJobsList\"></div>
                </div>
            </div>

            <div id=\"profileEmployerSection\" style=\"display: none;\">
                <div class=\"profile-section\">
                    <h3>Мои размещенные вакансии</h3>
                    <div class=\"applied-jobs-list\" id=\"employerJobsList\"></div>
                </div>
            </div>
        </div>
    </div>

    <div class=\"modal\" id=\"loginModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3>Вход в аккаунт</h3>
                <button class=\"modal-close\" onclick=\"closeModal('loginModal')\">&times;</button>
            </div>
            <div class=\"modal-body\">
                <form id=\"loginForm\">
                    <div class=\"form-group\">
                        <label>Email</label>
                        <input type=\"email\" name=\"email\" required>
                        <div class=\"form-error\">Введите корректный email</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Пароль</label>
                        <input type=\"password\" id=\"loginPassword\" name=\"password\" required>
                        <span class=\"password-toggle\" onclick=\"togglePassword('loginPassword')\">??️</span>
                        <div class=\"form-error\">Неверный пароль или email</div>
                    </div>
                    <button type=\"submit\" class=\"btn btn-primary\" style=\"width: 100%; margin-top: 8px;\">Войти</button>
                </form>
            </div>
        </div>
    </div>

    <div class=\"modal\" id=\"registerModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3>Регистрация</h3>
                <button class=\"modal-close\" onclick=\"closeModal('registerModal')\">&times;</button>
            </div>
            <div class=\"modal-body\">
                <form id=\"registerForm\">
                    <div class=\"form-group\">
                        <label>Никнейм</label>
                        <input type=\"text\" name=\"nickname\" required>
                        <div class=\"form-error\">Это поле обязательно</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Email</label>
                        <input type=\"email\" name=\"email\" required>
                        <div class=\"form-error\">Введите корректный email</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Пароль (минимум 6 символов)</label>
                        <input type=\"password\" id=\"registerPassword\" name=\"password\" required>
                        <span class=\"password-toggle\" onclick=\"togglePassword('registerPassword')\">??️</span>
                        <div class=\"form-error\">Пароль должен быть не менее 6 символов</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Я регистрируюсь как</label>
                        <select name=\"role\" id=\"registerRoleSelect\" required>
                            <option value=\"\">Выберите роль</option>
                            <option value=\"worker\">Я ищу работу</option>
                            <option value=\"employer\">Я работодатель</option>
                        </select>
                        <div class=\"form-error\">Выберите роль</div>
                    </div>
                    <button type=\"submit\" class=\"btn btn-primary\" style=\"width: 100%; margin-top: 8px;\">Зарегистрироваться</button>
                </form>
            </div>
        </div>
    </div>

    <div class=\"modal\" id=\"applyModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3>Откликнуться на вакансию</h3>
                <button class=\"modal-close\" onclick=\"closeModal('applyModal')\">&times;</button>
            </div>
            <div class=\"modal-body\" id=\"applyModalBody\"></div>
        </div>
    </div>

    <div class=\"modal\" id=\"postJobModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3>Разместить вакансию</h3>
                <button class=\"modal-close\" onclick=\"closeModal('postJobModal')\">&times;</button>
            </div>
            <div class=\"modal-body\">
                <form id=\"postJobForm\">
                    <div class=\"form-group\">
                        <label>Название вакансии</label>
                        <input type=\"text\" name=\"title\" required>
                        <div class=\"form-error\">Это поле обязательно</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Компания</label>
                        <input type=\"text\" name=\"company\" required>
                        <div class=\"form-error\">Это поле обязательно</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Город</label>
                        <select name=\"city\" required>
                            <option value=\"\">Выберите город</option>
                            <option value=\"Санкт-Петербург\">Санкт-Петербург</option>
                        </select>
                        <div class=\"form-error\">Это поле обязательно</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Зарплата (₽)</label>
                        <input type=\"number\" name=\"salary\" required min=\"0\">
                        <div class=\"form-error\">Введите корректную зарплату</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Тип работы</label>
                        <input type=\"text\" name=\"type\" placeholder=\"Например: Частичная занятость, сменный график\" required>
                        <div class=\"form-error\">Это поле обязательно</div>
                    </div>
                    <div class=\"form-group\">
                        <label>Описание</label>
                        <textarea name=\"description\" required></textarea>
                        <div class=\"form-error\">Это поле обязательно</div>
                    </div>
                    <button type=\"submit\" class=\"btn btn-primary\" style=\"width: 100%; margin-top: 8px;\">Разместить вакансию</button>
                </form>
            </div>
        </div>
    </div>

    <div class=\"modal\" id=\"infoModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3 id=\"infoModalTitle\"></h3>
                <button class=\"modal-close\" onclick=\"closeModal('infoModal')\">&times;</button>
            </div>
            <div class=\"modal-body\" id=\"infoModalBody\"></div>
        </div>
    </div>

    <div class=\"modal\" id=\"roleSelectorModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3>Изменить роль</h3>
                <button class=\"modal-close\" onclick=\"closeModal('roleSelectorModal')\">&times;</button>
            </div>
            <div class=\"modal-body\">
                <div class=\"role-selector-options\">
                    <div class=\"role-option\" onclick=\"changeUserRole('worker')\">
                        <div style=\"font-size: 18px; margin-bottom: 4px;\">Я ищу работу</div>
                        <div style=\"font-size: 14px; color: var(--text-gray); font-weight: 500;\">Соискатель</div>
                    </div>
                    <div class=\"role-option\" onclick=\"changeUserRole('employer')\">
                        <div style=\"font-size: 18px; margin-bottom: 4px;\">Я работодатель</div>
                        <div style=\"font-size: 14px; color: var(--text-gray); font-weight: 500;\">Размещение вакансий</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class=\"modal\" id=\"workerNeedsChangeModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3>Изменить роль</h3>
                <button class=\"modal-close\" onclick=\"closeModal('workerNeedsChangeModal')\">&times;</button>
            </div>
            <div class=\"modal-body\">
                <p style=\"margin-bottom: 20px; line-height: 1.7; color: var(--text-gray);\">Чтобы разместить вакансию, смените роль на Работодатель</p>
                <button class=\"btn btn-primary\" style=\"width: 100%;\" onclick=\"openRoleSelectorModalFromWorker()\">Сменить роль</button>
            </div>
        </div>
    </div>

    <div class=\"modal\" id=\"applicationsModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3>Отклики на вакансию</h3>
                <button class=\"modal-close\" onclick=\"closeModal('applicationsModal')\">&times;</button>
            </div>
            <div class=\"modal-body\" id=\"applicationsModalBody\"></div>
        </div>
    </div>

    <div class=\"modal\" id=\"chatModal\">
        <div class=\"modal-content\">
            <div class=\"modal-header\">
                <h3 id=\"chatModalTitle\">Чат</h3>
                <button class=\"modal-close\" onclick=\"closeModal('chatModal')\">&times;</button>
            </div>
            <div class=\"modal-body\">
                <div class=\"chat-messages\" id=\"chatMessages\"></div>
                <div class=\"chat-upload-indicator\" id=\"chatUploadIndicator\">⏳ Загрузка файла...</div>
                <div class=\"chat-input-container\">
                    <input type=\"file\" id=\"chatImageInput\" accept=\"image/*\">
                    <button class=\"chat-media-btn\" onclick=\"triggerChatImageUpload()\" title=\"Отправить изображение\">??️</button>
                    <button class=\"chat-media-btn\" id=\"voiceRecordBtn\" onclick=\"toggleVoiceRecording()\" title=\"Голосовое сообщение\">??️</button>
                    <input type=\"text\" class=\"input\" id=\"chatInput\" placeholder=\"Введите сообщение...\">
                    <button class=\"btn btn-primary\" id=\"chatSendBtn\" onclick=\"sendChatMessage()\">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const JOBS = [
            {
                id: 1,
                title: 'Промоутер водных экскурсий',
                company: 'Нева Тревел',
                city: 'Санкт-Петербург',
                salary: 30000,
                type: 'Сезонная, частичная занятость, на свежем воздухе',
                description: 'Работа в весенне-летний период. Привлечение туристов на водные экскурсии по Санкт-Петербургу. Консультирование клиентов по маршрутам. Работа на улице. Спецодежда предоставляется.'
            },
            {
                id: 2,
                title: 'Кассир',
                company: 'Додо Пицца',
                city: 'Санкт-Петербург',
                salary: 35000,
                type: 'Постоянная, сменный график',
                description: 'Прием заказов, расчет, выдача заказов, поддержание порядка. Бонусы для сотрудников.'
            },
            {
                id: 3,
                title: 'Продавец-кассир',
                company: 'Carte Dor',
                city: 'Санкт-Петербург',
                salary: 40000,
                type: 'Сменный график, торговля',
                description: 'Продажа мороженого. Работа с товаром, расчет, поддержание чистоты.'
            },
            {
                id: 4,
                title: 'Сборщик онлайн-заказов',
                company: 'Перекресток',
                city: 'Санкт-Петербург',
                salary: 40000,
                type: 'Частичная занятость, сменный график',
                description: 'Сбор онлайн-заказов, проверка сроков годности, передача курьерам.'
            },
            {
                id: 5,
                title: 'Кассир',
                company: 'Вкусно и точка',
                city: 'Санкт-Петербург',
                salary: 45000,
                type: 'Постоянная, сменный график',
                description: 'Прием заказов, расчет, выдача, общение с клиентами.'
            },
            {
                id: 6,
                title: 'Разнорабочий (благоустройство территорий)',
                company: 'Городская программа временной занятости',
                city: 'Санкт-Петербург',
                salary: 14000,
                type: 'Частичная занятость, временная',
                description: 'Уборка территорий в парках. Работа на свежем воздухе.'
            }
        ];

        const ADMIN_EMAIL = 'erorarun@gmail.com';

        const ADMIN_EMAILS = [
            'erorarun@gmail.com',
            'skurkomaksim833@gmail.com'
        ];

        const STATE = {
            jobs: [],
            filteredJobs: [],
            currentPage: 1,
            jobsPerPage: 6,
            currentUser: null,
            users: [],
            employerJobs: [],
            appliedJobs: [],
            currentChatId: null,
            chatUnsubscribe: null
        };
        window.STATE = STATE;
        window.renderJobs = renderJobs;

        const STORAGE = {
            USERS: 'teenwork_users',
            CURRENT_USER: 'teenwork_current_user',
            EMPLOYER_JOBS: 'teenwork_employer_jobs',
            APPLIED_JOBS: 'teenwork_applied_jobs'
        };

        const INFO_CONTENT = {
            'about': {
                title: 'О платформе',
                body: `
                    <h3 style=\"margin-bottom: 16px;\">Кто мы</h3>
                    <p style=\"margin-bottom: 16px; line-height: 1.7;\">TeenWork — первая в России платформа для поиска работы подростками 14-18 лет. Мы создали безопасную среду для получения первого трудового опыта.</p>
                    <h3 style=\"margin-bottom: 16px;\">Наша миссия</h3>
                    <p style=\"line-height: 1.7;\">Помочь подросткам получить первый опыт работы в легальных условиях, развить навыки и стать финансово независимыми.</p>
                `
            },
            'how-it-works': {
                title: 'Как это работает',
                body: `
                    <h3 style=\"margin-bottom: 16px;\">Для подростков</h3>
                    <p style=\"margin-bottom: 12px; line-height: 1.7;\"><strong>1. Регистрация</strong><br>Создайте аккаунт за пару минут</p>
                    <p style=\"margin-bottom: 12px; line-height: 1.7;\"><strong>2. Поиск</strong><br>Используйте фильтры для поиска подходящей работы</p>
                    <p style=\"margin-bottom: 12px; line-height: 1.7;\"><strong>3. Отклик</strong><br>Отправьте заявку работодателю</p>
                    <p style=\"line-height: 1.7;\"><strong>4. Работа</strong><br>Получите официальное трудоустройство</p>
                `
            },
            'safety': {
                title: 'Безопасность',
                body: `
                    <h3 style=\"margin-bottom: 16px;\">Проверка работодателей</h3>
                    <p style=\"margin-bottom: 16px; line-height: 1.7;\">Все компании проходят многоуровневую верификацию перед размещением вакансий.</p>
                    <h3 style=\"margin-bottom: 16px;\">Права подростков</h3>
                    <p style=\"line-height: 1.7;\">Мы следим за соблюдением трудового законодательства РФ: сокращенный рабочий день, запрет на ночные смены, безопасные условия труда.</p>
                `
            },
            'employers': {
                title: 'Работодателям',
                body: `
                    <h3 style=\"margin-bottom: 16px;\">Размещение вакансий</h3>
                    <p style=\"margin-bottom: 16px; line-height: 1.7;\">Для размещения вакансий необходимо пройти верификацию и предоставить документы компании.</p>
                    <h3 style=\"margin-bottom: 16px;\">Требования</h3>
                    <p style=\"line-height: 1.7;\">Вакансии должны соответствовать требованиям ТК РФ для несовершеннолетних сотрудников.</p>
                `
            },
            'support': {
                title: 'Поддержка',
                body: `
                    <h3 style=\"margin-bottom: 16px;\">Свяжитесь с нами</h3>
                    <p style=\"margin-bottom: 12px; line-height: 1.7;\"><strong>Email:</strong> support@teenwork.ru</p>
                    <p style=\"margin-bottom: 12px; line-height: 1.7;\"><strong>Телефон:</strong> +7 (495) 123-45-67</p>
                    <p style=\"line-height: 1.7;\"><strong>Время работы:</strong> Пн-Пт, 9:00-18:00 (МСК)</p>
                `
            },
            'legal': {
                title: 'Правовая информация',
                body: `
                    <h3 style=\"margin-bottom: 16px;\">Документы</h3>
                    <p style=\"margin-bottom: 12px; line-height: 1.7;\">• Пользовательское соглашение</p>
                    <p style=\"margin-bottom: 12px; line-height: 1.7;\">• Политика конфиденциальности</p>
                    <p style=\"line-height: 1.7;\">• Условия использования платформы</p>
                `
            }
        };

        function isAdmin() {
            return STATE.currentUser && ADMIN_EMAILS.includes(STATE.currentUser.email);
        }

        function initStorage() {
            try {
                const storedUsers = localStorage.getItem(STORAGE.USERS);
                const storedUser = localStorage.getItem(STORAGE.CURRENT_USER);
                const storedEmployerJobs = localStorage.getItem(STORAGE.EMPLOYER_JOBS);
                const storedAppliedJobs = localStorage.getItem(STORAGE.APPLIED_JOBS);

                if (storedUsers) STATE.users = JSON.parse(storedUsers);
                if (storedUser) STATE.currentUser = JSON.parse(storedUser);
                if (storedEmployerJobs) STATE.employerJobs = JSON.parse(storedEmployerJobs);
                if (storedAppliedJobs) STATE.appliedJobs = JSON.parse(storedAppliedJobs);
            } catch (e) {
                console.error('Storage error:', e);
                localStorage.removeItem(STORAGE.USERS);
                localStorage.removeItem(STORAGE.CURRENT_USER);
                localStorage.removeItem(STORAGE.EMPLOYER_JOBS);
                localStorage.removeItem(STORAGE.APPLIED_JOBS);
            }
        }

        function saveUsers() { localStorage.setItem(STORAGE.USERS, JSON.stringify(STATE.users)); }
        function saveCurrentUser() {
            if (STATE.currentUser) localStorage.setItem(STORAGE.CURRENT_USER, JSON.stringify(STATE.currentUser));
            else localStorage.removeItem(STORAGE.CURRENT_USER);
        }
        function saveEmployerJobs() { localStorage.setItem(STORAGE.EMPLOYER_JOBS, JSON.stringify(STATE.employerJobs)); }
        function saveAppliedJobs() { localStorage.setItem(STORAGE.APPLIED_JOBS, JSON.stringify(STATE.appliedJobs)); }

        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: '✓', error: '✕', warning: '⚠' };
            toast.innerHTML = `
                <div class=\"toast-icon\">${icons[type]}</div>
                <div class=\"toast-content\">
                    <div class=\"toast-title\">${title}</div>
                    <div class=\"toast-message\">${message}</div>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function updateNavbar() {
            const navActions = document.getElementById('navActions');
            if (STATE.currentUser) {
                const initial = STATE.currentUser.nickname ? STATE.currentUser.nickname[0].toUpperCase() : 'U';
                const avatarContent = STATE.currentUser.avatar ? `<img src=\"${STATE.currentUser.avatar}\" alt=\"Avatar\">` : initial;
                let navHTML = '';
                if (isAdmin()) navHTML += `<div class=\"admin-panel-badge\">ADMIN</div>`;
                if (STATE.currentUser.role === 'employer') navHTML += `<button class=\"btn btn-primary\" onclick=\"openModal('postJobModal')\">Разместить вакансию</button>`;
                navHTML += `
                    <div class=\"nav-profile-wrapper\" onclick=\"openProfile()\">
                        <div class=\"user-avatar\">${avatarContent}</div>
                        <span class=\"nav-profile-text\">Профиль</span>
                    </div>
                `;
                navActions.innerHTML = navHTML;
            } else {
                navActions.innerHTML = `
                    <button class=\"btn btn-secondary\" onclick=\"handleProfileClick()\">Профиль</button>
                    <button class=\"btn btn-secondary\" onclick=\"openModal('registerModal')\">Регистрация</button>
                `;
            }
        }

        function handleProfileClick() {
            if (!STATE.currentUser) openModal('loginModal');
            else openProfile();
        }

        function handleEmployerButtonClick() {
            if (!STATE.currentUser) {
                const registerRoleSelect = document.getElementById('registerRoleSelect');
                if (registerRoleSelect) registerRoleSelect.value = 'employer';
                openModal('registerModal');
            } else if (STATE.currentUser.role === 'employer') {
                openModal('postJobModal');
            } else {
                openModal('workerNeedsChangeModal');
            }
        }

        function openRoleSelectorModal() { openModal('roleSelectorModal'); }
        function openRoleSelectorModalFromWorker() { closeModal('workerNeedsChangeModal'); openModal('roleSelectorModal'); }

        function changeUserRole(newRole) {
            if (!STATE.currentUser) return;
            STATE.currentUser.role = newRole;
            const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
            if (userIndex !== -1) STATE.users[userIndex] = STATE.currentUser;
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            closeModal('roleSelectorModal');
            if (document.getElementById('profilePage').classList.contains('active')) openProfile();
            showToast('Успешно', 'Роль изменена', 'success');
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function openProfile() {
            if (!STATE.currentUser) { openModal('loginModal'); return; }
            const initial = STATE.currentUser.nickname ? STATE.currentUser.nickname[0].toUpperCase() : 'U';
            const avatarDisplay = document.getElementById('profileAvatarDisplay');
            if (STATE.currentUser.avatar) avatarDisplay.innerHTML = `<img src=\"${STATE.currentUser.avatar}\" alt=\"Avatar\">`;
            else avatarDisplay.textContent = initial;
            document.getElementById('profileNickname').value = STATE.currentUser.nickname || '';
            document.getElementById('profileEmail').textContent = STATE.currentUser.email;
            document.getElementById('profileRole').textContent = STATE.currentUser.role === 'worker' ? 'Соискатель' : 'Работодатель';
            const date = new Date(STATE.currentUser.createdAt);
            document.getElementById('profileDate').textContent = date.toLocaleDateString('ru-RU');
            if (STATE.currentUser.role === 'worker') {
                document.getElementById('profileApplicationsSection').style.display = 'block';
                document.getElementById('profileEmployerSection').style.display = 'none';
                renderAppliedJobs();
            } else {
                document.getElementById('profileApplicationsSection').style.display = 'none';
                document.getElementById('profileEmployerSection').style.display = 'block';
                renderEmployerJobs();
            }
            document.getElementById('profilePage').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        async function renderAppliedJobs() {
            const container = document.getElementById('appliedJobsList');
            if (!window.db) {
                container.innerHTML = '<p style=\"color: var(--text-gray); text-align: center; padding: 20px;\">Загрузка...</p>';
                return;
            }
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const applicationsRef = collection(window.db, 'applications');
                const q = query(applicationsRef, where('workerId', '==', STATE.currentUser.uid || STATE.currentUser.email));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.innerHTML = '<p style=\"color: var(--text-gray); text-align: center; padding: 20px;\">Вы пока не откликались на вакансии</p>';
                    return;
                }
                let html = '';
                for (const docSnap of snapshot.docs) {
                    const app = docSnap.data();
                    const job = STATE.jobs.find(j => j.id === app.jobId);
                    if (job) {
                        html += `
                            <div class=\"applied-job-item\">
                                <div>
                                    <div class=\"applied-job-title\">${job.title}</div>
                                    <div class=\"applied-job-company\">${job.company}</div>
                                </div>
                                <button class=\"btn btn-small btn-primary\" onclick=\"openChatFromWorker('${app.jobId}', '${app.employerId}')\">Открыть чат</button>
                            </div>
                        `;
                    }
                }
                container.innerHTML = html || '<p style=\"color: var(--text-gray); text-align: center; padding: 20px;\">Нет откликов</p>';
            } catch (error) {
                console.error('Error loading applications:', error);
                container.innerHTML = '<p style=\"color: var(--text-gray); text-align: center; padding: 20px;\">Ошибка загрузки</p>';
            }
        }

        async function renderEmployerJobs() {
            const container = document.getElementById('employerJobsList');
            const userJobs = STATE.jobs.filter(job => job.employerEmail === STATE.currentUser.email || job.employerId === (STATE.currentUser.uid || STATE.currentUser.email));
            if (userJobs.length === 0) {
                container.innerHTML = '<p style=\"color: var(--text-gray); text-align: center; padding: 20px;\">Вы еще не разместили ни одной вакансии</p>';
                return;
            }
            let html = '';
            for (const job of userJobs) {
                let appCount = 0;
                let viewCount = job.views || 0;
                if (window.db) {
                    try {
                        const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                        const appsRef = collection(window.db, 'applications');
                        const q = query(appsRef, where('jobId', '==', job.id));
                        const snapshot = await getDocs(q);
                        appCount = snapshot.size;
                    } catch (e) { console.error('Error counting applications:', e); }
                }
                html += `
                    <div class=\"applied-job-item\">
                        <div style=\"flex: 1;\">
                            <div class=\"applied-job-title\">${job.title}</div>
                            <div class=\"applied-job-company\">${job.company} • ${job.salary.toLocaleString('ru-RU')} ₽</div>
                            <div class=\"job-stats\">??️ Просмотров: ${viewCount} | ?? Откликов: ${appCount}</div>
                        </div>
                        <button class=\"btn btn-small btn-primary\" onclick=\"showApplications('${job.id}')\">Отклики</button>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        async function showApplications(jobId) {
            if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const applicationsRef = collection(window.db, 'applications');
                const q = query(applicationsRef, where('jobId', '==', jobId));
                const snapshot = await getDocs(q);
                const modalBody = document.getElementById('applicationsModalBody');
                if (snapshot.empty) {
                    modalBody.innerHTML = '<p style=\"color: var(--text-gray); text-align: center; padding: 20px;\">Нет откликов на эту вакансию</p>';
                } else {
                    let html = '<div class=\"applied-jobs-list\">';
                    snapshot.forEach(docSnap => {
                        const app = docSnap.data();
                        html += `
                            <div class=\"application-list-item\">
                                <div class=\"application-worker-name\">${app.workerNickname || 'Соискатель'}</div>
                                <div class=\"application-worker-email\">${app.workerEmail}</div>
                                ${app.message ? `<div style=\"margin-top: 8px; color: var(--text-gray); font-size: 14px;\">${app.message}</div>` : ''}
                                <div style=\"margin-top: 10px;\">
                                    <button class=\"btn btn-small btn-primary\" onclick=\"openChatFromEmployer('${jobId}', '${app.workerId}')\">Открыть чат</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    modalBody.innerHTML = html;
                }
                openModal('applicationsModal');
            } catch (error) {
                console.error('Error loading applications:', error);
                showToast('Ошибка', 'Не удалось загрузить отклики', 'error');
            }
        }

        async function openChatFromWorker(jobId, employerId) {
            openChat(jobId, employerId, STATE.currentUser.uid || STATE.currentUser.email);
        }

        async function openChatFromEmployer(jobId, workerId) {
            openChat(jobId, STATE.currentUser.uid || STATE.currentUser.email, workerId);
        }

        async function openChat(jobId, employerId, workerId) {
            if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
            try {
                const { collection, query, where, getDocs, addDoc, onSnapshot, orderBy } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                if (STATE.chatUnsubscribe) { STATE.chatUnsubscribe(); STATE.chatUnsubscribe = null; }
                const chatsRef = collection(window.db, 'chats');
                const q = query(chatsRef, where('jobId', '==', jobId), where('employerId', '==', employerId), where('workerId', '==', workerId));
                const snapshot = await getDocs(q);
                let chatId;
                if (snapshot.empty) {
                    const newChat = await addDoc(chatsRef, { jobId, employerId, workerId, createdAt: Date.now() });
                    chatId = newChat.id;
                } else {
                    chatId = snapshot.docs[0].id;
                }
                if (!chatId) { showToast('Ошибка', 'Не удалось создать чат', 'error'); return; }
                STATE.currentChatId = chatId;
                const job = STATE.jobs.find(j => j.id === jobId);
                document.getElementById('chatModalTitle').textContent = `Чат: ${job ? job.title : 'Вакансия'}`;
                const messagesRef = collection(window.db, 'messages');
                const messagesQuery = query(messagesRef, where('chatId', '==', chatId), orderBy('createdAt', 'asc'));
                STATE.chatUnsubscribe = onSnapshot(messagesQuery, (messagesSnapshot) => {
                    const container = document.getElementById('chatMessages');
                    if (!container) return;
                    let html = '';
                    messagesSnapshot.forEach(docSnap => {
                        const msg = docSnap.data();
                        const isSent = msg.senderId === (STATE.currentUser.uid || STATE.currentUser.email);
                        const alignClass = isSent ? 'sent' : 'received';
                        if (msg.imageUrl) {
                            html += `<div class=\"chat-message ${alignClass}\"><img class=\"chat-message-image\" src=\"${msg.imageUrl}\" alt=\"Изображение\" onclick=\"window.open('${msg.imageUrl}', '_blank')\"/></div>`;
                        } else if (msg.audioUrl) {
                            html += `<div class=\"chat-message ${alignClass}\">??️ <audio class=\"chat-message-audio\" controls src=\"${msg.audioUrl}\" preload=\"metadata\"></audio></div>`;
                        } else {
                            html += `<div class=\"chat-message ${alignClass}\">${msg.text}</div>`;
                        }
                    });
                    container.innerHTML = html || '<p style=\"color: var(--text-gray); text-align: center;\">Нет сообщений</p>';
                    container.scrollTop = container.scrollHeight;
                }, (error) => { console.error('Error in chat listener:', error); });
                openModal('chatModal');
            } catch (error) {
                console.error('Error opening chat:', error);
                showToast('Ошибка', 'Не удалось открыть чат', 'error');
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !STATE.currentChatId || !window.db) return;
            try {
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                await addDoc(collection(window.db, 'messages'), {
                    chatId: STATE.currentChatId,
                    senderId: STATE.currentUser.uid || STATE.currentUser.email,
                    text,
                    createdAt: Date.now()
                });
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Ошибка', 'Не удалось отправить сообщение', 'error');
            }
        }

        function closeProfile() {
            document.getElementById('profilePage').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function logout() {
            if (STATE.chatUnsubscribe) { STATE.chatUnsubscribe(); STATE.chatUnsubscribe = null; }
            STATE.currentUser = null;
            saveCurrentUser();
            updateNavbar();
            closeProfile();
            showToast('До встречи!', 'Вы вышли из аккаунта', 'success');
        }

        function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const user = STATE.users.find(u => u.email === email);
            if (!user || user.password !== password) {
                const formGroup = e.target.querySelector('input[name=\"password\"]').closest('.form-group');
                formGroup.classList.add('error');
                return;
            }
            STATE.currentUser = user;
            saveCurrentUser();
            updateNavbar();
            closeModal('loginModal');
            showToast('Добро пожаловать!', 'Вы успешно вошли в систему', 'success');
        }

        function handleRegister(e) {
            e.preventDefault();
            if (!validateForm(e.target)) { showToast('Ошибка', 'Заполните все поля корректно', 'error'); return; }
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const nickname = formData.get('nickname');
            const role = formData.get('role');
            if (STATE.users.find(u => u.email === email)) { showToast('Ошибка', 'Пользователь с таким email уже существует', 'error'); return; }
            if (password.length < 6) { const fg = e.target.querySelector('input[name=\"password\"]').closest('.form-group'); fg.classList.add('error'); return; }
            if (!role) { const fg = e.target.querySelector('select[name=\"role\"]').closest('.form-group'); fg.classList.add('error'); return; }
            const newUser = { email, password, nickname, role, avatar: null, createdAt: Date.now(), uid: email };
            STATE.users.push(newUser);
            STATE.currentUser = newUser;
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            closeModal('registerModal');
            showToast('Регистрация успешна!', 'Добро пожаловать в TeenWork', 'success');
        }

        function handleProfileUpdate(e) {
            e.preventDefault();
            const nickname = document.getElementById('profileNickname').value;
            if (!nickname) { showToast('Ошибка', 'Заполните никнейм', 'error'); return; }
            STATE.currentUser.nickname = nickname;
            const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
            if (userIndex !== -1) STATE.users[userIndex] = STATE.currentUser;
            saveUsers();
            saveCurrentUser();
            updateNavbar();
            showToast('Успешно', 'Профиль обновлен', 'success');
        }

        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                STATE.currentUser.avatar = event.target.result;
                const userIndex = STATE.users.findIndex(u => u.email === STATE.currentUser.email);
                if (userIndex !== -1) STATE.users[userIndex] = STATE.currentUser;
                saveUsers();
                saveCurrentUser();
                document.getElementById('profileAvatarDisplay').innerHTML = `<img src=\"${event.target.result}\" alt=\"Avatar\">`;
                updateNavbar();
                showToast('Успешно', 'Фото обновлено', 'success');
            };
            reader.readAsDataURL(file);
        }

        async function handlePostJob(e) {
            e.preventDefault();
            if (!validateForm(e.target)) { showToast('Ошибка', 'Заполните все поля корректно', 'error'); return; }
            const formData = new FormData(e.target);
            const newJob = {
                title: formData.get('title'),
                company: formData.get('company'),
                city: formData.get('city'),
                salary: parseInt(formData.get('salary')),
                type: formData.get('type'),
                description: formData.get('description'),
                employerEmail: STATE.currentUser.email,
                employerId: STATE.currentUser.uid || STATE.currentUser.email,
                isTop: false,
                views: 0,
                createdAt: Date.now()
            };
            try {
                if (window.db && window.addDoc && window.collection) {
                    await window.addDoc(window.collection(window.db, \"jobs\"), newJob);
                }
            } catch (error) { console.error('Firestore error:', error); }
            closeModal('postJobModal');
            showToast('Успешно', 'Вакансия размещена', 'success');
            if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cityFilter = document.getElementById('cityFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const salaryFilter = document.getElementById('salaryFilter').value;
            STATE.filteredJobs = STATE.jobs.filter(job => {
                const matchesSearch = !searchTerm || job.title.toLowerCase().includes(searchTerm) || job.company.toLowerCase().includes(searchTerm);
                const matchesCity = !cityFilter || job.city === cityFilter;
                const matchesType = !typeFilter || job.type.includes(typeFilter);
                let matchesSalary = true;
                if (salaryFilter) {
                    const [min, max] = salaryFilter.split('-').map(v => parseInt(v) || Infinity);
                    matchesSalary = job.salary >= min && (max === Infinity || job.salary <= max);
                }
                return matchesSearch && matchesCity && matchesType && matchesSalary;
            });
            applySorting();
            STATE.currentPage = 1;
            renderJobs();
        }

        function applySorting() {
            const sortValue = document.getElementById('sortFilter').value;
            STATE.filteredJobs.sort((a, b) => {
                if (a.isTop && !b.isTop) return -1;
                if (!a.isTop && b.isTop) return 1;
                if (sortValue === 'salary-desc') return b.salary - a.salary;
                if (sortValue === 'salary-asc') return a.salary - b.salary;
                return 0;
            });
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('cityFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('salaryFilter').value = '';
            document.getElementById('sortFilter').value = 'salary-desc';
            STATE.filteredJobs = [...STATE.jobs];
            applySorting();
            STATE.currentPage = 1;
            renderJobs();
        }

        function renderJobs() {
            const grid = document.getElementById('jobsGrid');
            const jobCount = document.getElementById('jobCount');
            jobCount.textContent = `Найдено вакансий: ${STATE.filteredJobs.length}`;
            if (STATE.filteredJobs.length === 0) {
                grid.innerHTML = `<div class=\"empty-state\"><div class=\"empty-state-icon\">??</div><h3>Вакансии не найдены</h3><p>Попробуйте изменить параметры поиска</p></div>`;
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            const startIndex = (STATE.currentPage - 1) * STATE.jobsPerPage;
            const endIndex = startIndex + STATE.jobsPerPage;
            const jobsToRender = STATE.filteredJobs.slice(startIndex, endIndex);
            grid.innerHTML = jobsToRender.map(job => {
                const adminBadge = job.isTop ? '<div class=\"admin-badge\">TOP</div>' : '';
                const adminControls = isAdmin() ? `
                    <div class=\"admin-controls\">
                        <button class=\"btn btn-admin btn-danger\" onclick=\"deleteJob('${job.id}', event)\">Удалить</button>
                        <button class=\"btn btn-admin btn-warning\" onclick=\"toggleTopJob('${job.id}', event)\">${job.isTop ? 'Снять TOP' : 'Сделать TOP'}</button>
                    </div>
                ` : '';
                return `
                    <div class=\"job-card\" onclick=\"openApplyModal('${job.id}')\">
                        ${adminBadge}
                        <div class=\"job-header\">
                            <div class=\"job-title\">${job.title}</div>
                            <div class=\"job-company\">${job.company}</div>
                            <div class=\"job-location\">?? ${job.city}</div>
                        </div>
                        <div class=\"job-details\">
                            <div class=\"job-salary\">${job.salary.toLocaleString('ru-RU')} ₽</div>
                            <div class=\"job-tags\"><span class=\"tag\">${job.type}</span></div>
                        </div>
                        <div class=\"job-footer\">
                            <button class=\"btn btn-primary btn-apply\" onclick=\"openApplyModal('${job.id}', event)\">Откликнуться</button>
                        </div>
                        ${adminControls}
                    </div>
                `;
            }).join('');
            renderPagination();
        }

        async function deleteJob(jobId, event) {
            if (event) event.stopPropagation();
            if (!isAdmin()) { showToast('Ошибка', 'Только админ может удалять вакансии', 'error'); return; }
            if (!confirm('Вы уверены, что хотите удалить эту вакансию?')) return;
            try {
                if (window.db) {
                    const { deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    await deleteDoc(doc(window.db, \"jobs\", jobId));
                }
                showToast('Успешно', 'Вакансия удалена', 'success');
                if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
            } catch (error) { console.error('Delete error:', error); showToast('Ошибка', 'Не удалось удалить вакансию', 'error'); }
        }

        async function toggleTopJob(jobId, event) {
            if (event) event.stopPropagation();
            if (!isAdmin()) { showToast('Ошибка', 'Только админ может управлять TOP-вакансиями', 'error'); return; }
            try {
                const job = STATE.jobs.find(j => j.id === jobId);
                if (!job) return;
                if (window.db) {
                    const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    await updateDoc(doc(window.db, \"jobs\", jobId), { isTop: !job.isTop });
                }
                showToast('Успешно', job.isTop ? 'TOP снят' : 'Вакансия в TOP', 'success');
                if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
            } catch (error) { console.error('Toggle TOP error:', error); showToast('Ошибка', 'Не удалось изменить статус', 'error'); }
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(STATE.filteredJobs.length / STATE.jobsPerPage);
            if (totalPages <= 1) { pagination.innerHTML = ''; return; }
            let html = `<button class=\"pagination-btn\" onclick=\"changePage(${STATE.currentPage - 1})\" ${STATE.currentPage === 1 ? 'disabled' : ''}>← Назад</button>`;
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= STATE.currentPage - 1 && i <= STATE.currentPage + 1)) {
                    html += `<button class=\"pagination-btn ${i === STATE.currentPage ? 'active' : ''}\" onclick=\"changePage(${i})\">${i}</button>`;
                } else if (i === STATE.currentPage - 2 || i === STATE.currentPage + 2) {
                    html += `<span style=\"padding: 8px;\">...</span>`;
                }
            }
            html += `<button class=\"pagination-btn\" onclick=\"changePage(${STATE.currentPage + 1})\" ${STATE.currentPage === totalPages ? 'disabled' : ''}>Вперёд →</button>`;
            pagination.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(STATE.filteredJobs.length / STATE.jobsPerPage);
            if (page < 1 || page > totalPages) return;
            STATE.currentPage = page;
            renderJobs();
            scrollToSearch();
        }

        function openModal(modalId, contentKey) {
            const modal = document.getElementById(modalId);
            if (modalId === 'infoModal' && contentKey) {
                const content = INFO_CONTENT[contentKey];
                if (content) {
                    document.getElementById('infoModalTitle').textContent = content.title;
                    document.getElementById('infoModalBody').innerHTML = content.body;
                }
            }
            modal.classList.remove('hiding');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hiding');
            if (modalId === 'chatModal' && STATE.chatUnsubscribe) {
                STATE.chatUnsubscribe();
                STATE.chatUnsubscribe = null;
                STATE.currentChatId = null;
            }
            setTimeout(() => {
                modal.classList.remove('active', 'hiding');
                document.body.style.overflow = 'auto';
                const form = modal.querySelector('form');
                if (form) { form.reset(); clearFormErrors(form); }
            }, 300);
        }

        function clearFormErrors(form) {
            form.querySelectorAll('.form-group').forEach(group => group.classList.remove('error'));
        }

        function validateForm(form) {
            let isValid = true;
            clearFormErrors(form);
            form.querySelectorAll('[required]').forEach(field => {
                const formGroup = field.closest('.form-group');
                if (!field.value.trim()) { formGroup.classList.add('error'); isValid = false; }
                else if (field.type === 'email' && !field.validity.valid) { formGroup.classList.add('error'); isValid = false; }
                else if (field.type === 'password' && field.value.length < 6) { formGroup.classList.add('error'); isValid = false; }
                else if (field.tagName === 'SELECT' && !field.value) { formGroup.classList.add('error'); isValid = false; }
            });
            return isValid;
        }

        async function openApplyModal(jobId, event) {
            if (event) event.stopPropagation();
            if (!STATE.currentUser) { showToast('Требуется авторизация', 'Войдите в аккаунт для отклика', 'warning'); openModal('loginModal'); return; }
            if (STATE.currentUser.role === 'employer') { showToast('Внимание', 'Работодатели не могут откликаться на вакансии', 'warning'); return; }
            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;
            if (window.db) {
                try {
                    const { updateDoc, doc, increment, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    const jobRef = doc(window.db, \"jobs\", jobId);
                    const jobSnap = await getDoc(jobRef);
                    if (jobSnap.exists()) {
                        const jobData = jobSnap.data();
                        if (typeof jobData.views === 'number') await updateDoc(jobRef, { views: increment(1) });
                        else await updateDoc(jobRef, { views: 1 });
                    }
                } catch (error) { console.error('Error incrementing views:', error); }
            }
            let alreadyApplied = false;
            if (window.db) {
                try {
                    const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                    const appsRef = collection(window.db, 'applications');
                    const q = query(appsRef, where('jobId', '==', jobId), where('workerId', '==', STATE.currentUser.uid || STATE.currentUser.email));
                    const snapshot = await getDocs(q);
                    alreadyApplied = !snapshot.empty;
                } catch (error) { console.error('Error checking application:', error); }
            }
            const modalBody = document.getElementById('applyModalBody');
            modalBody.innerHTML = `
                <div style=\"margin-bottom: 28px;\">
                    <h3 style=\"margin-bottom: 10px; font-weight: 700; font-size: 22px;\">${job.title}</h3>
                    <p style=\"color: var(--text-gray); margin-bottom: 20px; font-weight: 600;\">${job.company} • ${job.city}</p>
                    <div style=\"background: var(--light-gray); padding: 18px; border-radius: var(--radius-md); margin-bottom: 20px;\">
                        <strong>Зарплата:</strong> ${job.salary.toLocaleString('ru-RU')} ₽<br>
                        <strong>Тип:</strong> ${job.type}
                    </div>
                    <p style=\"line-height: 1.7; color: var(--text-gray); font-weight: 500;\">${job.description}</p>
                </div>
                <div style=\"text-align: center; padding: 20px;\">
                    ${alreadyApplied
                        ? '<p style=\"margin-bottom: 16px; color: var(--success); font-weight: 600;\">Вы уже откликнулись на эту вакансию</p>'
                        : `<textarea id=\"applicationMessage\" class=\"input\" placeholder=\"Сопроводительное сообщение (необязательно)\" style=\"width: 100%; margin-bottom: 12px; min-height: 80px;\"></textarea>
                           <button class=\"btn btn-primary\" onclick=\"applyToJob('${jobId}')\" style=\"margin-bottom: 12px;\">Откликнуться</button>`
                    }
                    <button class=\"btn btn-secondary\" onclick=\"closeModal('applyModal')\">Закрыть</button>
                </div>
            `;
            openModal('applyModal');
        }

        async function applyToJob(jobId) {
            if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
            const job = STATE.jobs.find(j => j.id === jobId);
            if (!job) return;
            const message = document.getElementById('applicationMessage')?.value || '';
            try {
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                await addDoc(collection(window.db, 'applications'), {
                    jobId,
                    workerId: STATE.currentUser.uid || STATE.currentUser.email,
                    employerId: job.employerId || job.employerEmail,
                    workerEmail: STATE.currentUser.email,
                    workerNickname: STATE.currentUser.nickname || 'Соискатель',
                    message,
                    createdAt: Date.now(),
                    status: 'new'
                });
                closeModal('applyModal');
                showToast('Успешно', 'Вы откликнулись на вакансию', 'success');
            } catch (error) { console.error('Error applying to job:', error); showToast('Ошибка', 'Не удалось откликнуться', 'error'); }
        }

        function toggleFaq(element) {
            const faqItem = element.parentElement;
            const answer = faqItem.querySelector('.faq-answer');
            const answerContent = answer.querySelector('.faq-answer-content');
            const isActive = faqItem.classList.contains('active');
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('.faq-answer').style.maxHeight = '0px';
            });
            if (!isActive) { faqItem.classList.add('active'); answer.style.maxHeight = answerContent.scrollHeight + 'px'; }
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function scrollToSearch() { document.getElementById('search').scrollIntoView({ behavior: 'smooth', block: 'start' }); }

        function initEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', () => { applySorting(); STATE.currentPage = 1; renderJobs(); });
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('avatarUpload').addEventListener('change', handleAvatarUpload);
            document.getElementById('postJobForm').addEventListener('submit', handlePostJob);
            document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
            document.getElementById('chatImageInput').addEventListener('change', handleChatImageSelected);
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal.id); });
            });
            window.addEventListener('scroll', () => {
                const navbar = document.getElementById('navbar');
                if (window.pageYOffset > 50) navbar.classList.add('scrolled');
                else navbar.classList.remove('scrolled');
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) closeModal(activeModal.id);
                    const profilePage = document.getElementById('profilePage');
                    if (profilePage.classList.contains('active')) closeProfile();
                }
            });
        }

        function init() { initStorage(); updateNavbar(); initEventListeners(); }
        document.addEventListener('DOMContentLoaded', init);

        // ==============================
        // STORAGE EXTENSION
        // ==============================
        function triggerChatImageUpload() {
            if (!STATE.currentChatId) { showToast('Ошибка', 'Сначала откройте чат', 'error'); return; }
            document.getElementById('chatImageInput').click();
        }

        async function handleChatImageSelected(e) {
            const file = e.target.files[0];
            e.target.value = '';
            if (!file || !STATE.currentChatId || !window.db) return;
            if (!file.type.startsWith('image/')) { showToast('Ошибка', 'Выберите изображение', 'error'); return; }
            if (file.size > 5 * 1024 * 1024) { showToast('Ошибка', 'Размер изображения не должен превышать 5 МБ', 'error'); return; }
            const indicator = document.getElementById('chatUploadIndicator');
            if (indicator) indicator.classList.add('visible');
            try {
                const { getStorage, ref, uploadBytes, getDownloadURL } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js');
                const storage = getStorage();
                const filePath = `chat-images/${STATE.currentChatId}/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, filePath);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                await addDoc(collection(window.db, 'messages'), { chatId: STATE.currentChatId, senderId: STATE.currentUser.uid || STATE.currentUser.email, imageUrl: downloadURL, text: '', createdAt: Date.now() });
            } catch (error) { console.error('Image upload error:', error); showToast('Ошибка', 'Не удалось загрузить изображение', 'error'); }
            finally { if (indicator) indicator.classList.remove('visible'); }
        }

        // ==============================
        // VOICE MESSAGE LOGIC
        // ==============================
        const VOICE_STATE = { mediaRecorder: null, audioChunks: [], isRecording: false, stream: null };

        async function toggleVoiceRecording() {
            if (!STATE.currentChatId) { showToast('Ошибка', 'Сначала откройте чат', 'error'); return; }
            if (VOICE_STATE.isRecording) {
                VOICE_STATE.mediaRecorder.stop();
            } else {
                try {
                    VOICE_STATE.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    VOICE_STATE.audioChunks = [];
                    VOICE_STATE.mediaRecorder = new MediaRecorder(VOICE_STATE.stream);
                    VOICE_STATE.mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) VOICE_STATE.audioChunks.push(event.data); };
                    VOICE_STATE.mediaRecorder.onstop = handleVoiceRecordingStop;
                    VOICE_STATE.mediaRecorder.start();
                    VOICE_STATE.isRecording = true;
                    const btn = document.getElementById('voiceRecordBtn');
                    if (btn) { btn.classList.add('recording'); btn.textContent = '⏹️'; btn.title = 'Остановить запись'; }
                } catch (err) { console.error('Microphone error:', err); showToast('Ошибка', 'Нет доступа к микрофону', 'error'); }
            }
        }

        async function handleVoiceRecordingStop() {
            VOICE_STATE.isRecording = false;
            const btn = document.getElementById('voiceRecordBtn');
            if (btn) { btn.classList.remove('recording'); btn.textContent = '??️'; btn.title = 'Голосовое сообщение'; }
            if (VOICE_STATE.stream) { VOICE_STATE.stream.getTracks().forEach(track => track.stop()); VOICE_STATE.stream = null; }
            if (VOICE_STATE.audioChunks.length === 0) return;
            const audioBlob = new Blob(VOICE_STATE.audioChunks, { type: 'audio/webm' });
            if (audioBlob.size < 512) { showToast('Внимание', 'Запись слишком короткая', 'warning'); return; }
            const indicator = document.getElementById('chatUploadIndicator');
            if (indicator) indicator.classList.add('visible');
            try {
                const { getStorage, ref, uploadBytes, getDownloadURL } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js');
                const storage = getStorage();
                const filePath = `chat-audio/${STATE.currentChatId}/${Date.now()}.webm`;
                const storageRef = ref(storage, filePath);
                await uploadBytes(storageRef, audioBlob);
                const downloadURL = await getDownloadURL(storageRef);
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                await addDoc(collection(window.db, 'messages'), { chatId: STATE.currentChatId, senderId: STATE.currentUser.uid || STATE.currentUser.email, audioUrl: downloadURL, text: '', createdAt: Date.now() });
            } catch (error) { console.error('Audio upload error:', error); showToast('Ошибка', 'Не удалось загрузить голосовое сообщение', 'error'); }
            finally { if (indicator) indicator.classList.remove('visible'); }
        }
    </script>

<script type=\"module\">
  import { initializeApp } from \"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js\";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from \"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js\";

  const firebaseConfig = {
    apiKey: \"AIzaSyC9l-LPIJl_51GC8FgdApYccycQjA7rNps\",
    authDomain: \"teenwork-app-afaa6.firebaseapp.com\",
    projectId: \"teenwork-app-afaa6\",
    storageBucket: \"teenwork-app-afaa6.firebasestorage.app\",
    messagingSenderId: \"657977585927\",
    appId: \"1:657977585927:web:190719f2acf432fdaf15a2\",
    measurementId: \"G-XWR4S2ZRN7\"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.addDoc = addDoc;
  window.collection = collection;
  window.deleteDoc = deleteDoc;
  window.doc = doc;
  window.updateDoc = updateDoc;

  const jobsCollection = collection(db, \"jobs\");

  async function uploadInitialJobs() {
    const snapshot = await getDocs(jobsCollection);
    if (!snapshot.empty) { console.log(\"Вакансии уже есть в Firestore\"); return; }
    const initialJobs = [
      { title: \"Промоутер водных экскурсий\", company: \"Нева Тревел\", city: \"Санкт-Петербург\", salary: 30000, type: \"Сезонная\", description: \"Работа в весенне-летний период.\", isTop: false, views: 0, createdAt: Date.now() },
      { title: \"Кассир\", company: \"Додо Пицца\", city: \"Санкт-Петербург\", salary: 35000, type: \"Постоянная\", description: \"Работа в ресторане быстрого питания.\", isTop: false, views: 0, createdAt: Date.now() }
    ];
    for (let job of initialJobs) await addDoc(jobsCollection, job);
    console.log(\"Вакансии успешно загружены в Firestore\");
  }

  async function loadJobsFromFirestore() {
    const snapshot = await getDocs(collection(db, \"jobs\"));
    const jobs = [];
    snapshot.forEach(docSnap => { jobs.push({ id: docSnap.id, ...docSnap.data() }); });
    if (window.STATE) {
      window.STATE.jobs = jobs;
      window.STATE.filteredJobs = [...jobs];
      window.STATE.currentPage = 1;
      if (window.renderJobs) window.renderJobs();
    }
    console.log(\"Вакансии загружены из Firestore:\", jobs.length);
  }

  window.loadJobsFromFirestore = loadJobsFromFirestore;
  uploadInitialJobs();
  loadJobsFromFirestore();
</script>

<!-- ================= SAFE PRESENCE EXTENSION ================= -->
<style>
.chat-presence-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px 9px 20px;
    border-bottom: 1px solid var(--border-gray);
    background: linear-gradient(90deg, rgba(239,246,255,0.9) 0%, rgba(255,255,255,0) 100%);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-gray);
    min-height: 38px;
    transition: all 0.3s ease;
    animation: presenceBarFade 0.4s ease backwards;
}

@keyframes presenceBarFade {
    from { opacity: 0; transform: translateY(-5px); }
    to   { opacity: 1; transform: translateY(0); }
}

.presence-dot-online {
    width: 9px; height: 9px; border-radius: 50%;
    background: var(--success); flex-shrink: 0;
    animation: presencePulse 2s ease-in-out infinite;
}

@keyframes presencePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.55); }
    50%       { box-shadow: 0 0 0 7px rgba(16,185,129,0); }
}

.presence-dot-offline { width: 9px; height: 9px; border-radius: 50%; background: #94a3b8; flex-shrink: 0; }
.presence-text-online { color: var(--success); font-weight: 700; font-size: 13px; }
.presence-text-offline { color: var(--text-gray); font-size: 12px; font-weight: 500; opacity: 0.85; }

#chatModal .modal-body { padding: 0 0 20px 0; }
#chatModal .chat-messages { max-height: 460px; margin: 0; border-radius: 0; border-left: none; border-right: none; border-top: none; }
#chatModal .chat-input-container { margin: 16px 20px 0 20px; }
#chatModal .modal-header { border-bottom: 2px solid var(--border-gray); padding: 18px 24px; }
#chatModal .modal-header h3 { font-size: 18px; letter-spacing: -0.3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 420px; }
#chatSendBtn:disabled { opacity: 0.42; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
</style>

<script>
const _PRESENCE_POLL_MS = 400;
const _PRESENCE_TIMEOUT = 12000;

function _presenceWhenDbReady(cb) {
    const start = Date.now();
    const t = setInterval(() => {
        if (window.db) { clearInterval(t); cb(); }
        else if (Date.now() - start > _PRESENCE_TIMEOUT) clearInterval(t);
    }, _PRESENCE_POLL_MS);
}

function _formatLastSeen(ts) {
    if (!ts) return '';
    const now = new Date();
    const d = new Date(ts);
    const pad = n => String(n).padStart(2, '0');
    const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const yest  = today - 86400000;
    const msgD  = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
    if (msgD === today) return `сегодня в ${time}`;
    if (msgD === yest)  return `вчера в ${time}`;
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${time}`;
}

async function _writePresence(isOnline) {
    if (!window.db || !window.STATE || !window.STATE.currentUser) return;
    const userId = window.STATE.currentUser.uid || window.STATE.currentUser.email;
    if (!userId) return;
    try {
        const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await setDoc(doc(window.db, 'users', userId), { isOnline, lastSeen: Date.now(), nickname: window.STATE.currentUser.nickname || '', email: window.STATE.currentUser.email || '' }, { merge: true });
    } catch (e) { console.warn('[presence] write error:', e); }
}

function _setPresenceOnline()  { _presenceWhenDbReady(() => _writePresence(true)); }
function _setPresenceOffline() { _writePresence(false); }

document.addEventListener('DOMContentLoaded', () => {
    _presenceWhenDbReady(() => { if (window.STATE && window.STATE.currentUser) _writePresence(true); });
});

window.addEventListener('beforeunload', () => { _setPresenceOffline(); });
document.addEventListener('visibilitychange', () => {
    if (!window.STATE || !window.STATE.currentUser) return;
    _presenceWhenDbReady(() => _writePresence(!document.hidden));
});

async function _subscribeToPresence(userId, callback) {
    if (!window.db || !userId) return null;
    try {
        const { doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        return onSnapshot(doc(window.db, 'users', userId), snap => {
            if (snap.exists()) { const d = snap.data(); callback(!!d.isOnline, d.lastSeen || null); }
            else callback(false, null);
        }, err => console.warn('[presence] subscribe error:', err));
    } catch (e) { console.warn('[presence] subscribeToPresence error:', e); return null; }
}

function _injectPresenceBar(otherUserId) {
    const modalBody = document.querySelector('#chatModal .modal-body');
    if (!modalBody) return;
    const existing = modalBody.querySelector('.chat-presence-bar');
    if (existing) existing.remove();
    const bar = document.createElement('div');
    bar.className = 'chat-presence-bar';
    bar.id = 'chatPresenceBar';
    bar.innerHTML = `<span class=\"presence-dot-offline\" id=\"presenceDot\"></span><span class=\"presence-text-offline\" id=\"presenceText\">Загрузка...</span>`;
    const chatMsgs = modalBody.querySelector('#chatMessages');
    if (chatMsgs) modalBody.insertBefore(bar, chatMsgs);
    else modalBody.insertBefore(bar, modalBody.firstChild);
    _presenceWhenDbReady(async () => {
        const unsub = await _subscribeToPresence(otherUserId, (isOnline, lastSeen) => {
            const dot = document.getElementById('presenceDot');
            const text = document.getElementById('presenceText');
            if (!dot || !text) return;
            if (isOnline) { dot.className = 'presence-dot-online'; text.className = 'presence-text-online'; text.textContent = '● В сети'; }
            else { dot.className = 'presence-dot-offline'; text.className = 'presence-text-offline'; text.textContent = lastSeen ? `Был(а) в сети: ${_formatLastSeen(lastSeen)}` : 'Не в сети'; }
        });
        window._presenceUnsub = unsub;
    });
}

const _origCloseModalPresence = window.closeModal || closeModal;
window.closeModal = function(modalId) {
    if (modalId === 'chatModal' && typeof window._presenceUnsub === 'function') { window._presenceUnsub(); window._presenceUnsub = null; }
    _origCloseModalPresence(modalId);
};

const _origOpenChat = window.openChat;
window.openChat = async function(jobId, employerId, workerId) {
    await _origOpenChat(jobId, employerId, workerId);
    const currentUserId = window.STATE && window.STATE.currentUser ? (window.STATE.currentUser.uid || window.STATE.currentUser.email) : null;
    const otherId = (currentUserId === employerId) ? workerId : employerId;
    setTimeout(() => { if (otherId) _injectPresenceBar(otherId); }, 160);
};

const _origHandleLogin = window.handleLogin || handleLogin;
window.handleLogin = function(e) { _origHandleLogin(e); setTimeout(() => { if (window.STATE && window.STATE.currentUser) _setPresenceOnline(); }, 200); };

const _origHandleRegister = window.handleRegister || handleRegister;
window.handleRegister = function(e) { _origHandleRegister(e); setTimeout(() => { if (window.STATE && window.STATE.currentUser) _setPresenceOnline(); }, 200); };

const _origLogout = window.logout || logout;
window.logout = function() { _setPresenceOffline(); _origLogout(); };

async function _markMessagesAsRead(chatId, currentUserId, messagesSnapshot) {
    if (!window.db || !chatId) return;
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const updates = [];
        messagesSnapshot.forEach(docSnap => {
            const msg = docSnap.data();
            if (msg.senderId !== currentUserId && msg.read === false) {
                updates.push(updateDoc(doc(window.db, 'messages', docSnap.id), { read: true, readAt: Date.now(), status: 'read' }));
            }
        });
        if (updates.length > 0) await Promise.all(updates);
    } catch (e) { console.warn('[chat] markMessagesAsRead error:', e); }
}
</script>

<!-- ================= DESIGN RESTORE PATCH ================= -->
<style>
.jobs-section .section-header h2 {
    background: linear-gradient(135deg, var(--text-dark) 0%, #1e3a8a 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: inline-block;
    transition: filter 0.3s ease;
}

.jobs-section .section-header h2::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 0;
    width: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-blue), var(--blue-light));
    border-radius: 2px;
    transition: width 0.55s cubic-bezier(0.4, 0, 0.2, 1);
}

.jobs-section .section-header:hover h2::after { width: 100%; }
.jobs-section .section-header:hover h2 { filter: drop-shadow(0 2px 14px rgba(37,99,235,0.22)); }

.job-count-badge {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: linear-gradient(135deg, var(--soft-blue), #dbeafe);
    color: var(--primary-blue);
    border: 1.5px solid rgba(37,99,235,0.15);
    border-radius: 24px;
    padding: 6px 16px;
    font-size: 14px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    cursor: default;
}

.job-count-badge:hover { transform: scale(1.04); box-shadow: 0 4px 18px rgba(37,99,235,0.16); }
.job-count-number { font-size: 17px; font-weight: 800; }

@keyframes countBadgePop {
    0%   { transform: scale(1); }
    45%  { transform: scale(1.28); }
    100% { transform: scale(1); }
}

.job-count-badge.pop { animation: countBadgePop 0.32s cubic-bezier(0.34, 1.56, 0.64, 1); }

@keyframes badgeGlow {
    0%, 100% { box-shadow: 0 2px 8px rgba(37,99,235,0.08); }
    50%       { box-shadow: 0 4px 22px rgba(37,99,235,0.24); }
}

.job-count-badge.loaded { animation: badgeGlow 2s ease-in-out 2; }

.job-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 60%;
    height: 100%;
    background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.5) 50%, transparent 100%);
    transform: skewX(-20deg);
    transition: left 0.55s cubic-bezier(0.4,0,0.2,1);
    pointer-events: none;
    z-index: 1;
    border-radius: var(--radius-lg);
}

.job-card:hover::before { left: 140%; }
.admin-badge { animation: topBadgePulse 3s ease-in-out infinite; }

@keyframes topBadgePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.5); }
    50%       { box-shadow: 0 0 0 6px rgba(245,158,11,0); }
}

.jobs-grid { transition: opacity 0.15s ease; }
.jobs-grid.rendering { opacity: 0.3; pointer-events: none; }
</style>

<script>
(function patchRenderJobsDesign() {
    const _orig = window.renderJobs;
    if (!_orig) return;
    window.renderJobs = function() {
        const grid = document.getElementById('jobsGrid');
        const hasContent = grid && grid.children.length > 0 && !grid.querySelector('.skeleton-card');
        const doRender = () => {
            _orig();
            const jobCount = document.getElementById('jobCount');
            if (jobCount && !jobCount.querySelector('.job-count-badge')) {
                const raw = jobCount.textContent || '';
                const match = raw.match(/\d+/);
                const n = match ? match[0] : '0';
                jobCount.innerHTML = `<span class=\"job-count-badge loaded\"><span class=\"job-count-number\">${n}</span> вакансий найдено</span>`;
            } else if (jobCount && jobCount.querySelector('.job-count-badge')) {
                const numEl = jobCount.querySelector('.job-count-number');
                if (numEl) { const raw = jobCount.textContent || ''; const match = raw.match(/\d+/); if (match) numEl.textContent = match[0]; }
                const badge = jobCount.querySelector('.job-count-badge');
                if (badge) { badge.classList.remove('pop', 'loaded'); void badge.offsetWidth; badge.classList.add('pop'); setTimeout(() => { badge.classList.remove('pop'); badge.classList.add('loaded'); }, 340); }
            }
        };
        if (hasContent) { grid.classList.add('rendering'); setTimeout(() => { grid.classList.remove('rendering'); doRender(); }, 110); }
        else doRender();
    };
})();
</script>

<!-- ================= CHAT UI ENHANCEMENT ================= -->
<style>
#chatModal { backdrop-filter: blur(8px); }

.chat-message.sent::after {
    content: '✔';
    display: block;
    font-size: 11px;
    text-align: right;
    margin-top: 3px;
    opacity: 0.65;
    letter-spacing: -1px;
}

.chat-message.sent.read::after { content: '✔✔'; opacity: 1; color: #bfdbfe; }

@keyframes msgAppear {
    from { opacity: 0; transform: translateY(10px) scale(0.95); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}

.chat-message { animation: msgAppear 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) backwards; }

@keyframes sendPulse {
    0%, 100% { box-shadow: 0 2px 8px rgba(37,99,235,0.2); }
    50%       { box-shadow: 0 4px 18px rgba(37,99,235,0.4); }
}

#chatSendBtn:not(:disabled):hover { animation: sendPulse 1.2s ease-in-out infinite; }
#chatSendBtn:disabled { opacity: 0.42; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

.chat-typing-indicator {
    display: flex; align-items: center; gap: 4px;
    padding: 10px 14px;
    background: var(--white);
    border: 1px solid var(--border-gray);
    border-radius: 18px;
    border-bottom-left-radius: 5px;
    width: fit-content;
    margin-bottom: 10px;
    animation: msgAppear 0.25s ease;
    box-shadow: var(--shadow-sm);
}

.chat-typing-dot { width: 6px; height: 6px; border-radius: 50%; background: #94a3b8; animation: typingBounce 1.2s ease-in-out infinite; }
.chat-typing-dot:nth-child(2) { animation-delay: 0.2s; }
.chat-typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30%            { transform: translateY(-5px); opacity: 1; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    const chatModal = document.getElementById('chatModal');
    if (!chatInput) return;
    function syncSendBtn() { const btn = document.getElementById('chatSendBtn'); if (btn) btn.disabled = !chatInput.value.trim(); }
    chatInput.addEventListener('input', syncSendBtn);
    syncSendBtn();
    if (chatModal) {
        new MutationObserver(() => { if (chatModal.classList.contains('active')) setTimeout(syncSendBtn, 100); }).observe(chatModal, { attributes: true, attributeFilter: ['class'] });
    }
});
</script>

<!-- ================= UX FILTER SYSTEM ================= -->
<style>
.filter-chips-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }

.filter-chip {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--soft-blue); color: var(--primary-blue);
    border: 1.5px solid rgba(37,99,235,0.22); border-radius: 24px;
    padding: 5px 14px 5px 12px; font-size: 13px; font-weight: 700;
    cursor: pointer; transition: var(--transition);
    animation: chipPop 0.22s cubic-bezier(0.34,1.56,0.64,1) backwards;
    user-select: none;
}

.filter-chip:hover { background: var(--primary-blue); color: var(--white); transform: scale(1.04); }
.filter-chip-remove { font-size: 14px; font-weight: 800; opacity: 0.65; line-height: 1; }

@keyframes chipPop { from { transform: scale(0.6); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.skeleton-card { background: var(--white); padding: 26px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 2px solid transparent; overflow: hidden; }
.skeleton-line { border-radius: 6px; background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; }

@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

.filter-restored-badge { display: inline-flex; align-items: center; gap: 5px; background: #dcfce7; color: #16a34a; border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 700; margin-left: 8px; animation: fadeIn 0.5s ease; transition: opacity 0.5s ease; }

.btn-ripple { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.35); transform: scale(0); animation: rippleAnim 0.55s linear; pointer-events: none; }

@keyframes rippleAnim { to { transform: scale(4); opacity: 0; } }
</style>

<script>
const FILTER_STORAGE_KEY = 'teenwork_filters_v1';
const FILTER_LABELS = {
    search: { id: 'searchInput',  label: 'Поиск',    type: 'input' },
    city:   { id: 'cityFilter',   label: 'Город',    type: 'select' },
    type:   { id: 'typeFilter',   label: 'Тип',      type: 'select' },
    salary: { id: 'salaryFilter', label: 'Зарплата', type: 'select' },
};

function initFilterChipsContainer() {
    const filterSection = document.querySelector('.filters-section');
    if (!filterSection || filterSection.querySelector('#filterChipsRow')) return;
    const actionsRow = filterSection.querySelector('.filter-actions');
    if (!actionsRow) return;
    const row = document.createElement('div');
    row.className = 'filter-chips-row';
    row.id = 'filterChipsRow';
    filterSection.insertBefore(row, actionsRow);
}

function renderFilterChips() {
    const row = document.getElementById('filterChipsRow');
    if (!row) return;
    row.innerHTML = '';
    let idx = 0;
    Object.entries(FILTER_LABELS).forEach(([, meta]) => {
        const el = document.getElementById(meta.id);
        if (!el || !el.value) return;
        const label = meta.type === 'select' && el.options[el.selectedIndex] ? el.options[el.selectedIndex].text : el.value;
        const chip = document.createElement('span');
        chip.className = 'filter-chip';
        chip.style.animationDelay = (idx * 40) + 'ms';
        chip.innerHTML = `${meta.label}: <strong>${label}</strong> <span class=\"filter-chip-remove\">×</span>`;
        chip.addEventListener('click', () => { el.value = ''; applyFilters(); });
        row.appendChild(chip);
        idx++;
    });
}

function saveFiltersToStorage() {
    const s = {};
    Object.values(FILTER_LABELS).forEach(m => { const el = document.getElementById(m.id); if (el) s[m.id] = el.value; });
    const sort = document.getElementById('sortFilter');
    if (sort) s['sortFilter'] = sort.value;
    try { localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(s)); } catch(e) {}
}

function restoreFiltersFromStorage() {
    try {
        const saved = JSON.parse(localStorage.getItem(FILTER_STORAGE_KEY) || 'null');
        if (!saved) return false;
        let any = false;
        Object.values(FILTER_LABELS).forEach(m => { const el = document.getElementById(m.id); if (el && saved[m.id]) { el.value = saved[m.id]; any = true; } });
        const sort = document.getElementById('sortFilter');
        if (sort && saved['sortFilter']) sort.value = saved['sortFilter'];
        return any;
    } catch(e) { return false; }
}

function showRestoredBadge() {
    const jc = document.getElementById('jobCount');
    if (!jc) return;
    const badge = document.createElement('span');
    badge.className = 'filter-restored-badge';
    badge.textContent = '↩ Фильтры восстановлены';
    jc.parentNode.insertBefore(badge, jc.nextSibling);
    setTimeout(() => { badge.style.opacity = '0'; setTimeout(() => badge.remove(), 500); }, 3000);
}

function showJobSkeletons(count) {
    const grid = document.getElementById('jobsGrid');
    if (!grid) return;
    let html = '';
    for (let i = 0; i < count; i++) {
        html += `<div class=\"skeleton-card\">
            <div class=\"skeleton-line\" style=\"height:22px;width:70%;margin-bottom:12px;\"></div>
            <div class=\"skeleton-line\" style=\"height:14px;width:45%;margin-bottom:8px;\"></div>
            <div class=\"skeleton-line\" style=\"height:14px;width:35%;margin-bottom:20px;\"></div>
            <div class=\"skeleton-line\" style=\"height:28px;width:55%;margin-bottom:14px;\"></div>
            <div class=\"skeleton-line\" style=\"height:34px;width:40%;border-radius:24px;margin-bottom:22px;\"></div>
            <div style=\"display:flex;justify-content:flex-end;\"><div class=\"skeleton-line\" style=\"height:36px;width:120px;border-radius:12px;\"></div></div>
        </div>`;
    }
    grid.innerHTML = html;
}

const _origApplyFilters_ux = applyFilters;
window.applyFilters = function() { _origApplyFilters_ux(); renderFilterChips(); saveFiltersToStorage(); };

const _origResetFilters_ux = resetFilters;
window.resetFilters = function() { _origResetFilters_ux(); renderFilterChips(); try { localStorage.removeItem(FILTER_STORAGE_KEY); } catch(e) {} };

document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn, .btn-clear-filters');
    if (!btn) return;
    const ripple = document.createElement('span');
    ripple.className = 'btn-ripple';
    const r = btn.getBoundingClientRect();
    const size = Math.max(r.width, r.height);
    ripple.style.cssText = `width:${size}px;height:${size}px;left:${e.clientX-r.left-size/2}px;top:${e.clientY-r.top-size/2}px;`;
    btn.appendChild(ripple);
    ripple.addEventListener('animationend', () => ripple.remove());
}, true);

document.addEventListener('DOMContentLoaded', function() {
    initFilterChipsContainer();
    showJobSkeletons(6);
    const wasRestored = restoreFiltersFromStorage();
    if (wasRestored) {
        const poll = setInterval(() => {
            if (window.STATE && window.STATE.jobs.length > 0) { applyFilters(); showRestoredBadge(); clearInterval(poll); }
        }, 300);
        setTimeout(() => clearInterval(poll), 8000);
    }
});
</script>

<!-- ================= DESIGN REWORK ================= -->
<style>
.jobs-section .section-header h2::after { display: none !important; }

.jobs-section .section-header h2 {
    -webkit-text-fill-color: initial !important;
    background: none !important;
    background-clip: initial !important;
    filter: none !important;
    display: block !important;
    font-size: 0 !important;
    position: relative;
    min-height: 0;
}

.job-section-hero { display: flex; flex-direction: column; gap: 6px; animation: heroCounterIn 0.6s cubic-bezier(0.34,1.56,0.64,1) backwards; }

@keyframes heroCounterIn { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }

.job-section-label { font-size: 11px; font-weight: 700; letter-spacing: 2.5px; text-transform: uppercase; color: var(--primary-blue); opacity: 0.8; }

.job-section-count-row { display: flex; align-items: baseline; gap: 10px; line-height: 1; }

.job-section-num { font-size: 52px; font-weight: 800; letter-spacing: -3px; color: var(--text-dark); font-variant-numeric: tabular-nums; transition: color 0.3s ease; text-shadow: 0 2px 24px rgba(37,99,235,0.10); position: relative; }

.job-section-num::after { content: ''; display: none; }

.job-section-num-wrap { position: relative; display: inline-block; }

.job-section-num-wrap::before { content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--primary-blue), var(--blue-light)); border-radius: 3px; opacity: 0.18; filter: blur(4px); transition: opacity 0.4s ease, width 0.4s ease; }

.job-section-hero:hover .job-section-num-wrap::before { opacity: 0.32; }

.job-section-suffix { font-size: 20px; font-weight: 600; color: var(--text-gray); letter-spacing: -0.3px; padding-bottom: 4px; }

@keyframes numFlip { 0% { opacity: 0; transform: translateY(-14px) scale(0.9); } 100% { opacity: 1; transform: translateY(0) scale(1); } }

.job-section-num.flipping { animation: numFlip 0.28s cubic-bezier(0.34,1.56,0.64,1); }

#jobCount { display: none !important; }
</style>

<script>
(function installJobSectionHero() {
    function buildHero() {
        const sectionHeader = document.querySelector('.jobs-section .section-header');
        if (!sectionHeader || sectionHeader.querySelector('.job-section-hero')) return;
        const heroDiv = document.createElement('div');
        heroDiv.className = 'job-section-hero';
        heroDiv.id = 'jobSectionHero';
        heroDiv.innerHTML = `
            <div class=\"job-section-label\">Вакансии</div>
            <div class=\"job-section-count-row\">
                <div class=\"job-section-num-wrap\"><span class=\"job-section-num\" id=\"jobSectionNum\">0</span></div>
                <span class=\"job-section-suffix\" id=\"jobSectionSuffix\">найдено</span>
            </div>
        `;
        const headerInner = sectionHeader.querySelector('div');
        if (headerInner) headerInner.insertBefore(heroDiv, headerInner.firstChild);
        else sectionHeader.insertBefore(heroDiv, sectionHeader.firstChild);
    }

    function animateCount(el, from, to, duration) {
        if (from === to) return;
        const startTime = performance.now();
        function tick(now) {
            const t = Math.min((now - startTime) / duration, 1);
            const eased = 1 - Math.pow(1 - t, 3);
            el.textContent = Math.round(from + (to - from) * eased);
            if (t < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
    }

    let _lastCount = null;

    function syncHeroCount() {
        const numEl = document.getElementById('jobSectionNum');
        if (!numEl) return;
        const count = window.STATE ? window.STATE.filteredJobs.length : 0;
        if (count === _lastCount) return;
        const prev = _lastCount === null ? 0 : _lastCount;
        _lastCount = count;
        numEl.classList.remove('flipping');
        void numEl.offsetWidth;
        numEl.classList.add('flipping');
        animateCount(numEl, prev, count, 420);
        const suffix = document.getElementById('jobSectionSuffix');
        if (suffix) {
            const mod10 = count % 10, mod100 = count % 100;
            let word;
            if (mod100 >= 11 && mod100 <= 14) word = 'найдено';
            else if (mod10 === 1) word = 'найдена';
            else if (mod10 >= 2 && mod10 <= 4) word = 'найдено';
            else word = 'найдено';
            suffix.textContent = word;
        }
    }

    const _origRenderForHero = window.renderJobs;
    window.renderJobs = function() { _origRenderForHero(); syncHeroCount(); };

    document.addEventListener('DOMContentLoaded', function() { buildHero(); syncHeroCount(); });
    setTimeout(() => { buildHero(); syncHeroCount(); }, 80);
})();
</script>

<!-- ================= CARD ANIMATION SYSTEM ================= -->
<style>
.job-card {
    background: #ffffff !important;
    padding: 30px 28px 24px !important;
    border-radius: 20px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06) !important;
    border: 1.5px solid rgba(226,232,240,0.8) !important;
    transition: box-shadow 0.35s cubic-bezier(0.4,0,0.2,1), transform 0.35s cubic-bezier(0.4,0,0.2,1), border-color 0.25s ease !important;
    position: relative;
    overflow: hidden;
}

.job-card:hover {
    transform: translateY(-8px) scale(1.012) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04), 0 12px 40px rgba(37,99,235,0.12), 0 24px 60px rgba(0,0,0,0.08) !important;
    border-color: rgba(37,99,235,0.3) !important;
}

.job-card:active { transform: translateY(-3px) scale(1.005) !important; transition-duration: 0.12s !important; }
.job-title { font-size: 19px !important; font-weight: 800 !important; letter-spacing: -0.4px !important; line-height: 1.25 !important; color: #0f172a !important; margin-bottom: 8px !important; }
.job-company { font-size: 14px !important; font-weight: 600 !important; color: var(--text-gray) !important; margin-bottom: 4px !important; }
.job-location { font-size: 13px !important; color: #94a3b8 !important; font-weight: 500 !important; }
.job-salary { font-size: 26px !important; font-weight: 800 !important; letter-spacing: -1px !important; margin-bottom: 16px !important; background: linear-gradient(130deg, #1d4ed8 0%, var(--blue-light) 100%) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; }
.tag { padding: 5px 12px !important; background: #f0f7ff !important; color: #2563eb !important; border-radius: 20px !important; font-size: 12px !important; font-weight: 700 !important; border: 1px solid rgba(37,99,235,0.12) !important; letter-spacing: 0.1px !important; }
.job-footer { padding-top: 16px !important; border-top: 1px solid #f1f5f9 !important; margin-top: 4px !important; }
.btn-apply { padding: 10px 22px !important; font-size: 13px !important; font-weight: 700 !important; letter-spacing: 0.2px !important; border-radius: var(--radius-md) !important; }

@keyframes cardEntry { from { opacity: 0; transform: translateY(28px); } to { opacity: 1; transform: translateY(0); } }

.job-card { animation: cardEntry 0.5s cubic-bezier(0.4,0,0.2,1) backwards !important; }
.job-card:nth-child(1) { animation-delay: 0.04s !important; }
.job-card:nth-child(2) { animation-delay: 0.09s !important; }
.job-card:nth-child(3) { animation-delay: 0.14s !important; }
.job-card:nth-child(4) { animation-delay: 0.19s !important; }
.job-card:nth-child(5) { animation-delay: 0.24s !important; }
.job-card:nth-child(6) { animation-delay: 0.29s !important; }

.job-card::before { z-index: 0 !important; border-radius: 20px !important; }

@keyframes modalSlideIn { from { opacity: 0; transform: scale(0.93) translateY(-24px); filter: blur(2px); } to { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); } }
@keyframes modalSlideOut { to { opacity: 0; transform: scale(0.96) translateY(-16px); filter: blur(1px); } }

.modal-content { animation: modalSlideIn 0.42s cubic-bezier(0.34,1.56,0.64,1) !important; }
.modal.hiding .modal-content { animation: modalSlideOut 0.28s ease forwards !important; }
.modal { backdrop-filter: blur(10px) !important; background: rgba(15, 23, 42, 0.5) !important; }
.jobs-grid { gap: 28px !important; }
</style>

<!-- ================= EMPLOYER VACANCY CONTROL ================= -->
<style>
.job-closed-badge { position: absolute; top: 12px; left: 14px; background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; letter-spacing: 0.4px; z-index: 2; pointer-events: none; box-shadow: 0 2px 8px rgba(239,68,68,0.3); }

.job-card.job-is-closed { opacity: 0.72; }
.job-card.job-is-closed::after { content: ''; position: absolute; inset: 0; background: rgba(241,245,249,0.45); border-radius: 20px; pointer-events: none; z-index: 0; }

.employer-vacancy-section { margin-top: 32px; background: var(--light-gray); border-radius: var(--radius-lg); padding: 24px; animation: fadeInUp 0.5s ease; }
.employer-vacancy-section h3 { font-size: 19px; font-weight: 700; margin-bottom: 18px; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
.employer-vacancy-section h3::before { content: '⚙️'; font-size: 18px; }

.employer-vacancy-card { background: var(--white); border-radius: var(--radius-md); padding: 18px; margin-bottom: 14px; box-shadow: var(--shadow-sm); border: 1.5px solid var(--border-gray); transition: var(--transition); }
.employer-vacancy-card:last-child { margin-bottom: 0; }
.employer-vacancy-card:hover { box-shadow: var(--shadow-md); border-color: rgba(37,99,235,0.2); }

.employer-vacancy-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.employer-vacancy-card-title { font-size: 16px; font-weight: 700; color: var(--text-dark); margin-bottom: 4px; }
.employer-vacancy-card-meta { font-size: 13px; color: var(--text-gray); font-weight: 500; }

.employer-vacancy-status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; flex-shrink: 0; transition: var(--transition); }
.employer-vacancy-status-badge.open { background: #dcfce7; color: #16a34a; }
.employer-vacancy-status-badge.closed { background: #fee2e2; color: #dc2626; }

.employer-vacancy-stats { display: flex; gap: 20px; margin-bottom: 14px; font-size: 13px; color: var(--text-gray); font-weight: 500; }
.employer-vacancy-stat { display: flex; align-items: center; gap: 5px; font-weight: 600; }

.employer-vacancy-controls { display: flex; gap: 8px; flex-wrap: wrap; }

.btn-toggle-vacancy { padding: 7px 16px; font-size: 12px; font-weight: 700; border-radius: var(--radius-sm); border: 1.5px solid var(--border-gray); cursor: pointer; transition: var(--transition); font-family: inherit; background: var(--white); color: var(--text-dark); }
.btn-toggle-vacancy:hover { border-color: var(--primary-blue); background: var(--soft-blue); color: var(--primary-blue); }
.btn-toggle-vacancy.close-action { border-color: #fca5a5; color: #dc2626; }
.btn-toggle-vacancy.close-action:hover { background: #fee2e2; border-color: #dc2626; }
.btn-toggle-vacancy.open-action { border-color: #86efac; color: #16a34a; }
.btn-toggle-vacancy.open-action:hover { background: #dcfce7; border-color: #16a34a; }

.btn-edit-vacancy { padding: 7px 16px; font-size: 12px; font-weight: 700; border-radius: var(--radius-sm); border: 1.5px solid rgba(37,99,235,0.3); cursor: pointer; transition: var(--transition); font-family: inherit; background: var(--soft-blue); color: var(--primary-blue); }
.btn-edit-vacancy:hover { background: var(--primary-blue); color: var(--white); border-color: var(--primary-blue); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.2); }

.btn-apply:disabled, .btn-apply[data-closed=\"true\"] { opacity: 0.45 !important; cursor: not-allowed !important; background: var(--text-gray) !important; transform: none !important; box-shadow: none !important; }
</style>

<div class=\"modal\" id=\"editVacancyModal\">
    <div class=\"modal-content\">
        <div class=\"modal-header\">
            <h3>Редактировать вакансию</h3>
            <button class=\"modal-close\" onclick=\"closeModal('editVacancyModal')\">&times;</button>
        </div>
        <div class=\"modal-body\">
            <form id=\"editVacancyForm\">
                <input type=\"hidden\" id=\"editVacancyId\">
                <div class=\"form-group\"><label>Название вакансии</label><input type=\"text\" id=\"editVacancyTitle\" required><div class=\"form-error\">Это поле обязательно</div></div>
                <div class=\"form-group\"><label>Зарплата (₽)</label><input type=\"number\" id=\"editVacancySalary\" required min=\"0\"><div class=\"form-error\">Введите корректную зарплату</div></div>
                <div class=\"form-group\"><label>Тип работы</label><input type=\"text\" id=\"editVacancyType\" required><div class=\"form-error\">Это поле обязательно</div></div>
                <div class=\"form-group\"><label>Город</label><select id=\"editVacancyCity\" required><option value=\"\">Выберите город</option><option value=\"Санкт-Петербург\">Санкт-Петербург</option></select><div class=\"form-error\">Это поле обязательно</div></div>
                <div class=\"form-group\"><label>Описание</label><textarea id=\"editVacancyDescription\" required style=\"min-height: 110px; resize: vertical;\"></textarea><div class=\"form-error\">Это поле обязательно</div></div>
                <button type=\"submit\" class=\"btn btn-primary\" style=\"width: 100%; margin-top: 8px;\">Сохранить изменения</button>
            </form>
        </div>
    </div>
</div>

<script>
(function patchRenderJobsForClosed() {
    const _origRender = window.renderJobs;
    if (!_origRender) return;
    window.renderJobs = function() {
        _origRender();
        const grid = document.getElementById('jobsGrid');
        if (!grid) return;
        const cards = grid.querySelectorAll('.job-card');
        cards.forEach(card => {
            const onclickAttr = card.getAttribute('onclick') || '';
            const match = onclickAttr.match(/openApplyModal\(['\"]([^'\"]+)['\"]\)/);
            if (!match) return;
            const jobId = match[1];
            const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
            if (!job) return;
            if (job.isClosed) {
                card.classList.add('job-is-closed');
                if (!card.querySelector('.job-closed-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'job-closed-badge';
                    badge.textContent = 'Набор закрыт';
                    card.insertBefore(badge, card.firstChild);
                }
                const applyBtn = card.querySelector('.btn-apply');
                if (applyBtn) {
                    applyBtn.disabled = true;
                    applyBtn.dataset.closed = 'true';
                    applyBtn.title = 'Набор на эту вакансию закрыт';
                    applyBtn.onclick = (e) => { e.stopPropagation(); if (window.showToast) showToast('Набор закрыт', 'Работодатель приостановил набор на эту вакансию', 'warning'); };
                }
            }
        });
    };
})();

async function toggleVacancyClosed(jobId, currentlyClosed) {
    if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'jobs', jobId), { isClosed: !currentlyClosed });
        showToast('Успешно', currentlyClosed ? 'Набор открыт' : 'Набор закрыт', 'success');
        if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
        _renderEmployerVacancySection();
    } catch (e) { console.error('toggleVacancyClosed error:', e); showToast('Ошибка', 'Не удалось изменить статус', 'error'); }
}

function openEditVacancyModal(jobId) {
    const job = window.STATE && window.STATE.jobs.find(j => j.id === jobId);
    if (!job) return;
    document.getElementById('editVacancyId').value = jobId;
    document.getElementById('editVacancyTitle').value = job.title || '';
    document.getElementById('editVacancySalary').value = job.salary || '';
    document.getElementById('editVacancyType').value = job.type || '';
    document.getElementById('editVacancyCity').value = job.city || '';
    document.getElementById('editVacancyDescription').value = job.description || '';
    openModal('editVacancyModal');
}

async function handleEditVacancySave(e) {
    e.preventDefault();
    const jobId = document.getElementById('editVacancyId').value;
    const title = document.getElementById('editVacancyTitle').value.trim();
    const salary = parseInt(document.getElementById('editVacancySalary').value);
    const type = document.getElementById('editVacancyType').value.trim();
    const city = document.getElementById('editVacancyCity').value;
    const description = document.getElementById('editVacancyDescription').value.trim();
    if (!title || !salary || !type || !city || !description) { showToast('Ошибка', 'Заполните все поля', 'error'); return; }
    if (!window.db) { showToast('Ошибка', 'База данных недоступна', 'error'); return; }
    try {
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        await updateDoc(doc(window.db, 'jobs', jobId), { title, salary, type, city, description, updatedAt: Date.now() });
        closeModal('editVacancyModal');
        showToast('Успешно', 'Вакансия обновлена', 'success');
        if (window.loadJobsFromFirestore) await window.loadJobsFromFirestore();
        _renderEmployerVacancySection();
    } catch (e) { console.error('handleEditVacancySave error:', e); showToast('Ошибка', 'Не удалось обновить вакансию', 'error'); }
}

async function _renderEmployerVacancySection() {
    const profileBody = document.querySelector('.profile-body');
    if (!profileBody || !window.STATE || !window.STATE.currentUser) return;
    if (window.STATE.currentUser.role !== 'employer') return;
    const oldSection = document.getElementById('employerVacancyControlSection');
    if (oldSection) oldSection.remove();
    const userJobs = window.STATE.jobs.filter(j => j.employerEmail === window.STATE.currentUser.email || j.employerId === (window.STATE.currentUser.uid || window.STATE.currentUser.email));
    if (userJobs.length === 0) return;
    const section = document.createElement('div');
    section.className = 'employer-vacancy-section';
    section.id = 'employerVacancyControlSection';
    let html = '<h3>Управление вакансиями</h3>';
    for (const job of userJobs) {
        let appCount = 0;
        const viewCount = job.views || 0;
        if (window.db) {
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
                const q = query(collection(window.db, 'applications'), where('jobId', '==', job.id));
                const snap = await getDocs(q);
                appCount = snap.size;
            } catch (e) { }
        }
        const isClosed = !!job.isClosed;
        const statusClass = isClosed ? 'closed' : 'open';
        const statusText = isClosed ? '● Набор закрыт' : '● Набор открыт';
        html += `
            <div class=\"employer-vacancy-card\">
                <div class=\"employer-vacancy-card-top\">
                    <div><div class=\"employer-vacancy-card-title\">${job.title}</div><div class=\"employer-vacancy-card-meta\">${job.company} • ${(job.salary || 0).toLocaleString('ru-RU')} ₽</div></div>
                    <div class=\"employer-vacancy-status-badge ${statusClass}\">${statusText}</div>
                </div>
                <div class=\"employer-vacancy-stats\"><div class=\"employer-vacancy-stat\">??️ <span>${viewCount} просмотров</span></div><div class=\"employer-vacancy-stat\">?? <span>${appCount} откликов</span></div></div>
                <div class=\"employer-vacancy-controls\">
                    <button class=\"btn-toggle-vacancy ${isClosed ? 'open-action' : 'close-action'}\" onclick=\"toggleVacancyClosed('${job.id}', ${isClosed})\">${isClosed ? '✓ Открыть набор' : '✗ Закрыть набор'}</button>
                    <button class=\"btn-edit-vacancy\" onclick=\"openEditVacancyModal('${job.id}')\">✎ Редактировать</button>
                    <button class=\"btn btn-small btn-primary\" onclick=\"showApplications('${job.id}')\">Отклики</button>
                </div>
            </div>
        `;
    }
    section.innerHTML = html;
    profileBody.appendChild(section);
}

const _origOpenProfileForVacancy = window.openProfile || openProfile;
window.openProfile = function() {
    _origOpenProfileForVacancy();
    setTimeout(() => { if (window.STATE && window.STATE.currentUser && window.STATE.currentUser.role === 'employer') _renderEmployerVacancySection(); }, 200);
};

document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editVacancyForm');
    if (editForm) editForm.addEventListener('submit', handleEditVacancySave);
});
</script>

<!-- ================= INTERACTION ENHANCEMENT ================= -->
<style>
.btn:not(:disabled):hover { transform: translateY(-2px) scale(1.02) !important; }
.btn:not(:disabled):active { transform: translateY(0) scale(0.97) !important; transition-duration: 0.08s !important; }
.back-btn:hover { transform: translateX(-2px) !important; }
.pagination-btn:hover:not(:disabled) { transform: translateY(-2px) !important; }
.faq-item { transition: box-shadow 0.25s ease, transform 0.25s ease !important; }
.faq-item:hover { transform: translateX(3px) !important; }
.info-card:hover { transform: translateY(-8px) scale(1.015) !important; box-shadow: 0 12px 36px rgba(37,99,235,0.12) !important; }

.section-fade-in { opacity: 0; transform: translateY(24px); transition: opacity 0.55s cubic-bezier(0.4,0,0.2,1), transform 0.55s cubic-bezier(0.4,0,0.2,1); }
.section-fade-in.visible { opacity: 1; transform: translateY(0); }

.modal-close:hover { transform: rotate(90deg) scale(1.15) !important; }
.nav-profile-wrapper { transition: background 0.2s ease, transform 0.2s ease !important; }
.nav-profile-wrapper:hover { transform: translateY(-1px) !important; }
.input:focus, .select:focus, .form-group input:focus, .form-group select:focus, .form-group textarea:focus { transform: scale(1.005); }
.role-option:hover { transform: translateX(4px) !important; }
.back-btn:hover { background: rgba(255,255,255,0.35) !important; transform: translateX(-3px) !important; }
.logo { transition: transform 0.3s ease, filter 0.3s ease !important; }
.applied-job-item { transition: box-shadow 0.2s ease, transform 0.2s ease; }
.applied-job-item:hover { transform: translateX(3px); box-shadow: var(--shadow-md); }
@keyframes slideInRight { from { transform: translateX(450px) scale(0.9); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
.logo:hover { filter: drop-shadow(0 4px 12px rgba(37,99,235,0.4)) !important; transform: translateY(-2px) !important; }
</style>

<script>
(function initScrollFadeIn() {
    const targets = ['.info-section', '.faq-section', '.footer', '.info-card', '.faq-item'];
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); observer.unobserve(entry.target); } });
    }, { rootMargin: '-40px 0px', threshold: 0.08 });

    function observeTargets() {
        targets.forEach(sel => {
            document.querySelectorAll(sel).forEach(el => { if (!el.classList.contains('visible')) { el.classList.add('section-fade-in'); observer.observe(el); } });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        observeTargets();
        document.getElementById('profilePage')?.addEventListener('transitionend', observeTargets);
    });
})();

document.addEventListener('keydown', function(e) {
    if (e.key !== 'Tab') return;
    const activeModal = document.querySelector('.modal.active');
    if (!activeModal) return;
    const focusable = activeModal.querySelectorAll('button:not(:disabled), input:not(:disabled), select:not(:disabled), textarea:not(:disabled), [tabindex]:not([tabindex=\"-1\"])');
    if (focusable.length === 0) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (e.shiftKey) { if (document.activeElement === first) { e.preventDefault(); last.focus(); } }
    else { if (document.activeElement === last) { e.preventDefault(); first.focus(); } }
});
</script>
<!-- ================= APPLICATION STATUS EXTENSION ================= -->
<style>
.app-status-badge {
    display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px;
    border-radius: 20px; font-size: 12px; font-weight: 700; letter-spacing: 0.2px;
    transition: all 0.3s ease; animation: statusFadeIn 0.3s cubic-bezier(0.34,1.56,0.64,1) backwards;
}
.app-status-badge.status-new { background:#eff6ff; color:#2563eb; border:1px solid rgba(37,99,235,0.2); }
.app-status-badge.status-accepted { background:#dcfce7; color:#16a34a; border:1px solid rgba(22,163,74,0.2); }
.app-status-badge.status-rejected { background:#fee2e2; color:#dc2626; border:1px solid rgba(220,38,38,0.2); }
.app-status-badge.status-in_progress { background:#fef9c3; color:#d97706; border:1px solid rgba(217,119,6,0.2); }
.app-status-badge.status-hired { background:#d1fae5; color:#059669; border:1px solid rgba(5,150,105,0.2); font-weight:800; }
.app-status-badge.status-not_hired { background:#f3f4f6; color:#6b7280; border:1px solid rgba(107,114,128,0.2); }
.app-status-badge.status-archived { background:#f1f5f9; color:#94a3b8; border:1px solid rgba(148,163,184,0.2); }
@keyframes statusFadeIn { from{opacity:0;transform:scale(0.85)} to{opacity:1;transform:scale(1)} }
.app-tabs { display:flex; gap:4px; margin-bottom:18px; background:var(--light-gray); border-radius:var(--radius-md); padding:4px; flex-wrap:wrap; }
.app-tab-btn { flex:1; min-width:90px; padding:9px 12px; border:none; border-radius:var(--radius-sm); background:transparent; font-family:inherit; font-size:13px; font-weight:600; color:var(--text-gray); cursor:pointer; transition:all 0.25s ease; display:flex; align-items:center; justify-content:center; gap:5px; white-space:nowrap; }
.app-tab-btn:hover { background:rgba(37,99,235,0.08); color:var(--primary-blue); }
.app-tab-btn.active { background:var(--white); color:var(--primary-blue); box-shadow:0 1px 4px rgba(0,0,0,0.1); }
.app-tab-count { background:var(--primary-blue); color:var(--white); border-radius:10px; font-size:11px; font-weight:800; min-width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; padding:0 5px; }
.app-tab-btn:not(.active) .app-tab-count { background:var(--text-gray); }
.app-decision-btns { display:flex; gap:8px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border-gray); }
.btn-accept-app { flex:1; padding:8px 14px; font-size:13px; font-weight:700; border-radius:var(--radius-sm); border:1.5px solid #86efac; background:#dcfce7; color:#16a34a; cursor:pointer; transition:all 0.2s ease; font-family:inherit; }
.btn-accept-app:hover { background:#16a34a; color:var(--white); border-color:#16a34a; transform:translateY(-1px); }
.btn-reject-app { flex:1; padding:8px 14px; font-size:13px; font-weight:700; border-radius:var(--radius-sm); border:1.5px solid #fca5a5; background:#fee2e2; color:#dc2626; cursor:pointer; transition:all 0.2s ease; font-family:inherit; }
.btn-reject-app:hover { background:#dc2626; color:var(--white); border-color:#dc2626; transform:translateY(-1px); }
.worker-outcome-btns { display:flex; gap:8px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border-gray); }
.btn-got-hired { flex:1; padding:8px 14px; font-size:13px; font-weight:700; border-radius:var(--radius-sm); border:1.5px solid #6ee7b7; background:#d1fae5; color:#059669; cursor:pointer; transition:all 0.2s ease; font-family:inherit; }
.btn-got-hired:hover { background:#059669; color:var(--white); border-color:#059669; transform:translateY(-1px); }
.btn-not-hired { flex:1; padding:8px 14px; font-size:13px; font-weight:700; border-radius:var(--radius-sm); border:1.5px solid #d1d5db; background:#f3f4f6; color:#6b7280; cursor:pointer; transition:all 0.2s ease; font-family:inherit; }
.btn-not-hired:hover { background:#6b7280; color:var(--white); border-color:#6b7280; transform:translateY(-1px); }
.app-ext-card { background:var(--white); border-radius:var(--radius-md); padding:16px; margin-bottom:12px; border:1.5px solid var(--border-gray); box-shadow:var(--shadow-sm); transition:all 0.25s ease; animation:statusFadeIn 0.3s ease backwards; }
.app-ext-card:last-child { margin-bottom:0; }
.app-ext-card:hover { box-shadow:var(--shadow-md); border-color:rgba(37,99,235,0.2); }
.app-ext-card-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; gap:10px; }
.app-ext-card-title { font-size:15px; font-weight:700; color:var(--text-dark); flex:1; }
.app-ext-card-sub { font-size:13px; color:var(--text-gray); font-weight:500; margin-top:2px; }
.app-status-badge.status-in_progress { animation:inProgressPulse 2s ease-in-out infinite !important; }
@keyframes inProgressPulse { 0%,100%{box-shadow:0 0 0 0 rgba(217,119,6,0.3)} 50%{box-shadow:0 0 0 6px rgba(217,119,6,0)} }
</style>

<script>
// ================= APPLICATION STATUS EXTENSION =================
function _getStatusLabel(s){const m={new:'Новый',accepted:'Принят',rejected:'Отклонён',in_progress:'На рассмотрении',hired:'Устроился',not_hired:'Не устроился',archived:'Архив'};return m[s]||s||'Новый';}
function _getStatusClass(s){const m={new:'status-new',accepted:'status-accepted',rejected:'status-rejected',in_progress:'status-in_progress',hired:'status-hired',not_hired:'status-not_hired',archived:'status-archived'};return m[s]||'status-new';}
function _buildStatusBadge(s){return '<span class="app-status-badge '+_getStatusClass(s)+'">'+_getStatusLabel(s)+'</span>';}
async function _updateApplicationStatus(id,newStatus){
    if(!window.db)return false;
    try{const{doc,updateDoc}=await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
    await updateDoc(doc(window.db,'applications',id),{status:newStatus,updatedAt:Date.now()});return true;}
    catch(e){console.error('_updateApplicationStatus error:',e);return false;}
}
</script>

<!-- ================= EMPLOYER DECISION EXTENSION ================= -->
<script>
async function employerAcceptApplication(appDocId,workerNickname){
    if(!window.db){showToast('Ошибка','База данных недоступна','error');return;}
    const ok=await _updateApplicationStatus(appDocId,'in_progress');
    if(ok){showToast('Принято','Заявка принята — статус «На рассмотрении»','success');window._employerAppTab='in_progress';if(window._currentEmployerJobId)await showApplicationsExtended(window._currentEmployerJobId);}
    else showToast('Ошибка','Не удалось принять заявку','error');
}
async function employerRejectApplication(appDocId,workerNickname){
    if(!window.db){showToast('Ошибка','База данных недоступна','error');return;}
    const ok=await _updateApplicationStatus(appDocId,'rejected');
    if(ok){showToast('Отклонено','Заявка отклонена','warning');window._employerAppTab='new';if(window._currentEmployerJobId)await showApplicationsExtended(window._currentEmployerJobId);}
    else showToast('Ошибка','Не удалось отклонить заявку','error');
}
async function showApplicationsExtended(jobId){
    window._currentEmployerJobId=jobId;
    if(!window.db){showToast('Ошибка','База данных недоступна','error');return;}
    try{
        const{collection,query,where,getDocs}=await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const snapshot=await getDocs(query(collection(window.db,'applications'),where('jobId','==',jobId)));
        const all=[];snapshot.forEach(d=>all.push({id:d.id,...d.data()}));
        const tabs={
            new:all.filter(a=>!a.status||a.status==='new'),
            in_progress:all.filter(a=>a.status==='in_progress'||a.status==='accepted'),
            archive:all.filter(a=>['rejected','hired','not_hired','archived'].includes(a.status))
        };
        function renderCards(tabKey){
            const items=tabs[tabKey];
            if(!items.length)return '<p style="color:var(--text-gray);text-align:center;padding:24px;">Нет заявок в этом разделе</p>';
            return items.map(app=>{
                const safe=(s)=>(s||'').replace(/'/g,"\'");
                const decisionBtns=tabKey==='new'?('<div class="app-decision-btns"><button class="btn-accept-app" onclick="employerAcceptApplication(''+app.id+'',''+safe(app.workerNickname)+'')">✓ Принять</button><button class="btn-reject-app" onclick="employerRejectApplication(''+app.id+'',''+safe(app.workerNickname)+'')">✗ Отклонить</button></div>'):'';
                const chatBtn=tabKey!=='archive'?('<button class="btn btn-small btn-primary" style="margin-top:10px;" onclick="openChatFromEmployer(''+safe(jobId)+'',''+safe(app.workerId)+'')">Открыть чат</button>'):'';
                const msgHtml=app.message?'<div style="font-size:13px;color:var(--text-gray);margin-bottom:4px;">'+app.message+'</div>':'';
                return '<div class="app-ext-card"><div class="app-ext-card-top"><div><div class="app-ext-card-title">'+(app.workerNickname||'Соискатель')+'</div><div class="app-ext-card-sub">'+(app.workerEmail||'')+'</div></div>'+_buildStatusBadge(app.status||'new')+'</div>'+msgHtml+decisionBtns+chatBtn+'</div>';
            }).join('');
        }
        window._buildEmployerTabHTML=function(tab){
            window._employerAppTab=tab;
            return '<div class="app-tabs">'+
                '<button class="app-tab-btn '+(tab==='new'?'active':'')+'" onclick="window._employerAppTab='new';document.getElementById('applicationsModalBody').innerHTML=window._buildEmployerTabHTML('new')">Новые <span class="app-tab-count">'+tabs.new.length+'</span></button>'+
                '<button class="app-tab-btn '+(tab==='in_progress'?'active':'')+'" onclick="window._employerAppTab='in_progress';document.getElementById('applicationsModalBody').innerHTML=window._buildEmployerTabHTML('in_progress')">На рассмотрении <span class="app-tab-count">'+tabs.in_progress.length+'</span></button>'+
                '<button class="app-tab-btn '+(tab==='archive'?'active':'')+'" onclick="window._employerAppTab='archive';document.getElementById('applicationsModalBody').innerHTML=window._buildEmployerTabHTML('archive')">Архив <span class="app-tab-count">'+tabs.archive.length+'</span></button>'+
                '</div><div>'+renderCards(tab)+'</div>';
        };
        const activeTab=window._employerAppTab||'new';
        document.getElementById('applicationsModalBody').innerHTML=window._buildEmployerTabHTML(activeTab);
        openModal('applicationsModal');
    }catch(e){console.error('showApplicationsExtended error:',e);showToast('Ошибка','Не удалось загрузить отклики','error');}
}
window.showApplications=showApplicationsExtended;
</script>

<!-- ================= WORKER TRACKING EXTENSION ================= -->
<script>
async function workerMarkHired(appDocId,jobTitle){
    if(!window.db){showToast('Ошибка','База данных недоступна','error');return;}
    const ok=await _updateApplicationStatus(appDocId,'hired');
    if(ok){showToast('Поздравляем!','Вы устроились — вакансия перемещена в Архив','success');window._workerAppTab='archive';renderAppliedJobsExtended();}
    else showToast('Ошибка','Не удалось обновить статус','error');
}
async function workerMarkNotHired(appDocId,jobTitle){
    if(!window.db){showToast('Ошибка','База данных недоступна','error');return;}
    const ok=await _updateApplicationStatus(appDocId,'not_hired');
    if(ok){showToast('Понятно','Статус обновлён — перемещено в Архив','warning');window._workerAppTab='archive';renderAppliedJobsExtended();}
    else showToast('Ошибка','Не удалось обновить статус','error');
}
async function renderAppliedJobsExtended(){
    const container=document.getElementById('appliedJobsList');
    if(!container)return;
    if(!window.db||!window.STATE||!window.STATE.currentUser){container.innerHTML='<p style="color:var(--text-gray);text-align:center;padding:20px;">Загрузка...</p>';return;}
    try{
        const{collection,query,where,getDocs}=await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const snapshot=await getDocs(query(collection(window.db,'applications'),where('workerId','==',window.STATE.currentUser.uid||window.STATE.currentUser.email)));
        const all=[];snapshot.forEach(d=>all.push({id:d.id,...d.data()}));
        const tabs={
            active:all.filter(a=>!a.status||a.status==='new'),
            in_progress:all.filter(a=>a.status==='in_progress'||a.status==='accepted'),
            archive:all.filter(a=>['rejected','hired','not_hired','archived'].includes(a.status))
        };
        function renderWorkerCards(tabKey){
            const items=tabs[tabKey];
            if(!items.length)return '<p style="color:var(--text-gray);text-align:center;padding:20px;">Нет заявок в этом разделе</p>';
            return items.map(app=>{
                const job=window.STATE.jobs.find(j=>j.id===app.jobId);
                const title=job?job.title:'Вакансия';
                const company=job?job.company:'';
                const safe=(s)=>(s||'').replace(/'/g,"\'");
                const outcomeBtns=tabKey==='in_progress'?('<div class="worker-outcome-btns"><button class="btn-got-hired" onclick="workerMarkHired(''+app.id+'',''+safe(title)+'')">✓ Устроился</button><button class="btn-not-hired" onclick="workerMarkNotHired(''+app.id+'',''+safe(title)+'')">✗ Не устроился</button></div>'):'';
                const chatBtn=tabKey!=='archive'?('<button class="btn btn-small btn-primary" style="margin-top:10px;" onclick="openChatFromWorker(''+safe(app.jobId)+'',''+safe(app.employerId)+'')">Открыть чат</button>'):'';
                return '<div class="app-ext-card"><div class="app-ext-card-top"><div><div class="app-ext-card-title">'+title+'</div><div class="app-ext-card-sub">'+company+'</div></div>'+_buildStatusBadge(app.status||'new')+'</div>'+outcomeBtns+chatBtn+'</div>';
            }).join('');
        }
        window._buildWorkerTabHTML=function(tab){
            window._workerAppTab=tab;
            return '<div class="app-tabs">'+
                '<button class="app-tab-btn '+(tab==='active'?'active':'')+'" onclick="window._workerAppTab='active';document.getElementById('appliedJobsList').innerHTML=window._buildWorkerTabHTML('active')">Активные <span class="app-tab-count">'+tabs.active.length+'</span></button>'+
                '<button class="app-tab-btn '+(tab==='in_progress'?'active':'')+'" onclick="window._workerAppTab='in_progress';document.getElementById('appliedJobsList').innerHTML=window._buildWorkerTabHTML('in_progress')">На рассмотрении <span class="app-tab-count">'+tabs.in_progress.length+'</span></button>'+
                '<button class="app-tab-btn '+(tab==='archive'?'active':'')+'" onclick="window._workerAppTab='archive';document.getElementById('appliedJobsList').innerHTML=window._buildWorkerTabHTML('archive')">Архив <span class="app-tab-count">'+tabs.archive.length+'</span></button>'+
                '</div><div>'+renderWorkerCards(tab)+'</div>';
        };
        const active=window._workerAppTab||'active';
        container.innerHTML=window._buildWorkerTabHTML(active);
    }catch(e){console.error('renderAppliedJobsExtended error:',e);container.innerHTML='<p style="color:var(--text-gray);text-align:center;padding:20px;">Ошибка загрузки</p>';}
}
window.renderAppliedJobs=renderAppliedJobsExtended;
</script>

</body>
</html>
